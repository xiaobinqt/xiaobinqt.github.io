<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="robots" content="noodp" /><title>Go GC 垃圾回收 - xiaobinqt 博客 - 技术改变生活</title><meta name="Description" content="golang GC 原理,Go 垃圾回收,Go 垃圾标记清除算法,golang 三色标记法,golang 屏障机制,go 垃圾回收算法,go 插入/删除屏障,golang 混合写屏障,垃圾回收 STW,STW"><meta property="og:url" content="https://www.xiaobinqt.cn/go-gc/">
  <meta property="og:site_name" content="xiaobinqt 博客 - 技术改变生活">
  <meta property="og:title" content="Go GC 垃圾回收">
  <meta property="og:description" content="golang GC 原理,Go 垃圾回收,Go 垃圾标记清除算法,golang 三色标记法,golang 屏障机制,go 垃圾回收算法,go 插入/删除屏障,golang 混合写屏障,垃圾回收 STW,STW">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2022-04-06T00:00:00+00:00">
    <meta property="article:modified_time" content="2023-08-22T16:08:54+08:00">
    <meta property="article:tag" content="Golang">
    <meta property="article:tag" content="GC">
    <meta property="og:image" content="https://www.xiaobinqt.cn/images/avatar.webp">
      <meta property="og:see_also" content="https://www.xiaobinqt.cn/docker-network/">
      <meta property="og:see_also" content="https://www.xiaobinqt.cn/highly-concurrent-architecture-evolution/">
      <meta property="og:see_also" content="https://www.xiaobinqt.cn/session-cookie-token-difference/">
      <meta property="og:see_also" content="https://www.xiaobinqt.cn/mysql-faq-2/">
      <meta property="og:see_also" content="https://www.xiaobinqt.cn/why-mysql-index-use-btree/">
      <meta property="og:see_also" content="https://www.xiaobinqt.cn/redis-break-pierce-avalanche/">

  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:image" content="https://www.xiaobinqt.cn/images/avatar.webp">
  <meta name="twitter:title" content="Go GC 垃圾回收">
  <meta name="twitter:description" content="golang GC 原理,Go 垃圾回收,Go 垃圾标记清除算法,golang 三色标记法,golang 屏障机制,go 垃圾回收算法,go 插入/删除屏障,golang 混合写屏障,垃圾回收 STW,STW">
<meta name="application-name" content="DoIt">
<meta name="apple-mobile-web-app-title" content="DoIt">

<meta name="theme-color" content="#f8f8f8"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">

<link rel="canonical" href="https://www.xiaobinqt.cn/go-gc/" /><link rel="prev" href="https://www.xiaobinqt.cn/github-actions-replace-env-vars-in-file/" /><link rel="next" href="https://www.xiaobinqt.cn/redis-break-pierce-avalanche/" />
<link rel="stylesheet" href="/css/main.min.css"><link rel="stylesheet" href="/css/style.min.css"><meta name="google-site-verification" content="hFkClWMTOtPBuE0lQaXNiNb707E7P6O2CwexZoSm3VQ" /><meta name="msvalidate.01" content="A961D393878F86E04112E1198500FDBD" /><meta name="baidu-site-verification" content="code-cMh5ORsrP2" /><script type="application/ld+json">{"@context": "https://schema.org","@type": "BlogPosting",
        "headline": "Go GC 垃圾回收",
        "inLanguage": "zh-CN",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https://www.xiaobinqt.cn/go-gc/"
        },"image": ["https://cdn.xiaobinqt.cn/xiaobinqt.io/20221118/74f00ad9b278426887ea4348fd7a0e1c.png"],"genre": "posts","keywords":["golang","GC"],"wordcount":  5723 ,
        "url": "https://www.xiaobinqt.cn/go-gc/","datePublished": "2022-04-06T00:00:00+00:00","dateModified": "2023-08-22T16:08:54+08:00","license": "This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher": {
            "@type": "Organization",
            "name": "xxxx","logo": {
                    "@type": "ImageObject",
                    "url": "https://www.xiaobinqt.cn/images/avatar.webp",
                    "width":  400 ,
                    "height":  400 
                }},"author": {
                "@type": "Person",
                "name": "xiaobinqt",
                "url": "https://github.com/xiaobinqt"
            },"description": "golang GC 原理,Go 垃圾回收,Go 垃圾标记清除算法,golang 三色标记法,golang 屏障机制,go 垃圾回收算法,go 插入/删除屏障,golang 混合写屏障,垃圾回收 STW,STW"
    }</script></head>


<body data-instant-intensity="viewport" ><script type="text/javascript">
        function setTheme(theme) {
          document.body.setAttribute('theme', theme); 
          document.documentElement.className = theme;
          document.documentElement.style.setProperty('color-scheme', theme === 'light' ? 'light' : 'dark');
          if (theme === 'light') {
            document.documentElement.classList.remove('tw-dark')
          } else {
            document.documentElement.classList.add('tw-dark')
          }
          window.theme = theme;   
          window.isDark = window.theme !== 'light' 
        }
        function saveTheme(theme) {window.localStorage && localStorage.setItem('theme', theme);}
        function getMeta(metaName) {const metas = document.getElementsByTagName('meta'); for (let i = 0; i < metas.length; i++) if (metas[i].getAttribute('name') === metaName) return metas[i]; return '';}
        if (window.localStorage && localStorage.getItem('theme')) {
            let theme = localStorage.getItem('theme');
            if (theme === 'light' || theme === 'dark') {
            setTheme(theme);
            } else {
                if ((window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                    setTheme('dark');
                } else {
                    setTheme('light');
                }
            }
         } else { 
            if ('auto' === 'light' || 'auto' === 'dark') 
                setTheme('auto'), saveTheme('auto'); 
            else saveTheme('auto'), window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? setTheme('dark') : setTheme('light');
        }
        let metaColors = {'light': '#f8f8f8','dark': '#161b22'}
        getMeta('theme-color').content = metaColors[document.body.getAttribute('theme')];
        window.switchThemeEventSet = new Set()
    </script>
    <div id="back-to-top"></div>
    <div id="mask"></div><div class="wrapper"><header class="desktop print:!tw-hidden" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="xiaobinqt 博客 - 技术改变生活"><span class="tw-mr-1"><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!-- Font Awesome Free 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M402.3 344.9l32-32c5-5 13.7-1.5 13.7 5.7V464c0 26.5-21.5 48-48 48H48c-26.5 0-48-21.5-48-48V112c0-26.5 21.5-48 48-48h273.5c7.1 0 10.7 8.6 5.7 13.7l-32 32c-1.5 1.5-3.5 2.3-5.7 2.3H48v352h352V350.5c0-2.1.8-4.1 2.3-5.6zm156.6-201.8L296.3 405.7l-90.4 10c-26.2 2.9-48.5-19.2-45.6-45.6l10-90.4L432.9 17.1c22.9-22.9 59.9-22.9 82.7 0l43.2 43.2c22.9 22.9 22.9 60 .1 82.8zM460.1 174L402 115.9 216.2 301.8l-7.3 65.3 65.3-7.3L460.1 174zm64.8-79.7l-43.2-43.2c-4.1-4.1-10.8-4.1-14.8 0L436 82l58.1 58.1 30.9-30.9c4-4.2 4-10.8-.1-14.9z"/></svg></span>萧十一郎</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item"
                    href="/posts/" > 所有文章 </a><a class="menu-item"
                    href="/tags/" > 标签 </a><a class="menu-item"
                    href="/categories/" > 分类 </a><a class="menu-item"
                    href="/series/" > 系列 </a><a class="menu-item"
                    href="/showcase/" > 小册 </a><a class="menu-item"
                    href="/keeplearning" > KeepLearning </a><a class="menu-item"
                    href="/leetcode" > LeetCode </a><a class="menu-item"
                    href="/links/" > 友链 </a><a class="menu-item"
                    href="/about/" > 关于 </a><a class="menu-item"
                    href="https://github.com/xiaobinqt"  title="GitHub" 
                    rel="noopener noreferrer" target="_blank" ><i class='fab fa-github fa-fw'></i>  </a><span class="menu-item delimiter"></span><span class="menu-item search" id="search-desktop">
                    <input type="text"
                        placeholder="搜索文章标题或内容..."
                        id="search-input-desktop">
                    <button class="search-button search-toggle" id="search-toggle-desktop" title="搜索">
                        <svg class="icon"
    xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!-- Font Awesome Free 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg>
                    </button>
                    <button class="search-button search-clear" id="search-clear-desktop" title="清空">
                        <svg class="icon"
    xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!-- Font Awesome Free 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M256 8C119 8 8 119 8 256s111 248 248 248 248-111 248-248S393 8 256 8zm121.6 313.1c4.7 4.7 4.7 12.3 0 17L338 377.6c-4.7 4.7-12.3 4.7-17 0L256 312l-65.1 65.6c-4.7 4.7-12.3 4.7-17 0L134.4 338c-4.7-4.7-4.7-12.3 0-17l65.6-65-65.6-65.1c-4.7-4.7-4.7-12.3 0-17l39.6-39.6c4.7-4.7 12.3-4.7 17 0l65 65.7 65.1-65.6c4.7-4.7 12.3-4.7 17 0l39.6 39.6c4.7 4.7 4.7 12.3 0 17L312 256l65.6 65.1z"/></svg>
                    </button>
                    <span class="search-button search-loading tw-animate-spin" id="search-loading-desktop">
                        <svg class="icon"
    xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!-- Font Awesome Free 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M304 48c0 26.51-21.49 48-48 48s-48-21.49-48-48 21.49-48 48-48 48 21.49 48 48zm-48 368c-26.51 0-48 21.49-48 48s21.49 48 48 48 48-21.49 48-48-21.49-48-48-48zm208-208c-26.51 0-48 21.49-48 48s21.49 48 48 48 48-21.49 48-48-21.49-48-48-48zM96 256c0-26.51-21.49-48-48-48S0 229.49 0 256s21.49 48 48 48 48-21.49 48-48zm12.922 99.078c-26.51 0-48 21.49-48 48s21.49 48 48 48 48-21.49 48-48c0-26.509-21.491-48-48-48zm294.156 0c-26.51 0-48 21.49-48 48s21.49 48 48 48 48-21.49 48-48c0-26.509-21.49-48-48-48zM108.922 60.922c-26.51 0-48 21.49-48 48s21.49 48 48 48 48-21.49 48-48-21.491-48-48-48z"/></svg>
                    </span>
                </span><button class="menu-item theme-select" aria-label="切换主题">
                    <svg class="icon"
    xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!-- Font Awesome Free 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M8 256c0 136.966 111.033 248 248 248s248-111.034 248-248S392.966 8 256 8 8 119.033 8 256zm248 184V72c101.705 0 184 82.311 184 184 0 101.705-82.311 184-184 184z"/></svg>
                    <select class="color-theme-select" id="theme-select-desktop" aria-label="切换主题">
                        <option value="light">浅色</option>
                        <option value="dark">深色</option>
                        <option value="auto">跟随系统</option>
                    </select>
                </button></div>
        </div>
    </div>
</header><header class="mobile print:!tw-hidden" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="xiaobinqt 博客 - 技术改变生活"><span class="tw-mr-1"><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!-- Font Awesome Free 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M402.3 344.9l32-32c5-5 13.7-1.5 13.7 5.7V464c0 26.5-21.5 48-48 48H48c-26.5 0-48-21.5-48-48V112c0-26.5 21.5-48 48-48h273.5c7.1 0 10.7 8.6 5.7 13.7l-32 32c-1.5 1.5-3.5 2.3-5.7 2.3H48v352h352V350.5c0-2.1.8-4.1 2.3-5.6zm156.6-201.8L296.3 405.7l-90.4 10c-26.2 2.9-48.5-19.2-45.6-45.6l10-90.4L432.9 17.1c22.9-22.9 59.9-22.9 82.7 0l43.2 43.2c22.9 22.9 22.9 60 .1 82.8zM460.1 174L402 115.9 216.2 301.8l-7.3 65.3 65.3-7.3L460.1 174zm64.8-79.7l-43.2-43.2c-4.1-4.1-10.8-4.1-14.8 0L436 82l58.1 58.1 30.9-30.9c4-4.2 4-10.8-.1-14.9z"/></svg></span>萧十一郎</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><div class="search-wrapper">
                <div class="search mobile" id="search-mobile">
                    <input type="text"
                        placeholder="搜索文章标题或内容..."
                        id="search-input-mobile">
                    <button class="search-button search-toggle tw-h-10" id="search-toggle-mobile" title="搜索">
                        <svg class="icon"
    xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!-- Font Awesome Free 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg>
                    </button>
                    <button class="search-button search-clear" id="search-clear-mobile" title="清空">
                        <svg class="icon"
    xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!-- Font Awesome Free 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M256 8C119 8 8 119 8 256s111 248 248 248 248-111 248-248S393 8 256 8zm121.6 313.1c4.7 4.7 4.7 12.3 0 17L338 377.6c-4.7 4.7-12.3 4.7-17 0L256 312l-65.1 65.6c-4.7 4.7-12.3 4.7-17 0L134.4 338c-4.7-4.7-4.7-12.3 0-17l65.6-65-65.6-65.1c-4.7-4.7-4.7-12.3 0-17l39.6-39.6c4.7-4.7 12.3-4.7 17 0l65 65.7 65.1-65.6c4.7-4.7 12.3-4.7 17 0l39.6 39.6c4.7 4.7 4.7 12.3 0 17L312 256l65.6 65.1z"/></svg>
                    </button>
                    <span class="search-button search-loading tw-animate-spin" id="search-loading-mobile">
                        <svg class="icon"
    xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!-- Font Awesome Free 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M304 48c0 26.51-21.49 48-48 48s-48-21.49-48-48 21.49-48 48-48 48 21.49 48 48zm-48 368c-26.51 0-48 21.49-48 48s21.49 48 48 48 48-21.49 48-48-21.49-48-48-48zm208-208c-26.51 0-48 21.49-48 48s21.49 48 48 48 48-21.49 48-48-21.49-48-48-48zM96 256c0-26.51-21.49-48-48-48S0 229.49 0 256s21.49 48 48 48 48-21.49 48-48zm12.922 99.078c-26.51 0-48 21.49-48 48s21.49 48 48 48 48-21.49 48-48c0-26.509-21.491-48-48-48zm294.156 0c-26.51 0-48 21.49-48 48s21.49 48 48 48 48-21.49 48-48c0-26.509-21.49-48-48-48zM108.922 60.922c-26.51 0-48 21.49-48 48s21.49 48 48 48 48-21.49 48-48-21.491-48-48-48z"/></svg>
                    </span>
                </div>
                <button class="search-cancel" id="search-cancel-mobile">
                    取消
                </button>
            </div><a class="menu-item" href="/posts/" title="" >所有文章</a><a class="menu-item" href="/tags/" title="" >标签</a><a class="menu-item" href="/categories/" title="" >分类</a><a class="menu-item" href="/series/" title="" >系列</a><a class="menu-item" href="/showcase/" title="" >小册</a><a class="menu-item" href="/keeplearning" title="" >KeepLearning</a><a class="menu-item" href="/leetcode" title="" >LeetCode</a><a class="menu-item" href="/links/" title="" >友链</a><a class="menu-item" href="/about/" title="" >关于</a><a class="menu-item" href="https://github.com/xiaobinqt" title="GitHub" 
                rel="noopener noreferrer" target="_blank" ><i class='fab fa-github fa-fw'></i></a><button class="menu-item theme-select tw-w-full" aria-label="切换主题">
                <svg class="icon"
    xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!-- Font Awesome Free 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M8 256c0 136.966 111.033 248 248 248s248-111.034 248-248S392.966 8 256 8 8 119.033 8 256zm248 184V72c101.705 0 184 82.311 184 184 0 101.705-82.311 184-184 184z"/></svg>
                <select class="color-theme-select" id="theme-select-mobile" aria-label="切换主题">
                    <option value="light">浅色</option>
                    <option value="dark">深色</option>
                    <option value="auto">跟随系统</option>
                </select>
            </button></div>
    </div>
</header>
<div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
</div>
<div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
</div><main class="main">
            <div class="container"><div class="toc print:!tw-hidden" id="toc-auto">
        <h2 class="toc-title">目录</h2>
        <div class="toc-content" id="toc-content-auto"><nav id="TableOfContents">
  <ul>
    <li><a href="#gc-变革">GC 变革</a></li>
    <li><a href="#堆和栈">堆和栈</a></li>
    <li><a href="#标记清除算法">标记清除算法</a>
      <ul>
        <li><a href="#第一步">第一步</a></li>
        <li><a href="#第二步">第二步</a></li>
        <li><a href="#第三步">第三步</a></li>
        <li><a href="#第四步">第四步</a></li>
        <li><a href="#缺点与优化">缺点与优化</a></li>
      </ul>
    </li>
    <li><a href="#有stw的三色标记法">有STW的三色标记法</a>
      <ul>
        <li><a href="#第一步-1">第一步</a></li>
        <li><a href="#第二步-1">第二步</a></li>
        <li><a href="#第三步-1">第三步</a></li>
        <li><a href="#第四步-1">第四步</a></li>
        <li><a href="#第五步">第五步</a></li>
      </ul>
    </li>
    <li><a href="#没有stw的三色标记法">没有STW的三色标记法</a></li>
    <li><a href="#屏障机制">屏障机制</a>
      <ul>
        <li><a href="#强三色不变式">强三色不变式</a></li>
        <li><a href="#弱三色不变式">弱三色不变式</a></li>
        <li><a href="#插入屏障">插入屏障</a></li>
        <li><a href="#删除屏障">删除屏障</a></li>
      </ul>
    </li>
    <li><a href="#混合写屏障">混合写屏障</a>
      <ul>
        <li><a href="#规则">规则</a></li>
        <li><a href="#具体场景">具体场景</a>
          <ul>
            <li><a href="#场景一">场景一</a></li>
            <li><a href="#场景二">场景二</a></li>
            <li><a href="#场景三">场景三</a></li>
            <li><a href="#场景四">场景四</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#总结">总结</a></li>
    <li><a href="#参考">参考</a></li>
  </ul>
</nav></div>
    </div><script>document.getElementsByTagName("main")[0].setAttribute("autoTOC", "true")</script><article class="page single print:!tw-w-full print:!tw-max-w-none print:!tw-m-0 print:!tw-p-0"><h1 class="single-title" data-pagefind-meta="date:2022-04-06" data-pagefind-body>Go GC 垃圾回收</h1><div class="post-meta">
            <div class="post-meta-line">
                <span class="post-author"><img class="tw-inline-block tw-max-h-4 tw-rounded-full tw-translate-y-[-2px] tw-mr-1"  src=/images/avatar.webp srcset="/images/avatar_hu11269060449570882715.webp 16w, /images/avatar_hu2515534640531409486.webp 24w, /images/avatar_hu9855092516384270799.webp 32w"  alt="xiaobinqt avatar" height="16" width="16"><a href="https://github.com/xiaobinqt" title="Author" target="_blank" rel="noopener noreferrer author" class="author">xiaobinqt</a>
                </span>&nbsp;<span class="post-category">收录于 </span>&nbsp;<span class="post-category">类别 <a href="/categories/golang/"><svg class="icon"
    xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!-- Font Awesome Free 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M464 128H272l-54.63-54.63c-6-6-14.14-9.37-22.63-9.37H48C21.49 64 0 85.49 0 112v288c0 26.51 21.49 48 48 48h416c26.51 0 48-21.49 48-48V176c0-26.51-21.49-48-48-48zm0 272H48V112h140.12l54.63 54.63c6 6 14.14 9.37 22.63 9.37H464v224z"/></svg>Golang</a></span>&nbsp;<span class="post-category">和</span>&nbsp;<span class="post-series">系列 <a href="/series/reproduce/"><svg class="icon"
    xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!-- Font Awesome Free 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M464 32H48C21.49 32 0 53.49 0 80v352c0 26.51 21.49 48 48 48h416c26.51 0 48-21.49 48-48V80c0-26.51-21.49-48-48-48zm-6 400H54a6 6 0 0 1-6-6V86a6 6 0 0 1 6-6h404a6 6 0 0 1 6 6v340a6 6 0 0 1-6 6zm-42-92v24c0 6.627-5.373 12-12 12H204c-6.627 0-12-5.373-12-12v-24c0-6.627 5.373-12 12-12h200c6.627 0 12 5.373 12 12zm0-96v24c0 6.627-5.373 12-12 12H204c-6.627 0-12-5.373-12-12v-24c0-6.627 5.373-12 12-12h200c6.627 0 12 5.373 12 12zm0-96v24c0 6.627-5.373 12-12 12H204c-6.627 0-12-5.373-12-12v-24c0-6.627 5.373-12 12-12h200c6.627 0 12 5.373 12 12zm-252 12c0 19.882-16.118 36-36 36s-36-16.118-36-36 16.118-36 36-36 36 16.118 36 36zm0 96c0 19.882-16.118 36-36 36s-36-16.118-36-36 16.118-36 36-36 36 16.118 36 36zm0 96c0 19.882-16.118 36-36 36s-36-16.118-36-36 16.118-36 36-36 36 16.118 36 36z"/></svg>转载</a></span></div>
            <div class="post-meta-line"><svg class="icon"
    xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!-- Font Awesome Free 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M148 288h-40c-6.6 0-12-5.4-12-12v-40c0-6.6 5.4-12 12-12h40c6.6 0 12 5.4 12 12v40c0 6.6-5.4 12-12 12zm108-12v-40c0-6.6-5.4-12-12-12h-40c-6.6 0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6 0 12-5.4 12-12zm96 0v-40c0-6.6-5.4-12-12-12h-40c-6.6 0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6 0 12-5.4 12-12zm-96 96v-40c0-6.6-5.4-12-12-12h-40c-6.6 0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6 0 12-5.4 12-12zm-96 0v-40c0-6.6-5.4-12-12-12h-40c-6.6 0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6 0 12-5.4 12-12zm192 0v-40c0-6.6-5.4-12-12-12h-40c-6.6 0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6 0 12-5.4 12-12zm96-260v352c0 26.5-21.5 48-48 48H48c-26.5 0-48-21.5-48-48V112c0-26.5 21.5-48 48-48h48V12c0-6.6 5.4-12 12-12h40c6.6 0 12 5.4 12 12v52h128V12c0-6.6 5.4-12 12-12h40c6.6 0 12 5.4 12 12v52h48c26.5 0 48 21.5 48 48zm-48 346V160H48v298c0 3.3 2.7 6 6 6h340c3.3 0 6-2.7 6-6z"/></svg>&nbsp;<time datetime="2022-04-06">2022-04-06</time>&nbsp;<svg class="icon"
    xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!-- Font Awesome Free 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M402.3 344.9l32-32c5-5 13.7-1.5 13.7 5.7V464c0 26.5-21.5 48-48 48H48c-26.5 0-48-21.5-48-48V112c0-26.5 21.5-48 48-48h273.5c7.1 0 10.7 8.6 5.7 13.7l-32 32c-1.5 1.5-3.5 2.3-5.7 2.3H48v352h352V350.5c0-2.1.8-4.1 2.3-5.6zm156.6-201.8L296.3 405.7l-90.4 10c-26.2 2.9-48.5-19.2-45.6-45.6l10-90.4L432.9 17.1c22.9-22.9 59.9-22.9 82.7 0l43.2 43.2c22.9 22.9 22.9 60 .1 82.8zM460.1 174L402 115.9 216.2 301.8l-7.3 65.3 65.3-7.3L460.1 174zm64.8-79.7l-43.2-43.2c-4.1-4.1-10.8-4.1-14.8 0L436 82l58.1 58.1 30.9-30.9c4-4.2 4-10.8-.1-14.9z"/></svg>&nbsp;<time datetime="2023-08-22">2023-08-22</time>&nbsp;<svg class="icon"
    xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!-- Font Awesome Free 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M497.9 142.1l-46.1 46.1c-4.7 4.7-12.3 4.7-17 0l-111-111c-4.7-4.7-4.7-12.3 0-17l46.1-46.1c18.7-18.7 49.1-18.7 67.9 0l60.1 60.1c18.8 18.7 18.8 49.1 0 67.9zM284.2 99.8L21.6 362.4.4 483.9c-2.9 16.4 11.4 30.6 27.8 27.8l121.5-21.3 262.6-262.6c4.7-4.7 4.7-12.3 0-17l-111-111c-4.8-4.7-12.4-4.7-17.1 0zM124.1 339.9c-5.5-5.5-5.5-14.3 0-19.8l154-154c5.5-5.5 14.3-5.5 19.8 0s5.5 14.3 0 19.8l-154 154c-5.5 5.5-14.3 5.5-19.8 0zM88 424h48v36.3l-64.5 11.3-31.1-31.1L51.7 376H88v48z"/></svg>&nbsp;约 5723 字&nbsp;
                    <svg class="icon"
    xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!-- Font Awesome Free 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M256 8C119 8 8 119 8 256s111 248 248 248 248-111 248-248S393 8 256 8zm0 448c-110.5 0-200-89.5-200-200S145.5 56 256 56s200 89.5 200 200-89.5 200-200 200zm61.8-104.4l-84.9-61.7c-3.1-2.3-4.9-5.9-4.9-9.7V116c0-6.6 5.4-12 12-12h32c6.6 0 12 5.4 12 12v141.7l66.8 48.6c5.4 3.9 6.5 11.4 2.6 16.8L334.6 349c-3.9 5.3-11.4 6.5-16.8 2.6z"/></svg>&nbsp;预计阅读 26 分钟&nbsp;</div>
        </div><div class="featured-image"><img  loading="eager" src=/74f00ad9b278426887ea4348fd7a0e1c_17431324096020860984.png srcset="/74f00ad9b278426887ea4348fd7a0e1c_17431324096020860984_hu16375063031802521862.webp 800w, /74f00ad9b278426887ea4348fd7a0e1c_17431324096020860984_hu5497266000018434777.webp 1200w, /74f00ad9b278426887ea4348fd7a0e1c_17431324096020860984_hu1233474415233265452.webp 1600w"  alt="golang GC 原理,Go 垃圾回收,Go 垃圾标记清除算法,golang 三色标记法,golang 屏障机制,go 垃圾回收算法,go 插入/删除屏障,golang 混合写屏障,垃圾回收 STW,STW" height="1022" width="2600"></div><div class="details toc print:!tw-block" id="toc-static"  kept="">
                <div class="details-summary toc-title">
                    <span>目录</span>
                    <span class="details-icon"><svg class="icon"
    xmlns="http://www.w3.org/2000/svg" viewBox="0 0 256 512"><!-- Font Awesome Free 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M224.3 273l-136 136c-9.4 9.4-24.6 9.4-33.9 0l-22.6-22.6c-9.4-9.4-9.4-24.6 0-33.9l96.4-96.4-96.4-96.4c-9.4-9.4-9.4-24.6 0-33.9L54.3 103c9.4-9.4 24.6-9.4 33.9 0l136 136c9.5 9.4 9.5 24.6.1 34z"/></svg></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#gc-变革">GC 变革</a></li>
    <li><a href="#堆和栈">堆和栈</a></li>
    <li><a href="#标记清除算法">标记清除算法</a>
      <ul>
        <li><a href="#第一步">第一步</a></li>
        <li><a href="#第二步">第二步</a></li>
        <li><a href="#第三步">第三步</a></li>
        <li><a href="#第四步">第四步</a></li>
        <li><a href="#缺点与优化">缺点与优化</a></li>
      </ul>
    </li>
    <li><a href="#有stw的三色标记法">有STW的三色标记法</a>
      <ul>
        <li><a href="#第一步-1">第一步</a></li>
        <li><a href="#第二步-1">第二步</a></li>
        <li><a href="#第三步-1">第三步</a></li>
        <li><a href="#第四步-1">第四步</a></li>
        <li><a href="#第五步">第五步</a></li>
      </ul>
    </li>
    <li><a href="#没有stw的三色标记法">没有STW的三色标记法</a></li>
    <li><a href="#屏障机制">屏障机制</a>
      <ul>
        <li><a href="#强三色不变式">强三色不变式</a></li>
        <li><a href="#弱三色不变式">弱三色不变式</a></li>
        <li><a href="#插入屏障">插入屏障</a></li>
        <li><a href="#删除屏障">删除屏障</a></li>
      </ul>
    </li>
    <li><a href="#混合写屏障">混合写屏障</a>
      <ul>
        <li><a href="#规则">规则</a></li>
        <li><a href="#具体场景">具体场景</a>
          <ul>
            <li><a href="#场景一">场景一</a></li>
            <li><a href="#场景二">场景二</a></li>
            <li><a href="#场景三">场景三</a></li>
            <li><a href="#场景四">场景四</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#总结">总结</a></li>
    <li><a href="#参考">参考</a></li>
  </ul>
</nav></div>
            </div><div class="content" id="content" data-pagefind-body><p>垃圾回收（Garbage Collection，GC）是编程语言中提供的自动的内存管理机制，自动释放不需要的内存对象，让出存储器资源。GC 过程中无需程序员手动执行。</p>
<p>GC 机制在现代很多编程语言都支持，GC 能力的性能与优劣也是不同语言之间对比度指标之一。</p>
<h2 id="gc-变革" class="headerLink">
    <a href="#gc-%e5%8f%98%e9%9d%a9" class="header-mark"></a>1 GC 变革</h2><p>// TODO</p>
<h2 id="堆和栈" class="headerLink">
    <a href="#%e5%a0%86%e5%92%8c%e6%a0%88" class="header-mark"></a>2 堆和栈</h2><p><strong>栈</strong>：由操作系统自动分配释放，存放函数的参数值，局部变量的值等。</p>
<p><strong>堆</strong>：一般由程序员分配和释放，若程序员不释放，程序结束时可能由 OS 回收。</p>
<p>栈使用的是一级缓存，他们通常都是被调用时处于存储空间中，<strong>调用完毕立即释放</strong>。</p>
<p>堆则是存放在二级缓存中，生命周期由虚拟机的垃圾回收算法来决定，但并不是一旦成为孤儿对象就能被回收。</p>
<p>申请到栈内存好处：函数返回直接释放，不会引起垃圾回收，对性能没有影响。</p>
<h2 id="标记清除算法" class="headerLink">
    <a href="#%e6%a0%87%e8%ae%b0%e6%b8%85%e9%99%a4%e7%ae%97%e6%b3%95" class="header-mark"></a>3 标记清除算法</h2><p>Go V1.3 之前使用普通的<strong><ruby>标记-清除<rt>mark and sweep</rt></ruby></strong>算法，主要有两个主要的步骤：</p>
<ol>
<li>
<p>标记(Mark phase)，找出<strong>不可达</strong>的对象，然后做上标记。</p>
</li>
<li>
<p>清除(Sweep phase)，回收标记好的对象。</p>
</li>
</ol>
<h3 id="第一步" class="headerLink">
    <a href="#%e7%ac%ac%e4%b8%80%e6%ad%a5" class="header-mark"></a>3.1 第一步</h3><p><strong>暂停</strong>程序业务逻辑， 分类出可达和不可达的对象，然后做上标记。</p>
<figure><a class="lightgallery" href="/692b1bd1669647518c96b6530c01b8a3_845497515746686991.png" title="" data-thumbnail="/692b1bd1669647518c96b6530c01b8a3_845497515746686991.png" data-sub-html="<h2>程序与对象的可达关系</h2>"><img  loading="lazy" src=/692b1bd1669647518c96b6530c01b8a3_845497515746686991.png srcset="/692b1bd1669647518c96b6530c01b8a3_845497515746686991_hu17564895700780102144.webp 800w, /692b1bd1669647518c96b6530c01b8a3_845497515746686991_hu9586206536808878657.webp 1200w, /692b1bd1669647518c96b6530c01b8a3_845497515746686991_hu16085575391988641766.webp 1600w"   height="703" width="500"></a><figcaption class="image-caption">程序与对象的可达关系</figcaption>
    </figure>
<p>&#x1f446;图中表示是程序与对象的可达关系，目前<strong>程序的可达</strong>对象有对象 1-2-3，对象 4-7 等五个对象。</p>
<h3 id="第二步" class="headerLink">
    <a href="#%e7%ac%ac%e4%ba%8c%e6%ad%a5" class="header-mark"></a>3.2 第二步</h3><p>开始标记，程序找出它所有可达的对象，并做上标记&#x1f447;。</p>
<figure><a class="lightgallery" href="/00d8aba1d229497c9cc907b359010178_2935157719862979257.png" title="" data-thumbnail="/00d8aba1d229497c9cc907b359010178_2935157719862979257.png" data-sub-html="<h2>找出可达对象</h2>"><img  loading="lazy" src=/00d8aba1d229497c9cc907b359010178_2935157719862979257.png srcset="/00d8aba1d229497c9cc907b359010178_2935157719862979257_hu18218661371565719864.webp 800w, /00d8aba1d229497c9cc907b359010178_2935157719862979257_hu11729003062154722575.webp 1200w, /00d8aba1d229497c9cc907b359010178_2935157719862979257_hu5355505222887226600.webp 1600w"   height="738" width="500"></a><figcaption class="image-caption">找出可达对象</figcaption>
    </figure>
<p>对象 1-2-3 、对象 4-7 等五个对象被做上标记。</p>
<h3 id="第三步" class="headerLink">
    <a href="#%e7%ac%ac%e4%b8%89%e6%ad%a5" class="header-mark"></a>3.3 第三步</h3><p>标记完了之后，然后开始清除未标记的对象。</p>
<figure><a class="lightgallery" href="/1a1ebfbd5c9b4f4183cb5bca704311e5_6904404418183619573.png" title="" data-thumbnail="/1a1ebfbd5c9b4f4183cb5bca704311e5_6904404418183619573.png" data-sub-html="<h2>清除对象</h2>"><img  loading="lazy" src=/1a1ebfbd5c9b4f4183cb5bca704311e5_6904404418183619573.png srcset="/1a1ebfbd5c9b4f4183cb5bca704311e5_6904404418183619573_hu12092192178232592699.webp 800w, /1a1ebfbd5c9b4f4183cb5bca704311e5_6904404418183619573_hu10400209857329804555.webp 1200w, /1a1ebfbd5c9b4f4183cb5bca704311e5_6904404418183619573_hu380499335159671552.webp 1600w"   height="655" width="400"></a><figcaption class="image-caption">清除对象</figcaption>
    </figure>
<p>对象 5，6 不可达，被 GC 清除。</p>
<p>操作简单，但是 mark and sweep 算法在执行的时候，需要程序暂停！即 <strong><ruby>STW<rt>stop the world</rt></ruby></strong>，STW 的过程中，CPU 不执行用户代码，全部用于垃圾回收，这个过程的影响很大，所以 STW 也是一些回收机制最大的难题和希望优化的点。</p>
<p><strong>在执行第三步的这段时间，程序会暂定停止任何工作，卡在那等待回收执行完毕</strong>。</p>
<h3 id="第四步" class="headerLink">
    <a href="#%e7%ac%ac%e5%9b%9b%e6%ad%a5" class="header-mark"></a>3.4 第四步</h3><p>停止暂停，让程序继续执行。然后循环重复这个过程，直到 process 程序生命周期结束。</p>
<h3 id="缺点与优化" class="headerLink">
    <a href="#%e7%bc%ba%e7%82%b9%e4%b8%8e%e4%bc%98%e5%8c%96" class="header-mark"></a>3.5 缺点与优化</h3><p>标记清除算法明了，过程鲜明干脆，但是也有非常严重的问题，就是 STW，让程序暂停，程序出现卡顿。</p>
<p>Go V1.3 版本之前就是用这种方式来实施的。执行 GC 的基本流程就是首先启动 STW 暂停，然后执行标记，再执行数据回收，最后停止 STW ，如下图&#x1f447;</p>
<p><figure><a class="lightgallery" href="/7913f2957c4f4b5c9ba01013cb0c44fa_8137592186864401752.png" title="STW" data-thumbnail="/7913f2957c4f4b5c9ba01013cb0c44fa_8137592186864401752.png" data-sub-html="<h2>STW</h2><p>STW</p>"><img  loading="lazy" src=/7913f2957c4f4b5c9ba01013cb0c44fa_8137592186864401752.png srcset="/7913f2957c4f4b5c9ba01013cb0c44fa_8137592186864401752_hu4749059294999115868.webp 800w, /7913f2957c4f4b5c9ba01013cb0c44fa_8137592186864401752_hu10441397799289403684.webp 1200w, /7913f2957c4f4b5c9ba01013cb0c44fa_8137592186864401752_hu11987126287660508276.webp 1600w"  alt="STW" height="578" width="2426"></a><figcaption class="image-caption">STW</figcaption>
</figure></p>
<p>从&#x1f446;来看，全部的 GC 时间都是包裹在 STW 范围之内的，这样貌似程序暂停的时间过长，影响程序的运行性能。所以Go V1.3 做了简单的优化，将 STW 的步骤提前，减少 STW 暂停的时间范围
&#x1f447;</p>
<p><figure><a class="lightgallery" href="/2b64ccd849624544ae495ed36236a780_1851066313146913629.png" title="STW优化" data-thumbnail="/2b64ccd849624544ae495ed36236a780_1851066313146913629.png" data-sub-html="<h2>STW优化</h2><p>STW优化</p>"><img  loading="lazy" src=/2b64ccd849624544ae495ed36236a780_1851066313146913629.png srcset="/2b64ccd849624544ae495ed36236a780_1851066313146913629_hu238751256129384582.webp 800w, /2b64ccd849624544ae495ed36236a780_1851066313146913629_hu12781165967613634588.webp 1200w, /2b64ccd849624544ae495ed36236a780_1851066313146913629_hu14341172004977216465.webp 1600w"  alt="STW优化" height="520" width="2410"></a><figcaption class="image-caption">STW优化</figcaption>
</figure></p>
<p>主要是将 STW 的步骤提前了一步，因为在 Sweep 清除的时候，可以不需要 STW 停止，因为这些对象已经是不可达对象了，不会出现回收写冲突等问题，<strong>清除操作和用户逻辑可以并发</strong>。</p>
<p>但是无论怎么优化，Go v1.3 都面临这个一个重要问题，就是 mark-and-sweep 算法会暂停整个程序 。</p>
<h2 id="有stw的三色标记法" class="headerLink">
    <a href="#%e6%9c%89stw%e7%9a%84%e4%b8%89%e8%89%b2%e6%a0%87%e8%ae%b0%e6%b3%95" class="header-mark"></a>4 有STW的三色标记法</h2><p>Go 中的垃圾回收主要应用三色标记法，GC 过程和其他用户 goroutine 可并发运行，但需要一定时间的 STW。</p>
<p>所谓三色标记法实际上就是通过<strong>三个阶段的标记</strong>来确定需要清除的对象有哪些。</p>
<h3 id="第一步-1" class="headerLink">
    <a href="#%e7%ac%ac%e4%b8%80%e6%ad%a5-1" class="header-mark"></a>4.1 第一步</h3><p>每次新创建的对象，默认的颜色都是标记为 “白色”&#x1f447;</p>
<figure><a class="lightgallery" href="/3b601d5fc23247b4b05de52b7fb2ed52_10126363811062274678.png" title="" data-thumbnail="/3b601d5fc23247b4b05de52b7fb2ed52_10126363811062274678.png" data-sub-html="<h2>白色对象</h2>"><img  loading="lazy" src=/3b601d5fc23247b4b05de52b7fb2ed52_10126363811062274678.png srcset="/3b601d5fc23247b4b05de52b7fb2ed52_10126363811062274678_hu13747526602908164432.webp 800w, /3b601d5fc23247b4b05de52b7fb2ed52_10126363811062274678_hu256066861008065153.webp 1200w, /3b601d5fc23247b4b05de52b7fb2ed52_10126363811062274678_hu14649437213941857344.webp 1600w"   height="1364" width="800"></a><figcaption class="image-caption">白色对象</figcaption>
    </figure>
<p>上图所示，我们的程序可抵达的内存对象关系如左图所示，右边的标记表是用来记录目前每个对象的标记颜色分类。这里所谓 “程序”，是一些<strong>对象的根节点集合</strong>。如果我们将 “程序” 展开，会得到类似如下的表现形式：</p>
<figure><a class="lightgallery" href="/25f6f7613a894569a426c70c6c8c2c10_16870257812466560858.png" title="" data-thumbnail="/25f6f7613a894569a426c70c6c8c2c10_16870257812466560858.png" data-sub-html="<h2>程序的根节点集合展开</h2>"><img  loading="lazy" src=/25f6f7613a894569a426c70c6c8c2c10_16870257812466560858.png srcset="/25f6f7613a894569a426c70c6c8c2c10_16870257812466560858_hu8104803047646989044.webp 800w, /25f6f7613a894569a426c70c6c8c2c10_16870257812466560858_hu14761369902522569884.webp 1200w, /25f6f7613a894569a426c70c6c8c2c10_16870257812466560858_hu5878775683025178253.webp 1600w"   height="778" width="800"></a><figcaption class="image-caption">程序的根节点集合展开</figcaption>
    </figure>
<h3 id="第二步-1" class="headerLink">
    <a href="#%e7%ac%ac%e4%ba%8c%e6%ad%a5-1" class="header-mark"></a>4.2 第二步</h3><p>每次 GC 回收开始， 会从根节点开始遍历所有对象，把遍历到的对象从白色集合放入 “灰色” 集合：</p>
<p><figure><a class="lightgallery" href="/c982dc0455cf437bace1b65454597995_13470720170891976999.png" title="遍历根对象" data-thumbnail="/c982dc0455cf437bace1b65454597995_13470720170891976999.png" data-sub-html="<h2>遍历根对象</h2><p>遍历根对象</p>"><img  loading="lazy" src=/c982dc0455cf437bace1b65454597995_13470720170891976999.png srcset="/c982dc0455cf437bace1b65454597995_13470720170891976999_hu11501552277342140149.webp 800w, /c982dc0455cf437bace1b65454597995_13470720170891976999_hu12953534151023912438.webp 1200w, /c982dc0455cf437bace1b65454597995_13470720170891976999_hu10541530836115690177.webp 1600w"  alt="遍历根对象" height="777" width="1460"></a><figcaption class="image-caption">遍历根对象</figcaption>
</figure></p>
<p>本次遍历是<strong>一次遍历，非递归形式</strong>，是从程序初次可抵达的对象遍历一层，如上图所示，当前可抵达的对象是对象1和对象4，那么自然本轮遍历结束，对象1和对象4就会被标记为灰色，灰色标记表就会多出这两个对象。</p>
<h3 id="第三步-1" class="headerLink">
    <a href="#%e7%ac%ac%e4%b8%89%e6%ad%a5-1" class="header-mark"></a>4.3 第三步</h3><p>遍历灰色集合，将灰色对象引用的对象从白色集合放入灰色集合，之后将此灰色对象放入黑色集合：</p>
<p><figure><a class="lightgallery" href="/f381a66d7e4944c998f7c893629accd4_849146443397397832.png" title="遍历_2" data-thumbnail="/f381a66d7e4944c998f7c893629accd4_849146443397397832.png" data-sub-html="<h2>遍历_2</h2><p>遍历_2</p>"><img  loading="lazy" src=/f381a66d7e4944c998f7c893629accd4_849146443397397832.png srcset="/f381a66d7e4944c998f7c893629accd4_849146443397397832_hu1088423468040198641.webp 800w, /f381a66d7e4944c998f7c893629accd4_849146443397397832_hu10634757694228943105.webp 1200w, /f381a66d7e4944c998f7c893629accd4_849146443397397832_hu17743616880146039028.webp 1600w"  alt="遍历_2" height="765" width="1434"></a><figcaption class="image-caption">遍历_2</figcaption>
</figure></p>
<p>这一次遍历是<strong>只扫描灰色对象</strong>，将灰色对象的第一层遍历可抵达的对象由白色变为灰色，如：对象2、对象7。 而之前的灰色对象1 和对象4 则会被标记为黑色，同时由灰色标记表移动到黑色标记表中。</p>
<h3 id="第四步-1" class="headerLink">
    <a href="#%e7%ac%ac%e5%9b%9b%e6%ad%a5-1" class="header-mark"></a>4.4 第四步</h3><p>重复第三步， 直到灰色中无任何对象，如图&#x1f447;所示：</p>
<p><figure><a class="lightgallery" href="/3a751806772e445d813bee6344ab81d1_17323629882913885729.png" title="遍历_3" data-thumbnail="/3a751806772e445d813bee6344ab81d1_17323629882913885729.png" data-sub-html="<h2>遍历_3</h2><p>遍历_3</p>"><img  loading="lazy" src=/3a751806772e445d813bee6344ab81d1_17323629882913885729.png srcset="/3a751806772e445d813bee6344ab81d1_17323629882913885729_hu16871244097397328204.webp 800w, /3a751806772e445d813bee6344ab81d1_17323629882913885729_hu16067634987053294948.webp 1200w, /3a751806772e445d813bee6344ab81d1_17323629882913885729_hu12218610536954979601.webp 1600w"  alt="遍历_3" height="771" width="1453"></a><figcaption class="image-caption">遍历_3</figcaption>
</figure></p>
<p><figure><a class="lightgallery" href="/07f715dda56a4b6ab242367ce0e15e4b_14895630810853773192.png" title="遍历_4" data-thumbnail="/07f715dda56a4b6ab242367ce0e15e4b_14895630810853773192.png" data-sub-html="<h2>遍历_4</h2><p>遍历_4</p>"><img  loading="lazy" src=/07f715dda56a4b6ab242367ce0e15e4b_14895630810853773192.png srcset="/07f715dda56a4b6ab242367ce0e15e4b_14895630810853773192_hu16315852491569486794.webp 800w, /07f715dda56a4b6ab242367ce0e15e4b_14895630810853773192_hu15809343822183595529.webp 1200w, /07f715dda56a4b6ab242367ce0e15e4b_14895630810853773192_hu7178926813818137895.webp 1600w"  alt="遍历_4" height="772" width="1382"></a><figcaption class="image-caption">遍历_4</figcaption>
</figure></p>
<p>当我们全部的可达对象都遍历完后，<strong>灰色标记表将不再存在灰色对象</strong>。</p>
<p>目前全部内存的数据只有两种颜色，黑色和白色。那么，黑色对象就是我们程序逻辑可达（需要的）对象，这些数据是目前支撑程序正常业务运行的，是合法的有用数据，不可删除。白色的对象是全部不可达对象，目前程序逻辑并不依赖他们，那么白色对象就是内存中目前的垃圾数据，需要被清除。</p>
<h3 id="第五步" class="headerLink">
    <a href="#%e7%ac%ac%e4%ba%94%e6%ad%a5" class="header-mark"></a>4.5 第五步</h3><p>回收所有的白色标记表的对象，也就是回收垃圾，如图所示&#x1f447;</p>
<p><figure><a class="lightgallery" href="/f271ee96ace2416c8eaf808d3f45b8f0_10750576469152835104.png" title="GC 回收" data-thumbnail="/f271ee96ace2416c8eaf808d3f45b8f0_10750576469152835104.png" data-sub-html="<h2>GC 回收</h2><p>GC 回收</p>"><img  loading="lazy" src=/f271ee96ace2416c8eaf808d3f45b8f0_10750576469152835104.png srcset="/f271ee96ace2416c8eaf808d3f45b8f0_10750576469152835104_hu5186358603257365377.webp 800w, /f271ee96ace2416c8eaf808d3f45b8f0_10750576469152835104_hu4975168936616656976.webp 1200w, /f271ee96ace2416c8eaf808d3f45b8f0_10750576469152835104_hu9823316821237657893.webp 1600w"  alt="GC 回收" height="784" width="1470"></a><figcaption class="image-caption">GC 回收</figcaption>
</figure></p>
<p>将全部的白色对象进行删除回收，剩下的就是全部依赖的黑色对象。</p>
<p>这里面可能会有很多并发流程均会被扫描，执行并发流程的内存可能相互依赖，为了在 GC 过程中保证数据的安全，<strong>在开始三色标记之前就会加上 STW，在扫描确定黑白对象之后再放开 STW</strong>。但是很明显这样的 GC 扫描的性能实在是太低了。</p>
<p>所以现在的三色标记法还是会 STW。</p>
<h2 id="没有stw的三色标记法" class="headerLink">
    <a href="#%e6%b2%a1%e6%9c%89stw%e7%9a%84%e4%b8%89%e8%89%b2%e6%a0%87%e8%ae%b0%e6%b3%95" class="header-mark"></a>5 没有STW的三色标记法</h2><p>如果没有 STW，那么也就不会再存在性能上的问题，那么假设如果三色标记法不加入 STW 会发生什么事情&#x2753;</p>
<p>还是基于上述的三色标记法来分析，他是一定要依赖 STW 的，因为如果不暂停程序，程序的逻辑可能会改变对象的引用关系，这种动作如果在标记阶段做了修改，会影响标记结果的正确性。</p>
<p>来看看一个场景，如果三色标记法，标记过程不使用 STW 将会发生什么事情&#x2753;</p>
<p>我们把初始状态设置为已经经历了第一轮扫描，目前黑色的有对象 1 和对象 4，灰色的有对象 2 和对象 7，其他的为白色对象，且对象 2 是通过指针 p 指向对象 3 的，如下图所示。</p>
<p><figure><a class="lightgallery" href="/df4917c4b48d4e12857a5b8552cf3815_13981813290642962041.png" title="no ST2 01" data-thumbnail="/df4917c4b48d4e12857a5b8552cf3815_13981813290642962041.png" data-sub-html="<h2>no ST2 01</h2><p>no ST2 01</p>"><img  loading="lazy" src=/df4917c4b48d4e12857a5b8552cf3815_13981813290642962041.png srcset="/df4917c4b48d4e12857a5b8552cf3815_13981813290642962041_hu7573407269244960316.webp 800w, /df4917c4b48d4e12857a5b8552cf3815_13981813290642962041_hu2873296577446688296.webp 1200w, /df4917c4b48d4e12857a5b8552cf3815_13981813290642962041_hu10772258373592958692.webp 1600w"  alt="no ST2 01" height="1080" width="1920"></a><figcaption class="image-caption">no ST2 01</figcaption>
</figure></p>
<p>现在如果三色标记过程不启动 STW，那么在 GC 扫描过程中，<strong>任意的对象均可能发生读写操作</strong>
，如下图所示，在还没有扫描到对象 2 的时候，已经标记为黑色的对象 4，此时创建指针 q，并且指向白色的对象 3。</p>
<p><figure><a class="lightgallery" href="/c47b38d901dc46efb2ddc7b3d01fede4_6357839815987300361.png" title="no ST2 02" data-thumbnail="/c47b38d901dc46efb2ddc7b3d01fede4_6357839815987300361.png" data-sub-html="<h2>no ST2 02</h2><p>no ST2 02</p>"><img  loading="lazy" src=/c47b38d901dc46efb2ddc7b3d01fede4_6357839815987300361.png srcset="/c47b38d901dc46efb2ddc7b3d01fede4_6357839815987300361_hu841276295351661684.webp 800w, /c47b38d901dc46efb2ddc7b3d01fede4_6357839815987300361_hu17246522220632540274.webp 1200w, /c47b38d901dc46efb2ddc7b3d01fede4_6357839815987300361_hu7566047209744068655.webp 1600w"  alt="no ST2 02" height="1080" width="1920"></a><figcaption class="image-caption">no ST2 02</figcaption>
</figure></p>
<p>与此同时灰色的对象 2 将指针 p 移除，那么白色的对象 3 实则是被挂在了已经扫描完成的黑色的对象 4 下，如下图所示。</p>
<p><figure><a class="lightgallery" href="/da651f3e078847ad8ba6ca0635301978_12317248830051133648.png" title="no ST2 03" data-thumbnail="/da651f3e078847ad8ba6ca0635301978_12317248830051133648.png" data-sub-html="<h2>no ST2 03</h2><p>no ST2 03</p>"><img  loading="lazy" src=/da651f3e078847ad8ba6ca0635301978_12317248830051133648.png srcset="/da651f3e078847ad8ba6ca0635301978_12317248830051133648_hu614602345245278306.webp 800w, /da651f3e078847ad8ba6ca0635301978_12317248830051133648_hu7234073215422085799.webp 1200w, /da651f3e078847ad8ba6ca0635301978_12317248830051133648_hu6676397135954014178.webp 1600w"  alt="no ST2 03" height="1080" width="1920"></a><figcaption class="image-caption">no ST2 03</figcaption>
</figure></p>
<p>然后我们正常执行三色标记的算法逻辑，将所有灰色的对象标记为黑色，那么对象 2 和对象 7 就被标记成了黑色，如下图所示。</p>
<p><figure><a class="lightgallery" href="/2a00e38c265a4370923ed6b4bf4a7435_8076642769167528017.png" title="no ST2 04" data-thumbnail="/2a00e38c265a4370923ed6b4bf4a7435_8076642769167528017.png" data-sub-html="<h2>no ST2 04</h2><p>no ST2 04</p>"><img  loading="lazy" src=/2a00e38c265a4370923ed6b4bf4a7435_8076642769167528017.png srcset="/2a00e38c265a4370923ed6b4bf4a7435_8076642769167528017_hu6827897806264311153.webp 800w, /2a00e38c265a4370923ed6b4bf4a7435_8076642769167528017_hu8878783412680616117.webp 1200w, /2a00e38c265a4370923ed6b4bf4a7435_8076642769167528017_hu7887431881521897296.webp 1600w"  alt="no ST2 04" height="1080" width="1920"></a><figcaption class="image-caption">no ST2 04</figcaption>
</figure></p>
<p>那么就执行了三色标记的最后一步，将所有白色对象当做垃圾进行回收，如图所示。</p>
<p><figure><a class="lightgallery" href="/512e92ad527e4ac1871abb2a8df63e75_14318485921209724827.png" title="no ST2 05" data-thumbnail="/512e92ad527e4ac1871abb2a8df63e75_14318485921209724827.png" data-sub-html="<h2>no ST2 05</h2><p>no ST2 05</p>"><img  loading="lazy" src=/512e92ad527e4ac1871abb2a8df63e75_14318485921209724827.png srcset="/512e92ad527e4ac1871abb2a8df63e75_14318485921209724827_hu16659806794507561972.webp 800w, /512e92ad527e4ac1871abb2a8df63e75_14318485921209724827_hu14320611125551107262.webp 1200w, /512e92ad527e4ac1871abb2a8df63e75_14318485921209724827_hu6390004513025985415.webp 1600w"  alt="no ST2 05" height="1080" width="1920"></a><figcaption class="image-caption">no ST2 05</figcaption>
</figure></p>
<p>最后我们发现，本来是对象4合法引用的对象 3，却被GC给“误杀”回收掉了。</p>
<p>可以看出，有两种情况，在三色标记法中是不希望被发生的。</p>
<ul>
<li>&#x1f449; 一个白色对象被黑色对象引用 <strong>（白色被挂在黑色下）</strong></li>
<li>&#x1f449; 灰色对象与它之间可达关系的白色对象遭到破坏 <strong>（灰色同时丢了该白色）</strong></li>
</ul>
<p>如果当以上两个条件同时满足时，就会出现对象丢失现象！</p>
<p><figure><a class="lightgallery" href="/f9e8dce78c274ccfb76bb491967d8fc2_11308176824149567694.png" title="三色标记对象丢失" data-thumbnail="/f9e8dce78c274ccfb76bb491967d8fc2_11308176824149567694.png" data-sub-html="<h2>三色标记对象丢失</h2><p>三色标记对象丢失</p>"><img  loading="lazy" src=/f9e8dce78c274ccfb76bb491967d8fc2_11308176824149567694.png srcset="/f9e8dce78c274ccfb76bb491967d8fc2_11308176824149567694_hu6690589842861472433.webp 800w, /f9e8dce78c274ccfb76bb491967d8fc2_11308176824149567694_hu16962220628830409516.webp 1200w, /f9e8dce78c274ccfb76bb491967d8fc2_11308176824149567694_hu6810144134521397019.webp 1600w"  alt="三色标记对象丢失" height="449" width="1095"></a><figcaption class="image-caption">三色标记对象丢失</figcaption>
</figure></p>
<p>并且，上面所示的场景中，如果示例中的白色对象3还有很多下游对象的话，也会一并都清理掉。</p>
<p>为了防止这种现象的发生，最简单的方式就是 STW，直接禁止掉其他用户程序对对象引用关系的干扰，但是<strong>STW的过程有明显的资源浪费，对所有的用户程序都有很大影响</strong>。</p>
<p>那么是否可以在保证对象不丢失的情况下合理的尽可能的提高 GC 效率，减少 STW 时间呢&#x2753;</p>
<p>答案是可以的，我们只要使用一种机制，尝试去破坏上面的两个必要条件就可以了。</p>
<h2 id="屏障机制" class="headerLink">
    <a href="#%e5%b1%8f%e9%9a%9c%e6%9c%ba%e5%88%b6" class="header-mark"></a>6 屏障机制</h2><p>如果让 GC 回收器，满足下面两种情况之一时，即可保证对象不丢失。这两种方式就是<strong>强三色不变式</strong>和<strong>弱三色不变式</strong>。</p>
<p><figure><a class="lightgallery" href="/95aefcee22ae4f72a04437582362e947_9820866590208076244.png" title="强/弱三色不变式" data-thumbnail="/95aefcee22ae4f72a04437582362e947_9820866590208076244.png" data-sub-html="<h2>强/弱三色不变式</h2><p>强/弱三色不变式</p>"><img  loading="lazy" src=/95aefcee22ae4f72a04437582362e947_9820866590208076244.png srcset="/95aefcee22ae4f72a04437582362e947_9820866590208076244_hu6732345100577781149.webp 800w, /95aefcee22ae4f72a04437582362e947_9820866590208076244_hu12486525816481155297.webp 1200w, /95aefcee22ae4f72a04437582362e947_9820866590208076244_hu15354520477606125150.webp 1600w"  alt="强/弱三色不变式" height="493" width="1095"></a><figcaption class="image-caption">强/弱三色不变式</figcaption>
</figure></p>
<h3 id="强三色不变式" class="headerLink">
    <a href="#%e5%bc%ba%e4%b8%89%e8%89%b2%e4%b8%8d%e5%8f%98%e5%bc%8f" class="header-mark"></a>6.1 强三色不变式</h3><p>强三色不变式实际上是强制性的<strong>不允许黑色对象引用白色对象</strong>，这样就不会出现有白色对象被误删的情况。</p>
<figure><a class="lightgallery" href="/9f8f0337b20c475bbf637503e68b0766_7743728240838200145.png" title="" data-thumbnail="/9f8f0337b20c475bbf637503e68b0766_7743728240838200145.png" data-sub-html="<h2>强三色不变式</h2>"><img  loading="lazy" src=/9f8f0337b20c475bbf637503e68b0766_7743728240838200145.png srcset="/9f8f0337b20c475bbf637503e68b0766_7743728240838200145_hu4396141848477474079.webp 800w, /9f8f0337b20c475bbf637503e68b0766_7743728240838200145_hu12327804667928782894.webp 1200w, /9f8f0337b20c475bbf637503e68b0766_7743728240838200145_hu11324914564739428272.webp 1600w"   height="678" width="500"></a><figcaption class="image-caption">强三色不变式</figcaption>
    </figure>
<h3 id="弱三色不变式" class="headerLink">
    <a href="#%e5%bc%b1%e4%b8%89%e8%89%b2%e4%b8%8d%e5%8f%98%e5%bc%8f" class="header-mark"></a>6.2 弱三色不变式</h3><p>所有被黑色对象引用的白色对象都处于灰色保护状态。</p>
<p><figure><a class="lightgallery" href="/9766a534c5244092b12e47a8255c7dc4_12137513788516555385.png" title="弱三色不变式" data-thumbnail="/9766a534c5244092b12e47a8255c7dc4_12137513788516555385.png" data-sub-html="<h2>弱三色不变式</h2><p>弱三色不变式</p>"><img  loading="lazy" src=/9766a534c5244092b12e47a8255c7dc4_12137513788516555385.png srcset="/9766a534c5244092b12e47a8255c7dc4_12137513788516555385_hu7744386411938802697.webp 800w, /9766a534c5244092b12e47a8255c7dc4_12137513788516555385_hu11474203240479415770.webp 1200w, /9766a534c5244092b12e47a8255c7dc4_12137513788516555385_hu17491609063196752954.webp 1600w"  alt="弱三色不变式" height="1080" width="1920"></a><figcaption class="image-caption">弱三色不变式</figcaption>
</figure></p>
<p>弱三色不变式强调，黑色对象可以引用白色对象，但是这个白色对象必须存在其他灰色对象对它的引用，或者可达它的链路上游存在灰色对象。这样实则是黑色对象引用白色对象，白色对象处于一个危险被删除的状态，但是由于上游灰色对象的引用，可以保护该白色对象，使其安全。</p>
<p>为了遵循上述的两个方式，GC 算法演进到两种屏障方式，分别是<strong>插入屏障</strong>和<strong>删除屏障</strong>。</p>
<h3 id="插入屏障" class="headerLink">
    <a href="#%e6%8f%92%e5%85%a5%e5%b1%8f%e9%9a%9c" class="header-mark"></a>6.3 插入屏障</h3><p>具体操作： 在 A 对象引用 B 对象的时候，B 对象被标记为灰色。<strong>将 B 挂在 A 下游，B 必须被标记为灰色</strong>。</p>
<p>满足：<strong>强三色不变式</strong>。不存在黑色对象引用白色对象的情况了， 因为<strong>白色会强制变成灰色</strong>。</p>
<p>伪代码如下：</p>
<div class="code-block highlight is-open show-line-numbers  tw-group tw-my-2">
  <div class="
    code-block-title 
    
    tw-flex 
    tw-flex-row 
    tw-justify-between 
    tw-w-full tw-bg-bgColor-secondary
    ">      
    <button 
      class="
        tw-select-none 
        tw-mx-2 
        tw-block
        group-[.is-open]:tw-rotate-90
        tw-transition-[transform] 
        tw-duration-500 
        tw-ease-in-out
        print:!tw-hidden"
      disabled
      aria-hidden="true"><svg class="icon"
    xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!-- Font Awesome Free 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M285.476 272.971L91.132 467.314c-9.373 9.373-24.569 9.373-33.941 0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941 0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"/></svg></button>

    <div class="code-block-title-bar tw-w-full">
      <p class="tw-select-none !tw-my-1">text</p>
    </div>
    <div class="tw-flex">
      <button 
        class="
          line-number-button
          tw-select-none 
          tw-mx-2 
          tw-hidden 
          group-[.is-open]:tw-block 
          group-[.show-line-numbers]:tw-text-fgColor-link 
          print:!tw-hidden" 
        title="Toggle line numbers"><svg class="icon"
    xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!-- Font Awesome Free 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M61.77 401l17.5-20.15a19.92 19.92 0 0 0 5.07-14.19v-3.31C84.34 356 80.5 352 73 352H16a8 8 0 0 0-8 8v16a8 8 0 0 0 8 8h22.83a157.41 157.41 0 0 0-11 12.31l-5.61 7c-4 5.07-5.25 10.13-2.8 14.88l1.05 1.93c3 5.76 6.29 7.88 12.25 7.88h4.73c10.33 0 15.94 2.44 15.94 9.09 0 4.72-4.2 8.22-14.36 8.22a41.54 41.54 0 0 1-15.47-3.12c-6.49-3.88-11.74-3.5-15.6 3.12l-5.59 9.31c-3.72 6.13-3.19 11.72 2.63 15.94 7.71 4.69 20.38 9.44 37 9.44 34.16 0 48.5-22.75 48.5-44.12-.03-14.38-9.12-29.76-28.73-34.88zM496 224H176a16 16 0 0 0-16 16v32a16 16 0 0 0 16 16h320a16 16 0 0 0 16-16v-32a16 16 0 0 0-16-16zm0-160H176a16 16 0 0 0-16 16v32a16 16 0 0 0 16 16h320a16 16 0 0 0 16-16V80a16 16 0 0 0-16-16zm0 320H176a16 16 0 0 0-16 16v32a16 16 0 0 0 16 16h320a16 16 0 0 0 16-16v-32a16 16 0 0 0-16-16zM16 160h64a8 8 0 0 0 8-8v-16a8 8 0 0 0-8-8H64V40a8 8 0 0 0-8-8H32a8 8 0 0 0-7.14 4.42l-8 16A8 8 0 0 0 24 64h8v64H16a8 8 0 0 0-8 8v16a8 8 0 0 0 8 8zm-3.91 160H80a8 8 0 0 0 8-8v-16a8 8 0 0 0-8-8H41.32c3.29-10.29 48.34-18.68 48.34-56.44 0-29.06-25-39.56-44.47-39.56-21.36 0-33.8 10-40.46 18.75-4.37 5.59-3 10.84 2.8 15.37l8.58 6.88c5.61 4.56 11 2.47 16.12-2.44a13.44 13.44 0 0 1 9.46-3.84c3.33 0 9.28 1.56 9.28 8.75C51 248.19 0 257.31 0 304.59v4C0 316 5.08 320 12.09 320z"/></svg></button>

      <button 
        class="
          wrap-code-button
          tw-select-none 
          tw-mx-2 
          tw-hidden 
          group-[.is-open]:tw-block 
          group-[.is-wrap]:tw-text-fgColor-link 
          print:!tw-hidden" 
        title="Toggle code wrap"><svg class="icon"
    xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!-- Font Awesome Free 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M16 132h416c8.837 0 16-7.163 16-16V76c0-8.837-7.163-16-16-16H16C7.163 60 0 67.163 0 76v40c0 8.837 7.163 16 16 16zm0 160h416c8.837 0 16-7.163 16-16v-40c0-8.837-7.163-16-16-16H16c-8.837 0-16 7.163-16 16v40c0 8.837 7.163 16 16 16zm0 160h416c8.837 0 16-7.163 16-16v-40c0-8.837-7.163-16-16-16H16c-8.837 0-16 7.163-16 16v40c0 8.837 7.163 16 16 16z"/></svg></button>
      
      <button 
        class="
          copy-code-button
          tw-select-none
          tw-mx-2 
          tw-hidden
          group-[.is-open]:tw-block
          hover:tw-text-fgColor-link 
          print:!tw-hidden"
        title="Copy code">
          <span class="copy-icon tw-block"><svg class="icon"
    xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!-- Font Awesome Free 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M433.941 65.941l-51.882-51.882A48 48 0 0 0 348.118 0H176c-26.51 0-48 21.49-48 48v48H48c-26.51 0-48 21.49-48 48v320c0 26.51 21.49 48 48 48h224c26.51 0 48-21.49 48-48v-48h80c26.51 0 48-21.49 48-48V99.882a48 48 0 0 0-14.059-33.941zM266 464H54a6 6 0 0 1-6-6V150a6 6 0 0 1 6-6h74v224c0 26.51 21.49 48 48 48h96v42a6 6 0 0 1-6 6zm128-96H182a6 6 0 0 1-6-6V54a6 6 0 0 1 6-6h106v88c0 13.255 10.745 24 24 24h88v202a6 6 0 0 1-6 6zm6-256h-64V48h9.632c1.591 0 3.117.632 4.243 1.757l48.368 48.368a6 6 0 0 1 1.757 4.243V112z"/></svg></span>
          <span class="check-icon tw-hidden"><svg class="icon"
    xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!-- Font Awesome Free 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M173.898 439.404l-166.4-166.4c-9.997-9.997-9.997-26.206 0-36.204l36.203-36.204c9.997-9.998 26.207-9.998 36.204 0L192 312.69 432.095 72.596c9.997-9.997 26.207-9.997 36.204 0l36.203 36.204c9.997 9.997 9.997 26.206 0 36.204l-294.4 294.401c-9.998 9.997-26.207 9.997-36.204-.001z"/></svg></span>
      </button>
        
      <button 
        class="
          tw-select-none 
          tw-mx-2 
          tw-block 
          group-[.is-open]:tw-hidden 
          print:!tw-hidden" 
        disabled
        aria-hidden="true"><svg class="icon"
    xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!-- Font Awesome Free 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M328 256c0 39.8-32.2 72-72 72s-72-32.2-72-72 32.2-72 72-72 72 32.2 72 72zm104-72c-39.8 0-72 32.2-72 72s32.2 72 72 72 72-32.2 72-72-32.2-72-72-72zm-352 0c-39.8 0-72 32.2-72 72s32.2 72 72 72 72-32.2 72-72-32.2-72-72-72z"/></svg></button>
    </div>
  </div>
  <pre style="counter-reset: codeblock;" class="tw-block tw-m-0 tw-p-0"><code 
    id="codeblock-id-1" 
    class="
      chroma 
      !tw-block 
      tw-p-0
      tw-m-0
      tw-transition-[max-height] 
      tw-duration-500 
      tw-ease-in-out 
      group-[.is-closed]:!tw-max-h-0 
      group-[.is-wrap]:tw-text-wrap
      tw-overflow-y-hidden
      tw-overflow-x-auto
      tw-scrollbar-thin
      "><span class="line"><span class="cl">添加下游对象(当前下游对象slot, 新下游对象ptr) {
</span></span><span class="line"><span class="cl">  //1
</span></span><span class="line"><span class="cl">  标记灰色(新下游对象ptr)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  //2
</span></span><span class="line"><span class="cl">  当前下游对象slot = 新下游对象ptr
</span></span><span class="line"><span class="cl">}</span></span></code></pre>
</div>
<p>场景：</p>
<div class="code-block highlight is-open show-line-numbers  tw-group tw-my-2">
  <div class="
    code-block-title 
    
    tw-flex 
    tw-flex-row 
    tw-justify-between 
    tw-w-full tw-bg-bgColor-secondary
    ">      
    <button 
      class="
        tw-select-none 
        tw-mx-2 
        tw-block
        group-[.is-open]:tw-rotate-90
        tw-transition-[transform] 
        tw-duration-500 
        tw-ease-in-out
        print:!tw-hidden"
      disabled
      aria-hidden="true"><svg class="icon"
    xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!-- Font Awesome Free 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M285.476 272.971L91.132 467.314c-9.373 9.373-24.569 9.373-33.941 0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941 0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"/></svg></button>

    <div class="code-block-title-bar tw-w-full">
      <p class="tw-select-none !tw-my-1">text</p>
    </div>
    <div class="tw-flex">
      <button 
        class="
          line-number-button
          tw-select-none 
          tw-mx-2 
          tw-hidden 
          group-[.is-open]:tw-block 
          group-[.show-line-numbers]:tw-text-fgColor-link 
          print:!tw-hidden" 
        title="Toggle line numbers"><svg class="icon"
    xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!-- Font Awesome Free 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M61.77 401l17.5-20.15a19.92 19.92 0 0 0 5.07-14.19v-3.31C84.34 356 80.5 352 73 352H16a8 8 0 0 0-8 8v16a8 8 0 0 0 8 8h22.83a157.41 157.41 0 0 0-11 12.31l-5.61 7c-4 5.07-5.25 10.13-2.8 14.88l1.05 1.93c3 5.76 6.29 7.88 12.25 7.88h4.73c10.33 0 15.94 2.44 15.94 9.09 0 4.72-4.2 8.22-14.36 8.22a41.54 41.54 0 0 1-15.47-3.12c-6.49-3.88-11.74-3.5-15.6 3.12l-5.59 9.31c-3.72 6.13-3.19 11.72 2.63 15.94 7.71 4.69 20.38 9.44 37 9.44 34.16 0 48.5-22.75 48.5-44.12-.03-14.38-9.12-29.76-28.73-34.88zM496 224H176a16 16 0 0 0-16 16v32a16 16 0 0 0 16 16h320a16 16 0 0 0 16-16v-32a16 16 0 0 0-16-16zm0-160H176a16 16 0 0 0-16 16v32a16 16 0 0 0 16 16h320a16 16 0 0 0 16-16V80a16 16 0 0 0-16-16zm0 320H176a16 16 0 0 0-16 16v32a16 16 0 0 0 16 16h320a16 16 0 0 0 16-16v-32a16 16 0 0 0-16-16zM16 160h64a8 8 0 0 0 8-8v-16a8 8 0 0 0-8-8H64V40a8 8 0 0 0-8-8H32a8 8 0 0 0-7.14 4.42l-8 16A8 8 0 0 0 24 64h8v64H16a8 8 0 0 0-8 8v16a8 8 0 0 0 8 8zm-3.91 160H80a8 8 0 0 0 8-8v-16a8 8 0 0 0-8-8H41.32c3.29-10.29 48.34-18.68 48.34-56.44 0-29.06-25-39.56-44.47-39.56-21.36 0-33.8 10-40.46 18.75-4.37 5.59-3 10.84 2.8 15.37l8.58 6.88c5.61 4.56 11 2.47 16.12-2.44a13.44 13.44 0 0 1 9.46-3.84c3.33 0 9.28 1.56 9.28 8.75C51 248.19 0 257.31 0 304.59v4C0 316 5.08 320 12.09 320z"/></svg></button>

      <button 
        class="
          wrap-code-button
          tw-select-none 
          tw-mx-2 
          tw-hidden 
          group-[.is-open]:tw-block 
          group-[.is-wrap]:tw-text-fgColor-link 
          print:!tw-hidden" 
        title="Toggle code wrap"><svg class="icon"
    xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!-- Font Awesome Free 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M16 132h416c8.837 0 16-7.163 16-16V76c0-8.837-7.163-16-16-16H16C7.163 60 0 67.163 0 76v40c0 8.837 7.163 16 16 16zm0 160h416c8.837 0 16-7.163 16-16v-40c0-8.837-7.163-16-16-16H16c-8.837 0-16 7.163-16 16v40c0 8.837 7.163 16 16 16zm0 160h416c8.837 0 16-7.163 16-16v-40c0-8.837-7.163-16-16-16H16c-8.837 0-16 7.163-16 16v40c0 8.837 7.163 16 16 16z"/></svg></button>
      
      <button 
        class="
          copy-code-button
          tw-select-none
          tw-mx-2 
          tw-hidden
          group-[.is-open]:tw-block
          hover:tw-text-fgColor-link 
          print:!tw-hidden"
        title="Copy code">
          <span class="copy-icon tw-block"><svg class="icon"
    xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!-- Font Awesome Free 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M433.941 65.941l-51.882-51.882A48 48 0 0 0 348.118 0H176c-26.51 0-48 21.49-48 48v48H48c-26.51 0-48 21.49-48 48v320c0 26.51 21.49 48 48 48h224c26.51 0 48-21.49 48-48v-48h80c26.51 0 48-21.49 48-48V99.882a48 48 0 0 0-14.059-33.941zM266 464H54a6 6 0 0 1-6-6V150a6 6 0 0 1 6-6h74v224c0 26.51 21.49 48 48 48h96v42a6 6 0 0 1-6 6zm128-96H182a6 6 0 0 1-6-6V54a6 6 0 0 1 6-6h106v88c0 13.255 10.745 24 24 24h88v202a6 6 0 0 1-6 6zm6-256h-64V48h9.632c1.591 0 3.117.632 4.243 1.757l48.368 48.368a6 6 0 0 1 1.757 4.243V112z"/></svg></span>
          <span class="check-icon tw-hidden"><svg class="icon"
    xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!-- Font Awesome Free 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M173.898 439.404l-166.4-166.4c-9.997-9.997-9.997-26.206 0-36.204l36.203-36.204c9.997-9.998 26.207-9.998 36.204 0L192 312.69 432.095 72.596c9.997-9.997 26.207-9.997 36.204 0l36.203 36.204c9.997 9.997 9.997 26.206 0 36.204l-294.4 294.401c-9.998 9.997-26.207 9.997-36.204-.001z"/></svg></span>
      </button>
        
      <button 
        class="
          tw-select-none 
          tw-mx-2 
          tw-block 
          group-[.is-open]:tw-hidden 
          print:!tw-hidden" 
        disabled
        aria-hidden="true"><svg class="icon"
    xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!-- Font Awesome Free 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M328 256c0 39.8-32.2 72-72 72s-72-32.2-72-72 32.2-72 72-72 72 32.2 72 72zm104-72c-39.8 0-72 32.2-72 72s32.2 72 72 72 72-32.2 72-72-32.2-72-72-72zm-352 0c-39.8 0-72 32.2-72 72s32.2 72 72 72 72-32.2 72-72-32.2-72-72-72z"/></svg></button>
    </div>
  </div>
  <pre style="counter-reset: codeblock;" class="tw-block tw-m-0 tw-p-0"><code 
    id="codeblock-id-2" 
    class="
      chroma 
      !tw-block 
      tw-p-0
      tw-m-0
      tw-transition-[max-height] 
      tw-duration-500 
      tw-ease-in-out 
      group-[.is-closed]:!tw-max-h-0 
      group-[.is-wrap]:tw-text-wrap
      tw-overflow-y-hidden
      tw-overflow-x-auto
      tw-scrollbar-thin
      "><span class="line"><span class="cl">A.添加下游对象(nil, B)   //A 之前没有下游， 新添加一个下游对象B， B被标记为灰色
</span></span><span class="line"><span class="cl">A.添加下游对象(C, B)     //A 将下游对象C 更换为B，  B被标记为灰色</span></span></code></pre>
</div>
<p>这段伪代码逻辑就是写屏障，但是这里有个性能损耗的地方就是每次添加好插入对象都要去判断。</p>
<p>黑色对象的内存槽有两种位置，栈和堆。 栈空间的特点是容量小，但是要求响应速度快，因为函数调用弹出频繁使用，所以<strong>插入屏障机制，在栈空间的对象操作中不使用，而仅仅使用在堆空间对象的操作中</strong>。</p>
<p>接下来，我们用几张图，来模拟一下整个详细的过程，希望能更可观的看清整体流程。</p>
<p><figure><a class="lightgallery" href="/9d76191546e44252ac8edd0fae087465_9063277446028074828.png" title="插入屏障01" data-thumbnail="/9d76191546e44252ac8edd0fae087465_9063277446028074828.png" data-sub-html="<h2>插入屏障01</h2><p>插入屏障01</p>"><img  loading="lazy" src=/9d76191546e44252ac8edd0fae087465_9063277446028074828.png srcset="/9d76191546e44252ac8edd0fae087465_9063277446028074828_hu18355426223044492245.webp 800w, /9d76191546e44252ac8edd0fae087465_9063277446028074828_hu4857712411530568582.webp 1200w, /9d76191546e44252ac8edd0fae087465_9063277446028074828_hu7420792017111471118.webp 1600w"  alt="插入屏障01" height="1080" width="1920"></a><figcaption class="image-caption">插入屏障01</figcaption>
</figure></p>
<p><figure><a class="lightgallery" href="/3d4a215e1c8347e2a6ebf416617cb2ee_1699580481272420994.png" title="插入屏障02" data-thumbnail="/3d4a215e1c8347e2a6ebf416617cb2ee_1699580481272420994.png" data-sub-html="<h2>插入屏障02</h2><p>插入屏障02</p>"><img  loading="lazy" src=/3d4a215e1c8347e2a6ebf416617cb2ee_1699580481272420994.png srcset="/3d4a215e1c8347e2a6ebf416617cb2ee_1699580481272420994_hu12055031299115404311.webp 800w, /3d4a215e1c8347e2a6ebf416617cb2ee_1699580481272420994_hu8612142902186223474.webp 1200w, /3d4a215e1c8347e2a6ebf416617cb2ee_1699580481272420994_hu12556990731791826943.webp 1600w"  alt="插入屏障02" height="1080" width="1920"></a><figcaption class="image-caption">插入屏障02</figcaption>
</figure></p>
<p><figure><a class="lightgallery" href="/53f0850d9ca746668c9a8ebf9c628ca3_14670594075040181403.png" title="插入屏障03" data-thumbnail="/53f0850d9ca746668c9a8ebf9c628ca3_14670594075040181403.png" data-sub-html="<h2>插入屏障03</h2><p>插入屏障03</p>"><img  loading="lazy" src=/53f0850d9ca746668c9a8ebf9c628ca3_14670594075040181403.png srcset="/53f0850d9ca746668c9a8ebf9c628ca3_14670594075040181403_hu10407942344887386298.webp 800w, /53f0850d9ca746668c9a8ebf9c628ca3_14670594075040181403_hu17444415364198877290.webp 1200w, /53f0850d9ca746668c9a8ebf9c628ca3_14670594075040181403_hu16564518723735433907.webp 1600w"  alt="插入屏障03" height="1080" width="1920"></a><figcaption class="image-caption">插入屏障03</figcaption>
</figure></p>
<p><figure><a class="lightgallery" href="/2b66b768590b448f857a5dba72cd7146_15586311562729069455.png" title="插入屏障04" data-thumbnail="/2b66b768590b448f857a5dba72cd7146_15586311562729069455.png" data-sub-html="<h2>插入屏障04</h2><p>插入屏障04</p>"><img  loading="lazy" src=/2b66b768590b448f857a5dba72cd7146_15586311562729069455.png srcset="/2b66b768590b448f857a5dba72cd7146_15586311562729069455_hu992192086270225081.webp 800w, /2b66b768590b448f857a5dba72cd7146_15586311562729069455_hu13479260696282741720.webp 1200w, /2b66b768590b448f857a5dba72cd7146_15586311562729069455_hu8038629280961165893.webp 1600w"  alt="插入屏障04" height="1080" width="1920"></a><figcaption class="image-caption">插入屏障04</figcaption>
</figure></p>
<p><figure><a class="lightgallery" href="/f0a379d3fd1d45df8dd20f7a68f615e0_9024370206524063723.png" title="插入屏障05" data-thumbnail="/f0a379d3fd1d45df8dd20f7a68f615e0_9024370206524063723.png" data-sub-html="<h2>插入屏障05</h2><p>插入屏障05</p>"><img  loading="lazy" src=/f0a379d3fd1d45df8dd20f7a68f615e0_9024370206524063723.png srcset="/f0a379d3fd1d45df8dd20f7a68f615e0_9024370206524063723_hu1745475322828753365.webp 800w, /f0a379d3fd1d45df8dd20f7a68f615e0_9024370206524063723_hu4874487653878086087.webp 1200w, /f0a379d3fd1d45df8dd20f7a68f615e0_9024370206524063723_hu12576097722396615865.webp 1600w"  alt="插入屏障05" height="1080" width="1920"></a><figcaption class="image-caption">插入屏障05</figcaption>
</figure></p>
<p><figure><a class="lightgallery" href="/c55625c54be54d848fb98ccfc88a76f9_13418662778091465785.png" title="插入屏障06" data-thumbnail="/c55625c54be54d848fb98ccfc88a76f9_13418662778091465785.png" data-sub-html="<h2>插入屏障06</h2><p>插入屏障06</p>"><img  loading="lazy" src=/c55625c54be54d848fb98ccfc88a76f9_13418662778091465785.png srcset="/c55625c54be54d848fb98ccfc88a76f9_13418662778091465785_hu959183422885721735.webp 800w, /c55625c54be54d848fb98ccfc88a76f9_13418662778091465785_hu11766675035053659593.webp 1200w, /c55625c54be54d848fb98ccfc88a76f9_13418662778091465785_hu12818440048833013605.webp 1600w"  alt="插入屏障06" height="1080" width="1920"></a><figcaption class="image-caption">插入屏障06</figcaption>
</figure></p>
<p>但是如果栈不添加，当全部三色标记扫描之后，栈上有可能依然存在白色对象被引用的情况（如上图的对象9）。所以要对栈重新进行三色标记扫描，但这次为了对象不丢失，<strong>要对本次标记扫描启动 STW 暂停</strong>，直到栈空间的三色标记结束。</p>
<p><figure><a class="lightgallery" href="/80c67f3febd44156b71332b19172c2ec_17162553926305808368.png" title="插入屏障07" data-thumbnail="/80c67f3febd44156b71332b19172c2ec_17162553926305808368.png" data-sub-html="<h2>插入屏障07</h2><p>插入屏障07</p>"><img  loading="lazy" src=/80c67f3febd44156b71332b19172c2ec_17162553926305808368.png srcset="/80c67f3febd44156b71332b19172c2ec_17162553926305808368_hu5342109272429176675.webp 800w, /80c67f3febd44156b71332b19172c2ec_17162553926305808368_hu7257011514028809605.webp 1200w, /80c67f3febd44156b71332b19172c2ec_17162553926305808368_hu12088282860221597314.webp 1600w"  alt="插入屏障07" height="1080" width="1920"></a><figcaption class="image-caption">插入屏障07</figcaption>
</figure></p>
<p><figure><a class="lightgallery" href="/77edaf8cc2cb4fad9283b5eedd81d2cf_11452527533356233155.png" title="插入屏障08" data-thumbnail="/77edaf8cc2cb4fad9283b5eedd81d2cf_11452527533356233155.png" data-sub-html="<h2>插入屏障08</h2><p>插入屏障08</p>"><img  loading="lazy" src=/77edaf8cc2cb4fad9283b5eedd81d2cf_11452527533356233155.png srcset="/77edaf8cc2cb4fad9283b5eedd81d2cf_11452527533356233155_hu3996696369941571103.webp 800w, /77edaf8cc2cb4fad9283b5eedd81d2cf_11452527533356233155_hu7194162654747301774.webp 1200w, /77edaf8cc2cb4fad9283b5eedd81d2cf_11452527533356233155_hu1293033444378921225.webp 1600w"  alt="插入屏障08" height="1080" width="1920"></a><figcaption class="image-caption">插入屏障08</figcaption>
</figure></p>
<p><figure><a class="lightgallery" href="/268b613c2dbd44048b5fd32667957a6e_4544043772469009072.png" title="插入屏障09" data-thumbnail="/268b613c2dbd44048b5fd32667957a6e_4544043772469009072.png" data-sub-html="<h2>插入屏障09</h2><p>插入屏障09</p>"><img  loading="lazy" src=/268b613c2dbd44048b5fd32667957a6e_4544043772469009072.png srcset="/268b613c2dbd44048b5fd32667957a6e_4544043772469009072_hu3821449504820709424.webp 800w, /268b613c2dbd44048b5fd32667957a6e_4544043772469009072_hu12888790991108799934.webp 1200w, /268b613c2dbd44048b5fd32667957a6e_4544043772469009072_hu9081269900845425584.webp 1600w"  alt="插入屏障09" height="1080" width="1920"></a><figcaption class="image-caption">插入屏障09</figcaption>
</figure></p>
<p>最后将栈和堆空间扫描剩余的全部白色节点清除，这次 STW 大约的时间在 10~100ms 间。这也是插入写屏障的<strong>不足</strong>，因为还是需要 STW，虽然时间很短。</p>
<p><figure><a class="lightgallery" href="/c3fe1710d579448aa8b13f84cd2cd6f0_1793480784933200351.png" title="插入屏障10" data-thumbnail="/c3fe1710d579448aa8b13f84cd2cd6f0_1793480784933200351.png" data-sub-html="<h2>插入屏障10</h2><p>插入屏障10</p>"><img  loading="lazy" src=/c3fe1710d579448aa8b13f84cd2cd6f0_1793480784933200351.png srcset="/c3fe1710d579448aa8b13f84cd2cd6f0_1793480784933200351_hu12344131597920288060.webp 800w, /c3fe1710d579448aa8b13f84cd2cd6f0_1793480784933200351_hu6256199262813147751.webp 1200w, /c3fe1710d579448aa8b13f84cd2cd6f0_1793480784933200351_hu13725164792906578762.webp 1600w"  alt="插入屏障10" height="1080" width="1920"></a><figcaption class="image-caption">插入屏障10</figcaption>
</figure></p>
<h3 id="删除屏障" class="headerLink">
    <a href="#%e5%88%a0%e9%99%a4%e5%b1%8f%e9%9a%9c" class="header-mark"></a>6.4 删除屏障</h3><p>具体操作：被删除的对象，如果自身为灰色或者白色，那么被标记为灰色。</p>
<p>满足：<strong>弱三色不变式</strong>，保护灰色对象到白色对象的路径不会断。</p>
<p>伪代码：</p>
<div class="code-block highlight is-open show-line-numbers  tw-group tw-my-2">
  <div class="
    code-block-title 
    
    tw-flex 
    tw-flex-row 
    tw-justify-between 
    tw-w-full tw-bg-bgColor-secondary
    ">      
    <button 
      class="
        tw-select-none 
        tw-mx-2 
        tw-block
        group-[.is-open]:tw-rotate-90
        tw-transition-[transform] 
        tw-duration-500 
        tw-ease-in-out
        print:!tw-hidden"
      disabled
      aria-hidden="true"><svg class="icon"
    xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!-- Font Awesome Free 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M285.476 272.971L91.132 467.314c-9.373 9.373-24.569 9.373-33.941 0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941 0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"/></svg></button>

    <div class="code-block-title-bar tw-w-full">
      <p class="tw-select-none !tw-my-1">text</p>
    </div>
    <div class="tw-flex">
      <button 
        class="
          line-number-button
          tw-select-none 
          tw-mx-2 
          tw-hidden 
          group-[.is-open]:tw-block 
          group-[.show-line-numbers]:tw-text-fgColor-link 
          print:!tw-hidden" 
        title="Toggle line numbers"><svg class="icon"
    xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!-- Font Awesome Free 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M61.77 401l17.5-20.15a19.92 19.92 0 0 0 5.07-14.19v-3.31C84.34 356 80.5 352 73 352H16a8 8 0 0 0-8 8v16a8 8 0 0 0 8 8h22.83a157.41 157.41 0 0 0-11 12.31l-5.61 7c-4 5.07-5.25 10.13-2.8 14.88l1.05 1.93c3 5.76 6.29 7.88 12.25 7.88h4.73c10.33 0 15.94 2.44 15.94 9.09 0 4.72-4.2 8.22-14.36 8.22a41.54 41.54 0 0 1-15.47-3.12c-6.49-3.88-11.74-3.5-15.6 3.12l-5.59 9.31c-3.72 6.13-3.19 11.72 2.63 15.94 7.71 4.69 20.38 9.44 37 9.44 34.16 0 48.5-22.75 48.5-44.12-.03-14.38-9.12-29.76-28.73-34.88zM496 224H176a16 16 0 0 0-16 16v32a16 16 0 0 0 16 16h320a16 16 0 0 0 16-16v-32a16 16 0 0 0-16-16zm0-160H176a16 16 0 0 0-16 16v32a16 16 0 0 0 16 16h320a16 16 0 0 0 16-16V80a16 16 0 0 0-16-16zm0 320H176a16 16 0 0 0-16 16v32a16 16 0 0 0 16 16h320a16 16 0 0 0 16-16v-32a16 16 0 0 0-16-16zM16 160h64a8 8 0 0 0 8-8v-16a8 8 0 0 0-8-8H64V40a8 8 0 0 0-8-8H32a8 8 0 0 0-7.14 4.42l-8 16A8 8 0 0 0 24 64h8v64H16a8 8 0 0 0-8 8v16a8 8 0 0 0 8 8zm-3.91 160H80a8 8 0 0 0 8-8v-16a8 8 0 0 0-8-8H41.32c3.29-10.29 48.34-18.68 48.34-56.44 0-29.06-25-39.56-44.47-39.56-21.36 0-33.8 10-40.46 18.75-4.37 5.59-3 10.84 2.8 15.37l8.58 6.88c5.61 4.56 11 2.47 16.12-2.44a13.44 13.44 0 0 1 9.46-3.84c3.33 0 9.28 1.56 9.28 8.75C51 248.19 0 257.31 0 304.59v4C0 316 5.08 320 12.09 320z"/></svg></button>

      <button 
        class="
          wrap-code-button
          tw-select-none 
          tw-mx-2 
          tw-hidden 
          group-[.is-open]:tw-block 
          group-[.is-wrap]:tw-text-fgColor-link 
          print:!tw-hidden" 
        title="Toggle code wrap"><svg class="icon"
    xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!-- Font Awesome Free 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M16 132h416c8.837 0 16-7.163 16-16V76c0-8.837-7.163-16-16-16H16C7.163 60 0 67.163 0 76v40c0 8.837 7.163 16 16 16zm0 160h416c8.837 0 16-7.163 16-16v-40c0-8.837-7.163-16-16-16H16c-8.837 0-16 7.163-16 16v40c0 8.837 7.163 16 16 16zm0 160h416c8.837 0 16-7.163 16-16v-40c0-8.837-7.163-16-16-16H16c-8.837 0-16 7.163-16 16v40c0 8.837 7.163 16 16 16z"/></svg></button>
      
      <button 
        class="
          copy-code-button
          tw-select-none
          tw-mx-2 
          tw-hidden
          group-[.is-open]:tw-block
          hover:tw-text-fgColor-link 
          print:!tw-hidden"
        title="Copy code">
          <span class="copy-icon tw-block"><svg class="icon"
    xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!-- Font Awesome Free 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M433.941 65.941l-51.882-51.882A48 48 0 0 0 348.118 0H176c-26.51 0-48 21.49-48 48v48H48c-26.51 0-48 21.49-48 48v320c0 26.51 21.49 48 48 48h224c26.51 0 48-21.49 48-48v-48h80c26.51 0 48-21.49 48-48V99.882a48 48 0 0 0-14.059-33.941zM266 464H54a6 6 0 0 1-6-6V150a6 6 0 0 1 6-6h74v224c0 26.51 21.49 48 48 48h96v42a6 6 0 0 1-6 6zm128-96H182a6 6 0 0 1-6-6V54a6 6 0 0 1 6-6h106v88c0 13.255 10.745 24 24 24h88v202a6 6 0 0 1-6 6zm6-256h-64V48h9.632c1.591 0 3.117.632 4.243 1.757l48.368 48.368a6 6 0 0 1 1.757 4.243V112z"/></svg></span>
          <span class="check-icon tw-hidden"><svg class="icon"
    xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!-- Font Awesome Free 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M173.898 439.404l-166.4-166.4c-9.997-9.997-9.997-26.206 0-36.204l36.203-36.204c9.997-9.998 26.207-9.998 36.204 0L192 312.69 432.095 72.596c9.997-9.997 26.207-9.997 36.204 0l36.203 36.204c9.997 9.997 9.997 26.206 0 36.204l-294.4 294.401c-9.998 9.997-26.207 9.997-36.204-.001z"/></svg></span>
      </button>
        
      <button 
        class="
          tw-select-none 
          tw-mx-2 
          tw-block 
          group-[.is-open]:tw-hidden 
          print:!tw-hidden" 
        disabled
        aria-hidden="true"><svg class="icon"
    xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!-- Font Awesome Free 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M328 256c0 39.8-32.2 72-72 72s-72-32.2-72-72 32.2-72 72-72 72 32.2 72 72zm104-72c-39.8 0-72 32.2-72 72s32.2 72 72 72 72-32.2 72-72-32.2-72-72-72zm-352 0c-39.8 0-72 32.2-72 72s32.2 72 72 72 72-32.2 72-72-32.2-72-72-72z"/></svg></button>
    </div>
  </div>
  <pre style="counter-reset: codeblock;" class="tw-block tw-m-0 tw-p-0"><code 
    id="codeblock-id-3" 
    class="
      chroma 
      !tw-block 
      tw-p-0
      tw-m-0
      tw-transition-[max-height] 
      tw-duration-500 
      tw-ease-in-out 
      group-[.is-closed]:!tw-max-h-0 
      group-[.is-wrap]:tw-text-wrap
      tw-overflow-y-hidden
      tw-overflow-x-auto
      tw-scrollbar-thin
      "><span class="line"><span class="cl">添加下游对象(当前下游对象slot， 新下游对象ptr) {
</span></span><span class="line"><span class="cl">  //1
</span></span><span class="line"><span class="cl">  if (当前下游对象slot是灰色 || 当前下游对象slot是白色) {
</span></span><span class="line"><span class="cl">  		标记灰色(当前下游对象slot)     //slot为被删除对象， 标记为灰色
</span></span><span class="line"><span class="cl">  }
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  //2
</span></span><span class="line"><span class="cl">  当前下游对象slot = 新下游对象ptr
</span></span><span class="line"><span class="cl">}</span></span></code></pre>
</div>
<p>场景：</p>
<div class="code-block highlight is-open show-line-numbers  tw-group tw-my-2">
  <div class="
    code-block-title 
    
    tw-flex 
    tw-flex-row 
    tw-justify-between 
    tw-w-full tw-bg-bgColor-secondary
    ">      
    <button 
      class="
        tw-select-none 
        tw-mx-2 
        tw-block
        group-[.is-open]:tw-rotate-90
        tw-transition-[transform] 
        tw-duration-500 
        tw-ease-in-out
        print:!tw-hidden"
      disabled
      aria-hidden="true"><svg class="icon"
    xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!-- Font Awesome Free 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M285.476 272.971L91.132 467.314c-9.373 9.373-24.569 9.373-33.941 0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941 0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"/></svg></button>

    <div class="code-block-title-bar tw-w-full">
      <p class="tw-select-none !tw-my-1">text</p>
    </div>
    <div class="tw-flex">
      <button 
        class="
          line-number-button
          tw-select-none 
          tw-mx-2 
          tw-hidden 
          group-[.is-open]:tw-block 
          group-[.show-line-numbers]:tw-text-fgColor-link 
          print:!tw-hidden" 
        title="Toggle line numbers"><svg class="icon"
    xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!-- Font Awesome Free 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M61.77 401l17.5-20.15a19.92 19.92 0 0 0 5.07-14.19v-3.31C84.34 356 80.5 352 73 352H16a8 8 0 0 0-8 8v16a8 8 0 0 0 8 8h22.83a157.41 157.41 0 0 0-11 12.31l-5.61 7c-4 5.07-5.25 10.13-2.8 14.88l1.05 1.93c3 5.76 6.29 7.88 12.25 7.88h4.73c10.33 0 15.94 2.44 15.94 9.09 0 4.72-4.2 8.22-14.36 8.22a41.54 41.54 0 0 1-15.47-3.12c-6.49-3.88-11.74-3.5-15.6 3.12l-5.59 9.31c-3.72 6.13-3.19 11.72 2.63 15.94 7.71 4.69 20.38 9.44 37 9.44 34.16 0 48.5-22.75 48.5-44.12-.03-14.38-9.12-29.76-28.73-34.88zM496 224H176a16 16 0 0 0-16 16v32a16 16 0 0 0 16 16h320a16 16 0 0 0 16-16v-32a16 16 0 0 0-16-16zm0-160H176a16 16 0 0 0-16 16v32a16 16 0 0 0 16 16h320a16 16 0 0 0 16-16V80a16 16 0 0 0-16-16zm0 320H176a16 16 0 0 0-16 16v32a16 16 0 0 0 16 16h320a16 16 0 0 0 16-16v-32a16 16 0 0 0-16-16zM16 160h64a8 8 0 0 0 8-8v-16a8 8 0 0 0-8-8H64V40a8 8 0 0 0-8-8H32a8 8 0 0 0-7.14 4.42l-8 16A8 8 0 0 0 24 64h8v64H16a8 8 0 0 0-8 8v16a8 8 0 0 0 8 8zm-3.91 160H80a8 8 0 0 0 8-8v-16a8 8 0 0 0-8-8H41.32c3.29-10.29 48.34-18.68 48.34-56.44 0-29.06-25-39.56-44.47-39.56-21.36 0-33.8 10-40.46 18.75-4.37 5.59-3 10.84 2.8 15.37l8.58 6.88c5.61 4.56 11 2.47 16.12-2.44a13.44 13.44 0 0 1 9.46-3.84c3.33 0 9.28 1.56 9.28 8.75C51 248.19 0 257.31 0 304.59v4C0 316 5.08 320 12.09 320z"/></svg></button>

      <button 
        class="
          wrap-code-button
          tw-select-none 
          tw-mx-2 
          tw-hidden 
          group-[.is-open]:tw-block 
          group-[.is-wrap]:tw-text-fgColor-link 
          print:!tw-hidden" 
        title="Toggle code wrap"><svg class="icon"
    xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!-- Font Awesome Free 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M16 132h416c8.837 0 16-7.163 16-16V76c0-8.837-7.163-16-16-16H16C7.163 60 0 67.163 0 76v40c0 8.837 7.163 16 16 16zm0 160h416c8.837 0 16-7.163 16-16v-40c0-8.837-7.163-16-16-16H16c-8.837 0-16 7.163-16 16v40c0 8.837 7.163 16 16 16zm0 160h416c8.837 0 16-7.163 16-16v-40c0-8.837-7.163-16-16-16H16c-8.837 0-16 7.163-16 16v40c0 8.837 7.163 16 16 16z"/></svg></button>
      
      <button 
        class="
          copy-code-button
          tw-select-none
          tw-mx-2 
          tw-hidden
          group-[.is-open]:tw-block
          hover:tw-text-fgColor-link 
          print:!tw-hidden"
        title="Copy code">
          <span class="copy-icon tw-block"><svg class="icon"
    xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!-- Font Awesome Free 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M433.941 65.941l-51.882-51.882A48 48 0 0 0 348.118 0H176c-26.51 0-48 21.49-48 48v48H48c-26.51 0-48 21.49-48 48v320c0 26.51 21.49 48 48 48h224c26.51 0 48-21.49 48-48v-48h80c26.51 0 48-21.49 48-48V99.882a48 48 0 0 0-14.059-33.941zM266 464H54a6 6 0 0 1-6-6V150a6 6 0 0 1 6-6h74v224c0 26.51 21.49 48 48 48h96v42a6 6 0 0 1-6 6zm128-96H182a6 6 0 0 1-6-6V54a6 6 0 0 1 6-6h106v88c0 13.255 10.745 24 24 24h88v202a6 6 0 0 1-6 6zm6-256h-64V48h9.632c1.591 0 3.117.632 4.243 1.757l48.368 48.368a6 6 0 0 1 1.757 4.243V112z"/></svg></span>
          <span class="check-icon tw-hidden"><svg class="icon"
    xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!-- Font Awesome Free 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M173.898 439.404l-166.4-166.4c-9.997-9.997-9.997-26.206 0-36.204l36.203-36.204c9.997-9.998 26.207-9.998 36.204 0L192 312.69 432.095 72.596c9.997-9.997 26.207-9.997 36.204 0l36.203 36.204c9.997 9.997 9.997 26.206 0 36.204l-294.4 294.401c-9.998 9.997-26.207 9.997-36.204-.001z"/></svg></span>
      </button>
        
      <button 
        class="
          tw-select-none 
          tw-mx-2 
          tw-block 
          group-[.is-open]:tw-hidden 
          print:!tw-hidden" 
        disabled
        aria-hidden="true"><svg class="icon"
    xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!-- Font Awesome Free 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M328 256c0 39.8-32.2 72-72 72s-72-32.2-72-72 32.2-72 72-72 72 32.2 72 72zm104-72c-39.8 0-72 32.2-72 72s32.2 72 72 72 72-32.2 72-72-32.2-72-72-72zm-352 0c-39.8 0-72 32.2-72 72s32.2 72 72 72 72-32.2 72-72-32.2-72-72-72z"/></svg></button>
    </div>
  </div>
  <pre style="counter-reset: codeblock;" class="tw-block tw-m-0 tw-p-0"><code 
    id="codeblock-id-4" 
    class="
      chroma 
      !tw-block 
      tw-p-0
      tw-m-0
      tw-transition-[max-height] 
      tw-duration-500 
      tw-ease-in-out 
      group-[.is-closed]:!tw-max-h-0 
      group-[.is-wrap]:tw-text-wrap
      tw-overflow-y-hidden
      tw-overflow-x-auto
      tw-scrollbar-thin
      "><span class="line"><span class="cl">A.添加下游对象(B, nil)   //A对象，删除B对象的引用。 B被A删除，被标记为灰(如果B之前为白)
</span></span><span class="line"><span class="cl">A.添加下游对象(B, C)         //A对象，更换下游B变成C。 B被A删除，被标记为灰(如果B之前为白)</span></span></code></pre>
</div>
<p>接下来，我们用几张图，来模拟一个详细的过程，希望能够更可观的看清楚整体流程。</p>
<p><figure><a class="lightgallery" href="/3ef46111cdca45b18626a0511f9b3df5_4629565537629394935.png" title="删除屏障01" data-thumbnail="/3ef46111cdca45b18626a0511f9b3df5_4629565537629394935.png" data-sub-html="<h2>删除屏障01</h2><p>删除屏障01</p>"><img  loading="lazy" src=/3ef46111cdca45b18626a0511f9b3df5_4629565537629394935.png srcset="/3ef46111cdca45b18626a0511f9b3df5_4629565537629394935_hu8286805923524500890.webp 800w, /3ef46111cdca45b18626a0511f9b3df5_4629565537629394935_hu3952543990515779932.webp 1200w, /3ef46111cdca45b18626a0511f9b3df5_4629565537629394935_hu18360256663936096725.webp 1600w"  alt="删除屏障01" height="1080" width="1920"></a><figcaption class="image-caption">删除屏障01</figcaption>
</figure></p>
<p><figure><a class="lightgallery" href="/e08ac9cd722c45ef98d9362fa5401c48_406428638966232896.png" title="删除屏障02" data-thumbnail="/e08ac9cd722c45ef98d9362fa5401c48_406428638966232896.png" data-sub-html="<h2>删除屏障02</h2><p>删除屏障02</p>"><img  loading="lazy" src=/e08ac9cd722c45ef98d9362fa5401c48_406428638966232896.png srcset="/e08ac9cd722c45ef98d9362fa5401c48_406428638966232896_hu12102722520536740343.webp 800w, /e08ac9cd722c45ef98d9362fa5401c48_406428638966232896_hu1080322567594622731.webp 1200w, /e08ac9cd722c45ef98d9362fa5401c48_406428638966232896_hu541723958307911676.webp 1600w"  alt="删除屏障02" height="1080" width="1920"></a><figcaption class="image-caption">删除屏障02</figcaption>
</figure></p>
<p><figure><a class="lightgallery" href="/a8ad362faec241848935c82e1fa7e428_1350162429871079868.png" title="删除屏障03" data-thumbnail="/a8ad362faec241848935c82e1fa7e428_1350162429871079868.png" data-sub-html="<h2>删除屏障03</h2><p>删除屏障03</p>"><img  loading="lazy" src=/a8ad362faec241848935c82e1fa7e428_1350162429871079868.png srcset="/a8ad362faec241848935c82e1fa7e428_1350162429871079868_hu9089207013741267918.webp 800w, /a8ad362faec241848935c82e1fa7e428_1350162429871079868_hu1265653153315188633.webp 1200w, /a8ad362faec241848935c82e1fa7e428_1350162429871079868_hu5174530411048153618.webp 1600w"  alt="删除屏障03" height="1080" width="1920"></a><figcaption class="image-caption">删除屏障03</figcaption>
</figure></p>
<p><figure><a class="lightgallery" href="/e230f27d981248e1b4bfb254a776c038_562294416603421131.png" title="删除屏障04" data-thumbnail="/e230f27d981248e1b4bfb254a776c038_562294416603421131.png" data-sub-html="<h2>删除屏障04</h2><p>删除屏障04</p>"><img  loading="lazy" src=/e230f27d981248e1b4bfb254a776c038_562294416603421131.png srcset="/e230f27d981248e1b4bfb254a776c038_562294416603421131_hu11790984347290026305.webp 800w, /e230f27d981248e1b4bfb254a776c038_562294416603421131_hu9264253990238499524.webp 1200w, /e230f27d981248e1b4bfb254a776c038_562294416603421131_hu2389780229127822952.webp 1600w"  alt="删除屏障04" height="1080" width="1920"></a><figcaption class="image-caption">删除屏障04</figcaption>
</figure></p>
<p><figure><a class="lightgallery" href="/3887ebd09e204ec9932c0cfb10fb38fa_16870218378890995347.png" title="删除屏障05" data-thumbnail="/3887ebd09e204ec9932c0cfb10fb38fa_16870218378890995347.png" data-sub-html="<h2>删除屏障05</h2><p>删除屏障05</p>"><img  loading="lazy" src=/3887ebd09e204ec9932c0cfb10fb38fa_16870218378890995347.png srcset="/3887ebd09e204ec9932c0cfb10fb38fa_16870218378890995347_hu15254398149678017257.webp 800w, /3887ebd09e204ec9932c0cfb10fb38fa_16870218378890995347_hu11551163013533108014.webp 1200w, /3887ebd09e204ec9932c0cfb10fb38fa_16870218378890995347_hu12003456355856861100.webp 1600w"  alt="删除屏障05" height="1080" width="1920"></a><figcaption class="image-caption">删除屏障05</figcaption>
</figure></p>
<p><figure><a class="lightgallery" href="/65cdf09e3d3e454487a23e3e79c424ee_10368971713115722345.png" title="删除屏障06" data-thumbnail="/65cdf09e3d3e454487a23e3e79c424ee_10368971713115722345.png" data-sub-html="<h2>删除屏障06</h2><p>删除屏障06</p>"><img  loading="lazy" src=/65cdf09e3d3e454487a23e3e79c424ee_10368971713115722345.png srcset="/65cdf09e3d3e454487a23e3e79c424ee_10368971713115722345_hu14362338687440275003.webp 800w, /65cdf09e3d3e454487a23e3e79c424ee_10368971713115722345_hu9854065172845636068.webp 1200w, /65cdf09e3d3e454487a23e3e79c424ee_10368971713115722345_hu12984462009849731729.webp 1600w"  alt="删除屏障06" height="1080" width="1920"></a><figcaption class="image-caption">删除屏障06</figcaption>
</figure></p>
<p><figure><a class="lightgallery" href="/7d6c80f3eec34796ab3c3e333642de96_181650488749558674.png" title="删除屏障07" data-thumbnail="/7d6c80f3eec34796ab3c3e333642de96_181650488749558674.png" data-sub-html="<h2>删除屏障07</h2><p>删除屏障07</p>"><img  loading="lazy" src=/7d6c80f3eec34796ab3c3e333642de96_181650488749558674.png srcset="/7d6c80f3eec34796ab3c3e333642de96_181650488749558674_hu2614312989079616203.webp 800w, /7d6c80f3eec34796ab3c3e333642de96_181650488749558674_hu4514522712808462073.webp 1200w, /7d6c80f3eec34796ab3c3e333642de96_181650488749558674_hu11258359847661807414.webp 1600w"  alt="删除屏障07" height="1080" width="1920"></a><figcaption class="image-caption">删除屏障07</figcaption>
</figure></p>
<p>这种方式的<strong>不足是回收精度低</strong>，一个对象即使被删除了最后一个指向它的指针也<strong>依旧可以</strong>活过这一轮，在下一轮 GC 中被清理掉。</p>
<h2 id="混合写屏障" class="headerLink">
    <a href="#%e6%b7%b7%e5%90%88%e5%86%99%e5%b1%8f%e9%9a%9c" class="header-mark"></a>7 混合写屏障</h2><p>插入写屏障和删除写屏障的短板：</p>
<ul>
<li>插入写屏障：结束时需要 STW 来重新扫描栈，标记栈上引用的白色对象的存活，大约需要 10-100ms。</li>
<li>删除写屏障：回收精度低，一个对象即使被删除了最后一个指向它的指针也依旧可以活过这一轮，在下一轮 GC 中被清理掉。GC 开始时 STW 扫描堆栈来记录初始快照（监控对象的内存修改，判断对象是否删除），这个过程会保护开始时刻的所有存活对象。</li>
</ul>
<p>Go v1.8 版本引入了<strong><ruby>混合写屏障机制<rt>hybrid write barrier</rt></ruby></strong>，避免了对栈 re-scan 的过程，极大的减少了 STW 的时间，结合了两者的优点。</p>
<h3 id="规则" class="headerLink">
    <a href="#%e8%a7%84%e5%88%99" class="header-mark"></a>7.1 规则</h3><p>具体操作：</p>
<ol>
<li>GC 开始将栈上的对象全部扫描并标记为黑色（之后不再进行第二次重复扫描，无需 STW ）。</li>
<li><strong>GC 期间，任何在栈上创建的新对象，均为黑色</strong>。</li>
<li>被删除的对象标记为灰色。</li>
<li>被添加的对象标记为灰色。</li>
</ol>
<p>满足：变形的弱三色不变式。</p>
<p>伪代码：</p>
<div class="code-block highlight is-open show-line-numbers  tw-group tw-my-2">
  <div class="
    code-block-title 
    
    tw-flex 
    tw-flex-row 
    tw-justify-between 
    tw-w-full tw-bg-bgColor-secondary
    ">      
    <button 
      class="
        tw-select-none 
        tw-mx-2 
        tw-block
        group-[.is-open]:tw-rotate-90
        tw-transition-[transform] 
        tw-duration-500 
        tw-ease-in-out
        print:!tw-hidden"
      disabled
      aria-hidden="true"><svg class="icon"
    xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!-- Font Awesome Free 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M285.476 272.971L91.132 467.314c-9.373 9.373-24.569 9.373-33.941 0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941 0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"/></svg></button>

    <div class="code-block-title-bar tw-w-full">
      <p class="tw-select-none !tw-my-1">text</p>
    </div>
    <div class="tw-flex">
      <button 
        class="
          line-number-button
          tw-select-none 
          tw-mx-2 
          tw-hidden 
          group-[.is-open]:tw-block 
          group-[.show-line-numbers]:tw-text-fgColor-link 
          print:!tw-hidden" 
        title="Toggle line numbers"><svg class="icon"
    xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!-- Font Awesome Free 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M61.77 401l17.5-20.15a19.92 19.92 0 0 0 5.07-14.19v-3.31C84.34 356 80.5 352 73 352H16a8 8 0 0 0-8 8v16a8 8 0 0 0 8 8h22.83a157.41 157.41 0 0 0-11 12.31l-5.61 7c-4 5.07-5.25 10.13-2.8 14.88l1.05 1.93c3 5.76 6.29 7.88 12.25 7.88h4.73c10.33 0 15.94 2.44 15.94 9.09 0 4.72-4.2 8.22-14.36 8.22a41.54 41.54 0 0 1-15.47-3.12c-6.49-3.88-11.74-3.5-15.6 3.12l-5.59 9.31c-3.72 6.13-3.19 11.72 2.63 15.94 7.71 4.69 20.38 9.44 37 9.44 34.16 0 48.5-22.75 48.5-44.12-.03-14.38-9.12-29.76-28.73-34.88zM496 224H176a16 16 0 0 0-16 16v32a16 16 0 0 0 16 16h320a16 16 0 0 0 16-16v-32a16 16 0 0 0-16-16zm0-160H176a16 16 0 0 0-16 16v32a16 16 0 0 0 16 16h320a16 16 0 0 0 16-16V80a16 16 0 0 0-16-16zm0 320H176a16 16 0 0 0-16 16v32a16 16 0 0 0 16 16h320a16 16 0 0 0 16-16v-32a16 16 0 0 0-16-16zM16 160h64a8 8 0 0 0 8-8v-16a8 8 0 0 0-8-8H64V40a8 8 0 0 0-8-8H32a8 8 0 0 0-7.14 4.42l-8 16A8 8 0 0 0 24 64h8v64H16a8 8 0 0 0-8 8v16a8 8 0 0 0 8 8zm-3.91 160H80a8 8 0 0 0 8-8v-16a8 8 0 0 0-8-8H41.32c3.29-10.29 48.34-18.68 48.34-56.44 0-29.06-25-39.56-44.47-39.56-21.36 0-33.8 10-40.46 18.75-4.37 5.59-3 10.84 2.8 15.37l8.58 6.88c5.61 4.56 11 2.47 16.12-2.44a13.44 13.44 0 0 1 9.46-3.84c3.33 0 9.28 1.56 9.28 8.75C51 248.19 0 257.31 0 304.59v4C0 316 5.08 320 12.09 320z"/></svg></button>

      <button 
        class="
          wrap-code-button
          tw-select-none 
          tw-mx-2 
          tw-hidden 
          group-[.is-open]:tw-block 
          group-[.is-wrap]:tw-text-fgColor-link 
          print:!tw-hidden" 
        title="Toggle code wrap"><svg class="icon"
    xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!-- Font Awesome Free 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M16 132h416c8.837 0 16-7.163 16-16V76c0-8.837-7.163-16-16-16H16C7.163 60 0 67.163 0 76v40c0 8.837 7.163 16 16 16zm0 160h416c8.837 0 16-7.163 16-16v-40c0-8.837-7.163-16-16-16H16c-8.837 0-16 7.163-16 16v40c0 8.837 7.163 16 16 16zm0 160h416c8.837 0 16-7.163 16-16v-40c0-8.837-7.163-16-16-16H16c-8.837 0-16 7.163-16 16v40c0 8.837 7.163 16 16 16z"/></svg></button>
      
      <button 
        class="
          copy-code-button
          tw-select-none
          tw-mx-2 
          tw-hidden
          group-[.is-open]:tw-block
          hover:tw-text-fgColor-link 
          print:!tw-hidden"
        title="Copy code">
          <span class="copy-icon tw-block"><svg class="icon"
    xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!-- Font Awesome Free 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M433.941 65.941l-51.882-51.882A48 48 0 0 0 348.118 0H176c-26.51 0-48 21.49-48 48v48H48c-26.51 0-48 21.49-48 48v320c0 26.51 21.49 48 48 48h224c26.51 0 48-21.49 48-48v-48h80c26.51 0 48-21.49 48-48V99.882a48 48 0 0 0-14.059-33.941zM266 464H54a6 6 0 0 1-6-6V150a6 6 0 0 1 6-6h74v224c0 26.51 21.49 48 48 48h96v42a6 6 0 0 1-6 6zm128-96H182a6 6 0 0 1-6-6V54a6 6 0 0 1 6-6h106v88c0 13.255 10.745 24 24 24h88v202a6 6 0 0 1-6 6zm6-256h-64V48h9.632c1.591 0 3.117.632 4.243 1.757l48.368 48.368a6 6 0 0 1 1.757 4.243V112z"/></svg></span>
          <span class="check-icon tw-hidden"><svg class="icon"
    xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!-- Font Awesome Free 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M173.898 439.404l-166.4-166.4c-9.997-9.997-9.997-26.206 0-36.204l36.203-36.204c9.997-9.998 26.207-9.998 36.204 0L192 312.69 432.095 72.596c9.997-9.997 26.207-9.997 36.204 0l36.203 36.204c9.997 9.997 9.997 26.206 0 36.204l-294.4 294.401c-9.998 9.997-26.207 9.997-36.204-.001z"/></svg></span>
      </button>
        
      <button 
        class="
          tw-select-none 
          tw-mx-2 
          tw-block 
          group-[.is-open]:tw-hidden 
          print:!tw-hidden" 
        disabled
        aria-hidden="true"><svg class="icon"
    xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!-- Font Awesome Free 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M328 256c0 39.8-32.2 72-72 72s-72-32.2-72-72 32.2-72 72-72 72 32.2 72 72zm104-72c-39.8 0-72 32.2-72 72s32.2 72 72 72 72-32.2 72-72-32.2-72-72-72zm-352 0c-39.8 0-72 32.2-72 72s32.2 72 72 72 72-32.2 72-72-32.2-72-72-72z"/></svg></button>
    </div>
  </div>
  <pre style="counter-reset: codeblock;" class="tw-block tw-m-0 tw-p-0"><code 
    id="codeblock-id-5" 
    class="
      chroma 
      !tw-block 
      tw-p-0
      tw-m-0
      tw-transition-[max-height] 
      tw-duration-500 
      tw-ease-in-out 
      group-[.is-closed]:!tw-max-h-0 
      group-[.is-wrap]:tw-text-wrap
      tw-overflow-y-hidden
      tw-overflow-x-auto
      tw-scrollbar-thin
      "><span class="line"><span class="cl">添加下游对象(当前下游对象slot, 新下游对象ptr) {
</span></span><span class="line"><span class="cl">  	//1
</span></span><span class="line"><span class="cl">	标记灰色(当前下游对象slot)    //只要当前下游对象被移走，就标记灰色
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  	//2
</span></span><span class="line"><span class="cl">  	标记灰色(新下游对象ptr)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  	//3
</span></span><span class="line"><span class="cl">  	当前下游对象slot = 新下游对象ptr
</span></span><span class="line"><span class="cl">}</span></span></code></pre>
</div>
<blockquote>
  <p>屏障技术是不在栈上应用的，因为要保证栈的运行效率。</p>

</blockquote><h3 id="具体场景" class="headerLink">
    <a href="#%e5%85%b7%e4%bd%93%e5%9c%ba%e6%99%af" class="header-mark"></a>7.2 具体场景</h3><p>我们用几张图，来模拟一个详细的过程，希望能够更可观的看清楚整体流程。</p>
<p>混合写屏障是 GC 的一种屏障机制，所以只是当程序执行 GC 的时候，才会触发这种机制。</p>
<p>GC开始：优先扫描栈区，将可达对象全部标记为黑</p>
<p><figure><a class="lightgallery" href="/d7aefd0f1c7e47fb94db02096fe857d9_18433398178865465673.png" title="混合写屏障01" data-thumbnail="/d7aefd0f1c7e47fb94db02096fe857d9_18433398178865465673.png" data-sub-html="<h2>混合写屏障01</h2><p>混合写屏障01</p>"><img  loading="lazy" src=/d7aefd0f1c7e47fb94db02096fe857d9_18433398178865465673.png srcset="/d7aefd0f1c7e47fb94db02096fe857d9_18433398178865465673_hu16132233960777584979.webp 800w, /d7aefd0f1c7e47fb94db02096fe857d9_18433398178865465673_hu11037959113634464645.webp 1200w, /d7aefd0f1c7e47fb94db02096fe857d9_18433398178865465673_hu14313525703722965227.webp 1600w"  alt="混合写屏障01" height="1080" width="1920"></a><figcaption class="image-caption">混合写屏障01</figcaption>
</figure></p>
<p><figure><a class="lightgallery" href="/d674041682d940189041add754694bdf_6148708713774544194.png" title="混合写屏障02" data-thumbnail="/d674041682d940189041add754694bdf_6148708713774544194.png" data-sub-html="<h2>混合写屏障02</h2><p>混合写屏障02</p>"><img  loading="lazy" src=/d674041682d940189041add754694bdf_6148708713774544194.png srcset="/d674041682d940189041add754694bdf_6148708713774544194_hu8471240418376355627.webp 800w, /d674041682d940189041add754694bdf_6148708713774544194_hu7615833816668100109.webp 1200w, /d674041682d940189041add754694bdf_6148708713774544194_hu2746513353512372145.webp 1600w"  alt="混合写屏障02" height="1080" width="1920"></a><figcaption class="image-caption">混合写屏障02</figcaption>
</figure></p>
<h4 id="场景一" class="headerLink">
    <a href="#%e5%9c%ba%e6%99%af%e4%b8%80" class="header-mark"></a>7.2.1 场景一</h4><p>对象被一个堆对象删除引用，成为栈对象的下游。</p>
<p>伪代码</p>
<div class="code-block highlight is-open show-line-numbers  tw-group tw-my-2">
  <div class="
    code-block-title 
    
    tw-flex 
    tw-flex-row 
    tw-justify-between 
    tw-w-full tw-bg-bgColor-secondary
    ">      
    <button 
      class="
        tw-select-none 
        tw-mx-2 
        tw-block
        group-[.is-open]:tw-rotate-90
        tw-transition-[transform] 
        tw-duration-500 
        tw-ease-in-out
        print:!tw-hidden"
      disabled
      aria-hidden="true"><svg class="icon"
    xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!-- Font Awesome Free 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M285.476 272.971L91.132 467.314c-9.373 9.373-24.569 9.373-33.941 0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941 0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"/></svg></button>

    <div class="code-block-title-bar tw-w-full">
      <p class="tw-select-none !tw-my-1">text</p>
    </div>
    <div class="tw-flex">
      <button 
        class="
          line-number-button
          tw-select-none 
          tw-mx-2 
          tw-hidden 
          group-[.is-open]:tw-block 
          group-[.show-line-numbers]:tw-text-fgColor-link 
          print:!tw-hidden" 
        title="Toggle line numbers"><svg class="icon"
    xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!-- Font Awesome Free 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M61.77 401l17.5-20.15a19.92 19.92 0 0 0 5.07-14.19v-3.31C84.34 356 80.5 352 73 352H16a8 8 0 0 0-8 8v16a8 8 0 0 0 8 8h22.83a157.41 157.41 0 0 0-11 12.31l-5.61 7c-4 5.07-5.25 10.13-2.8 14.88l1.05 1.93c3 5.76 6.29 7.88 12.25 7.88h4.73c10.33 0 15.94 2.44 15.94 9.09 0 4.72-4.2 8.22-14.36 8.22a41.54 41.54 0 0 1-15.47-3.12c-6.49-3.88-11.74-3.5-15.6 3.12l-5.59 9.31c-3.72 6.13-3.19 11.72 2.63 15.94 7.71 4.69 20.38 9.44 37 9.44 34.16 0 48.5-22.75 48.5-44.12-.03-14.38-9.12-29.76-28.73-34.88zM496 224H176a16 16 0 0 0-16 16v32a16 16 0 0 0 16 16h320a16 16 0 0 0 16-16v-32a16 16 0 0 0-16-16zm0-160H176a16 16 0 0 0-16 16v32a16 16 0 0 0 16 16h320a16 16 0 0 0 16-16V80a16 16 0 0 0-16-16zm0 320H176a16 16 0 0 0-16 16v32a16 16 0 0 0 16 16h320a16 16 0 0 0 16-16v-32a16 16 0 0 0-16-16zM16 160h64a8 8 0 0 0 8-8v-16a8 8 0 0 0-8-8H64V40a8 8 0 0 0-8-8H32a8 8 0 0 0-7.14 4.42l-8 16A8 8 0 0 0 24 64h8v64H16a8 8 0 0 0-8 8v16a8 8 0 0 0 8 8zm-3.91 160H80a8 8 0 0 0 8-8v-16a8 8 0 0 0-8-8H41.32c3.29-10.29 48.34-18.68 48.34-56.44 0-29.06-25-39.56-44.47-39.56-21.36 0-33.8 10-40.46 18.75-4.37 5.59-3 10.84 2.8 15.37l8.58 6.88c5.61 4.56 11 2.47 16.12-2.44a13.44 13.44 0 0 1 9.46-3.84c3.33 0 9.28 1.56 9.28 8.75C51 248.19 0 257.31 0 304.59v4C0 316 5.08 320 12.09 320z"/></svg></button>

      <button 
        class="
          wrap-code-button
          tw-select-none 
          tw-mx-2 
          tw-hidden 
          group-[.is-open]:tw-block 
          group-[.is-wrap]:tw-text-fgColor-link 
          print:!tw-hidden" 
        title="Toggle code wrap"><svg class="icon"
    xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!-- Font Awesome Free 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M16 132h416c8.837 0 16-7.163 16-16V76c0-8.837-7.163-16-16-16H16C7.163 60 0 67.163 0 76v40c0 8.837 7.163 16 16 16zm0 160h416c8.837 0 16-7.163 16-16v-40c0-8.837-7.163-16-16-16H16c-8.837 0-16 7.163-16 16v40c0 8.837 7.163 16 16 16zm0 160h416c8.837 0 16-7.163 16-16v-40c0-8.837-7.163-16-16-16H16c-8.837 0-16 7.163-16 16v40c0 8.837 7.163 16 16 16z"/></svg></button>
      
      <button 
        class="
          copy-code-button
          tw-select-none
          tw-mx-2 
          tw-hidden
          group-[.is-open]:tw-block
          hover:tw-text-fgColor-link 
          print:!tw-hidden"
        title="Copy code">
          <span class="copy-icon tw-block"><svg class="icon"
    xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!-- Font Awesome Free 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M433.941 65.941l-51.882-51.882A48 48 0 0 0 348.118 0H176c-26.51 0-48 21.49-48 48v48H48c-26.51 0-48 21.49-48 48v320c0 26.51 21.49 48 48 48h224c26.51 0 48-21.49 48-48v-48h80c26.51 0 48-21.49 48-48V99.882a48 48 0 0 0-14.059-33.941zM266 464H54a6 6 0 0 1-6-6V150a6 6 0 0 1 6-6h74v224c0 26.51 21.49 48 48 48h96v42a6 6 0 0 1-6 6zm128-96H182a6 6 0 0 1-6-6V54a6 6 0 0 1 6-6h106v88c0 13.255 10.745 24 24 24h88v202a6 6 0 0 1-6 6zm6-256h-64V48h9.632c1.591 0 3.117.632 4.243 1.757l48.368 48.368a6 6 0 0 1 1.757 4.243V112z"/></svg></span>
          <span class="check-icon tw-hidden"><svg class="icon"
    xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!-- Font Awesome Free 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M173.898 439.404l-166.4-166.4c-9.997-9.997-9.997-26.206 0-36.204l36.203-36.204c9.997-9.998 26.207-9.998 36.204 0L192 312.69 432.095 72.596c9.997-9.997 26.207-9.997 36.204 0l36.203 36.204c9.997 9.997 9.997 26.206 0 36.204l-294.4 294.401c-9.998 9.997-26.207 9.997-36.204-.001z"/></svg></span>
      </button>
        
      <button 
        class="
          tw-select-none 
          tw-mx-2 
          tw-block 
          group-[.is-open]:tw-hidden 
          print:!tw-hidden" 
        disabled
        aria-hidden="true"><svg class="icon"
    xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!-- Font Awesome Free 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M328 256c0 39.8-32.2 72-72 72s-72-32.2-72-72 32.2-72 72-72 72 32.2 72 72zm104-72c-39.8 0-72 32.2-72 72s32.2 72 72 72 72-32.2 72-72-32.2-72-72-72zm-352 0c-39.8 0-72 32.2-72 72s32.2 72 72 72 72-32.2 72-72-32.2-72-72-72z"/></svg></button>
    </div>
  </div>
  <pre style="counter-reset: codeblock;" class="tw-block tw-m-0 tw-p-0"><code 
    id="codeblock-id-6" 
    class="
      chroma 
      !tw-block 
      tw-p-0
      tw-m-0
      tw-transition-[max-height] 
      tw-duration-500 
      tw-ease-in-out 
      group-[.is-closed]:!tw-max-h-0 
      group-[.is-wrap]:tw-text-wrap
      tw-overflow-y-hidden
      tw-overflow-x-auto
      tw-scrollbar-thin
      "><span class="line"><span class="cl">//前提：堆对象4-&gt;对象7 = 对象7；  //对象7 被 对象4引用
</span></span><span class="line"><span class="cl">栈对象1-&gt;对象7 = 堆对象7；  //将堆对象7 挂在 栈对象1 下游
</span></span><span class="line"><span class="cl">堆对象4-&gt;对象7 = null；    //对象4 删除引用 对象7</span></span></code></pre>
</div>
<p><figure><a class="lightgallery" href="/6eccf4b23f1044499d0bbf77c2069b21_14044057614475425582.png" title="场景1-01" data-thumbnail="/6eccf4b23f1044499d0bbf77c2069b21_14044057614475425582.png" data-sub-html="<h2>场景1-01</h2><p>场景1-01</p>"><img  loading="lazy" src=/6eccf4b23f1044499d0bbf77c2069b21_14044057614475425582.png srcset="/6eccf4b23f1044499d0bbf77c2069b21_14044057614475425582_hu10892374948007414859.webp 800w, /6eccf4b23f1044499d0bbf77c2069b21_14044057614475425582_hu13004538383104230329.webp 1200w, /6eccf4b23f1044499d0bbf77c2069b21_14044057614475425582_hu8751603445163494596.webp 1600w"  alt="场景1-01" height="1080" width="1920"></a><figcaption class="image-caption">场景1-01</figcaption>
</figure></p>
<p><figure><a class="lightgallery" href="/03f8a2fc5bcc4d76a74f48495900d00f_12193510775313221317.png" title="场景1-02" data-thumbnail="/03f8a2fc5bcc4d76a74f48495900d00f_12193510775313221317.png" data-sub-html="<h2>场景1-02</h2><p>场景1-02</p>"><img  loading="lazy" src=/03f8a2fc5bcc4d76a74f48495900d00f_12193510775313221317.png srcset="/03f8a2fc5bcc4d76a74f48495900d00f_12193510775313221317_hu5557082897504564693.webp 800w, /03f8a2fc5bcc4d76a74f48495900d00f_12193510775313221317_hu16688659757438792759.webp 1200w, /03f8a2fc5bcc4d76a74f48495900d00f_12193510775313221317_hu17662238637240658460.webp 1600w"  alt="场景1-02" height="1080" width="1920"></a><figcaption class="image-caption">场景1-02</figcaption>
</figure></p>
<h4 id="场景二" class="headerLink">
    <a href="#%e5%9c%ba%e6%99%af%e4%ba%8c" class="header-mark"></a>7.2.2 场景二</h4><p>对象被一个栈对象删除引用，成为另一个栈对象的下游。</p>
<p>伪代码：</p>
<div class="code-block highlight is-open show-line-numbers  tw-group tw-my-2">
  <div class="
    code-block-title 
    
    tw-flex 
    tw-flex-row 
    tw-justify-between 
    tw-w-full tw-bg-bgColor-secondary
    ">      
    <button 
      class="
        tw-select-none 
        tw-mx-2 
        tw-block
        group-[.is-open]:tw-rotate-90
        tw-transition-[transform] 
        tw-duration-500 
        tw-ease-in-out
        print:!tw-hidden"
      disabled
      aria-hidden="true"><svg class="icon"
    xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!-- Font Awesome Free 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M285.476 272.971L91.132 467.314c-9.373 9.373-24.569 9.373-33.941 0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941 0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"/></svg></button>

    <div class="code-block-title-bar tw-w-full">
      <p class="tw-select-none !tw-my-1">text</p>
    </div>
    <div class="tw-flex">
      <button 
        class="
          line-number-button
          tw-select-none 
          tw-mx-2 
          tw-hidden 
          group-[.is-open]:tw-block 
          group-[.show-line-numbers]:tw-text-fgColor-link 
          print:!tw-hidden" 
        title="Toggle line numbers"><svg class="icon"
    xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!-- Font Awesome Free 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M61.77 401l17.5-20.15a19.92 19.92 0 0 0 5.07-14.19v-3.31C84.34 356 80.5 352 73 352H16a8 8 0 0 0-8 8v16a8 8 0 0 0 8 8h22.83a157.41 157.41 0 0 0-11 12.31l-5.61 7c-4 5.07-5.25 10.13-2.8 14.88l1.05 1.93c3 5.76 6.29 7.88 12.25 7.88h4.73c10.33 0 15.94 2.44 15.94 9.09 0 4.72-4.2 8.22-14.36 8.22a41.54 41.54 0 0 1-15.47-3.12c-6.49-3.88-11.74-3.5-15.6 3.12l-5.59 9.31c-3.72 6.13-3.19 11.72 2.63 15.94 7.71 4.69 20.38 9.44 37 9.44 34.16 0 48.5-22.75 48.5-44.12-.03-14.38-9.12-29.76-28.73-34.88zM496 224H176a16 16 0 0 0-16 16v32a16 16 0 0 0 16 16h320a16 16 0 0 0 16-16v-32a16 16 0 0 0-16-16zm0-160H176a16 16 0 0 0-16 16v32a16 16 0 0 0 16 16h320a16 16 0 0 0 16-16V80a16 16 0 0 0-16-16zm0 320H176a16 16 0 0 0-16 16v32a16 16 0 0 0 16 16h320a16 16 0 0 0 16-16v-32a16 16 0 0 0-16-16zM16 160h64a8 8 0 0 0 8-8v-16a8 8 0 0 0-8-8H64V40a8 8 0 0 0-8-8H32a8 8 0 0 0-7.14 4.42l-8 16A8 8 0 0 0 24 64h8v64H16a8 8 0 0 0-8 8v16a8 8 0 0 0 8 8zm-3.91 160H80a8 8 0 0 0 8-8v-16a8 8 0 0 0-8-8H41.32c3.29-10.29 48.34-18.68 48.34-56.44 0-29.06-25-39.56-44.47-39.56-21.36 0-33.8 10-40.46 18.75-4.37 5.59-3 10.84 2.8 15.37l8.58 6.88c5.61 4.56 11 2.47 16.12-2.44a13.44 13.44 0 0 1 9.46-3.84c3.33 0 9.28 1.56 9.28 8.75C51 248.19 0 257.31 0 304.59v4C0 316 5.08 320 12.09 320z"/></svg></button>

      <button 
        class="
          wrap-code-button
          tw-select-none 
          tw-mx-2 
          tw-hidden 
          group-[.is-open]:tw-block 
          group-[.is-wrap]:tw-text-fgColor-link 
          print:!tw-hidden" 
        title="Toggle code wrap"><svg class="icon"
    xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!-- Font Awesome Free 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M16 132h416c8.837 0 16-7.163 16-16V76c0-8.837-7.163-16-16-16H16C7.163 60 0 67.163 0 76v40c0 8.837 7.163 16 16 16zm0 160h416c8.837 0 16-7.163 16-16v-40c0-8.837-7.163-16-16-16H16c-8.837 0-16 7.163-16 16v40c0 8.837 7.163 16 16 16zm0 160h416c8.837 0 16-7.163 16-16v-40c0-8.837-7.163-16-16-16H16c-8.837 0-16 7.163-16 16v40c0 8.837 7.163 16 16 16z"/></svg></button>
      
      <button 
        class="
          copy-code-button
          tw-select-none
          tw-mx-2 
          tw-hidden
          group-[.is-open]:tw-block
          hover:tw-text-fgColor-link 
          print:!tw-hidden"
        title="Copy code">
          <span class="copy-icon tw-block"><svg class="icon"
    xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!-- Font Awesome Free 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M433.941 65.941l-51.882-51.882A48 48 0 0 0 348.118 0H176c-26.51 0-48 21.49-48 48v48H48c-26.51 0-48 21.49-48 48v320c0 26.51 21.49 48 48 48h224c26.51 0 48-21.49 48-48v-48h80c26.51 0 48-21.49 48-48V99.882a48 48 0 0 0-14.059-33.941zM266 464H54a6 6 0 0 1-6-6V150a6 6 0 0 1 6-6h74v224c0 26.51 21.49 48 48 48h96v42a6 6 0 0 1-6 6zm128-96H182a6 6 0 0 1-6-6V54a6 6 0 0 1 6-6h106v88c0 13.255 10.745 24 24 24h88v202a6 6 0 0 1-6 6zm6-256h-64V48h9.632c1.591 0 3.117.632 4.243 1.757l48.368 48.368a6 6 0 0 1 1.757 4.243V112z"/></svg></span>
          <span class="check-icon tw-hidden"><svg class="icon"
    xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!-- Font Awesome Free 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M173.898 439.404l-166.4-166.4c-9.997-9.997-9.997-26.206 0-36.204l36.203-36.204c9.997-9.998 26.207-9.998 36.204 0L192 312.69 432.095 72.596c9.997-9.997 26.207-9.997 36.204 0l36.203 36.204c9.997 9.997 9.997 26.206 0 36.204l-294.4 294.401c-9.998 9.997-26.207 9.997-36.204-.001z"/></svg></span>
      </button>
        
      <button 
        class="
          tw-select-none 
          tw-mx-2 
          tw-block 
          group-[.is-open]:tw-hidden 
          print:!tw-hidden" 
        disabled
        aria-hidden="true"><svg class="icon"
    xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!-- Font Awesome Free 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M328 256c0 39.8-32.2 72-72 72s-72-32.2-72-72 32.2-72 72-72 72 32.2 72 72zm104-72c-39.8 0-72 32.2-72 72s32.2 72 72 72 72-32.2 72-72-32.2-72-72-72zm-352 0c-39.8 0-72 32.2-72 72s32.2 72 72 72 72-32.2 72-72-32.2-72-72-72z"/></svg></button>
    </div>
  </div>
  <pre style="counter-reset: codeblock;" class="tw-block tw-m-0 tw-p-0"><code 
    id="codeblock-id-7" 
    class="
      chroma 
      !tw-block 
      tw-p-0
      tw-m-0
      tw-transition-[max-height] 
      tw-duration-500 
      tw-ease-in-out 
      group-[.is-closed]:!tw-max-h-0 
      group-[.is-wrap]:tw-text-wrap
      tw-overflow-y-hidden
      tw-overflow-x-auto
      tw-scrollbar-thin
      "><span class="line"><span class="cl">new 栈对象9；
</span></span><span class="line"><span class="cl">对象8-&gt;对象3 = 对象3；      //将栈对象3 挂在 栈对象9 下游
</span></span><span class="line"><span class="cl">对象2-&gt;对象3 = null；      //对象2 删除引用 对象3</span></span></code></pre>
</div>
<p><figure><a class="lightgallery" href="/da92001995cf4c8cbf2568c3bacd7fbd_18386242788602721679.png" title="场景2-01" data-thumbnail="/da92001995cf4c8cbf2568c3bacd7fbd_18386242788602721679.png" data-sub-html="<h2>场景2-01</h2><p>场景2-01</p>"><img  loading="lazy" src=/da92001995cf4c8cbf2568c3bacd7fbd_18386242788602721679.png srcset="/da92001995cf4c8cbf2568c3bacd7fbd_18386242788602721679_hu14204510795429585032.webp 800w, /da92001995cf4c8cbf2568c3bacd7fbd_18386242788602721679_hu13304442525981155332.webp 1200w, /da92001995cf4c8cbf2568c3bacd7fbd_18386242788602721679_hu15009801555731857505.webp 1600w"  alt="场景2-01" height="1080" width="1920"></a><figcaption class="image-caption">场景2-01</figcaption>
</figure></p>
<p><figure><a class="lightgallery" href="/bc9ae45a820e4af682c58a25f96155e2_2952709508233941866.png" title="场景2-02" data-thumbnail="/bc9ae45a820e4af682c58a25f96155e2_2952709508233941866.png" data-sub-html="<h2>场景2-02</h2><p>场景2-02</p>"><img  loading="lazy" src=/bc9ae45a820e4af682c58a25f96155e2_2952709508233941866.png srcset="/bc9ae45a820e4af682c58a25f96155e2_2952709508233941866_hu16122813641263174358.webp 800w, /bc9ae45a820e4af682c58a25f96155e2_2952709508233941866_hu5831380160430789191.webp 1200w, /bc9ae45a820e4af682c58a25f96155e2_2952709508233941866_hu7630732404701811841.webp 1600w"  alt="场景2-02" height="1080" width="1920"></a><figcaption class="image-caption">场景2-02</figcaption>
</figure></p>
<p><figure><a class="lightgallery" href="/310dda56e97f411bab5a2e5576fd4369_6432997882666408432.png" title="场景2-03" data-thumbnail="/310dda56e97f411bab5a2e5576fd4369_6432997882666408432.png" data-sub-html="<h2>场景2-03</h2><p>场景2-03</p>"><img  loading="lazy" src=/310dda56e97f411bab5a2e5576fd4369_6432997882666408432.png srcset="/310dda56e97f411bab5a2e5576fd4369_6432997882666408432_hu16734467237679026973.webp 800w, /310dda56e97f411bab5a2e5576fd4369_6432997882666408432_hu15144638757203996721.webp 1200w, /310dda56e97f411bab5a2e5576fd4369_6432997882666408432_hu5130331307619358052.webp 1600w"  alt="场景2-03" height="1080" width="1920"></a><figcaption class="image-caption">场景2-03</figcaption>
</figure></p>
<h4 id="场景三" class="headerLink">
    <a href="#%e5%9c%ba%e6%99%af%e4%b8%89" class="header-mark"></a>7.2.3 场景三</h4><p>对象被一个堆对象删除引用，成为另一个堆对象的下游。</p>
<p>伪代码：</p>
<div class="code-block highlight is-open show-line-numbers  tw-group tw-my-2">
  <div class="
    code-block-title 
    
    tw-flex 
    tw-flex-row 
    tw-justify-between 
    tw-w-full tw-bg-bgColor-secondary
    ">      
    <button 
      class="
        tw-select-none 
        tw-mx-2 
        tw-block
        group-[.is-open]:tw-rotate-90
        tw-transition-[transform] 
        tw-duration-500 
        tw-ease-in-out
        print:!tw-hidden"
      disabled
      aria-hidden="true"><svg class="icon"
    xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!-- Font Awesome Free 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M285.476 272.971L91.132 467.314c-9.373 9.373-24.569 9.373-33.941 0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941 0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"/></svg></button>

    <div class="code-block-title-bar tw-w-full">
      <p class="tw-select-none !tw-my-1">text</p>
    </div>
    <div class="tw-flex">
      <button 
        class="
          line-number-button
          tw-select-none 
          tw-mx-2 
          tw-hidden 
          group-[.is-open]:tw-block 
          group-[.show-line-numbers]:tw-text-fgColor-link 
          print:!tw-hidden" 
        title="Toggle line numbers"><svg class="icon"
    xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!-- Font Awesome Free 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M61.77 401l17.5-20.15a19.92 19.92 0 0 0 5.07-14.19v-3.31C84.34 356 80.5 352 73 352H16a8 8 0 0 0-8 8v16a8 8 0 0 0 8 8h22.83a157.41 157.41 0 0 0-11 12.31l-5.61 7c-4 5.07-5.25 10.13-2.8 14.88l1.05 1.93c3 5.76 6.29 7.88 12.25 7.88h4.73c10.33 0 15.94 2.44 15.94 9.09 0 4.72-4.2 8.22-14.36 8.22a41.54 41.54 0 0 1-15.47-3.12c-6.49-3.88-11.74-3.5-15.6 3.12l-5.59 9.31c-3.72 6.13-3.19 11.72 2.63 15.94 7.71 4.69 20.38 9.44 37 9.44 34.16 0 48.5-22.75 48.5-44.12-.03-14.38-9.12-29.76-28.73-34.88zM496 224H176a16 16 0 0 0-16 16v32a16 16 0 0 0 16 16h320a16 16 0 0 0 16-16v-32a16 16 0 0 0-16-16zm0-160H176a16 16 0 0 0-16 16v32a16 16 0 0 0 16 16h320a16 16 0 0 0 16-16V80a16 16 0 0 0-16-16zm0 320H176a16 16 0 0 0-16 16v32a16 16 0 0 0 16 16h320a16 16 0 0 0 16-16v-32a16 16 0 0 0-16-16zM16 160h64a8 8 0 0 0 8-8v-16a8 8 0 0 0-8-8H64V40a8 8 0 0 0-8-8H32a8 8 0 0 0-7.14 4.42l-8 16A8 8 0 0 0 24 64h8v64H16a8 8 0 0 0-8 8v16a8 8 0 0 0 8 8zm-3.91 160H80a8 8 0 0 0 8-8v-16a8 8 0 0 0-8-8H41.32c3.29-10.29 48.34-18.68 48.34-56.44 0-29.06-25-39.56-44.47-39.56-21.36 0-33.8 10-40.46 18.75-4.37 5.59-3 10.84 2.8 15.37l8.58 6.88c5.61 4.56 11 2.47 16.12-2.44a13.44 13.44 0 0 1 9.46-3.84c3.33 0 9.28 1.56 9.28 8.75C51 248.19 0 257.31 0 304.59v4C0 316 5.08 320 12.09 320z"/></svg></button>

      <button 
        class="
          wrap-code-button
          tw-select-none 
          tw-mx-2 
          tw-hidden 
          group-[.is-open]:tw-block 
          group-[.is-wrap]:tw-text-fgColor-link 
          print:!tw-hidden" 
        title="Toggle code wrap"><svg class="icon"
    xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!-- Font Awesome Free 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M16 132h416c8.837 0 16-7.163 16-16V76c0-8.837-7.163-16-16-16H16C7.163 60 0 67.163 0 76v40c0 8.837 7.163 16 16 16zm0 160h416c8.837 0 16-7.163 16-16v-40c0-8.837-7.163-16-16-16H16c-8.837 0-16 7.163-16 16v40c0 8.837 7.163 16 16 16zm0 160h416c8.837 0 16-7.163 16-16v-40c0-8.837-7.163-16-16-16H16c-8.837 0-16 7.163-16 16v40c0 8.837 7.163 16 16 16z"/></svg></button>
      
      <button 
        class="
          copy-code-button
          tw-select-none
          tw-mx-2 
          tw-hidden
          group-[.is-open]:tw-block
          hover:tw-text-fgColor-link 
          print:!tw-hidden"
        title="Copy code">
          <span class="copy-icon tw-block"><svg class="icon"
    xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!-- Font Awesome Free 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M433.941 65.941l-51.882-51.882A48 48 0 0 0 348.118 0H176c-26.51 0-48 21.49-48 48v48H48c-26.51 0-48 21.49-48 48v320c0 26.51 21.49 48 48 48h224c26.51 0 48-21.49 48-48v-48h80c26.51 0 48-21.49 48-48V99.882a48 48 0 0 0-14.059-33.941zM266 464H54a6 6 0 0 1-6-6V150a6 6 0 0 1 6-6h74v224c0 26.51 21.49 48 48 48h96v42a6 6 0 0 1-6 6zm128-96H182a6 6 0 0 1-6-6V54a6 6 0 0 1 6-6h106v88c0 13.255 10.745 24 24 24h88v202a6 6 0 0 1-6 6zm6-256h-64V48h9.632c1.591 0 3.117.632 4.243 1.757l48.368 48.368a6 6 0 0 1 1.757 4.243V112z"/></svg></span>
          <span class="check-icon tw-hidden"><svg class="icon"
    xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!-- Font Awesome Free 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M173.898 439.404l-166.4-166.4c-9.997-9.997-9.997-26.206 0-36.204l36.203-36.204c9.997-9.998 26.207-9.998 36.204 0L192 312.69 432.095 72.596c9.997-9.997 26.207-9.997 36.204 0l36.203 36.204c9.997 9.997 9.997 26.206 0 36.204l-294.4 294.401c-9.998 9.997-26.207 9.997-36.204-.001z"/></svg></span>
      </button>
        
      <button 
        class="
          tw-select-none 
          tw-mx-2 
          tw-block 
          group-[.is-open]:tw-hidden 
          print:!tw-hidden" 
        disabled
        aria-hidden="true"><svg class="icon"
    xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!-- Font Awesome Free 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M328 256c0 39.8-32.2 72-72 72s-72-32.2-72-72 32.2-72 72-72 72 32.2 72 72zm104-72c-39.8 0-72 32.2-72 72s32.2 72 72 72 72-32.2 72-72-32.2-72-72-72zm-352 0c-39.8 0-72 32.2-72 72s32.2 72 72 72 72-32.2 72-72-32.2-72-72-72z"/></svg></button>
    </div>
  </div>
  <pre style="counter-reset: codeblock;" class="tw-block tw-m-0 tw-p-0"><code 
    id="codeblock-id-8" 
    class="
      chroma 
      !tw-block 
      tw-p-0
      tw-m-0
      tw-transition-[max-height] 
      tw-duration-500 
      tw-ease-in-out 
      group-[.is-closed]:!tw-max-h-0 
      group-[.is-wrap]:tw-text-wrap
      tw-overflow-y-hidden
      tw-overflow-x-auto
      tw-scrollbar-thin
      "><span class="line"><span class="cl">堆对象10-&gt;对象7 = 堆对象7；       //将堆对象7 挂在 堆对象10 下游
</span></span><span class="line"><span class="cl">堆对象4-&gt;对象7 = null；         //对象4 删除引用 对象7</span></span></code></pre>
</div>
<p><figure><a class="lightgallery" href="/899ed05a51664c9eb09bfecce8b2945a_2584106028258547979.png" title="场景3-01" data-thumbnail="/899ed05a51664c9eb09bfecce8b2945a_2584106028258547979.png" data-sub-html="<h2>场景3-01</h2><p>场景3-01</p>"><img  loading="lazy" src=/899ed05a51664c9eb09bfecce8b2945a_2584106028258547979.png srcset="/899ed05a51664c9eb09bfecce8b2945a_2584106028258547979_hu17491955434766395590.webp 800w, /899ed05a51664c9eb09bfecce8b2945a_2584106028258547979_hu15878298187677945364.webp 1200w, /899ed05a51664c9eb09bfecce8b2945a_2584106028258547979_hu12337658864882723256.webp 1600w"  alt="场景3-01" height="1080" width="1920"></a><figcaption class="image-caption">场景3-01</figcaption>
</figure></p>
<p><figure><a class="lightgallery" href="/cee749d8466d416f8a1ecb07d1c165de_7279062891071480723.png" title="场景3-02" data-thumbnail="/cee749d8466d416f8a1ecb07d1c165de_7279062891071480723.png" data-sub-html="<h2>场景3-02</h2><p>场景3-02</p>"><img  loading="lazy" src=/cee749d8466d416f8a1ecb07d1c165de_7279062891071480723.png srcset="/cee749d8466d416f8a1ecb07d1c165de_7279062891071480723_hu4848225349267722875.webp 800w, /cee749d8466d416f8a1ecb07d1c165de_7279062891071480723_hu14945042690824187415.webp 1200w, /cee749d8466d416f8a1ecb07d1c165de_7279062891071480723_hu18370260119637090497.webp 1600w"  alt="场景3-02" height="1080" width="1920"></a><figcaption class="image-caption">场景3-02</figcaption>
</figure></p>
<p><figure><a class="lightgallery" href="/7d0257110cd2437dac1c7835c43b2a73_10619206266764685590.png" title="场景3-03" data-thumbnail="/7d0257110cd2437dac1c7835c43b2a73_10619206266764685590.png" data-sub-html="<h2>场景3-03</h2><p>场景3-03</p>"><img  loading="lazy" src=/7d0257110cd2437dac1c7835c43b2a73_10619206266764685590.png srcset="/7d0257110cd2437dac1c7835c43b2a73_10619206266764685590_hu2317626888721642794.webp 800w, /7d0257110cd2437dac1c7835c43b2a73_10619206266764685590_hu7426576219452762627.webp 1200w, /7d0257110cd2437dac1c7835c43b2a73_10619206266764685590_hu14237904714814773317.webp 1600w"  alt="场景3-03" height="1080" width="1920"></a><figcaption class="image-caption">场景3-03</figcaption>
</figure></p>
<h4 id="场景四" class="headerLink">
    <a href="#%e5%9c%ba%e6%99%af%e5%9b%9b" class="header-mark"></a>7.2.4 场景四</h4><p>对象从一个栈对象删除引用，成为另一个堆对象的下游。</p>
<p>伪代码：</p>
<div class="code-block highlight is-open show-line-numbers  tw-group tw-my-2">
  <div class="
    code-block-title 
    
    tw-flex 
    tw-flex-row 
    tw-justify-between 
    tw-w-full tw-bg-bgColor-secondary
    ">      
    <button 
      class="
        tw-select-none 
        tw-mx-2 
        tw-block
        group-[.is-open]:tw-rotate-90
        tw-transition-[transform] 
        tw-duration-500 
        tw-ease-in-out
        print:!tw-hidden"
      disabled
      aria-hidden="true"><svg class="icon"
    xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!-- Font Awesome Free 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M285.476 272.971L91.132 467.314c-9.373 9.373-24.569 9.373-33.941 0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941 0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"/></svg></button>

    <div class="code-block-title-bar tw-w-full">
      <p class="tw-select-none !tw-my-1">text</p>
    </div>
    <div class="tw-flex">
      <button 
        class="
          line-number-button
          tw-select-none 
          tw-mx-2 
          tw-hidden 
          group-[.is-open]:tw-block 
          group-[.show-line-numbers]:tw-text-fgColor-link 
          print:!tw-hidden" 
        title="Toggle line numbers"><svg class="icon"
    xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!-- Font Awesome Free 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M61.77 401l17.5-20.15a19.92 19.92 0 0 0 5.07-14.19v-3.31C84.34 356 80.5 352 73 352H16a8 8 0 0 0-8 8v16a8 8 0 0 0 8 8h22.83a157.41 157.41 0 0 0-11 12.31l-5.61 7c-4 5.07-5.25 10.13-2.8 14.88l1.05 1.93c3 5.76 6.29 7.88 12.25 7.88h4.73c10.33 0 15.94 2.44 15.94 9.09 0 4.72-4.2 8.22-14.36 8.22a41.54 41.54 0 0 1-15.47-3.12c-6.49-3.88-11.74-3.5-15.6 3.12l-5.59 9.31c-3.72 6.13-3.19 11.72 2.63 15.94 7.71 4.69 20.38 9.44 37 9.44 34.16 0 48.5-22.75 48.5-44.12-.03-14.38-9.12-29.76-28.73-34.88zM496 224H176a16 16 0 0 0-16 16v32a16 16 0 0 0 16 16h320a16 16 0 0 0 16-16v-32a16 16 0 0 0-16-16zm0-160H176a16 16 0 0 0-16 16v32a16 16 0 0 0 16 16h320a16 16 0 0 0 16-16V80a16 16 0 0 0-16-16zm0 320H176a16 16 0 0 0-16 16v32a16 16 0 0 0 16 16h320a16 16 0 0 0 16-16v-32a16 16 0 0 0-16-16zM16 160h64a8 8 0 0 0 8-8v-16a8 8 0 0 0-8-8H64V40a8 8 0 0 0-8-8H32a8 8 0 0 0-7.14 4.42l-8 16A8 8 0 0 0 24 64h8v64H16a8 8 0 0 0-8 8v16a8 8 0 0 0 8 8zm-3.91 160H80a8 8 0 0 0 8-8v-16a8 8 0 0 0-8-8H41.32c3.29-10.29 48.34-18.68 48.34-56.44 0-29.06-25-39.56-44.47-39.56-21.36 0-33.8 10-40.46 18.75-4.37 5.59-3 10.84 2.8 15.37l8.58 6.88c5.61 4.56 11 2.47 16.12-2.44a13.44 13.44 0 0 1 9.46-3.84c3.33 0 9.28 1.56 9.28 8.75C51 248.19 0 257.31 0 304.59v4C0 316 5.08 320 12.09 320z"/></svg></button>

      <button 
        class="
          wrap-code-button
          tw-select-none 
          tw-mx-2 
          tw-hidden 
          group-[.is-open]:tw-block 
          group-[.is-wrap]:tw-text-fgColor-link 
          print:!tw-hidden" 
        title="Toggle code wrap"><svg class="icon"
    xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!-- Font Awesome Free 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M16 132h416c8.837 0 16-7.163 16-16V76c0-8.837-7.163-16-16-16H16C7.163 60 0 67.163 0 76v40c0 8.837 7.163 16 16 16zm0 160h416c8.837 0 16-7.163 16-16v-40c0-8.837-7.163-16-16-16H16c-8.837 0-16 7.163-16 16v40c0 8.837 7.163 16 16 16zm0 160h416c8.837 0 16-7.163 16-16v-40c0-8.837-7.163-16-16-16H16c-8.837 0-16 7.163-16 16v40c0 8.837 7.163 16 16 16z"/></svg></button>
      
      <button 
        class="
          copy-code-button
          tw-select-none
          tw-mx-2 
          tw-hidden
          group-[.is-open]:tw-block
          hover:tw-text-fgColor-link 
          print:!tw-hidden"
        title="Copy code">
          <span class="copy-icon tw-block"><svg class="icon"
    xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!-- Font Awesome Free 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M433.941 65.941l-51.882-51.882A48 48 0 0 0 348.118 0H176c-26.51 0-48 21.49-48 48v48H48c-26.51 0-48 21.49-48 48v320c0 26.51 21.49 48 48 48h224c26.51 0 48-21.49 48-48v-48h80c26.51 0 48-21.49 48-48V99.882a48 48 0 0 0-14.059-33.941zM266 464H54a6 6 0 0 1-6-6V150a6 6 0 0 1 6-6h74v224c0 26.51 21.49 48 48 48h96v42a6 6 0 0 1-6 6zm128-96H182a6 6 0 0 1-6-6V54a6 6 0 0 1 6-6h106v88c0 13.255 10.745 24 24 24h88v202a6 6 0 0 1-6 6zm6-256h-64V48h9.632c1.591 0 3.117.632 4.243 1.757l48.368 48.368a6 6 0 0 1 1.757 4.243V112z"/></svg></span>
          <span class="check-icon tw-hidden"><svg class="icon"
    xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!-- Font Awesome Free 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M173.898 439.404l-166.4-166.4c-9.997-9.997-9.997-26.206 0-36.204l36.203-36.204c9.997-9.998 26.207-9.998 36.204 0L192 312.69 432.095 72.596c9.997-9.997 26.207-9.997 36.204 0l36.203 36.204c9.997 9.997 9.997 26.206 0 36.204l-294.4 294.401c-9.998 9.997-26.207 9.997-36.204-.001z"/></svg></span>
      </button>
        
      <button 
        class="
          tw-select-none 
          tw-mx-2 
          tw-block 
          group-[.is-open]:tw-hidden 
          print:!tw-hidden" 
        disabled
        aria-hidden="true"><svg class="icon"
    xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!-- Font Awesome Free 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M328 256c0 39.8-32.2 72-72 72s-72-32.2-72-72 32.2-72 72-72 72 32.2 72 72zm104-72c-39.8 0-72 32.2-72 72s32.2 72 72 72 72-32.2 72-72-32.2-72-72-72zm-352 0c-39.8 0-72 32.2-72 72s32.2 72 72 72 72-32.2 72-72-32.2-72-72-72z"/></svg></button>
    </div>
  </div>
  <pre style="counter-reset: codeblock;" class="tw-block tw-m-0 tw-p-0"><code 
    id="codeblock-id-9" 
    class="
      chroma 
      !tw-block 
      tw-p-0
      tw-m-0
      tw-transition-[max-height] 
      tw-duration-500 
      tw-ease-in-out 
      group-[.is-closed]:!tw-max-h-0 
      group-[.is-wrap]:tw-text-wrap
      tw-overflow-y-hidden
      tw-overflow-x-auto
      tw-scrollbar-thin
      "><span class="line"><span class="cl">堆对象10-&gt;对象7 = 堆对象7；       //将堆对象7 挂在 堆对象10 下游
</span></span><span class="line"><span class="cl">堆对象4-&gt;对象7 = null；         //对象4 删除引用 对象7</span></span></code></pre>
</div>
<p><figure><a class="lightgallery" href="/c1cc894d7bef4f1ba26e92c7427de8a5_10823023469696990383.png" title="场景4-01" data-thumbnail="/c1cc894d7bef4f1ba26e92c7427de8a5_10823023469696990383.png" data-sub-html="<h2>场景4-01</h2><p>场景4-01</p>"><img  loading="lazy" src=/c1cc894d7bef4f1ba26e92c7427de8a5_10823023469696990383.png srcset="/c1cc894d7bef4f1ba26e92c7427de8a5_10823023469696990383_hu11508593655041828611.webp 800w, /c1cc894d7bef4f1ba26e92c7427de8a5_10823023469696990383_hu8454540718758388171.webp 1200w, /c1cc894d7bef4f1ba26e92c7427de8a5_10823023469696990383_hu8505886094225409142.webp 1600w"  alt="场景4-01" height="1080" width="1920"></a><figcaption class="image-caption">场景4-01</figcaption>
</figure></p>
<p><figure><a class="lightgallery" href="/0c64f5d24f674a90942170b8998deafa_12010207949237001455.png" title="场景4-02" data-thumbnail="/0c64f5d24f674a90942170b8998deafa_12010207949237001455.png" data-sub-html="<h2>场景4-02</h2><p>场景4-02</p>"><img  loading="lazy" src=/0c64f5d24f674a90942170b8998deafa_12010207949237001455.png srcset="/0c64f5d24f674a90942170b8998deafa_12010207949237001455_hu13180692875327069589.webp 800w, /0c64f5d24f674a90942170b8998deafa_12010207949237001455_hu12640638688570391368.webp 1200w, /0c64f5d24f674a90942170b8998deafa_12010207949237001455_hu12138072401420259941.webp 1600w"  alt="场景4-02" height="1080" width="1920"></a><figcaption class="image-caption">场景4-02</figcaption>
</figure></p>
<p><figure><a class="lightgallery" href="/e25db1900a4d404189fdcb61d33ac5d2_1522871087836250696.png" title="场景4-03" data-thumbnail="/e25db1900a4d404189fdcb61d33ac5d2_1522871087836250696.png" data-sub-html="<h2>场景4-03</h2><p>场景4-03</p>"><img  loading="lazy" src=/e25db1900a4d404189fdcb61d33ac5d2_1522871087836250696.png srcset="/e25db1900a4d404189fdcb61d33ac5d2_1522871087836250696_hu2237985826821598362.webp 800w, /e25db1900a4d404189fdcb61d33ac5d2_1522871087836250696_hu13820943425239668943.webp 1200w, /e25db1900a4d404189fdcb61d33ac5d2_1522871087836250696_hu1235913274493190432.webp 1600w"  alt="场景4-03" height="1080" width="1920"></a><figcaption class="image-caption">场景4-03</figcaption>
</figure></p>
<p>Go 中的混合写屏障满足<strong>弱三色不变式</strong>，结合了删除写屏障和插入写屏障的优点，<strong>只需要在开始时并发扫描各个 goroutine 的栈</strong>，使其变黑并一直保持，这个过程不需要 STW，而标记结束后，因为栈在扫描后始终是黑色的，也无需再进行 re-scan 操作了，减少了 STW 的时间。</p>
<h2 id="总结" class="headerLink">
    <a href="#%e6%80%bb%e7%bb%93" class="header-mark"></a>8 总结</h2><p>GoV1.3：普通标记清除法，整体过程需要启动 STW，效率极低。</p>
<p>GoV1.5：三色标记法，堆空间启动写屏障，栈空间不启动，全部扫描之后，需要重新扫描一次栈(需要 STW )，效率普通。</p>
<p>GoV1.8：三色标记法，混合写屏障机制， 栈空间不启动，堆空间启动。整个过程几乎不需要STW，效率较高。</p>
<h2 id="参考" class="headerLink">
    <a href="#%e5%8f%82%e8%80%83" class="header-mark"></a>9 参考</h2><ul>
<li><a href="https://community.apinto.com/d/34057-golang-gc" target="_blank" rel="noopener noreferrer">一文弄懂 Golang GC、三色标记、混合写屏障机制</a></li>
<li><a href="https://www.kancloud.cn/aceld/golang/1958308" target="_blank" rel="noopener noreferrer">Golang三色标记+混合写屏障GC模式全分析</a></li>
<li><a href="https://www.bilibili.com/video/BV1wz4y1y7Kd/" target="_blank" rel="noopener noreferrer">Golang中GC回收机制三色标记与混合写屏障</a></li>
</ul>
</div>

        <div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>更新于 2023-08-22&nbsp;<a class="git-hash" href="https://github.com/xiaobinqt/xiaobinqt.github.io/commit/72ba15133e4d2ef99ed255036d020562c5a8915a" target="_blank" title="commit by weibin(xiaobinqt@163.com) 72ba15133e4d2ef99ed255036d020562c5a8915a: update go-gc.md" rel="noopener noreferrer">
                                    <svg class="icon"
    xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!-- Font Awesome Free 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M440.667 182.109l7.143-40c1.313-7.355-4.342-14.109-11.813-14.109h-74.81l14.623-81.891C377.123 38.754 371.468 32 363.997 32h-40.632a12 12 0 0 0-11.813 9.891L296.175 128H197.54l14.623-81.891C213.477 38.754 207.822 32 200.35 32h-40.632a12 12 0 0 0-11.813 9.891L132.528 128H53.432a12 12 0 0 0-11.813 9.891l-7.143 40C33.163 185.246 38.818 192 46.289 192h74.81L98.242 320H19.146a12 12 0 0 0-11.813 9.891l-7.143 40C-1.123 377.246 4.532 384 12.003 384h74.81L72.19 465.891C70.877 473.246 76.532 480 84.003 480h40.632a12 12 0 0 0 11.813-9.891L151.826 384h98.634l-14.623 81.891C234.523 473.246 240.178 480 247.65 480h40.632a12 12 0 0 0 11.813-9.891L315.472 384h79.096a12 12 0 0 0 11.813-9.891l7.143-40c1.313-7.355-4.342-14.109-11.813-14.109h-74.81l22.857-128h79.096a12 12 0 0 0 11.813-9.891zM261.889 320h-98.634l22.857-128h98.634l-22.857 128z"/></svg>72ba1513</a></span>
            </div>
            <div class="post-info-license"></div>
        </div>
        <div class="post-info-line print:!tw-hidden">
            <div class="post-info-md"><span><a class="link-to-mardown" href=/go-gc/index.md target="_blank" rel="noopener noreferrer">阅读原始文档</a>
                    </span><span>|&nbsp;<a class="link-to-source" href=https://github.com/xiaobinqt/xiaobinqt.github.io/blob/main/content/posts/go/go-gc.md target="_blank" rel="noopener noreferrer">查看源代码</a>
                    </span><span>|&nbsp;<a class="link-to-edit" href=https://github.com/xiaobinqt/xiaobinqt.github.io/edit/main/content/posts/go/go-gc.md target="_blank" rel="noopener noreferrer">编辑此页</a>
                    </span></div>
            <div class="post-info-share"><button title="分享到 微博" data-sharer="weibo" data-url="https://www.xiaobinqt.cn/go-gc/" data-title="Go GC 垃圾回收" data-image="https://cdn.xiaobinqt.cn/xiaobinqt.io/20221118/74f00ad9b278426887ea4348fd7a0e1c.png"><svg class="icon"
    xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!-- Font Awesome Free 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M407 177.6c7.6-24-13.4-46.8-37.4-41.7-22 4.8-28.8-28.1-7.1-32.8 50.1-10.9 92.3 37.1 76.5 84.8-6.8 21.2-38.8 10.8-32-10.3zM214.8 446.7C108.5 446.7 0 395.3 0 310.4c0-44.3 28-95.4 76.3-143.7C176 67 279.5 65.8 249.9 161c-4 13.1 12.3 5.7 12.3 6 79.5-33.6 140.5-16.8 114 51.4-3.7 9.4 1.1 10.9 8.3 13.1 135.7 42.3 34.8 215.2-169.7 215.2zm143.7-146.3c-5.4-55.7-78.5-94-163.4-85.7-84.8 8.6-148.8 60.3-143.4 116s78.5 94 163.4 85.7c84.8-8.6 148.8-60.3 143.4-116zM347.9 35.1c-25.9 5.6-16.8 43.7 8.3 38.3 72.3-15.2 134.8 52.8 111.7 124-7.4 24.2 29.1 37 37.4 12 31.9-99.8-55.1-195.9-157.4-174.3zm-78.5 311c-17.1 38.8-66.8 60-109.1 46.3-40.8-13.1-58-53.4-40.3-89.7 17.7-35.4 63.1-55.4 103.4-45.1 42 10.8 63.1 50.2 46 88.5zm-86.3-30c-12.9-5.4-30 .3-38 12.9-8.3 12.9-4.3 28 8.6 34 13.1 6 30.8.3 39.1-12.9 8-13.1 3.7-28.3-9.7-34zm32.6-13.4c-5.1-1.7-11.4.6-14.3 5.4-2.9 5.1-1.4 10.6 3.7 12.9 5.1 2 11.7-.3 14.6-5.4 2.8-5.2 1.1-10.9-4-12.9z"/></svg></button><button title="分享到 百度" data-sharer="baidu" data-url="https://www.xiaobinqt.cn/go-gc/" data-title="Go GC 垃圾回收"><svg class="icon" role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>Baidu</title><path d="M9.154 0C7.71 0 6.54 1.658 6.54 3.707c0 2.051 1.171 3.71 2.615 3.71 1.446 0 2.614-1.659 2.614-3.71C11.768 1.658 10.6 0 9.154 0zm7.025.594C14.86.58 13.347 2.589 13.2 3.927c-.187 1.745.25 3.487 2.179 3.735 1.933.25 3.175-1.806 3.422-3.364.252-1.555-.995-3.364-2.362-3.674a1.218 1.218 0 0 0-.261-.03zM3.582 5.535a2.811 2.811 0 0 0-.156.008c-2.118.19-2.428 3.24-2.428 3.24-.287 1.41.686 4.425 3.297 3.864 2.617-.561 2.262-3.68 2.183-4.362-.125-1.018-1.292-2.773-2.896-2.75zm16.534 1.753c-2.308 0-2.617 2.119-2.617 3.616 0 1.43.121 3.425 2.988 3.362 2.867-.063 2.553-3.238 2.553-3.988 0-.745-.62-2.99-2.924-2.99zm-8.264 2.478c-1.424.014-2.708.925-3.323 1.947-1.118 1.868-2.863 3.05-3.112 3.363-.25.309-3.61 2.116-2.864 5.42.746 3.301 3.365 3.237 3.365 3.237s1.93.19 4.171-.31c2.24-.495 4.17.123 4.17.123s5.233 1.748 6.665-1.616c1.43-3.364-.808-5.109-.808-5.109s-2.99-2.306-4.736-4.798c-1.072-1.665-2.348-2.268-3.528-2.257zm-2.234 3.84l1.542.024v8.197H7.758c-1.47-.291-2.055-1.292-2.13-1.462-.072-.173-.488-.976-.268-2.343.635-2.049 2.447-2.196 2.447-2.196h1.81zm3.964 2.39v3.881c.096.413.612.488.612.488h1.614v-4.343h1.689v5.782h-3.915c-1.517-.39-1.59-1.465-1.59-1.465v-4.317zm-5.458 1.147c-.66.197-.978.708-1.05.928-.076.22-.247.78-.1 1.269.294 1.095 1.248 1.144 1.248 1.144h1.37v-3.34z"/></svg></button></div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><svg class="icon"
    xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><!-- Font Awesome Free 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M497.941 225.941L286.059 14.059A48 48 0 0 0 252.118 0H48C21.49 0 0 21.49 0 48v204.118a48 48 0 0 0 14.059 33.941l211.882 211.882c18.744 18.745 49.136 18.746 67.882 0l204.118-204.118c18.745-18.745 18.745-49.137 0-67.882zM112 160c-26.51 0-48-21.49-48-48s21.49-48 48-48 48 21.49 48 48-21.49 48-48 48zm513.941 133.823L421.823 497.941c-18.745 18.745-49.137 18.745-67.882 0l-.36-.36L527.64 323.522c16.999-16.999 26.36-39.6 26.36-63.64s-9.362-46.641-26.36-63.64L331.397 0h48.721a48 48 0 0 1 33.941 14.059l211.882 211.882c18.745 18.745 18.745 49.137 0 67.882z"/></svg>&nbsp;<a href="/tags/golang/">Golang</a>,&nbsp;<a href="/tags/gc/">GC</a></section>
        <section class="print:!tw-hidden">
            <span><button class="tw-text-fgColor-link-muted hover:tw-text-fgColor-link-muted-hover" onclick="window.history.back();">返回</button></span>&nbsp;|&nbsp;<span><a href="/">主页</a></span>
        </section>
    </div>

    <div class="post-nav print:tw-hidden"><a href="/github-actions-replace-env-vars-in-file/" class="prev" rel="prev" title="Github Actions replace env vars in file"><svg class="icon"
    xmlns="http://www.w3.org/2000/svg" viewBox="0 0 256 512"><!-- Font Awesome Free 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M31.7 239l136-136c9.4-9.4 24.6-9.4 33.9 0l22.6 22.6c9.4 9.4 9.4 24.6 0 33.9L127.9 256l96.4 96.4c9.4 9.4 9.4 24.6 0 33.9L201.7 409c-9.4 9.4-24.6 9.4-33.9 0l-136-136c-9.5-9.4-9.5-24.6-.1-34z"/></svg>Github Actions replace env vars in file</a>
            <a href="/redis-break-pierce-avalanche/" class="next" rel="next" title="Redis 缓存击穿、缓存穿透、缓存雪崩">Redis 缓存击穿、缓存穿透、缓存雪崩<svg class="icon"
    xmlns="http://www.w3.org/2000/svg" viewBox="0 0 256 512"><!-- Font Awesome Free 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M224.3 273l-136 136c-9.4 9.4-24.6 9.4-33.9 0l-22.6-22.6c-9.4-9.4-9.4-24.6 0-33.9l96.4-96.4-96.4-96.4c-9.4-9.4-9.4-24.6 0-33.9L54.3 103c9.4-9.4 24.6-9.4 33.9 0l136 136c9.5 9.4 9.5 24.6.1 34z"/></svg></a></div>
</div>
<div id="comments" class="print:!tw-hidden tw-pt-32 tw-pb-8"><div id="gitalk" class="comment"></div><noscript>
                Please enable JavaScript to view the comments powered by <a href="https://github.com/gitalk/gitalk"></a>Gitalk</a>.
            </noscript></div></article></div>
        </main><footer class="footer">
        <div class="footer-container"><div class="footer-line"><svg class="icon"
    xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!-- Font Awesome Free 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M256 8C119.033 8 8 119.033 8 256s111.033 248 248 248 248-111.033 248-248S392.967 8 256 8zm0 448c-110.532 0-200-89.451-200-200 0-110.531 89.451-200 200-200 110.532 0 200 89.451 200 200 0 110.532-89.451 200-200 200zm107.351-101.064c-9.614 9.712-45.53 41.396-104.065 41.396-82.43 0-140.484-61.425-140.484-141.567 0-79.152 60.275-139.401 139.762-139.401 55.531 0 88.738 26.62 97.593 34.779a11.965 11.965 0 0 1 1.936 15.322l-18.155 28.113c-3.841 5.95-11.966 7.282-17.499 2.921-8.595-6.776-31.814-22.538-61.708-22.538-48.303 0-77.916 35.33-77.916 80.082 0 41.589 26.888 83.692 78.277 83.692 32.657 0 56.843-19.039 65.726-27.225 5.27-4.857 13.596-4.039 17.82 1.738l19.865 27.17a11.947 11.947 0 0 1-1.152 15.518z"/></svg>2018 - 2024<span class="author">&nbsp;<a href="https://github.com/xiaobinqt" target="_blank" rel="noopener noreferrer">xiaobinqt</a></span>&nbsp;|&nbsp;<span class="license"><a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span></div>
            <div class="footer-line"></div>
            <div class="footer-line">
            </div>
        </div></footer></div>

    <div id="fixed-buttons" class="print:!tw-hidden"><a href="#back-to-top" id="back-to-top-button" class="fixed-button tw-transition-opacity tw-opacity-0" title="回到顶部">
            <svg class="icon"
    xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!-- Font Awesome Free 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M34.9 289.5l-22.2-22.2c-9.4-9.4-9.4-24.6 0-33.9L207 39c9.4-9.4 24.6-9.4 33.9 0l194.3 194.3c9.4 9.4 9.4 24.6 0 33.9L413 289.4c-9.5 9.5-25 9.3-34.3-.4L264 168.6V456c0 13.3-10.7 24-24 24h-32c-13.3 0-24-10.7-24-24V168.6L69.2 289.1c-9.3 9.8-24.8 10-34.3.4z"/></svg>
        </a><a href="#comments" id="view-comments" class="fixed-button" title="查看评论">
            <svg class="icon"
    xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!-- Font Awesome Free 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M256 32C114.6 32 0 125.1 0 240c0 49.6 21.4 95 57 130.7C44.5 421.1 2.7 466 2.2 466.5c-2.2 2.3-2.8 5.7-1.5 8.7S4.8 480 8 480c66.3 0 116-31.8 140.6-51.4 32.7 12.3 69 19.4 107.4 19.4 141.4 0 256-93.1 256-208S397.4 32 256 32z"/></svg>
        </a></div><script type="module">
        (async () => {
            const supportSpeculationRules = HTMLScriptElement.supports && HTMLScriptElement.supports("speculationrules");
            if (!supportSpeculationRules) {
              await import("\/lib\/instant.page\/instantpage.min.js");
            }
        })();
    </script><link rel="stylesheet" href="/lib/gitalk/gitalk.min.css"><link rel="stylesheet" href="/lib/lightgallery/lightgallery.min.css">
<script>window.config={"algoliasearch.min.js":"/lib/algoliasearch/algoliasearch-lite.umd.min.js","autocomplete.min.js":"/lib/autocomplete/autocomplete.min.js","comment":{"gitalk":{"admin":["xiaobinqt"],"clientID":"47b15de6c2d8a0f8d707","clientSecret":"c70556c8b3a3b38ea7c72e539ff3b37d5bc1b4f3","id":"b6184283b223dead605ae636e54dd05a","owner":"xiaobinqt","repo":"xiaobinqt.github.io","title":"Go GC 垃圾回收"}},"lightGallery":{"actualSize":false,"exThumbImage":"data-thumbnail","hideBarsDelay":2000,"selector":".lightgallery","speed":400,"thumbContHeight":80,"thumbWidth":80,"thumbnail":true},"search":{"algoliaAppID":"U7QBQFMJWZ","algoliaIndex":"xiaobinqt.io","algoliaSearchKey":"1679f7a929fbfff6be0d47ba33947c03","highlightTag":"em","maxResultLength":20,"noResultsFound":"没有找到结果","snippetLength":50,"type":"algolia"},"sharerjs":true,"table":{"sort":true}};</script><script
    src="/lib/tablesort/tablesort.min.js"
    
  ></script><script
    src="/lib/lightgallery/lightgallery.min.js"
    
  ></script><script
    src="/lib/lightgallery/lg-thumbnail.min.js"
    
  ></script><script
    src="/lib/lightgallery/lg-zoom.min.js"
    
  ></script><script
    src="/lib/sharer/sharer.min.js"
    
  ></script><script
    src="/js/theme.min.js"
    
      defer
    
  ></script><script
    src="/lib/gitalk/gitalk.min.js"
    
  ></script><script
    src="/js/gitalk.min.js"
    
      defer
    
  ></script>
    
    <script type="speculationrules">
        {
          "prerender": [
            {
              "where": { "href_matches": "/*" },
              "eagerness": "moderate"
            }
          ]
        }
    </script>
      
</body>

</html>
