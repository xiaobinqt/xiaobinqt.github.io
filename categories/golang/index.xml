<rss xmlns:atom="http://www.w3.org/2005/Atom" version="2.0">
    <channel>
        <title>golang - åˆ†ç±» - xiaobinqt åšå®¢ - æŠ€æœ¯æ”¹å˜ç”Ÿæ´»</title>
        <link>https://www.xiaobinqt.cn/categories/golang/</link>
        <description>golang - åˆ†ç±» - xiaobinqt åšå®¢ - æŠ€æœ¯æ”¹å˜ç”Ÿæ´»</description>
        <generator>Hugo -- gohugo.io</generator><language>zh-CN</language><managingEditor>xiaobinqt@163.com (xiaobinqt)</managingEditor>
            <webMaster>xiaobinqt@163.com (xiaobinqt)</webMaster><copyright>This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.</copyright><lastBuildDate>Sat, 28 Jan 2023 00:00:00 &#43;0000</lastBuildDate><atom:link href="https://www.xiaobinqt.cn/categories/golang/" rel="self" type="application/rss+xml" /><item>
    <title>Go ç¼–è¯‘æ ‡ç­¾ build tag</title>
    <link>https://www.xiaobinqt.cn/go-build-tag/</link>
    <pubDate>Sat, 28 Jan 2023 00:00:00 &#43;0000</pubDate><author>
        <name>xiaobinqt</name>
    </author><guid>https://www.xiaobinqt.cn/go-build-tag/</guid>
    <description><![CDATA[<!-- authorï¼š xiaobinqt -->
<!-- emailï¼š xiaobinqt@163.com -->
<!-- https://xiaobinqt.github.io -->
<!-- https://www.xiaobinqt.cn -->
<h2 id="ç®€ä»‹" class="headerLink">
    <a href="#%e7%ae%80%e4%bb%8b" class="header-mark"></a>ç®€ä»‹</h2><p>åœ¨ Go ä¸­ï¼Œbuild tag æ˜¯æ·»åŠ åˆ°ä»£ç ä¸­ç¬¬ä¸€è¡Œï¼Œæ¥æ ‡è¯†ç¼–è¯‘ç›¸å…³ä¿¡æ¯çš„ï¼Œbuild tag å†³å®šäº†å½“å‰æ–‡ä»¶æ˜¯å¦ä¼šè¢«å½“å‰ package æ‰€åŒ…å«ï¼Œç”¨äºé™åˆ¶ä¸€æ•´ä¸ªæ–‡ä»¶æ˜¯å¦åº”è¯¥è¢«ç¼–è¯‘å…¥æœ€ç»ˆçš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œè€Œä¸æ˜¯ä¸€ä¸ªæ–‡ä»¶ä¸­çš„éƒ¨åˆ†ä»£ç ç‰‡æ®µã€‚</p>
<p>Go <strong><ruby>ç¼–è¯‘æ ‡ç­¾<rt>build tag</rt></ruby></strong>è¯­æ³•å¦‚ä¸‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">// +build [tag]
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>build tags æ–‡ä»¶é¡¶éƒ¨é™„è¿‘ï¼Œå‰é¢åªèƒ½æœ‰ç©ºè¡Œå’Œå…¶ä»–è¡Œæ³¨é‡Šã€‚</li>
<li>ç¼–è¯‘æ ‡è®°å¿…é¡»å‡ºç°åœ¨ package å­å¥ä¹‹å‰ï¼Œå¹¶ä¸”ä¸ºäº†ä¸åŒ…æ–‡æ¡£åŒºåˆ†å¼€æ¥ï¼Œå®ƒ<strong>å¿…é¡»</strong>åè·Ÿä¸€ä¸ªç©ºè¡Œã€‚</li>
</ul>
<h2 id="ç¼–è¯‘æ ‡ç­¾çš„é€»è¾‘" class="headerLink">
    <a href="#%e7%bc%96%e8%af%91%e6%a0%87%e7%ad%be%e7%9a%84%e9%80%bb%e8%be%91" class="header-mark"></a>ç¼–è¯‘æ ‡ç­¾çš„é€»è¾‘</h2><p>å½“åœ¨ä¸€ä¸ªåŒ…ä¸­ä½¿ç”¨å¤šä¸ªæ ‡ç­¾æ—¶ä¼šä½¿ç”¨ bool é€»è¾‘è¿›è¡Œäº¤äº’ï¼Œå…·ä½“å–å†³äºæˆ‘ä»¬å¦‚ä½•è¿›è¡Œå£°æ˜çš„ã€‚</p>
<p>Build tags éµå¾ªä»¥ä¸‹ä¸‰ä¸ªè§„åˆ™ï¼š</p>
<ul>
<li>ä»¥ç©ºæ ¼åˆ†éš”çš„æ ‡ç­¾å°†åœ¨<code>OR</code>é€»è¾‘ä¸‹è¿›è¡Œè§£é‡Šã€‚</li>
<li>é€—å·åˆ†éš”çš„æ ‡ç­¾å°†åœ¨<code>AND</code>é€»è¾‘ä¸‹è¿›è¡Œè§£é‡Šã€‚</li>
<li>æ¯ä¸ªæœ¯è¯­éƒ½æ˜¯ä¸€ä¸ªå­—æ¯æ•°å­—å•è¯ï¼Œå¦‚æœå‰é¢æœ‰<code>!</code>å®ƒæ„å‘³ç€å®ƒè¢«å¦å®šã€‚</li>
</ul>
<h3 id="or-æ ‡ç­¾é€»è¾‘" class="headerLink">
    <a href="#or-%e6%a0%87%e7%ad%be%e9%80%bb%e8%be%91" class="header-mark"></a>or æ ‡ç­¾é€»è¾‘</h3><p>ç»™å®šæ ‡ç­¾ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">// +build tag1 tag2
</span></span></code></pre></td></tr></table>
</div>
</div><p>OR è§£é‡Šæ˜¯ï¼Œå¦‚æœåœ¨æ‰§è¡Œ build æ„å»ºå‘½ä»¤æ—¶å­˜åœ¨ tag1 æˆ– tag2ï¼Œåˆ™å°†åŒ…å«æ­¤æ–‡ä»¶ã€‚</p>
<h3 id="and-æ ‡ç­¾é€»è¾‘" class="headerLink">
    <a href="#and-%e6%a0%87%e7%ad%be%e9%80%bb%e8%be%91" class="header-mark"></a>and æ ‡ç­¾é€»è¾‘</h3><p>å¦‚æœæˆ‘ä»¬ä½¿ç”¨æ ‡ç­¾ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">// +build tag1, tag2
</span></span></code></pre></td></tr></table>
</div>
</div><p>è§£é‡Šæ˜¯ tag1 ä¸”ï¼ˆANDï¼‰ tag2 å¿…é¡»å­˜åœ¨äº build æ„å»ºå‘½ä»¤ä¸­ï¼Œæˆ‘ä»¬çš„æ–‡ä»¶æ‰èƒ½åŒ…å«åœ¨ç¼–è¯‘ä¸­ã€‚</p>
<h3 id="éæ ‡ç­¾é€»è¾‘" class="headerLink">
    <a href="#%e9%9d%9e%e6%a0%87%e7%ad%be%e9%80%bb%e8%be%91" class="header-mark"></a>ï¼éæ ‡ç­¾é€»è¾‘</h3><p>å¦‚æœæˆ‘ä»¬ä½¿ç”¨æ ‡ç­¾</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"> // +build !tag1
</span></span></code></pre></td></tr></table>
</div>
</div><p>è§£é‡Šæ˜¯ï¼Œé tag1ï¼Œæˆ‘ä»¬çš„æ–‡ä»¶æ‰ä¼š build ç¼–è¯‘</p>
<h2 id="å¦‚ä½•ä½¿ç”¨" class="headerLink">
    <a href="#%e5%a6%82%e4%bd%95%e4%bd%bf%e7%94%a8" class="header-mark"></a>å¦‚ä½•ä½¿ç”¨</h2><h3 id="æ–°å»º-build-tag" class="headerLink">
    <a href="#%e6%96%b0%e5%bb%ba-build-tag" class="header-mark"></a>æ–°å»º build tag</h3><p>æˆ‘ä»¬æ–°å»ºä¸€ä¸ª buildtag æ–‡ä»¶å¤¹ï¼Œå¹¶åœ¨æ–‡ä»¶å¤¹ä¸‹æ–°å»ºå¦‚ä¸‹4ä¸ªç©ºæ–‡ä»¶ï¼Œå¦‚ä¸‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">.
</span></span><span class="line"><span class="cl">â”œâ”€â”€ dev.go
</span></span><span class="line"><span class="cl">â”œâ”€â”€ main.go
</span></span><span class="line"><span class="cl">â”œâ”€â”€ prod.go
</span></span><span class="line"><span class="cl">â”œâ”€â”€ test.go
</span></span><span class="line"><span class="cl">â””â”€â”€ without.go
</span></span></code></pre></td></tr></table>
</div>
</div><p>æˆ‘ä»¬æ‰“å¼€ main.go è¾“å…¥ä»£ç å¦‚ä¸‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="s">&#34;fmt&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">configArr</span> <span class="p">[]</span><span class="kt">string</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">conf</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">configArr</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>æˆ‘ä»¬æ‰“å¼€ dev.go è¾“å…¥ä»£ç å¦‚ä¸‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// +build dev
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">init</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">configArr</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">configArr</span><span class="p">,</span> <span class="s">&#34;mysql dev&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>æˆ‘ä»¬æ‰“å¼€ prod.go è¾“å…¥ä»£ç å¦‚ä¸‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// +build prod
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">init</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">configArr</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">configArr</span><span class="p">,</span> <span class="s">&#34;mysql prod&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>æˆ‘ä»¬æ‰“å¼€ test.go è¾“å…¥ä»£ç å¦‚ä¸‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// +build test1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">init</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">configArr</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">configArr</span><span class="p">,</span> <span class="s">&#34;mysql test&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>æˆ‘ä»¬æ‰“å¼€ without.go è¾“å…¥ä»£ç å¦‚ä¸‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// +build !without
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">init</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">configArr</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">configArr</span><span class="p">,</span> <span class="s">&#34;mysql without&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="ä½¿ç”¨-tags-ç¼–è¯‘" class="headerLink">
    <a href="#%e4%bd%bf%e7%94%a8-tags-%e7%bc%96%e8%af%91" class="header-mark"></a>ä½¿ç”¨ tags ç¼–è¯‘</h3><h4 id="1-æ²¡æœ‰tagç¼–è¯‘" class="headerLink">
    <a href="#1-%e6%b2%a1%e6%9c%89tag%e7%bc%96%e8%af%91" class="header-mark"></a>1. æ²¡æœ‰tagç¼–è¯‘</h4><p>æˆ‘ä»¬ä½¿ç”¨</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">go build
</span></span></code></pre></td></tr></table>
</div>
</div><p>åœ¨æ–‡ä»¶å¤¹é‡Œç”Ÿæˆäº†äºŒè¿›åˆ¶æ‰§è¡Œæ–‡ä»¶ buildtagï¼Œæˆ‘ä»¬æ‰§è¡Œä¸€ä¸‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">âœ ./buildtag 
</span></span></code></pre></td></tr></table>
</div>
</div><p>è¾“å‡ºï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">mysql without
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="2-å•ä¸ªtagç¼–è¯‘" class="headerLink">
    <a href="#2-%e5%8d%95%e4%b8%aatag%e7%bc%96%e8%af%91" class="header-mark"></a>2. å•ä¸ªtagç¼–è¯‘</h4><p>æˆ‘ä»¬ä½¿ç”¨</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">go build  -tags &#34;dev&#34; 
</span></span></code></pre></td></tr></table>
</div>
</div><p>åœ¨æ–‡ä»¶å¤¹é‡Œç”Ÿæˆäº†äºŒè¿›åˆ¶æ‰§è¡Œæ–‡ä»¶ buildtagï¼Œæˆ‘ä»¬æ‰§è¡Œä¸€ä¸‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">âœ ./buildtag 
</span></span></code></pre></td></tr></table>
</div>
</div><p>è¾“å‡ºï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">mysql dev
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="3-å¤šä¸ªtagç¼–è¯‘" class="headerLink">
    <a href="#3-%e5%a4%9a%e4%b8%aatag%e7%bc%96%e8%af%91" class="header-mark"></a>3. å¤šä¸ªtagç¼–è¯‘</h4><p>æˆ‘ä»¬ä½¿ç”¨</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">go build  -tags &#34;dev prod&#34; 
</span></span></code></pre></td></tr></table>
</div>
</div><p>åœ¨æ–‡ä»¶å¤¹é‡Œç”Ÿæˆäº†äºŒè¿›åˆ¶æ‰§è¡Œæ–‡ä»¶ buildtagï¼Œæˆ‘ä»¬æ‰§è¡Œä¸€ä¸‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">âœ ./buildtag 
</span></span></code></pre></td></tr></table>
</div>
</div><p>è¾“å‡ºï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">mysql dev
</span></span><span class="line"><span class="cl">mysql prod
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="gobuild-ä¸-build-çš„åŒºåˆ«" class="headerLink">
    <a href="#gobuild-%e4%b8%8e-build-%e7%9a%84%e5%8c%ba%e5%88%ab" class="header-mark"></a>go:build ä¸ +build çš„åŒºåˆ«</h2><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">//go:build
</span></span></code></pre></td></tr></table>
</div>
</div><p>â˜ï¸æ˜¯ Go 1.17 ä¸­å¼•å…¥çš„æ–°æ¡ä»¶ç¼–è¯‘æŒ‡ä»¤æ ¼å¼ã€‚å®ƒæ—¨åœ¨æ›¿æ¢</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">// +build
</span></span></code></pre></td></tr></table>
</div>
</div><p>æŒ‡ä»¤ã€‚é‚£ä¹ˆä¸ºä½•è¦é‡‡ç”¨æ–°çš„æ ¼å¼å‘¢ï¼Ÿå¯¹æ¯”ä¸€ä¸‹æ–°æ—§æ ¼å¼çš„åŒºåˆ«å°±çŸ¥é“äº†ğŸ‘‡</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">// go:build linux &amp;&amp; amd64 || darwin
</span></span><span class="line"><span class="cl">// +build linux,amd64 darwin
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>go:build</code>è¿™ç§æ ¼å¼ï¼Œå¯¹ coder æ¥è¯´ï¼Œæ›´å®¹æ˜“ç†è§£å…¶é€»è¾‘ç»„åˆï¼Œä¸<code>//go:embed</code>å’Œ<code>//go:generate</code>è¿™äº›å‘½ä»¤ç›¸æ¯”è¾ƒï¼Œæ ¼å¼ä¸Šè¿›è¡Œäº†ç»Ÿä¸€ã€‚</p>
<h2 id="å‚è€ƒ" class="headerLink">
    <a href="#%e5%8f%82%e8%80%83" class="header-mark"></a>å‚è€ƒ</h2><ul>
<li><a href="https://github.com/xiaobinqt/go.src/tree/master/dev/buildtag" target="_blank" rel="noopener noreferrer">ä»£ç åœ°å€</a></li>
<li><a href="https://segmentfault.com/a/1190000042007310" target="_blank" rel="noopener noreferrer">go ç¼–è¯‘æ ‡ç­¾( build tag)-æ³¨é‡Šé‡Œçš„ç¼–è¯‘è¯­æ³•</a></li>
<li><a href="https://wrfly.kfd.me/posts/golang-netgo-vs-cgo/" target="_blank" rel="noopener noreferrer">golang: netgo vs cgo</a></li>
</ul>
]]></description>
</item><item>
    <title>Go1.18 sync.Map è§£è¯»</title>
    <link>https://www.xiaobinqt.cn/go-sync-map/</link>
    <pubDate>Wed, 14 Sep 2022 00:00:00 &#43;0000</pubDate><author>
        <name>xiaobinqt</name>
    </author><guid>https://www.xiaobinqt.cn/go-sync-map/</guid>
    <description><![CDATA[<!-- authorï¼š xiaobinqt -->
<!-- emailï¼š xiaobinqt@163.com -->
<!-- https://xiaobinqt.github.io -->
<!-- https://www.xiaobinqt.cn -->
<h2 id="èƒŒæ™¯" class="headerLink">
    <a href="#%e8%83%8c%e6%99%af" class="header-mark"></a>èƒŒæ™¯</h2><p>é¡¹ç›®ä¸­é‡åˆ°äº†éœ€è¦ä½¿ç”¨é«˜å¹¶å‘çš„ map çš„åœºæ™¯ï¼Œä¼—æ‰€å‘¨çŸ¥ Go å®˜æ–¹çš„åŸç”Ÿ map æ˜¯ä¸æ”¯æŒå¹¶å‘è¯»å†™çš„ï¼Œç›´æ¥å¹¶å‘çš„è¯»å†™å¾ˆå®¹æ˜“è§¦å‘ panicã€‚</p>
<p>è§£å†³çš„åŠæ³•æœ‰ä¸¤ä¸ªï¼š</p>
<ul>
<li>è‡ªå·±é…ä¸€æŠŠé” <code>sync.Mutex</code> æˆ–è€…æ›´åŠ è€ƒç©¶ä¸€ç‚¹é…ä¸€æŠŠè¯»å†™é” <code>sync.RWMutex</code>ã€‚è¿™ç§æ–¹æ¡ˆç®€çº¦ç›´æ¥ï¼Œä½†æ˜¯ç¼ºç‚¹ä¹Ÿæ˜æ˜¾ï¼Œå°±æ˜¯æ€§èƒ½ä¸ä¼šå¤ªé«˜ã€‚</li>
<li>ä½¿ç”¨ Go è¯­è¨€åœ¨ 2017 å¹´å‘å¸ƒçš„ Go 1.9 ä¸­æ­£å¼åŠ å…¥äº†å¹¶å‘å®‰å…¨çš„å­—å…¸ç±»å‹ <code>sync.Map</code>ã€‚</li>
</ul>
<p>å¾ˆæ˜¾ç„¶ï¼Œæ–¹æ¡ˆ 2 æ˜¯ä¼˜é›…ä¸”å®ç”¨çš„ã€‚ä½†æ˜¯ï¼Œä¸ºä»€ä¹ˆå®˜æ–¹çš„ <code>sync.Map</code> èƒ½å¤Ÿåœ¨ <strong><ruby>lock free<rt>æ— é”å¹¶å‘</rt></ruby></strong> çš„å‰æä¸‹ï¼Œä¿è¯è¶³å¤Ÿé«˜çš„æ€§èƒ½â“æœ¬æ–‡ç»“åˆ golang 1.18 æºç è¿›è¡Œç®€å•çš„åˆ†æã€‚</p>
<h2 id="æ ¸å¿ƒæ€æƒ³" class="headerLink">
    <a href="#%e6%a0%b8%e5%bf%83%e6%80%9d%e6%83%b3" class="header-mark"></a>æ ¸å¿ƒæ€æƒ³</h2><p>å¦‚æœè¦ä¿è¯å¹¶å‘çš„å®‰å…¨ï¼Œæœ€æœ´ç´ çš„æƒ³æ³•å°±æ˜¯ä½¿ç”¨é”ï¼Œä½†æ˜¯è¿™æ„å‘³ç€è¦æŠŠä¸€äº›å¹¶å‘çš„æ“ä½œå¼ºåˆ¶ä¸²è¡ŒåŒ–ï¼Œæ€§èƒ½è‡ªç„¶å°±ä¼šä¸‹é™ã€‚</p>
<p>äº‹å®ä¸Šï¼Œé™¤äº†ä½¿ç”¨é”ï¼Œè¿˜æœ‰ä¸€ä¸ªåŠæ³•ä¹Ÿå¯ä»¥è¾¾åˆ°ç±»ä¼¼å¹¶å‘å®‰å…¨çš„ç›®çš„ï¼Œå°±æ˜¯ <code>atomic</code> åŸå­æ“ä½œã€‚<code>sync.Map</code> çš„è®¾è®¡éå¸¸å·§å¦™ï¼Œå……åˆ†åˆ©ç”¨äº† <code>atmoic</code> å’Œ <code>mutex</code> äº’æ–¥é”çš„é…åˆã€‚</p>
<ul>
<li>
<p>read map ç”±äºæ˜¯åŸå­åŒ…æ‰˜ç®¡ï¼Œä¸»è¦è´Ÿè´£é«˜æ€§èƒ½ï¼Œä½†æ˜¯æ— æ³•ä¿è¯æ‹¥æœ‰å…¨é‡çš„ keyï¼Œå› ä¸ºå¯¹äºæ–°å¢ keyï¼Œä¼šé¦–å…ˆåŠ åˆ° dirty ä¸­ï¼Œæ‰€ä»¥ read æŸç§ç¨‹åº¦ä¸Šï¼Œç±»ä¼¼äºä¸€ä¸ª key çš„å¿«ç…§ï¼Œè¿™ä¸ªå¿«ç…§åœ¨æŸäº›æƒ…å†µä¸‹å¯èƒ½æ˜¯å…¨é‡å¿«ç…§ã€‚</p>
</li>
<li>
<p>dirty map æ‹¥æœ‰å…¨é‡çš„ keyï¼Œå½“ <code>Store</code> æ“ä½œè¦æ–°å¢ä¸€ä¸ªä¹‹å‰ä¸å­˜åœ¨çš„ key çš„æ—¶å€™ï¼Œä¼šå…ˆå¢åŠ åˆ° dirty ä¸­çš„ã€‚</p>
</li>
<li>
<p>åœ¨æŸ¥æ‰¾æŒ‡å®šçš„ key çš„æ—¶å€™ï¼Œæ€»ä¼šå…ˆå» read map ä¸­å¯»æ‰¾ï¼Œå¹¶ä¸éœ€è¦é”å®šäº’æ–¥é”ã€‚åªæœ‰å½“ read ä¸­æ²¡æœ‰ï¼Œä½† dirty ä¸­å¯èƒ½ä¼šæœ‰è¿™ä¸ª key çš„æ—¶å€™ï¼Œæ‰ä¼šåœ¨é”çš„ä¿æŠ¤ä¸‹å»è®¿é—® dirtyã€‚</p>
</li>
<li>
<p>åœ¨å­˜å‚¨é”®å€¼å¯¹çš„æ—¶å€™ï¼Œåªè¦ read ä¸­å·²å­˜æœ‰è¿™ä¸ª keyï¼Œå¹¶ä¸”è¯¥é”®å€¼å¯¹<strong>æœªè¢«</strong>æ ‡è®°ä¸º <code>expunged</code>ï¼Œå°±ä¼šæŠŠæ–°å€¼å­˜åˆ°é‡Œé¢å¹¶ç›´æ¥è¿”å›ï¼Œè¿™ç§æƒ…å†µä¸‹ä¹Ÿä¸éœ€è¦ç”¨åˆ°é”ã€‚</p>
</li>
<li>
<p>read å’Œ dirty ä¹‹é—´æ˜¯ä¼šäº’ç›¸è½¬æ¢çš„ï¼Œåœ¨ dirty ä¸­æŸ¥æ‰¾ key å¯¹æ¬¡æ•°è¶³å¤Ÿå¤šçš„æ—¶å€™ï¼Œ<code>sync.Map</code> ä¼šæŠŠ dirty ç›´æ¥ä½œä¸º readï¼Œå³è§¦å‘  <code>dirty-&gt;read</code> çš„è½¬å˜ï¼Œæ­¤æ—¶ read ä¸­æ‹¥æœ‰å…¨é‡çš„ keyã€‚åŒæ—¶åœ¨æŸäº›æƒ…å†µï¼Œä¹Ÿä¼šå‡ºç° <code>read-&gt;dirty</code> çš„è½¬å˜ã€‚</p>
</li>
</ul>
<h2 id="æ•°æ®ç»“æ„" class="headerLink">
    <a href="#%e6%95%b0%e6%8d%ae%e7%bb%93%e6%9e%84" class="header-mark"></a>æ•°æ®ç»“æ„</h2><p>å°½é‡ä½¿ç”¨åŸå­æ“ä½œï¼Œæœ€å¤§ç¨‹åº¦ä¸Šå‡å°‘äº†é”çš„ä½¿ç”¨ï¼Œä»è€Œæ¥è¿‘äº† lock free çš„æ•ˆæœã€‚</p>
<p><figure><a class="lightgallery" href="https://cdn.xiaobinqt.cn/xiaobinqt.io/20221205/3c105d85e5c24fecb51e45bc3a184cfe.png" title="æ•°æ®ç»“æ„" data-thumbnail="https://cdn.xiaobinqt.cn/xiaobinqt.io/20221205/3c105d85e5c24fecb51e45bc3a184cfe.png" data-sub-html="<h2>æ•°æ®ç»“æ„</h2><p>æ•°æ®ç»“æ„</p>">
        
    </a><figcaption class="image-caption">æ•°æ®ç»“æ„</figcaption>
    </figure></p>
<p>sync.Map ç±»å‹çš„åº•å±‚æ•°æ®ç»“æ„å¦‚ä¸‹ğŸ‘‡</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">type Map struct {
</span></span><span class="line"><span class="cl"> mu Mutex
</span></span><span class="line"><span class="cl"> read atomic.Value // readOnly
</span></span><span class="line"><span class="cl"> dirty map[any]*entry
</span></span><span class="line"><span class="cl"> misses int
</span></span><span class="line"><span class="cl">}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">// Map.read å±æ€§å®é™…å­˜å‚¨çš„æ˜¯ readOnlyã€‚
</span></span><span class="line"><span class="cl">type readOnly struct {
</span></span><span class="line"><span class="cl"> m map[any]*entry
</span></span><span class="line"><span class="cl"> amended bool
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>
<p>muï¼šäº’æ–¥é”ï¼Œç”¨äºä¿æŠ¤ read å’Œ dirtyã€‚</p>
</li>
<li>
<p>readï¼šåªè¯»æ•°æ®ï¼Œæ”¯æŒå¹¶å‘è¯»å–ï¼ˆ<code>atomic.Value</code>ï¼‰ã€‚å¦‚æœæ¶‰åŠåˆ°æ›´æ–°æ“ä½œï¼Œåˆ™åªéœ€è¦åŠ é”æ¥ä¿è¯æ•°æ®å®‰å…¨ã€‚</p>
</li>
<li>
<p>read å®é™…å­˜å‚¨çš„æ˜¯ readOnly ç»“æ„ä½“ï¼Œå†…éƒ¨ä¹Ÿæ˜¯ä¸€ä¸ªåŸç”Ÿ mapï¼Œamended å±æ€§ç”¨äºæ ‡è®° read å’Œ dirty çš„æ•°æ®æ˜¯å¦ä¸€è‡´ï¼Œå½“ dirty ä¸­å­˜åœ¨ read ä¸­ä¸å­˜åœ¨çš„ key æ—¶ï¼Œamended ä¸º <code>true</code>ã€‚</p>
</li>
<li>
<p>dirtyï¼šè¯»å†™æ•°æ®ï¼Œæ˜¯ä¸€ä¸ªåŸç”Ÿ mapï¼Œä¹Ÿå°±æ˜¯éçº¿ç¨‹å®‰å…¨ã€‚æ“ä½œ dirty éœ€è¦åŠ é”æ¥ä¿è¯æ•°æ®å®‰å…¨ã€‚</p>
</li>
<li>
<p>missesï¼šç»Ÿè®¡æœ‰å¤šå°‘æ¬¡è¯»å– read æ²¡æœ‰å‘½ä¸­ã€‚æ¯æ¬¡ read ä¸­è¯»å–å¤±è´¥åï¼Œmisses çš„è®¡æ•°å€¼éƒ½ä¼šåŠ  1ã€‚</p>
</li>
</ul>
<p>åœ¨ read å’Œ dirty ä¸­ï¼Œéƒ½æœ‰æ¶‰åŠåˆ°çš„ç»“æ„ä½“ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">type entry struct {
</span></span><span class="line"><span class="cl"> p unsafe.Pointer // *any
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div><p>å…¶åŒ…å«ä¸€ä¸ªæŒ‡é’ˆ p, ç”¨äºæŒ‡å‘ç”¨æˆ·å­˜å‚¨çš„å…ƒç´ ï¼ˆkeyï¼‰æ‰€æŒ‡å‘çš„ value å€¼ã€‚</p>
<h2 id="atomicvalue" class="headerLink">
    <a href="#atomicvalue" class="header-mark"></a>atomic.Value</h2><p>å½“éœ€è¦åœ¨ Go ä¸­è¿›è¡Œå¹¶å‘å®‰å…¨çš„å€¼å­˜å‚¨å’Œè¯»å–æ—¶ï¼Œå¯ä»¥ä½¿ç”¨ <code>sync/atomic</code> åŒ…ä¸­çš„ <code>atomic.Value</code> ç±»å‹ã€‚<code>atomic.Value</code> æä¾›äº†ä¸€ç§åŸå­æ“ä½œçš„æ–¹å¼æ¥å­˜å‚¨å’Œè¯»å–å€¼ï¼Œä»¥ç¡®ä¿åœ¨å¹¶å‘ç¯å¢ƒä¸‹ä¸ä¼šå‡ºç°æ•°æ®ç«äº‰ã€‚</p>
<p>ä»¥ä¸‹æ˜¯å…³äº <code>atomic.Value</code> çš„è¯¦ç»†è¯´æ˜ï¼š</p>
<ol>
<li>
<p><strong>åˆ›å»º <code>atomic.Value</code></strong>ï¼š
è¦åˆ›å»ºä¸€ä¸ª <code>atomic.Value</code>ï¼Œå¯ä»¥ä½¿ç”¨ <code>sync/atomic</code> åŒ…ä¸­çš„ <code>atomic.Value</code> ç±»å‹çš„é›¶å€¼ã€‚ä¾‹å¦‚ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">var v atomic.Value
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p><strong>å­˜å‚¨å€¼</strong>ï¼š
ä½¿ç”¨ <code>Store</code> æ–¹æ³•æ¥å­˜å‚¨ä¸€ä¸ªå€¼åˆ° <code>atomic.Value</code> ä¸­ã€‚è¿™ä¸ªæ“ä½œæ˜¯åŸå­çš„ï¼Œä¸ä¼šå‡ºç°æ•°æ®ç«äº‰ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">v.Store(&#34;Hello, World!&#34;)
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p><strong>è¯»å–å€¼</strong>ï¼š
ä½¿ç”¨ <code>Load</code> æ–¹æ³•æ¥ä» <code>atomic.Value</code> ä¸­è¯»å–å€¼ã€‚è¿™ä¸ªæ“ä½œä¹Ÿæ˜¯åŸå­çš„ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">value := v.Load()
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p><strong>å¹¶å‘å®‰å…¨</strong>ï¼š
<code>atomic.Value</code> ä¿è¯äº†å­˜å‚¨å’Œè¯»å–çš„æ“ä½œæ˜¯å¹¶å‘å®‰å…¨çš„ï¼Œä¸éœ€è¦é¢å¤–çš„é”æˆ–äº’æ–¥ä½“ã€‚è¿™å¯¹äºåœ¨å¤šä¸ª goroutine ä¹‹é—´å…±äº«æ•°æ®éå¸¸æœ‰ç”¨ã€‚</p>
</li>
<li>
<p><strong>å€¼çš„ç±»å‹</strong>ï¼š
<code>atomic.Value</code> å¯ä»¥å­˜å‚¨ä»»ä½•ç±»å‹çš„å€¼ã€‚è¿™æ„å‘³ç€å®ƒå¯ä»¥ç”¨äºå­˜å‚¨å­—ç¬¦ä¸²ã€æ•´æ•°ã€ç»“æ„ä½“ã€åˆ‡ç‰‡ã€æ¥å£ç­‰ä»»ä½• Go ç±»å‹ã€‚</p>
</li>
<li>
<p><strong>æ³¨æ„äº‹é¡¹</strong>ï¼š</p>
<ul>
<li>
<p>è™½ç„¶ <code>atomic.Value</code> æä¾›äº†å¹¶å‘å®‰å…¨çš„å­˜å‚¨å’Œè¯»å–ï¼Œä½†å®ƒå¹¶ä¸é€‚ç”¨äºå¤æ‚çš„æ•°æ®ç»“æ„ã€‚å¦‚æœéœ€è¦å¯¹å¤æ‚æ•°æ®ç»“æ„è¿›è¡Œå¹¶å‘è®¿é—®å’Œä¿®æ”¹ï¼Œå¯èƒ½éœ€è¦ä½¿ç”¨å…¶ä»–åŒæ­¥æœºåˆ¶ï¼Œå¦‚äº’æ–¥é”ã€‚</p>
</li>
<li>
<p>å½“ä» <code>atomic.Value</code> ä¸­è¯»å–å€¼æ—¶ï¼Œéœ€è¦è¿›è¡Œç±»å‹æ–­è¨€ï¼Œä»¥å°†æ¥å£ç±»å‹è½¬æ¢ä¸ºå®é™…çš„å€¼ç±»å‹ã€‚è¿™éœ€è¦è°¨æ…å¤„ç†ï¼Œä»¥ç¡®ä¿ç±»å‹å®‰å…¨ã€‚</p>
</li>
</ul>
</li>
</ol>
<p><code>atomic.Value</code> æ˜¯ Go è¯­è¨€ä¸­ç”¨äºå¹¶å‘å®‰å…¨å€¼å­˜å‚¨å’Œè¯»å–çš„æœ‰ç”¨å·¥å…·ã€‚å®ƒåœ¨ç®€å•çš„å€¼å­˜å‚¨å’Œè¯»å–åœºæ™¯ä¸­éå¸¸æœ‰ç”¨ï¼Œå¯ä»¥å¸®åŠ©é¿å…æ•°æ®ç«äº‰é—®é¢˜ã€‚ä½†åœ¨å¤„ç†å¤æ‚æ•°æ®ç»“æ„æˆ–éœ€è¦æ›´å¤æ‚åŒæ­¥çš„æƒ…å†µä¸‹ï¼Œå¯èƒ½éœ€è¦è€ƒè™‘å…¶ä»–å¹¶å‘æ§åˆ¶æœºåˆ¶ã€‚</p>
<h2 id="entry-çš„-p-å¯èƒ½çŠ¶æ€" class="headerLink">
    <a href="#entry-%e7%9a%84-p-%e5%8f%af%e8%83%bd%e7%8a%b6%e6%80%81" class="header-mark"></a>entry çš„ p å¯èƒ½çŠ¶æ€</h2><p><figure><a class="lightgallery" href="https://cdn.xiaobinqt.cn/xiaobinqt.io/20230714/9ab5f3ce270e4d39ac832e6bea79238b.png" title="https://cdn.xiaobinqt.cn/xiaobinqt.io/20230714/9ab5f3ce270e4d39ac832e6bea79238b.png" data-thumbnail="https://cdn.xiaobinqt.cn/xiaobinqt.io/20230714/9ab5f3ce270e4d39ac832e6bea79238b.png" data-sub-html="<h2>p çš„çŠ¶æ€</h2>">
        
    </a><figcaption class="image-caption">p çš„çŠ¶æ€</figcaption>
    </figure></p>
<h3 id="nil" class="headerLink">
    <a href="#nil" class="header-mark"></a>nil</h3><p>å½“åˆ é™¤ä¸€ä¸ª key æ—¶ï¼Œå¦‚æœ read ä¸­å­˜åœ¨ä¼šæŠŠè¿™ä¸ª key çš„ value ä¹Ÿå°±æ˜¯ e.p æ ‡è®°ä¸º nilã€‚è¿™æ ·åœ¨ä¸‹æ¬¡æŸ¥æ‰¾çš„æ—¶å€™è¿˜ä¼šåœ¨ read ä¸­æ‰¾ä¸ªè¿™ä¸ª keyï¼Œè¿™æ—¶éœ€è¦å»åˆ¤æ–­ä¸‹ e.p æ˜¯å¦æ˜¯ nilï¼Œå¦‚æœæ˜¯ nil å°±è¡¨ç¤ºè¿™ä¸ª key æ˜¯å·²ç»åˆ é™¤çš„ã€‚</p>
<p>å¦‚æœ read ä¸­ä¸å­˜åœ¨ä½†æ˜¯ dirty ä¸­å­˜åœ¨ï¼Œä¼šå…ˆä» dirty ä¸­æŠŠè¿™ä¸ª key åˆ é™¤ï¼Œç„¶åæŠŠè¿™ä¸ª key å¯¹åº”çš„ value ä¹Ÿå°±æ˜¯ e.p æ ‡è®°ä¸º nilã€‚</p>
<ul>
<li><code>e.p==nil</code>ï¼šentry å·²ç»è¢«æ ‡è®°åˆ é™¤ï¼Œä¸è¿‡æ­¤æ—¶è¿˜æœªç»è¿‡ <code>read-&gt;dirty</code> é‡å¡‘ï¼Œæ­¤æ—¶å¯èƒ½ä»ç„¶å±äº dirtyï¼ˆå¦‚æœ dirty é nilï¼‰ã€‚</li>
</ul>
<h3 id="expunged" class="headerLink">
    <a href="#expunged" class="header-mark"></a>expunged</h3><p>å½“ <code>dirty-&gt;read</code> å®Œæˆåï¼Œåˆæœ‰æ–° key å†™å…¥æ—¶ï¼Œæ­¤æ—¶ read ä¸­çš„ amended ä¸º <code>false</code>ï¼Œå°±ä¼šè°ƒç”¨ <code>dirtyLocked()</code> æ–¹æ³•ï¼Œæ­¤æ—¶ä¼šå‘ç”Ÿ <code>read-&gt;dirty</code> çš„è½¬å˜ï¼Œæ­¤æ—¶ä¼šå¾ªç¯ read æ•°æ®ï¼Œå°† p ä¸ä¸º nil çš„å€¼å†™åˆ° dirty ä¸­ï¼Œå¦‚æœ p ä¸º nil åˆ™å°† nil è½¬ä¸º expungedï¼Œ</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">func (m *Map) dirtyLocked() {
</span></span><span class="line"><span class="cl">	if m.dirty != nil {
</span></span><span class="line"><span class="cl">		return
</span></span><span class="line"><span class="cl">	}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	read, _ := m.read.Load().(readOnly)
</span></span><span class="line"><span class="cl">	m.dirty = make(map[any]*entry, len(read.m))
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	println(&#34;read-&gt;dirty è½¬å˜&#34;)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	for k, e := range read.m {
</span></span><span class="line"><span class="cl">		// æŠŠ read ä¸­ value e.p ä¸æ˜¯ expunged çš„ key,value è½¬åˆ° dirty ä¸­
</span></span><span class="line"><span class="cl">		// è¿™é‡Œæ˜¯å¾ªç¯ï¼Œå¦‚æœæ•°æ®é‡å¤§å¯èƒ½ä¼šéå¸¸è€—æ—¶
</span></span><span class="line"><span class="cl">		if !e.tryExpungeLocked() {
</span></span><span class="line"><span class="cl">			m.dirty[k] = e
</span></span><span class="line"><span class="cl">		}
</span></span><span class="line"><span class="cl">	}
</span></span><span class="line"><span class="cl">}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">func (e *entry) tryExpungeLocked() (isExpunged bool) {
</span></span><span class="line"><span class="cl">	p := atomic.LoadPointer(&amp;e.p)
</span></span><span class="line"><span class="cl">	for p == nil {
</span></span><span class="line"><span class="cl">		// å°† e.p çš„ nil è½¬æˆ expunged
</span></span><span class="line"><span class="cl">		if atomic.CompareAndSwapPointer(&amp;e.p, nil, expunged) {
</span></span><span class="line"><span class="cl">			return true
</span></span><span class="line"><span class="cl">		}
</span></span><span class="line"><span class="cl">		p = atomic.LoadPointer(&amp;e.p)
</span></span><span class="line"><span class="cl">	}
</span></span><span class="line"><span class="cl">	return p == expunged
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div><p>åœ¨ä» <code>read-&gt;dirty</code> çš„è½¬å˜ä¸­ï¼Œè™½ç„¶ read ä¸­è¿˜ä¼šå­˜åœ¨ expunged çš„å†…å®¹ï¼ˆexpunged æ˜¯ read ç‹¬æœ‰çš„ï¼‰ï¼Œä½†æ˜¯ä¸å½±å“ sync.map çš„é«˜æ€§èƒ½ã€‚ç›¸åï¼Œå¦‚æœåœ¨ Delete æ—¶ç›´æ¥å»åˆ é™¤å…ƒç´ ï¼Œé‚£ä¹ˆå°±ä¼šå»åŠ é”æ“ä½œ dirtyï¼Œåªè¦æ¶‰åŠåˆ°é”ï¼Œå°±ä¼šå½±å“åˆ°æ€§èƒ½ã€‚</p>
<h3 id="æ­£å¸¸" class="headerLink">
    <a href="#%e6%ad%a3%e5%b8%b8" class="header-mark"></a>æ­£å¸¸</h3><p>æ­¤æ—¶ entry æ˜¯ä¸€ä¸ªæ™®é€šçš„å­˜åœ¨çŠ¶æ€ï¼Œå±äº readï¼Œå¦‚æœ dirty é nilï¼Œä¹Ÿå±äº dirtyã€‚</p>
<h2 id="storeå†™å…¥è¿‡ç¨‹" class="headerLink">
    <a href="#store%e5%86%99%e5%85%a5%e8%bf%87%e7%a8%8b" class="header-mark"></a>Storeå†™å…¥è¿‡ç¨‹</h2><p>å…ˆæ¥çœ‹ expunged</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">var expunged = unsafe.Pointer(new(any))
</span></span></code></pre></td></tr></table>
</div>
</div><p>expunged æ˜¯ä¸€ä¸ªæŒ‡å‘ä»»æ„ç±»å‹çš„æŒ‡é’ˆï¼Œç”¨æ¥æ ‡è®°ä» dirty map ä¸­<strong>åˆ é™¤</strong>çš„ entryã€‚</p>
<p>sync.Map ç±»å‹çš„ Store æ–¹æ³•ï¼Œè¯¥æ–¹æ³•çš„ä½œç”¨æ˜¯æ–°å¢æˆ–æ›´æ–°ä¸€ä¸ªå…ƒç´ ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">func (m *Map) Store(key, value any) {
</span></span><span class="line"><span class="cl"> read, _ := m.read.Load().(readOnly)
</span></span><span class="line"><span class="cl"> if e, ok := read.m[key]; ok &amp;&amp; e.tryStore(&amp;value) {
</span></span><span class="line"><span class="cl">  return
</span></span><span class="line"><span class="cl"> }
</span></span><span class="line"><span class="cl">  ...
</span></span><span class="line"><span class="cl">}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">// tryStore stores a value if the entry has not been expunged.
</span></span><span class="line"><span class="cl">//
</span></span><span class="line"><span class="cl">// If the entry is expunged, tryStore returns false and leaves the entry
</span></span><span class="line"><span class="cl">// unchanged.
</span></span><span class="line"><span class="cl">func (e *entry) tryStore(i *any) bool {
</span></span><span class="line"><span class="cl">	for {
</span></span><span class="line"><span class="cl">		p := atomic.LoadPointer(&amp;e.p)
</span></span><span class="line"><span class="cl">		if p == expunged {
</span></span><span class="line"><span class="cl">			return false
</span></span><span class="line"><span class="cl">		}
</span></span><span class="line"><span class="cl">		if atomic.CompareAndSwapPointer(&amp;e.p, p, unsafe.Pointer(i)) {
</span></span><span class="line"><span class="cl">			return true
</span></span><span class="line"><span class="cl">		}
</span></span><span class="line"><span class="cl">	}
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div><p>è°ƒç”¨<code>Load</code>æ–¹æ³•æ£€æŸ¥<code>m.read</code>ä¸­æ˜¯å¦å­˜åœ¨è¿™ä¸ªå…ƒç´ ã€‚è‹¥å­˜åœ¨ï¼Œä¸”åœ¨ tryStore æ—¶ï¼Œåˆ¤æ–­æ²¡æœ‰è¢«æ ‡è®°ä¸º expunged åˆ é™¤çŠ¶æ€ï¼Œåˆ™å°è¯•å­˜å‚¨ã€‚</p>
<p>è‹¥è¯¥å…ƒç´ ä¸å­˜åœ¨æˆ–åœ¨ tryStore æ—¶åˆ¤æ–­æ—¶ï¼Œå·²ç»è¢«æ ‡è®°ä¸ºåˆ é™¤çŠ¶æ€ï¼Œåˆ™ç»§ç»­èµ°åˆ°ä¸‹é¢æµç¨‹ğŸ‘‡</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">func (m *Map) Store(key, value any) {
</span></span><span class="line"><span class="cl">    ...
</span></span><span class="line"><span class="cl">    m.mu.Lock()
</span></span><span class="line"><span class="cl">	read, _ = m.read.Load().(readOnly)
</span></span><span class="line"><span class="cl">	if e, ok := read.m[key]; ok {
</span></span><span class="line"><span class="cl">		if e.unexpungeLocked() {
</span></span><span class="line"><span class="cl">			// å¦‚æœ read map ä¸­å­˜åœ¨è¯¥ keyï¼Œä½† p == expungedï¼Œåˆ™è¯´æ˜åœ¨ read ä¸­å·²ç»è¢«åˆ é™¤äº†:
</span></span><span class="line"><span class="cl">			//    a. å°† p çš„çŠ¶æ€ç”±ä¸­é—´å€¼ expunged æ›´æ”¹ä¸º nil
</span></span><span class="line"><span class="cl">			//    b. dirty map æ’å…¥ key
</span></span><span class="line"><span class="cl">			m.dirty[key] = e
</span></span><span class="line"><span class="cl">		}
</span></span><span class="line"><span class="cl">		// æ›´æ–° entry.p = value (read map å’Œ dirty map æŒ‡å‘åŒä¸€ä¸ª entry)
</span></span><span class="line"><span class="cl">		e.storeLocked(&amp;value)
</span></span><span class="line"><span class="cl">	} else if e, ok := m.dirty[key]; ok {
</span></span><span class="line"><span class="cl">		// å¦‚æœ read map ä¸­ä¸å­˜åœ¨è¯¥ keyï¼Œä½† dirty map ä¸­å­˜åœ¨è¯¥ keyï¼Œç›´æ¥å†™å…¥æ›´æ–° entry(read map ä¸­ä»ç„¶æ²¡æœ‰è¿™ä¸ª key)
</span></span><span class="line"><span class="cl">		e.storeLocked(&amp;value)
</span></span><span class="line"><span class="cl">	} else {
</span></span><span class="line"><span class="cl">		// å¦‚æœ read map å’Œ dirty map ä¸­éƒ½ä¸å­˜åœ¨è¯¥ keyï¼Œåˆ™ï¼š
</span></span><span class="line"><span class="cl">		//	  a. å¦‚æœ dirty map ä¸ºç©ºï¼Œåˆ™éœ€è¦åˆ›å»º dirty mapï¼Œå¹¶ä» read map ä¸­æ‹·è´æœªåˆ é™¤çš„å…ƒç´ åˆ°æ–°åˆ›å»ºçš„ dirty map
</span></span><span class="line"><span class="cl">		//    b. æ›´æ–° amended å­—æ®µï¼Œæ ‡è¯† dirty map ä¸­å­˜åœ¨ read map ä¸­æ²¡æœ‰çš„ key
</span></span><span class="line"><span class="cl">		//    c. å°† kv å†™å…¥ dirty map ä¸­ï¼Œread ä¸å˜
</span></span><span class="line"><span class="cl">		if !read.amended {
</span></span><span class="line"><span class="cl">		    // åˆ°è¿™é‡Œå°±æ„å‘³ç€ï¼Œå½“å‰çš„ key æ˜¯ç¬¬ä¸€æ¬¡è¢«åŠ åˆ° dirty map ä¸­ã€‚
</span></span><span class="line"><span class="cl">			// store ä¹‹å‰å…ˆåˆ¤æ–­ä¸€ä¸‹ dirty map æ˜¯å¦ä¸ºç©ºï¼Œå¦‚æœä¸ºç©ºï¼Œå°±æŠŠ read map æµ…æ‹·è´ä¸€æ¬¡ã€‚
</span></span><span class="line"><span class="cl">			m.dirtyLocked()
</span></span><span class="line"><span class="cl">			m.read.Store(readOnly{m: read.m, amended: true})
</span></span><span class="line"><span class="cl">		}
</span></span><span class="line"><span class="cl">		// å†™å…¥æ–° keyï¼Œåœ¨ dirty ä¸­å­˜å‚¨ value
</span></span><span class="line"><span class="cl">		m.dirty[key] = newEntry(value)
</span></span><span class="line"><span class="cl">	}
</span></span><span class="line"><span class="cl">	m.mu.Unlock()
</span></span><span class="line"><span class="cl">}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">func (m *Map) dirtyLocked() {
</span></span><span class="line"><span class="cl">	if m.dirty != nil {
</span></span><span class="line"><span class="cl">		return
</span></span><span class="line"><span class="cl">	}
</span></span><span class="line"><span class="cl">	read, _ := m.read.Load().(readOnly)
</span></span><span class="line"><span class="cl">	m.dirty = make(map[any]*entry, len(read.m))
</span></span><span class="line"><span class="cl">	for k, e := range read.m {
</span></span><span class="line"><span class="cl">		if !e.tryExpungeLocked() {
</span></span><span class="line"><span class="cl">			m.dirty[k] = e
</span></span><span class="line"><span class="cl">		}
</span></span><span class="line"><span class="cl">	}
</span></span><span class="line"><span class="cl">}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">func (e *entry) tryExpungeLocked() (isExpunged bool) {
</span></span><span class="line"><span class="cl">	p := atomic.LoadPointer(&amp;e.p)
</span></span><span class="line"><span class="cl">	for p == nil {
</span></span><span class="line"><span class="cl">		// å°†å·²ç»åˆ é™¤æ ‡è®°ä¸ºnilçš„æ•°æ®æ ‡è®°ä¸º expunged
</span></span><span class="line"><span class="cl">		if atomic.CompareAndSwapPointer(&amp;e.p, nil, expunged) {
</span></span><span class="line"><span class="cl">			return true
</span></span><span class="line"><span class="cl">		}
</span></span><span class="line"><span class="cl">		p = atomic.LoadPointer(&amp;e.p)
</span></span><span class="line"><span class="cl">	}
</span></span><span class="line"><span class="cl">	return p == expunged
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div><p>è¿™é‡Œä½¿ç”¨äº†<strong>åŒæ£€æŸ¥</strong>çš„å¤„ç†ï¼Œå› ä¸ºåœ¨ä¸‹é¢çš„ä¸¤ä¸ªè¯­å¥ä¸­ï¼Œè¿™ä¸¤è¡Œè¯­å¥å¹¶ä¸æ˜¯ä¸€ä¸ªåŸå­æ“ä½œã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">if !ok &amp;&amp; read.amended {
</span></span><span class="line"><span class="cl">		m.mu.Lock()
</span></span></code></pre></td></tr></table>
</div>
</div><p>è™½ç„¶ç¬¬ä¸€å¥æ‰§è¡Œçš„æ—¶å€™æ¡ä»¶æ»¡è¶³ï¼Œä½†æ˜¯åœ¨åŠ é”ä¹‹å‰ï¼Œ<code>m.dirty</code> å¯èƒ½è¢«æå‡ä¸º <code>m.read</code>ï¼Œæ‰€ä»¥åŠ é”åè¿˜å¾—å†æ£€æŸ¥ä¸€æ¬¡ <code>m.read</code>ï¼Œåç»­çš„æ–¹æ³•ä¸­éƒ½ä½¿ç”¨äº†è¿™ä¸ªæ–¹æ³•ã€‚</p>
<p>ç”±äºå·²ç»èµ°åˆ°äº† dirty çš„æµç¨‹ï¼Œå› æ­¤å¼€å¤´å°±ç›´æ¥è°ƒç”¨äº† <code>Lock</code> æ–¹æ³•ä¸Š<strong>äº’æ–¥é”</strong>ï¼Œä¿è¯æ•°æ®å®‰å…¨ï¼Œä¹Ÿæ˜¯å‡¸æ˜¾<strong>æ€§èƒ½å˜å·®çš„ç¬¬ä¸€å¹•</strong>ã€‚</p>
<p>å†™å…¥è¿‡ç¨‹çš„æ•´ä½“æµç¨‹æ˜¯ğŸ‘‡</p>
<ol>
<li>å¦‚æœåœ¨ read é‡Œèƒ½å¤Ÿæ‰¾åˆ°å¾…å­˜å‚¨çš„ keyï¼Œå¹¶ä¸”å¯¹åº”çš„ entry çš„ p å€¼ä¸ä¸º expungedï¼Œä¹Ÿå°±æ˜¯æ²¡è¢«åˆ é™¤æ—¶ï¼Œç›´æ¥æ›´æ–°å¯¹åº”çš„ entry å³å¯ã€‚</li>
<li>å¦‚æœç¬¬ä¸€æ­¥æ²¡æœ‰æˆåŠŸï¼Œè¦ä¹ˆ read ä¸­æ²¡æœ‰è¿™ä¸ª keyï¼Œè¦ä¹ˆ key è¢«æ ‡è®°ä¸ºåˆ é™¤ã€‚åˆ™å…ˆåŠ é”ï¼Œå†è¿›è¡Œåç»­çš„æ“ä½œã€‚</li>
<li>å†æ¬¡åœ¨ read ä¸­æŸ¥æ‰¾æ˜¯å¦å­˜åœ¨è¿™ä¸ª keyï¼Œä¹Ÿå°±æ˜¯ double check åŒæ£€æŸ¥ä¸€ä¸‹ï¼Œè¿™æ˜¯ lock-free ç¼–ç¨‹çš„å¸¸è§å¥—è·¯ã€‚å¦‚æœ read ä¸­å­˜åœ¨è¯¥ keyï¼Œä½† <code>p == expunged</code>ï¼Œè¯´æ˜ <code>m.dirty != nil</code>ï¼ˆ<code>m.dirty</code> æ˜¯è¢«åˆå§‹åŒ–è¿‡çš„ï¼‰å¹¶ä¸” <code>m.dirty</code> ä¸­ä¸å­˜åœ¨è¯¥ key å€¼ï¼ˆå› ä¸ºå·²ç»è¢«åˆ é™¤äº†ï¼Œdirty ä¸­çš„åˆ é™¤ç›´æ¥å°±åˆ é™¤äº†ï¼›read ä¸­çš„åˆ é™¤ï¼Œä¼šå…ˆæ ‡è®°ä¸º nilï¼Œ<code>read-&gt;dirty</code> é‡å¡‘æ—¶å†æ ‡è®°ä¸º <code>expunged</code>ï¼‰ï¼Œæ­¤æ—¶ğŸ‘‡
<ol>
<li>å°† p çš„çŠ¶æ€ç”± <code>expunged</code> æ›´æ”¹ä¸º <code>nil</code></li>
<li>dirty map æ’å…¥ keyã€‚ç„¶åï¼Œç›´æ¥æ›´æ–°å¯¹åº”çš„ value</li>
</ol>
</li>
<li>å¦‚æœ read ä¸­æ²¡æœ‰æ­¤ keyï¼Œé‚£å°±æŸ¥çœ‹ dirty ä¸­æ˜¯å¦æœ‰æ­¤ keyï¼Œå¦‚æœæœ‰ï¼Œåˆ™ç›´æ¥æ›´æ–°å¯¹åº”çš„ valueï¼Œè¿™æ—¶ read ä¸­è¿˜æ˜¯æ²¡æœ‰æ­¤ keyã€‚</li>
<li>æœ€åä¸€æ­¥ï¼Œå¦‚æœ read å’Œ dirty ä¸­éƒ½ä¸å­˜åœ¨è¯¥ keyï¼Œåˆ™ğŸ‘‡
<ol>
<li>å¦‚æœ <code>dirty</code> ä¸ºç©ºï¼Œåˆ™éœ€è¦åˆ›å»º <code>dirty</code>ï¼Œå¹¶ä» <code>read</code> ä¸­æ‹·è´æœªè¢«åˆ é™¤çš„å…ƒç´ </li>
<li>æ›´æ–° <code>amended</code> å­—æ®µä¸º trueï¼Œæ ‡è¯† dirty map ä¸­å­˜åœ¨ read map ä¸­æ²¡æœ‰çš„ <code>key</code></li>
<li>å°† <code>k-v</code> å†™å…¥ dirty map ä¸­ï¼Œ<code>read.m</code> ä¸å˜ã€‚æœ€åï¼Œæ›´æ–°æ­¤ key å¯¹åº”çš„ <code>value</code>ã€‚</li>
</ol>
</li>
</ol>
<p><strong>ä¸ºä»€ä¹ˆ read ä¸­å­˜åœ¨ keyï¼Œä½†æ˜¯ <code>p == expunged</code> æ—¶éœ€è¦æŠŠ p çš„çŠ¶æ€ç”± <code>expunged</code> æ›´æ”¹ä¸º <code>nil</code></strong> â“</p>
<p>expunged çš„æ„ä¹‰æ˜¯åœ¨åˆ é™¤æ“ä½œåï¼Œé”®çš„å¯¹åº”å€¼è¢«æ ‡è®°ä¸º expungedï¼Œè€Œä¸æ˜¯ç®€å•åœ°è®¾ç½®ä¸º nilã€‚è¿™æ ·åšçš„å¥½å¤„æ˜¯ï¼Œnil å€¼å¯èƒ½æ˜¯é”®æœ¬èº«çš„æœ‰æ•ˆå€¼ï¼Œå› æ­¤æ— æ³•åŒºåˆ†é”®å·²è¢«åˆ é™¤å’Œé”®å¯¹åº”çš„å€¼ä¸º nil ä¸¤ç§æƒ…å†µã€‚é€šè¿‡ä½¿ç”¨ expunged æ ‡è®°ï¼Œsync.Map å¯ä»¥æ¸…æ¥šåœ°åŒºåˆ†é”®è¢«åˆ é™¤å’Œé”®å¯¹åº”çš„å€¼ä¸º nilã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">if e.unexpungeLocked() {
</span></span><span class="line"><span class="cl">      // The entry was previously expunged, which implies that there is a
</span></span><span class="line"><span class="cl">      // non-nil dirty map and this entry is not in it.
</span></span><span class="line"><span class="cl">      m.dirty[key] = e
</span></span><span class="line"><span class="cl">  }
</span></span><span class="line"><span class="cl">  e.storeLocked(&amp;value)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">// storeLocked unconditionally stores a value to the entry.
</span></span><span class="line"><span class="cl">//
</span></span><span class="line"><span class="cl">// The entry must be known not to be expunged.
</span></span><span class="line"><span class="cl">func (e *entry) storeLocked(i *any) {
</span></span><span class="line"><span class="cl">	atomic.StorePointer(&amp;e.p, unsafe.Pointer(i))
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div><p>Store å¯èƒ½ä¼šåœ¨æŸç§æƒ…å†µä¸‹ï¼ˆåˆå§‹åŒ–æˆ–è€… <code>m.dirty</code> åˆšè¢«æå‡åï¼Œæ­¤æ—¶ <code>m.read</code> ä¸­çš„æ•°æ®å’Œ <code>m.dirty</code> ä¸­çš„ç›¸ç­‰ï¼ŒreadOnly ä¸­çš„ <code>amended</code> ä¸º <code>false</code>ï¼Œä¹Ÿå°±æ˜¯è¯´å¯èƒ½å­˜åœ¨ä¸€ä¸ª keyï¼Œread ä¸­æ‰¾ä¸åˆ° dirty ä¸­ä¹Ÿæ‰¾ä¸åˆ°ï¼‰ä» <code>m.read</code> ä¸­å¤åˆ¶æ•°æ®ï¼Œå¦‚æœè¿™ä¸ªæ—¶å€™ <code>m.read</code> ä¸­æ•°æ®é‡éå¸¸å¤§ï¼Œå¯èƒ½ä¼šå½±å“æ€§èƒ½ã€‚</p>
<p>ç»¼ä¸Šï¼Œsync.Map ç±»å‹<strong>ä¸é€‚åˆå†™å¤šçš„åœºæ™¯</strong>ï¼Œè¯»å¤šå†™å°‘æ˜¯æ¯”è¾ƒå¥½çš„ã€‚è‹¥æœ‰å¤§æ•°æ®é‡çš„åœºæ™¯ï¼Œåˆ™éœ€è¦è€ƒè™‘ read å¤åˆ¶æ•°æ®æ—¶çš„å¶ç„¶æ€§èƒ½æŠ–åŠ¨æ˜¯å¦èƒ½å¤Ÿæ¥å—ã€‚</p>
<h2 id="loadæŸ¥æ‰¾è¿‡ç¨‹" class="headerLink">
    <a href="#load%e6%9f%a5%e6%89%be%e8%bf%87%e7%a8%8b" class="header-mark"></a>LoadæŸ¥æ‰¾è¿‡ç¨‹</h2><p>sync.Map ç±»å‹æœ¬è´¨ä¸Šæ˜¯æœ‰ä¸¤ä¸ª mapã€‚ä¸€ä¸ªå« readã€ä¸€ä¸ªå« dirtyï¼Œé•¿çš„ä¹Ÿå·®ä¸å¤šğŸ‘‡</p>
<p><figure><a class="lightgallery" href="https://cdn.xiaobinqt.cn/xiaobinqt.io/20221204/301dd5df668c43c08845983b106b0fc4.png" title="sync.map" data-thumbnail="https://cdn.xiaobinqt.cn/xiaobinqt.io/20221204/301dd5df668c43c08845983b106b0fc4.png" data-sub-html="<h2>sync.map</h2><p>sync.map</p>">
        
    </a><figcaption class="image-caption">sync.map</figcaption>
    </figure></p>
<p>å½“ä» sync.Map ç±»å‹ä¸­è¯»å–æ•°æ®æ—¶ï¼Œå…¶ä¼šå…ˆæŸ¥çœ‹ read ä¸­æ˜¯å¦åŒ…å«æ‰€éœ€çš„å…ƒç´ ï¼š</p>
<ul>
<li>è‹¥æœ‰ï¼Œåˆ™é€šè¿‡ atomic åŸå­æ“ä½œè¯»å–æ•°æ®å¹¶è¿”å›ã€‚</li>
<li>è‹¥æ— ï¼Œåˆ™ä¼šåˆ¤æ–­ read.readOnly ä¸­çš„ amended å±æ€§ï¼Œä»–ä¼šå‘Šè¯‰ç¨‹åºï¼Œdirty æ˜¯å¦åŒ…å« <code>read.readOnly.m</code> ä¸­æ²¡æœ‰çš„æ•°æ®ï¼›å¦‚æœå­˜åœ¨ï¼Œä¹Ÿå°±æ˜¯ amended ä¸º trueï¼Œå°†ä¼šè¿› ä¸€æ­¥åˆ° dirty ä¸­æŸ¥æ‰¾æ•°æ®ã€‚</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">func (m *Map) Load(key any) (value any, ok bool) {
</span></span><span class="line"><span class="cl">	// 1.é¦–å…ˆä» m.read ä¸­å¾—åˆ°åªè¯» readOnly,ä»å®ƒçš„ map ä¸­æŸ¥æ‰¾ï¼Œä¸éœ€è¦åŠ é”
</span></span><span class="line"><span class="cl">	read, _ := m.read.Load().(readOnly)
</span></span><span class="line"><span class="cl">	e, ok := read.m[key]
</span></span><span class="line"><span class="cl">	// 2. å¦‚æœæ²¡æ‰¾åˆ°ï¼Œå¹¶ä¸” m.dirty ä¸­æœ‰æ–°æ•°æ®ï¼Œéœ€è¦ä» m.dirty æŸ¥æ‰¾ï¼Œè¿™ä¸ªæ—¶å€™éœ€è¦åŠ é”
</span></span><span class="line"><span class="cl">	if !ok &amp;&amp; read.amended {
</span></span><span class="line"><span class="cl">		m.mu.Lock()
</span></span><span class="line"><span class="cl">		// åŒæ£€æŸ¥ï¼Œé¿å…åŠ é”çš„æ—¶å€™ m.dirty æå‡ä¸º m.read,è¿™ä¸ªæ—¶å€™ m.read å¯èƒ½è¢«æ›¿æ¢äº†ã€‚
</span></span><span class="line"><span class="cl">		read, _ = m.read.Load().(readOnly)
</span></span><span class="line"><span class="cl">		e, ok = read.m[key]
</span></span><span class="line"><span class="cl">		// å¦‚æœm.readä¸­è¿˜æ˜¯ä¸å­˜åœ¨ï¼Œå¹¶ä¸”m.dirtyä¸­æœ‰æ–°æ•°æ®
</span></span><span class="line"><span class="cl">		if !ok &amp;&amp; read.amended {
</span></span><span class="line"><span class="cl">			// ä»m.dirtyæŸ¥æ‰¾
</span></span><span class="line"><span class="cl">			e, ok = m.dirty[key]
</span></span><span class="line"><span class="cl">			// ä¸ç®¡ m.dirty ä¸­å­˜ä¸å­˜åœ¨ï¼Œéƒ½å°† misses è®¡æ•°åŠ ä¸€
</span></span><span class="line"><span class="cl">			// missLocked()ä¸­æ»¡è¶³æ¡ä»¶åå°±ä¼šæå‡ m.dirty
</span></span><span class="line"><span class="cl">			m.missLocked()
</span></span><span class="line"><span class="cl">		}
</span></span><span class="line"><span class="cl">		m.mu.Unlock()
</span></span><span class="line"><span class="cl">	}
</span></span><span class="line"><span class="cl">	if !ok {
</span></span><span class="line"><span class="cl">		return nil, false
</span></span><span class="line"><span class="cl">	}
</span></span><span class="line"><span class="cl">	return e.load()
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div><p>å¤„ç†è·¯å¾„åˆ†ä¸º fast path å’Œ slow pathï¼Œæ•´ä½“æµç¨‹å¦‚ä¸‹ï¼š</p>
<ol>
<li>é¦–å…ˆæ˜¯ fast pathï¼Œç›´æ¥åœ¨ read ä¸­æ‰¾ï¼Œå¦‚æœæ‰¾åˆ°äº†ç›´æ¥è°ƒç”¨ entry çš„ load æ–¹æ³•ï¼Œå–å‡ºå…¶ä¸­çš„å€¼ã€‚</li>
<li>å¦‚æœ read ä¸­æ²¡æœ‰è¿™ä¸ª keyï¼Œä¸” amended ä¸º falseï¼Œè¯´æ˜ dirty ä¸ºç©ºï¼Œé‚£ç›´æ¥è¿”å›ç©ºå’Œ falseã€‚</li>
<li>å¦‚æœ read ä¸­æ²¡æœ‰è¿™ä¸ª keyï¼Œä¸” amended ä¸º trueï¼Œè¯´æ˜ dirty ä¸­å¯èƒ½å­˜åœ¨æˆ‘ä»¬è¦æ‰¾çš„ keyã€‚è¦å…ˆä¸Šé”ï¼Œå†å°è¯•å» dirty ä¸­æŸ¥æ‰¾ã€‚åœ¨è¿™ä¹‹å‰ï¼Œä»ç„¶æœ‰ä¸€ä¸ª double check çš„æ“ä½œã€‚è‹¥è¿˜æ˜¯æ²¡æœ‰åœ¨ read ä¸­æ‰¾åˆ°ï¼Œé‚£ä¹ˆå°±ä» dirty ä¸­æ‰¾ã€‚ä¸ç®¡ dirty ä¸­æœ‰æ²¡æœ‰æ‰¾åˆ°ï¼Œéƒ½è¦ â€œè®°ä¸€ç¬”â€ï¼Œå› ä¸ºåœ¨ dirty è¢«æå‡ä¸º read ä¹‹å‰ï¼Œéƒ½ä¼šè¿›å…¥è¿™æ¡è·¯å¾„</li>
</ol>
<p>é‚£ä¹ˆ <code>m.dirty</code> æ˜¯å¦‚ä½•è¢«æå‡çš„â“ <code>missLocked</code> æ–¹æ³•ä¸­å¯èƒ½ä¼šå°† <code>m.dirty</code> æå‡ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">func (m *Map) missLocked() {
</span></span><span class="line"><span class="cl">	m.misses++ // ä¸ç®¡åœ¨ dirty ä¸­æ²¡æœ‰è¯»åˆ°ï¼Œmiss éƒ½æ‰§è¡Œ ++ æ“ä½œ
</span></span><span class="line"><span class="cl">	if m.misses &lt; len(m.dirty) {
</span></span><span class="line"><span class="cl">		return
</span></span><span class="line"><span class="cl">	}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	// å¦‚æœ miss çš„å€¼ &gt;= len(dirty)ï¼Œå°† dirty èµ‹ç»™ read, dirty å’Œ miss é‡æ–°åˆå§‹åŒ–
</span></span><span class="line"><span class="cl">	// æ­¤æ—¶ dirty å°±ä¸ºç©ºäº†ï¼Œè¯´æ˜ä» dirty å…¨éƒ¨è¿‡æ¸¡åˆ°äº† read, æ­¤æ—¶ read æ˜¯å…¨é‡çš„
</span></span><span class="line"><span class="cl">	m.read.Store(readOnly{m: m.dirty})
</span></span><span class="line"><span class="cl">	m.dirty = nil
</span></span><span class="line"><span class="cl">	m.misses = 0
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div><p>ç›´æ¥å°† misses çš„å€¼åŠ  1ï¼Œè¡¨ç¤ºä¸€æ¬¡æœªå‘½ä¸­ï¼Œå¦‚æœ misses å€¼å°äº <code>m.dirty</code> çš„é•¿åº¦ï¼Œå°±ç›´æ¥è¿”å›ã€‚å¦åˆ™ï¼Œå°† <code>m.dirty</code> æ™‹å‡ä¸º readï¼Œå¹¶æ¸…ç©º dirtyï¼Œæ¸…ç©º misses è®¡æ•°å€¼ï¼Œå¹¶ä¸” <code>m.read.amended</code> ä¸º <code>false</code>ã€‚è¿™æ ·ï¼Œä¹‹å‰ä¸€æ®µæ—¶é—´æ–°åŠ å…¥çš„ key éƒ½ä¼šè¿›å…¥åˆ° read ä¸­ï¼Œä»è€Œèƒ½å¤Ÿæå‡ read çš„å‘½ä¸­ç‡ã€‚</p>
<p>å†æ¥çœ‹ä¸‹ entry çš„ load æ–¹æ³•ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">func (e *entry) load() (value any, ok bool) {
</span></span><span class="line"><span class="cl">	p := atomic.LoadPointer(&amp;e.p)
</span></span><span class="line"><span class="cl">	if p == nil || p == expunged {
</span></span><span class="line"><span class="cl">		return nil, false
</span></span><span class="line"><span class="cl">	}
</span></span><span class="line"><span class="cl">	return *(*any)(p), true
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div><p>å¯¹äº nil å’Œ expunged çŠ¶æ€çš„ entryï¼Œç›´æ¥è¿”å› <code>ok=false</code>ï¼›å¦åˆ™ï¼Œå°† p è½¬æˆ <code>any</code> è¿”å›ã€‚</p>
<p>sync.Map çš„è¯»æ“ä½œæ€§èƒ½å¦‚æ­¤ä¹‹é«˜çš„åŸå› ï¼Œå°±åœ¨äºå­˜åœ¨ read è¿™ä¸€å·§å¦™çš„è®¾è®¡ï¼Œå…¶ä½œä¸ºä¸€ä¸ªç¼“å­˜å±‚ï¼Œæä¾›äº†<strong><ruby>å¿«è·¯å¾„<rt>fast path</rt></ruby></strong>çš„æŸ¥æ‰¾ã€‚</p>
<h2 id="deleteåˆ é™¤è¿‡ç¨‹" class="headerLink">
    <a href="#delete%e5%88%a0%e9%99%a4%e8%bf%87%e7%a8%8b" class="header-mark"></a>Deleteåˆ é™¤è¿‡ç¨‹</h2><p>å†™å…¥è¿‡ç¨‹ï¼Œç†è®ºä¸Šå’Œåˆ é™¤ä¸ä¼šå·®å¤ªè¿œã€‚æ€ä¹ˆ sync.Map ç±»å‹çš„åˆ é™¤çš„æ€§èƒ½ä¼¼ä¹è¿˜è¡Œï¼Œé‚£è¿™é‡Œé¢åˆ°åº•æ˜¯å¦‚ä½•å®ç°çš„å‘¢â“</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">func (m *Map) Delete(key any) {
</span></span><span class="line"><span class="cl">	read, _ := m.read.Load().(readOnly)
</span></span><span class="line"><span class="cl">	e, ok := read.m[key]
</span></span><span class="line"><span class="cl">	// å¦‚æœ read ä¸­æ²¡æœ‰è¿™ä¸ª keyï¼Œä¸” dirty map ä¸ä¸ºç©º
</span></span><span class="line"><span class="cl">	if !ok &amp;&amp; read.amended {
</span></span><span class="line"><span class="cl">		m.mu.Lock()
</span></span><span class="line"><span class="cl">		read, _ = m.read.Load().(readOnly)
</span></span><span class="line"><span class="cl">		e, ok = read.m[key]
</span></span><span class="line"><span class="cl">		if !ok &amp;&amp; read.amended {
</span></span><span class="line"><span class="cl">			delete(m.dirty, key) // ç›´æ¥ä» dirty ä¸­åˆ é™¤è¿™ä¸ª key
</span></span><span class="line"><span class="cl">		}
</span></span><span class="line"><span class="cl">		m.mu.Unlock()
</span></span><span class="line"><span class="cl">	}
</span></span><span class="line"><span class="cl">	if ok {
</span></span><span class="line"><span class="cl">		e.delete() // å¦‚æœåœ¨ read ä¸­æ‰¾åˆ°äº†è¿™ä¸ª keyï¼Œå°† p ç½®ä¸º nil
</span></span><span class="line"><span class="cl">	}
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div><p>ç¬¬ä¸€ç§æƒ…å†µï¼šå¯ä»¥çœ‹åˆ°ï¼Œå…ˆä» read é‡ŒæŸ¥æ˜¯å¦æœ‰è¿™ä¸ª keyï¼Œå¦‚æœæœ‰åˆ™æ‰§è¡Œ <code>e.delete</code> æ–¹æ³•ï¼Œå°† p ç½®ä¸º nilï¼Œè¿™æ · read å’Œ dirty éƒ½èƒ½çœ‹åˆ°è¿™ä¸ªå˜åŒ–ï¼Œå› ä¸ºå®ƒä»¬æŒ‡å‘çš„æ˜¯åŒä¸€å—å†…å­˜åœ°å€ã€‚</p>
<p><figure><a class="lightgallery" href="https://cdn.xiaobinqt.cn/xiaobinqt.io/20221205/3c105d85e5c24fecb51e45bc3a184cfe.png" title="æ•°æ®ç»“æ„" data-thumbnail="https://cdn.xiaobinqt.cn/xiaobinqt.io/20221205/3c105d85e5c24fecb51e45bc3a184cfe.png" data-sub-html="<h2>æ•°æ®ç»“æ„</h2><p>æ•°æ®ç»“æ„</p>">
        
    </a><figcaption class="image-caption">æ•°æ®ç»“æ„</figcaption>
    </figure></p>
<p>ä»¥ä¸‹æ˜¯<code>entry.delete</code>æ–¹æ³•ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">func (e *entry) delete() (hadValue bool) {
</span></span><span class="line"><span class="cl">	for {
</span></span><span class="line"><span class="cl">		p := atomic.LoadPointer(&amp;e.p)
</span></span><span class="line"><span class="cl">		if p == nil || p == expunged {
</span></span><span class="line"><span class="cl">			return false
</span></span><span class="line"><span class="cl">		}
</span></span><span class="line"><span class="cl">		if atomic.CompareAndSwapPointer(&amp;e.p, p, nil) {
</span></span><span class="line"><span class="cl">			return true
</span></span><span class="line"><span class="cl">		}
</span></span><span class="line"><span class="cl">	}
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div><p>å®ƒçœŸæ­£åšçš„äº‹æƒ…æ˜¯å°†æ­£å¸¸çŠ¶æ€ï¼ˆæŒ‡å‘ä¸€ä¸ª anyï¼‰çš„ p è®¾ç½®æˆ nilã€‚æ²¡æœ‰è®¾ç½®æˆ expunged çš„åŸå› æ˜¯ï¼Œå½“ p ä¸º expunged æ—¶ï¼Œè¡¨ç¤ºå®ƒå·²ç»ä¸åœ¨ dirty ä¸­äº†ï¼Œè¿™æ˜¯ p çš„çŠ¶æ€å†³å®šçš„ï¼Œåœ¨ <code>tryExpungeLocked</code> å‡½æ•°ä¸­ï¼Œä¼šå°† nil åŸå­åœ°è®¾ç½®æˆ expungedã€‚</p>
<p><code>tryExpungeLocked</code> æ˜¯åœ¨æ–°åˆ›å»º dirty æ—¶è°ƒç”¨çš„ï¼Œä¼šå°†å·²è¢«åˆ é™¤çš„ <code>entry.p</code> ä» nil æ”¹æˆ expungedï¼Œè¿™ä¸ª entry å°±ä¸ä¼šå†™å…¥ dirty äº†ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">func (e *entry) tryExpungeLocked() (isExpunged bool) {
</span></span><span class="line"><span class="cl">	p := atomic.LoadPointer(&amp;e.p)
</span></span><span class="line"><span class="cl">	for p == nil {
</span></span><span class="line"><span class="cl">		// å¦‚æœåŸæ¥æ˜¯ nilï¼Œè¯´æ˜åŸ key å·²è¢«åˆ é™¤ï¼Œåˆ™å°†å…¶è½¬ä¸º expungedã€‚
</span></span><span class="line"><span class="cl">		if atomic.CompareAndSwapPointer(&amp;e.p, nil, expunged) {
</span></span><span class="line"><span class="cl">			return true
</span></span><span class="line"><span class="cl">		}
</span></span><span class="line"><span class="cl">		p = atomic.LoadPointer(&amp;e.p)
</span></span><span class="line"><span class="cl">	}
</span></span><span class="line"><span class="cl">	return p == expunged
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div><p>ç¬¬äºŒç§æƒ…å†µï¼šå¦‚æœæ²¡åœ¨ read ä¸­æ‰¾åˆ°è¿™ä¸ª keyï¼Œå¹¶ä¸” dirty ä¸ä¸ºç©ºï¼Œé‚£ä¹ˆå°±è¦æ“ä½œ dirty äº†ï¼Œæ“ä½œä¹‹å‰ï¼Œè¿˜æ˜¯è¦å…ˆä¸Šé”ã€‚ç„¶åè¿›è¡Œ double checkï¼Œå¦‚æœä»ç„¶æ²¡æœ‰åœ¨ read é‡Œæ‰¾åˆ°æ­¤ keyï¼Œåˆ™ä» dirty ä¸­åˆ æ‰è¿™ä¸ª keyã€‚</p>
<p>æ³¨æ„åˆ°å¦‚æœ key åŒæ—¶å­˜åœ¨äº read å’Œ dirty ä¸­æ—¶ï¼Œåˆ é™¤åªæ˜¯åšäº†ä¸€ä¸ªæ ‡è®°ï¼Œå°† p ç½®ä¸º nilï¼›è€Œå¦‚æœä»…åœ¨ dirty ä¸­å«æœ‰è¿™ä¸ª key æ—¶ï¼Œä¼šç›´æ¥åˆ é™¤è¿™ä¸ª keyã€‚åŸå› åœ¨äºï¼Œè‹¥ä¸¤è€…éƒ½å­˜åœ¨è¿™ä¸ª keyï¼Œä»…åšæ ‡è®°åˆ é™¤ï¼Œå¯ä»¥åœ¨ä¸‹æ¬¡æŸ¥æ‰¾è¿™ä¸ª key æ—¶ï¼Œå‘½ä¸­ readï¼Œæå‡æ•ˆç‡ã€‚è‹¥åªæœ‰åœ¨ dirty ä¸­å­˜åœ¨æ—¶ï¼Œread èµ·ä¸åˆ° â€œç¼“å­˜â€ çš„ä½œç”¨ï¼Œç›´æ¥åˆ é™¤ã€‚</p>
<h2 id="dirtyå’Œreadäº’è½¬åˆ†åˆ«åœ¨ä»€ä¹ˆæ ·çš„æ—¶æœºä¸‹è¿›è¡Œ" class="headerLink">
    <a href="#dirty%e5%92%8cread%e4%ba%92%e8%bd%ac%e5%88%86%e5%88%ab%e5%9c%a8%e4%bb%80%e4%b9%88%e6%a0%b7%e7%9a%84%e6%97%b6%e6%9c%ba%e4%b8%8b%e8%bf%9b%e8%a1%8c" class="header-mark"></a>dirtyå’Œreadäº’è½¬ï¼Œåˆ†åˆ«åœ¨ä»€ä¹ˆæ ·çš„æ—¶æœºä¸‹è¿›è¡Œ</h2><ul>
<li>
<p><code>dirty-&gt;read</code>ï¼šéšç€ load çš„ miss ä¸æ–­è‡ªå¢ï¼Œè¾¾åˆ°é˜ˆå€¼ï¼ˆ<code>m.misses &gt;= len(m.dirty)</code>ï¼‰åè§¦å‘å‡çº§è½¬å‚¨ã€‚</p>
</li>
<li>
<p><code>read-&gt;dirty</code>ï¼šå½“æœ‰ read ä¸­ä¸å­˜åœ¨çš„æ–° key éœ€è¦å¢åŠ ï¼Œä¸” read å’Œ dirty ä¸€è‡´çš„æ—¶å€™ï¼Œè§¦å‘é‡å¡‘ï¼Œä¸” <code>read.amended</code> è®¾ç½®ä¸º trueï¼Œç„¶åå†åœ¨ dirty ä¸­æ–°å¢ã€‚é‡å¡‘çš„è¿‡ç¨‹ï¼Œä¼šå°† nil çŠ¶æ€çš„ entryï¼Œå…¨éƒ¨è½¬æ¢ä¸º expunged çŠ¶æ€ä¸­ï¼ŒåŒæ—¶å°†é expunged çš„ entry æµ…æ‹·è´åˆ° dirty ä¸­ï¼Œè¿™æ ·å¯ä»¥é¿å… read çš„ key æ— é™çš„è†¨èƒ€ï¼ˆå­˜åœ¨å¤§é‡é€»è¾‘åˆ é™¤çš„ keyï¼‰ã€‚æœ€ç»ˆï¼Œåœ¨ dirty å†æ¬¡å‡çº§ä¸º read çš„æ—¶å€™ï¼Œè¿™äº›é€»è¾‘åˆ é™¤çš„ key å°±å¯ä»¥ä¸€æ¬¡æ€§ä¸¢å¼ƒé‡Šæ”¾ï¼ˆå› ä¸ºæ˜¯ç›´æ¥è¦†ç›–ä¸Šå»ï¼‰ã€‚</p>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">if !read.amended {
</span></span><span class="line"><span class="cl">   // We&#39;re adding the first new key to the dirty map.
</span></span><span class="line"><span class="cl">   // Make sure it is allocated and mark the read-only map as incomplete.
</span></span><span class="line"><span class="cl">   m.dirtyLocked()
</span></span><span class="line"><span class="cl">   m.read.Store(readOnly{m: read.m, amended: true})
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div><p><figure><a class="lightgallery" href="https://cdn.xiaobinqt.cn/xiaobinqt.io/20221025/e8837d7eda904db586f5e78b23a69ef2.png" title="read-&amp;gt;dirty" data-thumbnail="https://cdn.xiaobinqt.cn/xiaobinqt.io/20221025/e8837d7eda904db586f5e78b23a69ef2.png" data-sub-html="<h2>read-&gt;dirty</h2><p>read-&amp;gt;dirty</p>">
        
    </a><figcaption class="image-caption">read->dirty</figcaption>
    </figure></p>
<h2 id="readä»ä½•è€Œæ¥å­˜åœ¨çš„æ„ä¹‰æ˜¯ä»€ä¹ˆ" class="headerLink">
    <a href="#read%e4%bb%8e%e4%bd%95%e8%80%8c%e6%9d%a5%e5%ad%98%e5%9c%a8%e7%9a%84%e6%84%8f%e4%b9%89%e6%98%af%e4%bb%80%e4%b9%88" class="header-mark"></a>readä»ä½•è€Œæ¥ï¼Œå­˜åœ¨çš„æ„ä¹‰æ˜¯ä»€ä¹ˆ</h2><ul>
<li>
<p>read æ˜¯ç”± dirty å‡çº§è€Œæ¥ï¼Œæ˜¯åˆ©ç”¨äº† <code>atomic.Store</code> ä¸€æ¬¡æ€§è¦†ç›–ï¼Œè€Œä¸æ˜¯ä¸€ç‚¹ç‚¹çš„ set æ“ä½œå‡ºæ¥çš„ã€‚æ‰€ä»¥ï¼Œread æ›´åƒæ˜¯ä¸€ä¸ªå¿«ç…§ï¼Œread ä¸­ key çš„é›†åˆä¸èƒ½è¢«æ”¹å˜ï¼ˆæ³¨æ„ï¼Œè¿™é‡Œè¯´çš„ read çš„ key ä¸å¯æ”¹å˜ï¼Œä¸ä»£è¡¨æŒ‡å®šçš„ key çš„ value ä¸å¯æ”¹å˜ï¼Œvalue æ˜¯å¯ä»¥é€šè¿‡åŸå­ <code>CAS</code> æ¥è¿›è¡Œæ›´æ”¹çš„ï¼‰ï¼Œæ‰€ä»¥å…¶ä¸­çš„é”®çš„é›†åˆæœ‰æ—¶å€™å¯èƒ½æ˜¯ä¸å…¨çš„ã€‚</p>
</li>
<li>
<p>è„å­—å…¸ä¸­çš„é”®å€¼å¯¹é›†åˆæ€»æ˜¯å®Œå…¨çš„ï¼Œä½†æ˜¯å…¶ä¸­<strong>ä¸ä¼šåŒ…å«</strong> expunged çš„é”®å€¼å¯¹ã€‚</p>
</li>
<li>
<p>read çš„å­˜åœ¨ä»·å€¼ï¼Œåœ¨äºåŠ é€Ÿè¯»æ€§èƒ½ï¼ˆé€šè¿‡åŸå­æ“ä½œé¿å…äº†é”ï¼‰ã€‚</p>
</li>
</ul>
<h2 id="dirtyä»€ä¹ˆæ—¶å€™æ˜¯nil" class="headerLink">
    <a href="#dirty%e4%bb%80%e4%b9%88%e6%97%b6%e5%80%99%e6%98%afnil" class="header-mark"></a>dirtyä»€ä¹ˆæ—¶å€™æ˜¯nil</h2><p>dirty æ•°æ®æå‡ä¸º read æ—¶ <code>m.dirty</code> ä¼šç½®ä¸º nilã€‚æ­¤æ—¶ï¼Œ<code>m.read</code> å’Œ <code>m.dirty</code> ç›¸ç­‰ï¼Œ<code>m.amended</code> ä¸º falseï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œread ä¸­æ‰¾ä¸åˆ°çš„æ•°æ®ï¼Œdirty ä¸­åŒæ ·æ‰¾ä¸åˆ°ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">amended bool // true if the dirty map contains some key not in m.
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">func (m *Map) missLocked() {
</span></span><span class="line"><span class="cl">	m.misses++
</span></span><span class="line"><span class="cl">	if m.misses &lt; len(m.dirty) {
</span></span><span class="line"><span class="cl">		return
</span></span><span class="line"><span class="cl">	}
</span></span><span class="line"><span class="cl">	m.read.Store(readOnly{m: m.dirty})
</span></span><span class="line"><span class="cl">	m.dirty = nil
</span></span><span class="line"><span class="cl">	m.misses = 0
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="åˆ é™¤æ—¶-ep-è®¾ç½®æˆäº†-nil-è¿˜æ˜¯-expunged" class="headerLink">
    <a href="#%e5%88%a0%e9%99%a4%e6%97%b6-ep-%e8%ae%be%e7%bd%ae%e6%88%90%e4%ba%86-nil-%e8%bf%98%e6%98%af-expunged" class="header-mark"></a>åˆ é™¤æ—¶ e.p è®¾ç½®æˆäº† nil è¿˜æ˜¯ expunged</h2><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">func (m *Map) Delete(key any) {
</span></span><span class="line"><span class="cl">	m.LoadAndDelete(key)
</span></span><span class="line"><span class="cl">}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">func (m *Map) LoadAndDelete(key any) (value any, loaded bool) {
</span></span><span class="line"><span class="cl">	read, _ := m.read.Load().(readOnly)
</span></span><span class="line"><span class="cl">	e, ok := read.m[key]
</span></span><span class="line"><span class="cl">	// å¦‚æœ read ä¸­ä¸å­˜åœ¨è¿™ä¸ª key å¹¶ä¸” dirty map ä¸­å­˜åœ¨è¿™ä¸ª key
</span></span><span class="line"><span class="cl">	if !ok &amp;&amp; read.amended {
</span></span><span class="line"><span class="cl">		m.mu.Lock()
</span></span><span class="line"><span class="cl">		read, _ = m.read.Load().(readOnly)
</span></span><span class="line"><span class="cl">		e, ok = read.m[key]
</span></span><span class="line"><span class="cl">		if !ok &amp;&amp; read.amended {
</span></span><span class="line"><span class="cl">			e, ok = m.dirty[key]
</span></span><span class="line"><span class="cl">			delete(m.dirty, key) // ç›´æ¥åˆ é™¤ dirty ä¸­çš„ keyï¼Œä¸ç®¡ dirty ä¸­å­˜ä¸å­˜åœ¨
</span></span><span class="line"><span class="cl">			// Regardless of whether the entry was present, record a miss: this key
</span></span><span class="line"><span class="cl">			// will take the slow path until the dirty map is promoted to the read
</span></span><span class="line"><span class="cl">			// map.
</span></span><span class="line"><span class="cl">			m.missLocked()
</span></span><span class="line"><span class="cl">		}
</span></span><span class="line"><span class="cl">		m.mu.Unlock()
</span></span><span class="line"><span class="cl">	}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	// read ä¸­å­˜åœ¨æˆ–æ˜¯ dirty ä¸­å­˜åœ¨éƒ½ä¼šèµ°åˆ°è¿™é‡Œ,æ‰§è¡Œ e.delete()
</span></span><span class="line"><span class="cl">	if ok {
</span></span><span class="line"><span class="cl">		return e.delete()
</span></span><span class="line"><span class="cl">	}
</span></span><span class="line"><span class="cl">	return nil, false
</span></span><span class="line"><span class="cl">}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">func (e *entry) delete() (value any, ok bool) {
</span></span><span class="line"><span class="cl">	for {
</span></span><span class="line"><span class="cl">		p := atomic.LoadPointer(&amp;e.p)
</span></span><span class="line"><span class="cl">		if p == nil || p == expunged {
</span></span><span class="line"><span class="cl">			return nil, false
</span></span><span class="line"><span class="cl">		}
</span></span><span class="line"><span class="cl">		// æŠŠ entry ä¸­çš„ p è½¬æˆ nilï¼Œè¡¨ç¤ºå·²ç»åˆ é™¤
</span></span><span class="line"><span class="cl">		if atomic.CompareAndSwapPointer(&amp;e.p, p, nil) {
</span></span><span class="line"><span class="cl">			// *(*any)(p) çš„ä½œç”¨æ˜¯å°†æŒ‡é’ˆ p æŒ‡å‘çš„æ•°æ®è½¬æ¢ä¸º any ç±»å‹ï¼Œå¹¶ä¸”è§£å¼•ç”¨è¯¥æŒ‡é’ˆï¼Œä»¥ä¾¿è®¿é—® any ç±»å‹çš„å€¼ã€‚
</span></span><span class="line"><span class="cl">			return *(*any)(p), true
</span></span><span class="line"><span class="cl">		}
</span></span><span class="line"><span class="cl">	}
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div><p>ç”±æºç å¯çŸ¥ï¼Œä¸ç®¡ key æ˜¯åœ¨ read ä¸­è¿˜æ˜¯ dirty ä¸­ï¼Œæœ€åéƒ½è°ƒç”¨äº† <code>e.delete()</code> æ–¹æ³•ï¼Œå°† e.p è®¾ç½®ä¸º nilã€‚</p>
<h2 id="ä»€ä¹ˆæ—¶å€™-ep-ç”±-nil-å˜æˆ-expunged" class="headerLink">
    <a href="#%e4%bb%80%e4%b9%88%e6%97%b6%e5%80%99-ep-%e7%94%b1-nil-%e5%8f%98%e6%88%90-expunged" class="header-mark"></a>ä»€ä¹ˆæ—¶å€™ e.p ç”± nil å˜æˆ expunged</h2><ul>
<li><code>read-&gt;dirty</code> é‡å¡‘çš„æ—¶å€™ï¼Œæ­¤æ—¶ read ä¸­ä»ç„¶æ˜¯ nil çš„ä¼šå˜æˆ expungedï¼Œè¡¨ç¤ºè¿™éƒ¨åˆ† key ç­‰å¾…è¢«æœ€ç»ˆä¸¢å¼ƒï¼ˆexpunged æ˜¯æœ€ç»ˆæ€ï¼Œç­‰å¾…è¢«ä¸¢å¼ƒï¼Œé™¤éåˆå‡ºç°äº†é‡æ–° Store çš„æƒ…å†µï¼‰</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">// åˆ¤æ–­ e.p æ˜¯ä¸æ˜¯ expunged, å¦‚æœæ˜¯ e.p æ˜¯ nil åˆ™è½¬ä¸º expunged
</span></span><span class="line"><span class="cl">func (e *entry) tryExpungeLocked() (isExpunged bool) {
</span></span><span class="line"><span class="cl">	p := atomic.LoadPointer(&amp;e.p)
</span></span><span class="line"><span class="cl">	for p == nil {
</span></span><span class="line"><span class="cl">		// å°† e.p çš„ nil è½¬æˆ expunged
</span></span><span class="line"><span class="cl">		if atomic.CompareAndSwapPointer(&amp;e.p, nil, expunged) {
</span></span><span class="line"><span class="cl">			return true
</span></span><span class="line"><span class="cl">		}
</span></span><span class="line"><span class="cl">		p = atomic.LoadPointer(&amp;e.p)
</span></span><span class="line"><span class="cl">	}
</span></span><span class="line"><span class="cl">	return p == expunged
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>æœ€ç»ˆä¸¢å¼ƒçš„æ—¶æœºå°±æ˜¯ <code>dirty-&gt;read</code> å‡çº§çš„æ—¶å€™ï¼Œdirty çš„ç›´æ¥ç²—æš´è¦†ç›–ï¼Œä¼šä½¿å¾— read ä¸­çš„æ‰€æœ‰æˆå‘˜éƒ½è¢«ä¸¢å¼ƒï¼ŒåŒ…æ‹¬ expungedã€‚</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">func (m *Map) missLocked() {
</span></span><span class="line"><span class="cl">	m.misses++ // ä¸ç®¡åœ¨ dirty ä¸­æ²¡æœ‰è¯»åˆ°ï¼Œmiss éƒ½æ‰§è¡Œ ++ æ“ä½œ
</span></span><span class="line"><span class="cl">	if m.misses &lt; len(m.dirty) {
</span></span><span class="line"><span class="cl">		return
</span></span><span class="line"><span class="cl">	}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	// å¦‚æœ miss çš„å€¼ &gt;= len(dirty)ï¼Œå°† dirty èµ‹ç»™ read, dirty å’Œ miss é‡æ–°åˆå§‹åŒ–
</span></span><span class="line"><span class="cl">	// æ­¤æ—¶ dirty å°±ä¸ºç©ºäº†ï¼Œè¯´æ˜ä» dirty å…¨éƒ¨è¿‡æ¸¡åˆ°äº† read, æ­¤æ—¶ read æ˜¯å…¨é‡çš„
</span></span><span class="line"><span class="cl">	m.read.Store(readOnly{m: m.dirty})
</span></span><span class="line"><span class="cl">	m.dirty = nil
</span></span><span class="line"><span class="cl">	m.misses = 0
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="æ—¢ç„¶-nil-è¡¨ç¤ºæ ‡è®°åˆ é™¤expunged-çš„æ„ä¹‰æ˜¯ä»€ä¹ˆ" class="headerLink">
    <a href="#%e6%97%a2%e7%84%b6-nil-%e8%a1%a8%e7%a4%ba%e6%a0%87%e8%ae%b0%e5%88%a0%e9%99%a4expunged-%e7%9a%84%e6%84%8f%e4%b9%89%e6%98%af%e4%bb%80%e4%b9%88" class="header-mark"></a>æ—¢ç„¶ nil è¡¨ç¤ºæ ‡è®°åˆ é™¤ï¼Œexpunged çš„æ„ä¹‰æ˜¯ä»€ä¹ˆ</h2><p><code>expunged</code> çš„æ„ä¹‰æ˜¯åœ¨åˆ é™¤æ“ä½œåï¼Œé”®å¯¹åº”å€¼è¢«æ ‡è®°ä¸º <code>expunged</code>ï¼Œè€Œä¸æ˜¯ç®€å•åœ°è®¾ç½®ä¸º <code>nil</code>ã€‚è¿™æ ·åšçš„å¥½å¤„æ˜¯ï¼Œ<code>nil</code> å€¼å¯èƒ½æ˜¯é”®æœ¬èº«çš„æœ‰æ•ˆå€¼ï¼Œå› æ­¤æ— æ³•åŒºåˆ†é”®å·²è¢«åˆ é™¤å’Œé”®å¯¹åº”çš„å€¼ä¸º <code>nil</code> ä¸¤ç§æƒ…å†µã€‚é€šè¿‡ä½¿ç”¨ <code>expunged</code> æ ‡è®°ï¼Œ<code>sync.Map</code> å¯ä»¥æ¸…æ¥šåœ°åŒºåˆ†é”®è¢«åˆ é™¤å’Œé”®å¯¹åº”çš„å€¼ä¸º <code>nil</code>ã€‚</p>
<p>å…·ä½“æ¥è¯´ï¼Œå½“æ‰§è¡Œåˆ é™¤æ“ä½œæ—¶ï¼Œ<code>sync.Map</code> å°†é”®å¯¹åº”çš„å€¼è®¾ç½®ä¸ºä¸€ä¸ªç‰¹æ®Šçš„å ä½ç¬¦ <code>expunged</code>ï¼Œè¡¨ç¤ºè¯¥é”®å·²è¢«åˆ é™¤ã€‚åœ¨åç»­çš„æ“ä½œä¸­ï¼Œé€šè¿‡æ£€æŸ¥å€¼æ˜¯å¦ç­‰äº <code>expunged</code>ï¼Œå¯ä»¥åˆ¤æ–­é”®æ˜¯å¦å­˜åœ¨ã€‚</p>
<p>è¿™ç§è®¾è®¡æœ‰ä»¥ä¸‹å¥½å¤„ï¼š</p>
<ol>
<li>
<p>é¿å…äº† <code>nil</code> å€¼å¯èƒ½å¸¦æ¥çš„æ­§ä¹‰ï¼š<code>nil</code> å€¼å¯èƒ½æ˜¯é”®çš„æœ‰æ•ˆå€¼ï¼Œå› æ­¤ä¸èƒ½ç®€å•åœ°ä¾é  <code>nil</code> å€¼æ¥åˆ¤æ–­é”®æ˜¯å¦å­˜åœ¨æˆ–å·²è¢«åˆ é™¤ã€‚</p>
</li>
<li>
<p>æé«˜äº†åˆ é™¤æ“ä½œçš„æ•ˆç‡ï¼šç›´æ¥å°†å€¼æ ‡è®°ä¸º <code>expunged</code>ï¼Œè€Œä¸æ˜¯åˆ é™¤é”®å€¼å¯¹ï¼Œå¯ä»¥é¿å…é‡æ–°åˆ†é…å†…å­˜æˆ–è¿›è¡Œå…¶ä»–å¤æ‚çš„æ“ä½œï¼Œä»è€Œæé«˜äº†åˆ é™¤æ“ä½œçš„æ•ˆç‡ã€‚</p>
</li>
<li>
<p>ä¿æŒäº†å¹¶å‘å®‰å…¨æ€§ï¼šé€šè¿‡å°†é”®çš„å¯¹åº”å€¼è®¾ç½®ä¸º <code>expunged</code>ï¼Œ<code>sync.Map</code> åœ¨å¹¶å‘ç¯å¢ƒä¸­ä»ç„¶èƒ½å¤Ÿä¿æŒæ­£ç¡®çš„çŠ¶æ€å’Œæ“ä½œä¸€è‡´æ€§ã€‚</p>
</li>
</ol>
<h2 id="å‚è€ƒ" class="headerLink">
    <a href="#%e5%8f%82%e8%80%83" class="header-mark"></a>å‚è€ƒ</h2><ul>
<li><a href="https://cloud.tencent.com/developer/article/2022098" target="_blank" rel="noopener noreferrer">ä¸å¾—ä¸çŸ¥é“çš„Golangä¹‹sync.Mapè§£è¯»ï¼</a></li>
<li><a href="https://mp.weixin.qq.com/s?__biz=MzUxMDI4MDc1NA==&amp;mid=2247489164&amp;idx=1&amp;sn=e56e5c9836cda40f3c95a39e2ba57dde" target="_blank" rel="noopener noreferrer">ä¸€å£æ°”ææ‡‚ Go sync.map æ‰€æœ‰çŸ¥è¯†ç‚¹</a></li>
<li><a href="https://colobu.com/2017/07/11/dive-into-sync-Map/" target="_blank" rel="noopener noreferrer">Go 1.9 sync.Mapæ­ç§˜</a></li>
<li><a href="https://qcrao.com/post/dive-into-go-sync-map/" target="_blank" rel="noopener noreferrer">æ·±åº¦è§£å¯† Go è¯­è¨€ä¹‹ sync.map</a></li>
</ul>
]]></description>
</item><item>
    <title>Go GC åƒåœ¾å›æ”¶</title>
    <link>https://www.xiaobinqt.cn/go-gc/</link>
    <pubDate>Wed, 06 Apr 2022 00:00:00 &#43;0000</pubDate><author>
        <name>xiaobinqt</name>
    </author><guid>https://www.xiaobinqt.cn/go-gc/</guid>
    <description><![CDATA[<div class="featured-image">
                <img src="https://cdn.xiaobinqt.cn/xiaobinqt.io/20221118/74f00ad9b278426887ea4348fd7a0e1c.png" referrerpolicy="no-referrer">
            </div><p>åƒåœ¾å›æ”¶ï¼ˆGarbage Collectionï¼ŒGCï¼‰æ˜¯ç¼–ç¨‹è¯­è¨€ä¸­æä¾›çš„è‡ªåŠ¨çš„å†…å­˜ç®¡ç†æœºåˆ¶ï¼Œè‡ªåŠ¨é‡Šæ”¾ä¸éœ€è¦çš„å†…å­˜å¯¹è±¡ï¼Œè®©å‡ºå­˜å‚¨å™¨èµ„æºã€‚GC è¿‡ç¨‹ä¸­æ— éœ€ç¨‹åºå‘˜æ‰‹åŠ¨æ‰§è¡Œã€‚</p>
<p>GC æœºåˆ¶åœ¨ç°ä»£å¾ˆå¤šç¼–ç¨‹è¯­è¨€éƒ½æ”¯æŒï¼ŒGC èƒ½åŠ›çš„æ€§èƒ½ä¸ä¼˜åŠ£ä¹Ÿæ˜¯ä¸åŒè¯­è¨€ä¹‹é—´å¯¹æ¯”åº¦æŒ‡æ ‡ä¹‹ä¸€ã€‚</p>
<h2 id="gc-å˜é©" class="headerLink">
    <a href="#gc-%e5%8f%98%e9%9d%a9" class="header-mark"></a>GC å˜é©</h2><p>// TODO</p>
<h2 id="å †å’Œæ ˆ" class="headerLink">
    <a href="#%e5%a0%86%e5%92%8c%e6%a0%88" class="header-mark"></a>å †å’Œæ ˆ</h2><p><strong>æ ˆ</strong>ï¼šç”±æ“ä½œç³»ç»Ÿè‡ªåŠ¨åˆ†é…é‡Šæ”¾ï¼Œå­˜æ”¾å‡½æ•°çš„å‚æ•°å€¼ï¼Œå±€éƒ¨å˜é‡çš„å€¼ç­‰ã€‚</p>
<p><strong>å †</strong>ï¼šä¸€èˆ¬ç”±ç¨‹åºå‘˜åˆ†é…å’Œé‡Šæ”¾ï¼Œè‹¥ç¨‹åºå‘˜ä¸é‡Šæ”¾ï¼Œç¨‹åºç»“æŸæ—¶å¯èƒ½ç”± OS å›æ”¶ã€‚</p>
<p>æ ˆä½¿ç”¨çš„æ˜¯ä¸€çº§ç¼“å­˜ï¼Œä»–ä»¬é€šå¸¸éƒ½æ˜¯è¢«è°ƒç”¨æ—¶å¤„äºå­˜å‚¨ç©ºé—´ä¸­ï¼Œ<strong>è°ƒç”¨å®Œæ¯•ç«‹å³é‡Šæ”¾</strong>ã€‚</p>
<p>å †åˆ™æ˜¯å­˜æ”¾åœ¨äºŒçº§ç¼“å­˜ä¸­ï¼Œç”Ÿå‘½å‘¨æœŸç”±è™šæ‹Ÿæœºçš„åƒåœ¾å›æ”¶ç®—æ³•æ¥å†³å®šï¼Œä½†å¹¶ä¸æ˜¯ä¸€æ—¦æˆä¸ºå­¤å„¿å¯¹è±¡å°±èƒ½è¢«å›æ”¶ã€‚</p>
<p>ç”³è¯·åˆ°æ ˆå†…å­˜å¥½å¤„ï¼šå‡½æ•°è¿”å›ç›´æ¥é‡Šæ”¾ï¼Œä¸ä¼šå¼•èµ·åƒåœ¾å›æ”¶ï¼Œå¯¹æ€§èƒ½æ²¡æœ‰å½±å“ã€‚</p>
<h2 id="æ ‡è®°æ¸…é™¤ç®—æ³•" class="headerLink">
    <a href="#%e6%a0%87%e8%ae%b0%e6%b8%85%e9%99%a4%e7%ae%97%e6%b3%95" class="header-mark"></a>æ ‡è®°æ¸…é™¤ç®—æ³•</h2><p>Go V1.3 ä¹‹å‰ä½¿ç”¨æ™®é€šçš„<strong><ruby>æ ‡è®°-æ¸…é™¤<rt>mark and sweep</rt></ruby></strong>ç®—æ³•ï¼Œä¸»è¦æœ‰ä¸¤ä¸ªä¸»è¦çš„æ­¥éª¤ï¼š</p>
<ol>
<li>
<p>æ ‡è®°(Mark phase)ï¼Œæ‰¾å‡º<strong>ä¸å¯è¾¾</strong>çš„å¯¹è±¡ï¼Œç„¶ååšä¸Šæ ‡è®°ã€‚</p>
</li>
<li>
<p>æ¸…é™¤(Sweep phase)ï¼Œå›æ”¶æ ‡è®°å¥½çš„å¯¹è±¡ã€‚</p>
</li>
</ol>
<h3 id="ç¬¬ä¸€æ­¥" class="headerLink">
    <a href="#%e7%ac%ac%e4%b8%80%e6%ad%a5" class="header-mark"></a>ç¬¬ä¸€æ­¥</h3><p><strong>æš‚åœ</strong>ç¨‹åºä¸šåŠ¡é€»è¾‘ï¼Œ åˆ†ç±»å‡ºå¯è¾¾å’Œä¸å¯è¾¾çš„å¯¹è±¡ï¼Œç„¶ååšä¸Šæ ‡è®°ã€‚</p>
<figure><a class="lightgallery" href="https://cdn.xiaobinqt.cn/xiaobinqt.io/20220406/692b1bd1669647518c96b6530c01b8a3.png" title="https://cdn.xiaobinqt.cn/xiaobinqt.io/20220406/692b1bd1669647518c96b6530c01b8a3.png" data-thumbnail="https://cdn.xiaobinqt.cn/xiaobinqt.io/20220406/692b1bd1669647518c96b6530c01b8a3.png" data-sub-html="<h2>ç¨‹åºä¸å¯¹è±¡çš„å¯è¾¾å…³ç³»</h2>">
        
    </a><figcaption class="image-caption">ç¨‹åºä¸å¯¹è±¡çš„å¯è¾¾å…³ç³»</figcaption>
    </figure>
<p>ğŸ‘†å›¾ä¸­è¡¨ç¤ºæ˜¯ç¨‹åºä¸å¯¹è±¡çš„å¯è¾¾å…³ç³»ï¼Œç›®å‰<strong>ç¨‹åºçš„å¯è¾¾</strong>å¯¹è±¡æœ‰å¯¹è±¡ 1-2-3ï¼Œå¯¹è±¡ 4-7 ç­‰äº”ä¸ªå¯¹è±¡ã€‚</p>
<h3 id="ç¬¬äºŒæ­¥" class="headerLink">
    <a href="#%e7%ac%ac%e4%ba%8c%e6%ad%a5" class="header-mark"></a>ç¬¬äºŒæ­¥</h3><p>å¼€å§‹æ ‡è®°ï¼Œç¨‹åºæ‰¾å‡ºå®ƒæ‰€æœ‰å¯è¾¾çš„å¯¹è±¡ï¼Œå¹¶åšä¸Šæ ‡è®°ğŸ‘‡ã€‚</p>
<figure><a class="lightgallery" href="https://cdn.xiaobinqt.cn/xiaobinqt.io/20220406/00d8aba1d229497c9cc907b359010178.png" title="https://cdn.xiaobinqt.cn/xiaobinqt.io/20220406/00d8aba1d229497c9cc907b359010178.png" data-thumbnail="https://cdn.xiaobinqt.cn/xiaobinqt.io/20220406/00d8aba1d229497c9cc907b359010178.png" data-sub-html="<h2>æ‰¾å‡ºå¯è¾¾å¯¹è±¡</h2>">
        
    </a><figcaption class="image-caption">æ‰¾å‡ºå¯è¾¾å¯¹è±¡</figcaption>
    </figure>
<p>å¯¹è±¡ 1-2-3 ã€å¯¹è±¡ 4-7 ç­‰äº”ä¸ªå¯¹è±¡è¢«åšä¸Šæ ‡è®°ã€‚</p>
<h3 id="ç¬¬ä¸‰æ­¥" class="headerLink">
    <a href="#%e7%ac%ac%e4%b8%89%e6%ad%a5" class="header-mark"></a>ç¬¬ä¸‰æ­¥</h3><p>æ ‡è®°å®Œäº†ä¹‹åï¼Œç„¶åå¼€å§‹æ¸…é™¤æœªæ ‡è®°çš„å¯¹è±¡ã€‚</p>
<figure><a class="lightgallery" href="https://cdn.xiaobinqt.cn/xiaobinqt.io/20220406/1a1ebfbd5c9b4f4183cb5bca704311e5.png" title="https://cdn.xiaobinqt.cn/xiaobinqt.io/20220406/1a1ebfbd5c9b4f4183cb5bca704311e5.png" data-thumbnail="https://cdn.xiaobinqt.cn/xiaobinqt.io/20220406/1a1ebfbd5c9b4f4183cb5bca704311e5.png" data-sub-html="<h2>æ¸…é™¤å¯¹è±¡</h2>">
        
    </a><figcaption class="image-caption">æ¸…é™¤å¯¹è±¡</figcaption>
    </figure>
<p>å¯¹è±¡ 5ï¼Œ6 ä¸å¯è¾¾ï¼Œè¢« GC æ¸…é™¤ã€‚</p>
<p>æ“ä½œç®€å•ï¼Œä½†æ˜¯ mark and sweep ç®—æ³•åœ¨æ‰§è¡Œçš„æ—¶å€™ï¼Œéœ€è¦ç¨‹åºæš‚åœï¼å³ <strong><ruby>STW<rt>stop the world</rt></ruby></strong>ï¼ŒSTW çš„è¿‡ç¨‹ä¸­ï¼ŒCPU ä¸æ‰§è¡Œç”¨æˆ·ä»£ç ï¼Œå…¨éƒ¨ç”¨äºåƒåœ¾å›æ”¶ï¼Œè¿™ä¸ªè¿‡ç¨‹çš„å½±å“å¾ˆå¤§ï¼Œæ‰€ä»¥ STW ä¹Ÿæ˜¯ä¸€äº›å›æ”¶æœºåˆ¶æœ€å¤§çš„éš¾é¢˜å’Œå¸Œæœ›ä¼˜åŒ–çš„ç‚¹ã€‚</p>
<p><strong>åœ¨æ‰§è¡Œç¬¬ä¸‰æ­¥çš„è¿™æ®µæ—¶é—´ï¼Œç¨‹åºä¼šæš‚å®šåœæ­¢ä»»ä½•å·¥ä½œï¼Œå¡åœ¨é‚£ç­‰å¾…å›æ”¶æ‰§è¡Œå®Œæ¯•</strong>ã€‚</p>
<h3 id="ç¬¬å››æ­¥" class="headerLink">
    <a href="#%e7%ac%ac%e5%9b%9b%e6%ad%a5" class="header-mark"></a>ç¬¬å››æ­¥</h3><p>åœæ­¢æš‚åœï¼Œè®©ç¨‹åºç»§ç»­æ‰§è¡Œã€‚ç„¶åå¾ªç¯é‡å¤è¿™ä¸ªè¿‡ç¨‹ï¼Œç›´åˆ° process ç¨‹åºç”Ÿå‘½å‘¨æœŸç»“æŸã€‚</p>
<h3 id="ç¼ºç‚¹ä¸ä¼˜åŒ–" class="headerLink">
    <a href="#%e7%bc%ba%e7%82%b9%e4%b8%8e%e4%bc%98%e5%8c%96" class="header-mark"></a>ç¼ºç‚¹ä¸ä¼˜åŒ–</h3><p>æ ‡è®°æ¸…é™¤ç®—æ³•æ˜äº†ï¼Œè¿‡ç¨‹é²œæ˜å¹²è„†ï¼Œä½†æ˜¯ä¹Ÿæœ‰éå¸¸ä¸¥é‡çš„é—®é¢˜ï¼Œå°±æ˜¯ STWï¼Œè®©ç¨‹åºæš‚åœï¼Œç¨‹åºå‡ºç°å¡é¡¿ã€‚</p>
<p>Go V1.3 ç‰ˆæœ¬ä¹‹å‰å°±æ˜¯ç”¨è¿™ç§æ–¹å¼æ¥å®æ–½çš„ã€‚æ‰§è¡Œ GC çš„åŸºæœ¬æµç¨‹å°±æ˜¯é¦–å…ˆå¯åŠ¨ STW æš‚åœï¼Œç„¶åæ‰§è¡Œæ ‡è®°ï¼Œå†æ‰§è¡Œæ•°æ®å›æ”¶ï¼Œæœ€ååœæ­¢ STW ï¼Œå¦‚ä¸‹å›¾ğŸ‘‡</p>
<p><figure><a class="lightgallery" href="https://cdn.xiaobinqt.cn/xiaobinqt.io/20220406/7913f2957c4f4b5c9ba01013cb0c44fa.png" title="STW" data-thumbnail="https://cdn.xiaobinqt.cn/xiaobinqt.io/20220406/7913f2957c4f4b5c9ba01013cb0c44fa.png" data-sub-html="<h2>STW</h2><p>STW</p>">
        
    </a><figcaption class="image-caption">STW</figcaption>
    </figure></p>
<p>ä»ğŸ‘†æ¥çœ‹ï¼Œå…¨éƒ¨çš„ GC æ—¶é—´éƒ½æ˜¯åŒ…è£¹åœ¨ STW èŒƒå›´ä¹‹å†…çš„ï¼Œè¿™æ ·è²Œä¼¼ç¨‹åºæš‚åœçš„æ—¶é—´è¿‡é•¿ï¼Œå½±å“ç¨‹åºçš„è¿è¡Œæ€§èƒ½ã€‚æ‰€ä»¥Go V1.3 åšäº†ç®€å•çš„ä¼˜åŒ–ï¼Œå°† STW çš„æ­¥éª¤æå‰ï¼Œå‡å°‘ STW æš‚åœçš„æ—¶é—´èŒƒå›´
ğŸ‘‡</p>
<p><figure><a class="lightgallery" href="https://cdn.xiaobinqt.cn/xiaobinqt.io/20220406/2b64ccd849624544ae495ed36236a780.png" title="STWä¼˜åŒ–" data-thumbnail="https://cdn.xiaobinqt.cn/xiaobinqt.io/20220406/2b64ccd849624544ae495ed36236a780.png" data-sub-html="<h2>STWä¼˜åŒ–</h2><p>STWä¼˜åŒ–</p>">
        
    </a><figcaption class="image-caption">STWä¼˜åŒ–</figcaption>
    </figure></p>
<p>ä¸»è¦æ˜¯å°† STW çš„æ­¥éª¤æå‰äº†ä¸€æ­¥ï¼Œå› ä¸ºåœ¨ Sweep æ¸…é™¤çš„æ—¶å€™ï¼Œå¯ä»¥ä¸éœ€è¦ STW åœæ­¢ï¼Œå› ä¸ºè¿™äº›å¯¹è±¡å·²ç»æ˜¯ä¸å¯è¾¾å¯¹è±¡äº†ï¼Œä¸ä¼šå‡ºç°å›æ”¶å†™å†²çªç­‰é—®é¢˜ï¼Œ<strong>æ¸…é™¤æ“ä½œå’Œç”¨æˆ·é€»è¾‘å¯ä»¥å¹¶å‘</strong>ã€‚</p>
<p>ä½†æ˜¯æ— è®ºæ€ä¹ˆä¼˜åŒ–ï¼ŒGo v1.3 éƒ½é¢ä¸´è¿™ä¸ªä¸€ä¸ªé‡è¦é—®é¢˜ï¼Œå°±æ˜¯ mark-and-sweep ç®—æ³•ä¼šæš‚åœæ•´ä¸ªç¨‹åº ã€‚</p>
<h2 id="æœ‰stwçš„ä¸‰è‰²æ ‡è®°æ³•" class="headerLink">
    <a href="#%e6%9c%89stw%e7%9a%84%e4%b8%89%e8%89%b2%e6%a0%87%e8%ae%b0%e6%b3%95" class="header-mark"></a>æœ‰STWçš„ä¸‰è‰²æ ‡è®°æ³•</h2><p>Go ä¸­çš„åƒåœ¾å›æ”¶ä¸»è¦åº”ç”¨ä¸‰è‰²æ ‡è®°æ³•ï¼ŒGC è¿‡ç¨‹å’Œå…¶ä»–ç”¨æˆ· goroutine å¯å¹¶å‘è¿è¡Œï¼Œä½†éœ€è¦ä¸€å®šæ—¶é—´çš„ STWã€‚</p>
<p>æ‰€è°“ä¸‰è‰²æ ‡è®°æ³•å®é™…ä¸Šå°±æ˜¯é€šè¿‡<strong>ä¸‰ä¸ªé˜¶æ®µçš„æ ‡è®°</strong>æ¥ç¡®å®šéœ€è¦æ¸…é™¤çš„å¯¹è±¡æœ‰å“ªäº›ã€‚</p>
<h3 id="ç¬¬ä¸€æ­¥-1" class="headerLink">
    <a href="#%e7%ac%ac%e4%b8%80%e6%ad%a5-1" class="header-mark"></a>ç¬¬ä¸€æ­¥</h3><p>æ¯æ¬¡æ–°åˆ›å»ºçš„å¯¹è±¡ï¼Œé»˜è®¤çš„é¢œè‰²éƒ½æ˜¯æ ‡è®°ä¸º â€œç™½è‰²â€ğŸ‘‡</p>
<figure><a class="lightgallery" href="https://cdn.xiaobinqt.cn/xiaobinqt.io/20220407/3b601d5fc23247b4b05de52b7fb2ed52.png" title="https://cdn.xiaobinqt.cn/xiaobinqt.io/20220407/3b601d5fc23247b4b05de52b7fb2ed52.png" data-thumbnail="https://cdn.xiaobinqt.cn/xiaobinqt.io/20220407/3b601d5fc23247b4b05de52b7fb2ed52.png" data-sub-html="<h2>ç™½è‰²å¯¹è±¡</h2>">
        
    </a><figcaption class="image-caption">ç™½è‰²å¯¹è±¡</figcaption>
    </figure>
<p>ä¸Šå›¾æ‰€ç¤ºï¼Œæˆ‘ä»¬çš„ç¨‹åºå¯æŠµè¾¾çš„å†…å­˜å¯¹è±¡å…³ç³»å¦‚å·¦å›¾æ‰€ç¤ºï¼Œå³è¾¹çš„æ ‡è®°è¡¨æ˜¯ç”¨æ¥è®°å½•ç›®å‰æ¯ä¸ªå¯¹è±¡çš„æ ‡è®°é¢œè‰²åˆ†ç±»ã€‚è¿™é‡Œæ‰€è°“ â€œç¨‹åºâ€ï¼Œæ˜¯ä¸€äº›<strong>å¯¹è±¡çš„æ ¹èŠ‚ç‚¹é›†åˆ</strong>ã€‚å¦‚æœæˆ‘ä»¬å°† â€œç¨‹åºâ€ å±•å¼€ï¼Œä¼šå¾—åˆ°ç±»ä¼¼å¦‚ä¸‹çš„è¡¨ç°å½¢å¼ï¼š</p>
<figure><a class="lightgallery" href="https://cdn.xiaobinqt.cn/xiaobinqt.io/20220406/25f6f7613a894569a426c70c6c8c2c10.png" title="https://cdn.xiaobinqt.cn/xiaobinqt.io/20220406/25f6f7613a894569a426c70c6c8c2c10.png" data-thumbnail="https://cdn.xiaobinqt.cn/xiaobinqt.io/20220406/25f6f7613a894569a426c70c6c8c2c10.png" data-sub-html="<h2>ç¨‹åºçš„æ ¹èŠ‚ç‚¹é›†åˆå±•å¼€</h2>">
        
    </a><figcaption class="image-caption">ç¨‹åºçš„æ ¹èŠ‚ç‚¹é›†åˆå±•å¼€</figcaption>
    </figure>
<h3 id="ç¬¬äºŒæ­¥-1" class="headerLink">
    <a href="#%e7%ac%ac%e4%ba%8c%e6%ad%a5-1" class="header-mark"></a>ç¬¬äºŒæ­¥</h3><p>æ¯æ¬¡ GC å›æ”¶å¼€å§‹ï¼Œ ä¼šä»æ ¹èŠ‚ç‚¹å¼€å§‹éå†æ‰€æœ‰å¯¹è±¡ï¼ŒæŠŠéå†åˆ°çš„å¯¹è±¡ä»ç™½è‰²é›†åˆæ”¾å…¥ â€œç°è‰²â€ é›†åˆï¼š</p>
<p><figure><a class="lightgallery" href="https://cdn.xiaobinqt.cn/xiaobinqt.io/20220406/c982dc0455cf437bace1b65454597995.png" title="éå†æ ¹å¯¹è±¡" data-thumbnail="https://cdn.xiaobinqt.cn/xiaobinqt.io/20220406/c982dc0455cf437bace1b65454597995.png" data-sub-html="<h2>éå†æ ¹å¯¹è±¡</h2><p>éå†æ ¹å¯¹è±¡</p>">
        
    </a><figcaption class="image-caption">éå†æ ¹å¯¹è±¡</figcaption>
    </figure></p>
<p>æœ¬æ¬¡éå†æ˜¯<strong>ä¸€æ¬¡éå†ï¼Œéé€’å½’å½¢å¼</strong>ï¼Œæ˜¯ä»ç¨‹åºåˆæ¬¡å¯æŠµè¾¾çš„å¯¹è±¡éå†ä¸€å±‚ï¼Œå¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œå½“å‰å¯æŠµè¾¾çš„å¯¹è±¡æ˜¯å¯¹è±¡1å’Œå¯¹è±¡4ï¼Œé‚£ä¹ˆè‡ªç„¶æœ¬è½®éå†ç»“æŸï¼Œå¯¹è±¡1å’Œå¯¹è±¡4å°±ä¼šè¢«æ ‡è®°ä¸ºç°è‰²ï¼Œç°è‰²æ ‡è®°è¡¨å°±ä¼šå¤šå‡ºè¿™ä¸¤ä¸ªå¯¹è±¡ã€‚</p>
<h3 id="ç¬¬ä¸‰æ­¥-1" class="headerLink">
    <a href="#%e7%ac%ac%e4%b8%89%e6%ad%a5-1" class="header-mark"></a>ç¬¬ä¸‰æ­¥</h3><p>éå†ç°è‰²é›†åˆï¼Œå°†ç°è‰²å¯¹è±¡å¼•ç”¨çš„å¯¹è±¡ä»ç™½è‰²é›†åˆæ”¾å…¥ç°è‰²é›†åˆï¼Œä¹‹åå°†æ­¤ç°è‰²å¯¹è±¡æ”¾å…¥é»‘è‰²é›†åˆï¼š</p>
<p><figure><a class="lightgallery" href="https://cdn.xiaobinqt.cn/xiaobinqt.io/20220406/f381a66d7e4944c998f7c893629accd4.png" title="éå†_2" data-thumbnail="https://cdn.xiaobinqt.cn/xiaobinqt.io/20220406/f381a66d7e4944c998f7c893629accd4.png" data-sub-html="<h2>éå†_2</h2><p>éå†_2</p>">
        
    </a><figcaption class="image-caption">éå†_2</figcaption>
    </figure></p>
<p>è¿™ä¸€æ¬¡éå†æ˜¯<strong>åªæ‰«æç°è‰²å¯¹è±¡</strong>ï¼Œå°†ç°è‰²å¯¹è±¡çš„ç¬¬ä¸€å±‚éå†å¯æŠµè¾¾çš„å¯¹è±¡ç”±ç™½è‰²å˜ä¸ºç°è‰²ï¼Œå¦‚ï¼šå¯¹è±¡2ã€å¯¹è±¡7ã€‚ è€Œä¹‹å‰çš„ç°è‰²å¯¹è±¡1 å’Œå¯¹è±¡4 åˆ™ä¼šè¢«æ ‡è®°ä¸ºé»‘è‰²ï¼ŒåŒæ—¶ç”±ç°è‰²æ ‡è®°è¡¨ç§»åŠ¨åˆ°é»‘è‰²æ ‡è®°è¡¨ä¸­ã€‚</p>
<h3 id="ç¬¬å››æ­¥-1" class="headerLink">
    <a href="#%e7%ac%ac%e5%9b%9b%e6%ad%a5-1" class="header-mark"></a>ç¬¬å››æ­¥</h3><p>é‡å¤ç¬¬ä¸‰æ­¥ï¼Œ ç›´åˆ°ç°è‰²ä¸­æ— ä»»ä½•å¯¹è±¡ï¼Œå¦‚å›¾ğŸ‘‡æ‰€ç¤ºï¼š</p>
<p><figure><a class="lightgallery" href="https://cdn.xiaobinqt.cn/xiaobinqt.io/20220406/3a751806772e445d813bee6344ab81d1.png" title="éå†_3" data-thumbnail="https://cdn.xiaobinqt.cn/xiaobinqt.io/20220406/3a751806772e445d813bee6344ab81d1.png" data-sub-html="<h2>éå†_3</h2><p>éå†_3</p>">
        
    </a><figcaption class="image-caption">éå†_3</figcaption>
    </figure></p>
<p><figure><a class="lightgallery" href="https://cdn.xiaobinqt.cn/xiaobinqt.io/20220406/07f715dda56a4b6ab242367ce0e15e4b.png" title="éå†_4" data-thumbnail="https://cdn.xiaobinqt.cn/xiaobinqt.io/20220406/07f715dda56a4b6ab242367ce0e15e4b.png" data-sub-html="<h2>éå†_4</h2><p>éå†_4</p>">
        
    </a><figcaption class="image-caption">éå†_4</figcaption>
    </figure></p>
<p>å½“æˆ‘ä»¬å…¨éƒ¨çš„å¯è¾¾å¯¹è±¡éƒ½éå†å®Œåï¼Œ<strong>ç°è‰²æ ‡è®°è¡¨å°†ä¸å†å­˜åœ¨ç°è‰²å¯¹è±¡</strong>ã€‚</p>
<p>ç›®å‰å…¨éƒ¨å†…å­˜çš„æ•°æ®åªæœ‰ä¸¤ç§é¢œè‰²ï¼Œé»‘è‰²å’Œç™½è‰²ã€‚é‚£ä¹ˆï¼Œé»‘è‰²å¯¹è±¡å°±æ˜¯æˆ‘ä»¬ç¨‹åºé€»è¾‘å¯è¾¾ï¼ˆéœ€è¦çš„ï¼‰å¯¹è±¡ï¼Œè¿™äº›æ•°æ®æ˜¯ç›®å‰æ”¯æ’‘ç¨‹åºæ­£å¸¸ä¸šåŠ¡è¿è¡Œçš„ï¼Œæ˜¯åˆæ³•çš„æœ‰ç”¨æ•°æ®ï¼Œä¸å¯åˆ é™¤ã€‚ç™½è‰²çš„å¯¹è±¡æ˜¯å…¨éƒ¨ä¸å¯è¾¾å¯¹è±¡ï¼Œç›®å‰ç¨‹åºé€»è¾‘å¹¶ä¸ä¾èµ–ä»–ä»¬ï¼Œé‚£ä¹ˆç™½è‰²å¯¹è±¡å°±æ˜¯å†…å­˜ä¸­ç›®å‰çš„åƒåœ¾æ•°æ®ï¼Œéœ€è¦è¢«æ¸…é™¤ã€‚</p>
<h3 id="ç¬¬äº”æ­¥" class="headerLink">
    <a href="#%e7%ac%ac%e4%ba%94%e6%ad%a5" class="header-mark"></a>ç¬¬äº”æ­¥</h3><p>å›æ”¶æ‰€æœ‰çš„ç™½è‰²æ ‡è®°è¡¨çš„å¯¹è±¡ï¼Œä¹Ÿå°±æ˜¯å›æ”¶åƒåœ¾ï¼Œå¦‚å›¾æ‰€ç¤ºğŸ‘‡</p>
<p><figure><a class="lightgallery" href="https://cdn.xiaobinqt.cn/xiaobinqt.io/20220406/f271ee96ace2416c8eaf808d3f45b8f0.png" title="GC å›æ”¶" data-thumbnail="https://cdn.xiaobinqt.cn/xiaobinqt.io/20220406/f271ee96ace2416c8eaf808d3f45b8f0.png" data-sub-html="<h2>GC å›æ”¶</h2><p>GC å›æ”¶</p>">
        
    </a><figcaption class="image-caption">GC å›æ”¶</figcaption>
    </figure></p>
<p>å°†å…¨éƒ¨çš„ç™½è‰²å¯¹è±¡è¿›è¡Œåˆ é™¤å›æ”¶ï¼Œå‰©ä¸‹çš„å°±æ˜¯å…¨éƒ¨ä¾èµ–çš„é»‘è‰²å¯¹è±¡ã€‚</p>
<p>è¿™é‡Œé¢å¯èƒ½ä¼šæœ‰å¾ˆå¤šå¹¶å‘æµç¨‹å‡ä¼šè¢«æ‰«æï¼Œæ‰§è¡Œå¹¶å‘æµç¨‹çš„å†…å­˜å¯èƒ½ç›¸äº’ä¾èµ–ï¼Œä¸ºäº†åœ¨ GC è¿‡ç¨‹ä¸­ä¿è¯æ•°æ®çš„å®‰å…¨ï¼Œ<strong>åœ¨å¼€å§‹ä¸‰è‰²æ ‡è®°ä¹‹å‰å°±ä¼šåŠ ä¸Š STWï¼Œåœ¨æ‰«æç¡®å®šé»‘ç™½å¯¹è±¡ä¹‹åå†æ”¾å¼€ STW</strong>ã€‚ä½†æ˜¯å¾ˆæ˜æ˜¾è¿™æ ·çš„ GC æ‰«æçš„æ€§èƒ½å®åœ¨æ˜¯å¤ªä½äº†ã€‚</p>
<p>æ‰€ä»¥ç°åœ¨çš„ä¸‰è‰²æ ‡è®°æ³•è¿˜æ˜¯ä¼š STWã€‚</p>
<h2 id="æ²¡æœ‰stwçš„ä¸‰è‰²æ ‡è®°æ³•" class="headerLink">
    <a href="#%e6%b2%a1%e6%9c%89stw%e7%9a%84%e4%b8%89%e8%89%b2%e6%a0%87%e8%ae%b0%e6%b3%95" class="header-mark"></a>æ²¡æœ‰STWçš„ä¸‰è‰²æ ‡è®°æ³•</h2><p>å¦‚æœæ²¡æœ‰ STWï¼Œé‚£ä¹ˆä¹Ÿå°±ä¸ä¼šå†å­˜åœ¨æ€§èƒ½ä¸Šçš„é—®é¢˜ï¼Œé‚£ä¹ˆå‡è®¾å¦‚æœä¸‰è‰²æ ‡è®°æ³•ä¸åŠ å…¥ STW ä¼šå‘ç”Ÿä»€ä¹ˆäº‹æƒ…â“</p>
<p>è¿˜æ˜¯åŸºäºä¸Šè¿°çš„ä¸‰è‰²æ ‡è®°æ³•æ¥åˆ†æï¼Œä»–æ˜¯ä¸€å®šè¦ä¾èµ– STW çš„ï¼Œå› ä¸ºå¦‚æœä¸æš‚åœç¨‹åºï¼Œç¨‹åºçš„é€»è¾‘å¯èƒ½ä¼šæ”¹å˜å¯¹è±¡çš„å¼•ç”¨å…³ç³»ï¼Œè¿™ç§åŠ¨ä½œå¦‚æœåœ¨æ ‡è®°é˜¶æ®µåšäº†ä¿®æ”¹ï¼Œä¼šå½±å“æ ‡è®°ç»“æœçš„æ­£ç¡®æ€§ã€‚</p>
<p>æ¥çœ‹çœ‹ä¸€ä¸ªåœºæ™¯ï¼Œå¦‚æœä¸‰è‰²æ ‡è®°æ³•ï¼Œæ ‡è®°è¿‡ç¨‹ä¸ä½¿ç”¨ STW å°†ä¼šå‘ç”Ÿä»€ä¹ˆäº‹æƒ…â“</p>
<p>æˆ‘ä»¬æŠŠåˆå§‹çŠ¶æ€è®¾ç½®ä¸ºå·²ç»ç»å†äº†ç¬¬ä¸€è½®æ‰«æï¼Œç›®å‰é»‘è‰²çš„æœ‰å¯¹è±¡ 1 å’Œå¯¹è±¡ 4ï¼Œç°è‰²çš„æœ‰å¯¹è±¡ 2 å’Œå¯¹è±¡ 7ï¼Œå…¶ä»–çš„ä¸ºç™½è‰²å¯¹è±¡ï¼Œä¸”å¯¹è±¡ 2 æ˜¯é€šè¿‡æŒ‡é’ˆ p æŒ‡å‘å¯¹è±¡ 3 çš„ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p>
<p><figure><a class="lightgallery" href="https://cdn.xiaobinqt.cn/xiaobinqt.io/20220406/df4917c4b48d4e12857a5b8552cf3815.png" title="no ST2 01" data-thumbnail="https://cdn.xiaobinqt.cn/xiaobinqt.io/20220406/df4917c4b48d4e12857a5b8552cf3815.png" data-sub-html="<h2>no ST2 01</h2><p>no ST2 01</p>">
        
    </a><figcaption class="image-caption">no ST2 01</figcaption>
    </figure></p>
<p>ç°åœ¨å¦‚æœä¸‰è‰²æ ‡è®°è¿‡ç¨‹ä¸å¯åŠ¨ STWï¼Œé‚£ä¹ˆåœ¨ GC æ‰«æè¿‡ç¨‹ä¸­ï¼Œ<strong>ä»»æ„çš„å¯¹è±¡å‡å¯èƒ½å‘ç”Ÿè¯»å†™æ“ä½œ</strong>
ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œåœ¨è¿˜æ²¡æœ‰æ‰«æåˆ°å¯¹è±¡ 2 çš„æ—¶å€™ï¼Œå·²ç»æ ‡è®°ä¸ºé»‘è‰²çš„å¯¹è±¡ 4ï¼Œæ­¤æ—¶åˆ›å»ºæŒ‡é’ˆ qï¼Œå¹¶ä¸”æŒ‡å‘ç™½è‰²çš„å¯¹è±¡ 3ã€‚</p>
<p><figure><a class="lightgallery" href="https://cdn.xiaobinqt.cn/xiaobinqt.io/20220406/c47b38d901dc46efb2ddc7b3d01fede4.png" title="no ST2 02" data-thumbnail="https://cdn.xiaobinqt.cn/xiaobinqt.io/20220406/c47b38d901dc46efb2ddc7b3d01fede4.png" data-sub-html="<h2>no ST2 02</h2><p>no ST2 02</p>">
        
    </a><figcaption class="image-caption">no ST2 02</figcaption>
    </figure></p>
<p>ä¸æ­¤åŒæ—¶ç°è‰²çš„å¯¹è±¡ 2 å°†æŒ‡é’ˆ p ç§»é™¤ï¼Œé‚£ä¹ˆç™½è‰²çš„å¯¹è±¡ 3 å®åˆ™æ˜¯è¢«æŒ‚åœ¨äº†å·²ç»æ‰«æå®Œæˆçš„é»‘è‰²çš„å¯¹è±¡ 4 ä¸‹ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p>
<p><figure><a class="lightgallery" href="https://cdn.xiaobinqt.cn/xiaobinqt.io/20220406/da651f3e078847ad8ba6ca0635301978.png" title="no ST2 03" data-thumbnail="https://cdn.xiaobinqt.cn/xiaobinqt.io/20220406/da651f3e078847ad8ba6ca0635301978.png" data-sub-html="<h2>no ST2 03</h2><p>no ST2 03</p>">
        
    </a><figcaption class="image-caption">no ST2 03</figcaption>
    </figure></p>
<p>ç„¶åæˆ‘ä»¬æ­£å¸¸æ‰§è¡Œä¸‰è‰²æ ‡è®°çš„ç®—æ³•é€»è¾‘ï¼Œå°†æ‰€æœ‰ç°è‰²çš„å¯¹è±¡æ ‡è®°ä¸ºé»‘è‰²ï¼Œé‚£ä¹ˆå¯¹è±¡ 2 å’Œå¯¹è±¡ 7 å°±è¢«æ ‡è®°æˆäº†é»‘è‰²ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p>
<p><figure><a class="lightgallery" href="https://cdn.xiaobinqt.cn/xiaobinqt.io/20220406/2a00e38c265a4370923ed6b4bf4a7435.png" title="no ST2 04" data-thumbnail="https://cdn.xiaobinqt.cn/xiaobinqt.io/20220406/2a00e38c265a4370923ed6b4bf4a7435.png" data-sub-html="<h2>no ST2 04</h2><p>no ST2 04</p>">
        
    </a><figcaption class="image-caption">no ST2 04</figcaption>
    </figure></p>
<p>é‚£ä¹ˆå°±æ‰§è¡Œäº†ä¸‰è‰²æ ‡è®°çš„æœ€åä¸€æ­¥ï¼Œå°†æ‰€æœ‰ç™½è‰²å¯¹è±¡å½“åšåƒåœ¾è¿›è¡Œå›æ”¶ï¼Œå¦‚å›¾æ‰€ç¤ºã€‚</p>
<p><figure><a class="lightgallery" href="https://cdn.xiaobinqt.cn/xiaobinqt.io/20220406/512e92ad527e4ac1871abb2a8df63e75.png" title="no ST2 05" data-thumbnail="https://cdn.xiaobinqt.cn/xiaobinqt.io/20220406/512e92ad527e4ac1871abb2a8df63e75.png" data-sub-html="<h2>no ST2 05</h2><p>no ST2 05</p>">
        
    </a><figcaption class="image-caption">no ST2 05</figcaption>
    </figure></p>
<p>æœ€åæˆ‘ä»¬å‘ç°ï¼Œæœ¬æ¥æ˜¯å¯¹è±¡4åˆæ³•å¼•ç”¨çš„å¯¹è±¡ 3ï¼Œå´è¢«GCç»™â€œè¯¯æ€â€å›æ”¶æ‰äº†ã€‚</p>
<p>å¯ä»¥çœ‹å‡ºï¼Œæœ‰ä¸¤ç§æƒ…å†µï¼Œåœ¨ä¸‰è‰²æ ‡è®°æ³•ä¸­æ˜¯ä¸å¸Œæœ›è¢«å‘ç”Ÿçš„ã€‚</p>
<ul>
<li>ğŸ‘‰ ä¸€ä¸ªç™½è‰²å¯¹è±¡è¢«é»‘è‰²å¯¹è±¡å¼•ç”¨ <strong>ï¼ˆç™½è‰²è¢«æŒ‚åœ¨é»‘è‰²ä¸‹ï¼‰</strong></li>
<li>ğŸ‘‰ ç°è‰²å¯¹è±¡ä¸å®ƒä¹‹é—´å¯è¾¾å…³ç³»çš„ç™½è‰²å¯¹è±¡é­åˆ°ç ´å <strong>ï¼ˆç°è‰²åŒæ—¶ä¸¢äº†è¯¥ç™½è‰²ï¼‰</strong></li>
</ul>
<p>å¦‚æœå½“ä»¥ä¸Šä¸¤ä¸ªæ¡ä»¶åŒæ—¶æ»¡è¶³æ—¶ï¼Œå°±ä¼šå‡ºç°å¯¹è±¡ä¸¢å¤±ç°è±¡ï¼</p>
<p><figure><a class="lightgallery" href="https://cdn.xiaobinqt.cn/xiaobinqt.io/20221120/f9e8dce78c274ccfb76bb491967d8fc2.png" title="ä¸‰è‰²æ ‡è®°å¯¹è±¡ä¸¢å¤±" data-thumbnail="https://cdn.xiaobinqt.cn/xiaobinqt.io/20221120/f9e8dce78c274ccfb76bb491967d8fc2.png" data-sub-html="<h2>ä¸‰è‰²æ ‡è®°å¯¹è±¡ä¸¢å¤±</h2><p>ä¸‰è‰²æ ‡è®°å¯¹è±¡ä¸¢å¤±</p>">
        
    </a><figcaption class="image-caption">ä¸‰è‰²æ ‡è®°å¯¹è±¡ä¸¢å¤±</figcaption>
    </figure></p>
<p>å¹¶ä¸”ï¼Œä¸Šé¢æ‰€ç¤ºçš„åœºæ™¯ä¸­ï¼Œå¦‚æœç¤ºä¾‹ä¸­çš„ç™½è‰²å¯¹è±¡3è¿˜æœ‰å¾ˆå¤šä¸‹æ¸¸å¯¹è±¡çš„è¯ï¼Œä¹Ÿä¼šä¸€å¹¶éƒ½æ¸…ç†æ‰ã€‚</p>
<p>ä¸ºäº†é˜²æ­¢è¿™ç§ç°è±¡çš„å‘ç”Ÿï¼Œæœ€ç®€å•çš„æ–¹å¼å°±æ˜¯ STWï¼Œç›´æ¥ç¦æ­¢æ‰å…¶ä»–ç”¨æˆ·ç¨‹åºå¯¹å¯¹è±¡å¼•ç”¨å…³ç³»çš„å¹²æ‰°ï¼Œä½†æ˜¯<strong>STWçš„è¿‡ç¨‹æœ‰æ˜æ˜¾çš„èµ„æºæµªè´¹ï¼Œå¯¹æ‰€æœ‰çš„ç”¨æˆ·ç¨‹åºéƒ½æœ‰å¾ˆå¤§å½±å“</strong>ã€‚</p>
<p>é‚£ä¹ˆæ˜¯å¦å¯ä»¥åœ¨ä¿è¯å¯¹è±¡ä¸ä¸¢å¤±çš„æƒ…å†µä¸‹åˆç†çš„å°½å¯èƒ½çš„æé«˜ GC æ•ˆç‡ï¼Œå‡å°‘ STW æ—¶é—´å‘¢â“</p>
<p>ç­”æ¡ˆæ˜¯å¯ä»¥çš„ï¼Œæˆ‘ä»¬åªè¦ä½¿ç”¨ä¸€ç§æœºåˆ¶ï¼Œå°è¯•å»ç ´åä¸Šé¢çš„ä¸¤ä¸ªå¿…è¦æ¡ä»¶å°±å¯ä»¥äº†ã€‚</p>
<h2 id="å±éšœæœºåˆ¶" class="headerLink">
    <a href="#%e5%b1%8f%e9%9a%9c%e6%9c%ba%e5%88%b6" class="header-mark"></a>å±éšœæœºåˆ¶</h2><p>å¦‚æœè®© GC å›æ”¶å™¨ï¼Œæ»¡è¶³ä¸‹é¢ä¸¤ç§æƒ…å†µä¹‹ä¸€æ—¶ï¼Œå³å¯ä¿è¯å¯¹è±¡ä¸ä¸¢å¤±ã€‚è¿™ä¸¤ç§æ–¹å¼å°±æ˜¯<strong>å¼ºä¸‰è‰²ä¸å˜å¼</strong>å’Œ<strong>å¼±ä¸‰è‰²ä¸å˜å¼</strong>ã€‚</p>
<p><figure><a class="lightgallery" href="https://cdn.xiaobinqt.cn/xiaobinqt.io/20221120/95aefcee22ae4f72a04437582362e947.png" title="å¼º/å¼±ä¸‰è‰²ä¸å˜å¼" data-thumbnail="https://cdn.xiaobinqt.cn/xiaobinqt.io/20221120/95aefcee22ae4f72a04437582362e947.png" data-sub-html="<h2>å¼º/å¼±ä¸‰è‰²ä¸å˜å¼</h2><p>å¼º/å¼±ä¸‰è‰²ä¸å˜å¼</p>">
        
    </a><figcaption class="image-caption">å¼º/å¼±ä¸‰è‰²ä¸å˜å¼</figcaption>
    </figure></p>
<h3 id="å¼ºä¸‰è‰²ä¸å˜å¼" class="headerLink">
    <a href="#%e5%bc%ba%e4%b8%89%e8%89%b2%e4%b8%8d%e5%8f%98%e5%bc%8f" class="header-mark"></a>å¼ºä¸‰è‰²ä¸å˜å¼</h3><p>å¼ºä¸‰è‰²ä¸å˜å¼å®é™…ä¸Šæ˜¯å¼ºåˆ¶æ€§çš„<strong>ä¸å…è®¸é»‘è‰²å¯¹è±¡å¼•ç”¨ç™½è‰²å¯¹è±¡</strong>ï¼Œè¿™æ ·å°±ä¸ä¼šå‡ºç°æœ‰ç™½è‰²å¯¹è±¡è¢«è¯¯åˆ çš„æƒ…å†µã€‚</p>
<figure><a class="lightgallery" href="https://cdn.xiaobinqt.cn/xiaobinqt.io/20230105/9f8f0337b20c475bbf637503e68b0766.png" title="https://cdn.xiaobinqt.cn/xiaobinqt.io/20230105/9f8f0337b20c475bbf637503e68b0766.png" data-thumbnail="https://cdn.xiaobinqt.cn/xiaobinqt.io/20230105/9f8f0337b20c475bbf637503e68b0766.png" data-sub-html="<h2>å¼ºä¸‰è‰²ä¸å˜å¼</h2>">
        
    </a><figcaption class="image-caption">å¼ºä¸‰è‰²ä¸å˜å¼</figcaption>
    </figure>
<h3 id="å¼±ä¸‰è‰²ä¸å˜å¼" class="headerLink">
    <a href="#%e5%bc%b1%e4%b8%89%e8%89%b2%e4%b8%8d%e5%8f%98%e5%bc%8f" class="header-mark"></a>å¼±ä¸‰è‰²ä¸å˜å¼</h3><p>æ‰€æœ‰è¢«é»‘è‰²å¯¹è±¡å¼•ç”¨çš„ç™½è‰²å¯¹è±¡éƒ½å¤„äºç°è‰²ä¿æŠ¤çŠ¶æ€ã€‚</p>
<p><figure><a class="lightgallery" href="https://cdn.xiaobinqt.cn/xiaobinqt.io/20220406/9766a534c5244092b12e47a8255c7dc4.png" title="å¼±ä¸‰è‰²ä¸å˜å¼" data-thumbnail="https://cdn.xiaobinqt.cn/xiaobinqt.io/20220406/9766a534c5244092b12e47a8255c7dc4.png" data-sub-html="<h2>å¼±ä¸‰è‰²ä¸å˜å¼</h2><p>å¼±ä¸‰è‰²ä¸å˜å¼</p>">
        
    </a><figcaption class="image-caption">å¼±ä¸‰è‰²ä¸å˜å¼</figcaption>
    </figure></p>
<p>å¼±ä¸‰è‰²ä¸å˜å¼å¼ºè°ƒï¼Œé»‘è‰²å¯¹è±¡å¯ä»¥å¼•ç”¨ç™½è‰²å¯¹è±¡ï¼Œä½†æ˜¯è¿™ä¸ªç™½è‰²å¯¹è±¡å¿…é¡»å­˜åœ¨å…¶ä»–ç°è‰²å¯¹è±¡å¯¹å®ƒçš„å¼•ç”¨ï¼Œæˆ–è€…å¯è¾¾å®ƒçš„é“¾è·¯ä¸Šæ¸¸å­˜åœ¨ç°è‰²å¯¹è±¡ã€‚è¿™æ ·å®åˆ™æ˜¯é»‘è‰²å¯¹è±¡å¼•ç”¨ç™½è‰²å¯¹è±¡ï¼Œç™½è‰²å¯¹è±¡å¤„äºä¸€ä¸ªå±é™©è¢«åˆ é™¤çš„çŠ¶æ€ï¼Œä½†æ˜¯ç”±äºä¸Šæ¸¸ç°è‰²å¯¹è±¡çš„å¼•ç”¨ï¼Œå¯ä»¥ä¿æŠ¤è¯¥ç™½è‰²å¯¹è±¡ï¼Œä½¿å…¶å®‰å…¨ã€‚</p>
<p>ä¸ºäº†éµå¾ªä¸Šè¿°çš„ä¸¤ä¸ªæ–¹å¼ï¼ŒGC ç®—æ³•æ¼”è¿›åˆ°ä¸¤ç§å±éšœæ–¹å¼ï¼Œåˆ†åˆ«æ˜¯<strong>æ’å…¥å±éšœ</strong>å’Œ<strong>åˆ é™¤å±éšœ</strong>ã€‚</p>
<h3 id="æ’å…¥å±éšœ" class="headerLink">
    <a href="#%e6%8f%92%e5%85%a5%e5%b1%8f%e9%9a%9c" class="header-mark"></a>æ’å…¥å±éšœ</h3><p>å…·ä½“æ“ä½œï¼š åœ¨ A å¯¹è±¡å¼•ç”¨ B å¯¹è±¡çš„æ—¶å€™ï¼ŒB å¯¹è±¡è¢«æ ‡è®°ä¸ºç°è‰²ã€‚<strong>å°† B æŒ‚åœ¨ A ä¸‹æ¸¸ï¼ŒB å¿…é¡»è¢«æ ‡è®°ä¸ºç°è‰²</strong>ã€‚</p>
<p>æ»¡è¶³ï¼š<strong>å¼ºä¸‰è‰²ä¸å˜å¼</strong>ã€‚ä¸å­˜åœ¨é»‘è‰²å¯¹è±¡å¼•ç”¨ç™½è‰²å¯¹è±¡çš„æƒ…å†µäº†ï¼Œ å› ä¸º<strong>ç™½è‰²ä¼šå¼ºåˆ¶å˜æˆç°è‰²</strong>ã€‚</p>
<p>ä¼ªä»£ç å¦‚ä¸‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">æ·»åŠ ä¸‹æ¸¸å¯¹è±¡(å½“å‰ä¸‹æ¸¸å¯¹è±¡slot, æ–°ä¸‹æ¸¸å¯¹è±¡ptr) {
</span></span><span class="line"><span class="cl">  //1
</span></span><span class="line"><span class="cl">  æ ‡è®°ç°è‰²(æ–°ä¸‹æ¸¸å¯¹è±¡ptr)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  //2
</span></span><span class="line"><span class="cl">  å½“å‰ä¸‹æ¸¸å¯¹è±¡slot = æ–°ä¸‹æ¸¸å¯¹è±¡ptr
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div><p>åœºæ™¯ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">A.æ·»åŠ ä¸‹æ¸¸å¯¹è±¡(nil, B)   //A ä¹‹å‰æ²¡æœ‰ä¸‹æ¸¸ï¼Œ æ–°æ·»åŠ ä¸€ä¸ªä¸‹æ¸¸å¯¹è±¡Bï¼Œ Bè¢«æ ‡è®°ä¸ºç°è‰²
</span></span><span class="line"><span class="cl">A.æ·»åŠ ä¸‹æ¸¸å¯¹è±¡(C, B)     //A å°†ä¸‹æ¸¸å¯¹è±¡C æ›´æ¢ä¸ºBï¼Œ  Bè¢«æ ‡è®°ä¸ºç°è‰²
</span></span></code></pre></td></tr></table>
</div>
</div><p>è¿™æ®µä¼ªä»£ç é€»è¾‘å°±æ˜¯å†™å±éšœï¼Œä½†æ˜¯è¿™é‡Œæœ‰ä¸ªæ€§èƒ½æŸè€—çš„åœ°æ–¹å°±æ˜¯æ¯æ¬¡æ·»åŠ å¥½æ’å…¥å¯¹è±¡éƒ½è¦å»åˆ¤æ–­ã€‚</p>
<p>é»‘è‰²å¯¹è±¡çš„å†…å­˜æ§½æœ‰ä¸¤ç§ä½ç½®ï¼Œæ ˆå’Œå †ã€‚ æ ˆç©ºé—´çš„ç‰¹ç‚¹æ˜¯å®¹é‡å°ï¼Œä½†æ˜¯è¦æ±‚å“åº”é€Ÿåº¦å¿«ï¼Œå› ä¸ºå‡½æ•°è°ƒç”¨å¼¹å‡ºé¢‘ç¹ä½¿ç”¨ï¼Œæ‰€ä»¥<strong>æ’å…¥å±éšœæœºåˆ¶ï¼Œåœ¨æ ˆç©ºé—´çš„å¯¹è±¡æ“ä½œä¸­ä¸ä½¿ç”¨ï¼Œè€Œä»…ä»…ä½¿ç”¨åœ¨å †ç©ºé—´å¯¹è±¡çš„æ“ä½œä¸­</strong>ã€‚</p>
<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ç”¨å‡ å¼ å›¾ï¼Œæ¥æ¨¡æ‹Ÿä¸€ä¸‹æ•´ä¸ªè¯¦ç»†çš„è¿‡ç¨‹ï¼Œå¸Œæœ›èƒ½æ›´å¯è§‚çš„çœ‹æ¸…æ•´ä½“æµç¨‹ã€‚</p>
<p><figure><a class="lightgallery" href="https://cdn.xiaobinqt.cn/xiaobinqt.io/20220406/9d76191546e44252ac8edd0fae087465.png" title="æ’å…¥å±éšœ01" data-thumbnail="https://cdn.xiaobinqt.cn/xiaobinqt.io/20220406/9d76191546e44252ac8edd0fae087465.png" data-sub-html="<h2>æ’å…¥å±éšœ01</h2><p>æ’å…¥å±éšœ01</p>">
        
    </a><figcaption class="image-caption">æ’å…¥å±éšœ01</figcaption>
    </figure></p>
<p><figure><a class="lightgallery" href="https://cdn.xiaobinqt.cn/xiaobinqt.io/20220406/3d4a215e1c8347e2a6ebf416617cb2ee.png" title="æ’å…¥å±éšœ02" data-thumbnail="https://cdn.xiaobinqt.cn/xiaobinqt.io/20220406/3d4a215e1c8347e2a6ebf416617cb2ee.png" data-sub-html="<h2>æ’å…¥å±éšœ02</h2><p>æ’å…¥å±éšœ02</p>">
        
    </a><figcaption class="image-caption">æ’å…¥å±éšœ02</figcaption>
    </figure></p>
<p><figure><a class="lightgallery" href="https://cdn.xiaobinqt.cn/xiaobinqt.io/20220406/53f0850d9ca746668c9a8ebf9c628ca3.png" title="æ’å…¥å±éšœ03" data-thumbnail="https://cdn.xiaobinqt.cn/xiaobinqt.io/20220406/53f0850d9ca746668c9a8ebf9c628ca3.png" data-sub-html="<h2>æ’å…¥å±éšœ03</h2><p>æ’å…¥å±éšœ03</p>">
        
    </a><figcaption class="image-caption">æ’å…¥å±éšœ03</figcaption>
    </figure></p>
<p><figure><a class="lightgallery" href="https://cdn.xiaobinqt.cn/xiaobinqt.io/20220406/2b66b768590b448f857a5dba72cd7146.png" title="æ’å…¥å±éšœ04" data-thumbnail="https://cdn.xiaobinqt.cn/xiaobinqt.io/20220406/2b66b768590b448f857a5dba72cd7146.png" data-sub-html="<h2>æ’å…¥å±éšœ04</h2><p>æ’å…¥å±éšœ04</p>">
        
    </a><figcaption class="image-caption">æ’å…¥å±éšœ04</figcaption>
    </figure></p>
<p><figure><a class="lightgallery" href="https://cdn.xiaobinqt.cn/xiaobinqt.io/20220406/f0a379d3fd1d45df8dd20f7a68f615e0.png" title="æ’å…¥å±éšœ05" data-thumbnail="https://cdn.xiaobinqt.cn/xiaobinqt.io/20220406/f0a379d3fd1d45df8dd20f7a68f615e0.png" data-sub-html="<h2>æ’å…¥å±éšœ05</h2><p>æ’å…¥å±éšœ05</p>">
        
    </a><figcaption class="image-caption">æ’å…¥å±éšœ05</figcaption>
    </figure></p>
<p><figure><a class="lightgallery" href="https://cdn.xiaobinqt.cn/xiaobinqt.io/20220406/c55625c54be54d848fb98ccfc88a76f9.png" title="æ’å…¥å±éšœ06" data-thumbnail="https://cdn.xiaobinqt.cn/xiaobinqt.io/20220406/c55625c54be54d848fb98ccfc88a76f9.png" data-sub-html="<h2>æ’å…¥å±éšœ06</h2><p>æ’å…¥å±éšœ06</p>">
        
    </a><figcaption class="image-caption">æ’å…¥å±éšœ06</figcaption>
    </figure></p>
<p>ä½†æ˜¯å¦‚æœæ ˆä¸æ·»åŠ ï¼Œå½“å…¨éƒ¨ä¸‰è‰²æ ‡è®°æ‰«æä¹‹åï¼Œæ ˆä¸Šæœ‰å¯èƒ½ä¾ç„¶å­˜åœ¨ç™½è‰²å¯¹è±¡è¢«å¼•ç”¨çš„æƒ…å†µï¼ˆå¦‚ä¸Šå›¾çš„å¯¹è±¡9ï¼‰ã€‚æ‰€ä»¥è¦å¯¹æ ˆé‡æ–°è¿›è¡Œä¸‰è‰²æ ‡è®°æ‰«æï¼Œä½†è¿™æ¬¡ä¸ºäº†å¯¹è±¡ä¸ä¸¢å¤±ï¼Œ<strong>è¦å¯¹æœ¬æ¬¡æ ‡è®°æ‰«æå¯åŠ¨ STW æš‚åœ</strong>ï¼Œç›´åˆ°æ ˆç©ºé—´çš„ä¸‰è‰²æ ‡è®°ç»“æŸã€‚</p>
<p><figure><a class="lightgallery" href="https://cdn.xiaobinqt.cn/xiaobinqt.io/20220406/80c67f3febd44156b71332b19172c2ec.png" title="æ’å…¥å±éšœ07" data-thumbnail="https://cdn.xiaobinqt.cn/xiaobinqt.io/20220406/80c67f3febd44156b71332b19172c2ec.png" data-sub-html="<h2>æ’å…¥å±éšœ07</h2><p>æ’å…¥å±éšœ07</p>">
        
    </a><figcaption class="image-caption">æ’å…¥å±éšœ07</figcaption>
    </figure></p>
<p><figure><a class="lightgallery" href="https://cdn.xiaobinqt.cn/xiaobinqt.io/20220406/77edaf8cc2cb4fad9283b5eedd81d2cf.png" title="æ’å…¥å±éšœ08" data-thumbnail="https://cdn.xiaobinqt.cn/xiaobinqt.io/20220406/77edaf8cc2cb4fad9283b5eedd81d2cf.png" data-sub-html="<h2>æ’å…¥å±éšœ08</h2><p>æ’å…¥å±éšœ08</p>">
        
    </a><figcaption class="image-caption">æ’å…¥å±éšœ08</figcaption>
    </figure></p>
<p><figure><a class="lightgallery" href="https://cdn.xiaobinqt.cn/xiaobinqt.io/20220406/268b613c2dbd44048b5fd32667957a6e.png" title="æ’å…¥å±éšœ09" data-thumbnail="https://cdn.xiaobinqt.cn/xiaobinqt.io/20220406/268b613c2dbd44048b5fd32667957a6e.png" data-sub-html="<h2>æ’å…¥å±éšœ09</h2><p>æ’å…¥å±éšœ09</p>">
        
    </a><figcaption class="image-caption">æ’å…¥å±éšœ09</figcaption>
    </figure></p>
<p>æœ€åå°†æ ˆå’Œå †ç©ºé—´æ‰«æå‰©ä½™çš„å…¨éƒ¨ç™½è‰²èŠ‚ç‚¹æ¸…é™¤ï¼Œè¿™æ¬¡ STW å¤§çº¦çš„æ—¶é—´åœ¨ 10~100ms é—´ã€‚è¿™ä¹Ÿæ˜¯æ’å…¥å†™å±éšœçš„<strong>ä¸è¶³</strong>ï¼Œå› ä¸ºè¿˜æ˜¯éœ€è¦ STWï¼Œè™½ç„¶æ—¶é—´å¾ˆçŸ­ã€‚</p>
<p><figure><a class="lightgallery" href="https://cdn.xiaobinqt.cn/xiaobinqt.io/20220406/c3fe1710d579448aa8b13f84cd2cd6f0.png" title="æ’å…¥å±éšœ10" data-thumbnail="https://cdn.xiaobinqt.cn/xiaobinqt.io/20220406/c3fe1710d579448aa8b13f84cd2cd6f0.png" data-sub-html="<h2>æ’å…¥å±éšœ10</h2><p>æ’å…¥å±éšœ10</p>">
        
    </a><figcaption class="image-caption">æ’å…¥å±éšœ10</figcaption>
    </figure></p>
<h3 id="åˆ é™¤å±éšœ" class="headerLink">
    <a href="#%e5%88%a0%e9%99%a4%e5%b1%8f%e9%9a%9c" class="header-mark"></a>åˆ é™¤å±éšœ</h3><p>å…·ä½“æ“ä½œï¼šè¢«åˆ é™¤çš„å¯¹è±¡ï¼Œå¦‚æœè‡ªèº«ä¸ºç°è‰²æˆ–è€…ç™½è‰²ï¼Œé‚£ä¹ˆè¢«æ ‡è®°ä¸ºç°è‰²ã€‚</p>
<p>æ»¡è¶³ï¼š<strong>å¼±ä¸‰è‰²ä¸å˜å¼</strong>ï¼Œä¿æŠ¤ç°è‰²å¯¹è±¡åˆ°ç™½è‰²å¯¹è±¡çš„è·¯å¾„ä¸ä¼šæ–­ã€‚</p>
<p>ä¼ªä»£ç ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">æ·»åŠ ä¸‹æ¸¸å¯¹è±¡(å½“å‰ä¸‹æ¸¸å¯¹è±¡slotï¼Œ æ–°ä¸‹æ¸¸å¯¹è±¡ptr) {
</span></span><span class="line"><span class="cl">  //1
</span></span><span class="line"><span class="cl">  if (å½“å‰ä¸‹æ¸¸å¯¹è±¡slotæ˜¯ç°è‰² || å½“å‰ä¸‹æ¸¸å¯¹è±¡slotæ˜¯ç™½è‰²) {
</span></span><span class="line"><span class="cl">  		æ ‡è®°ç°è‰²(å½“å‰ä¸‹æ¸¸å¯¹è±¡slot)     //slotä¸ºè¢«åˆ é™¤å¯¹è±¡ï¼Œ æ ‡è®°ä¸ºç°è‰²
</span></span><span class="line"><span class="cl">  }
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  //2
</span></span><span class="line"><span class="cl">  å½“å‰ä¸‹æ¸¸å¯¹è±¡slot = æ–°ä¸‹æ¸¸å¯¹è±¡ptr
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div><p>åœºæ™¯ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">A.æ·»åŠ ä¸‹æ¸¸å¯¹è±¡(B, nil)   //Aå¯¹è±¡ï¼Œåˆ é™¤Bå¯¹è±¡çš„å¼•ç”¨ã€‚ Bè¢«Aåˆ é™¤ï¼Œè¢«æ ‡è®°ä¸ºç°(å¦‚æœBä¹‹å‰ä¸ºç™½)
</span></span><span class="line"><span class="cl">A.æ·»åŠ ä¸‹æ¸¸å¯¹è±¡(B, C)         //Aå¯¹è±¡ï¼Œæ›´æ¢ä¸‹æ¸¸Bå˜æˆCã€‚ Bè¢«Aåˆ é™¤ï¼Œè¢«æ ‡è®°ä¸ºç°(å¦‚æœBä¹‹å‰ä¸ºç™½)
</span></span></code></pre></td></tr></table>
</div>
</div><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ç”¨å‡ å¼ å›¾ï¼Œæ¥æ¨¡æ‹Ÿä¸€ä¸ªè¯¦ç»†çš„è¿‡ç¨‹ï¼Œå¸Œæœ›èƒ½å¤Ÿæ›´å¯è§‚çš„çœ‹æ¸…æ¥šæ•´ä½“æµç¨‹ã€‚</p>
<p><figure><a class="lightgallery" href="https://cdn.xiaobinqt.cn/xiaobinqt.io/20220406/3ef46111cdca45b18626a0511f9b3df5.png" title="åˆ é™¤å±éšœ01" data-thumbnail="https://cdn.xiaobinqt.cn/xiaobinqt.io/20220406/3ef46111cdca45b18626a0511f9b3df5.png" data-sub-html="<h2>åˆ é™¤å±éšœ01</h2><p>åˆ é™¤å±éšœ01</p>">
        
    </a><figcaption class="image-caption">åˆ é™¤å±éšœ01</figcaption>
    </figure></p>
<p><figure><a class="lightgallery" href="https://cdn.xiaobinqt.cn/xiaobinqt.io/20220406/e08ac9cd722c45ef98d9362fa5401c48.png" title="åˆ é™¤å±éšœ02" data-thumbnail="https://cdn.xiaobinqt.cn/xiaobinqt.io/20220406/e08ac9cd722c45ef98d9362fa5401c48.png" data-sub-html="<h2>åˆ é™¤å±éšœ02</h2><p>åˆ é™¤å±éšœ02</p>">
        
    </a><figcaption class="image-caption">åˆ é™¤å±éšœ02</figcaption>
    </figure></p>
<p><figure><a class="lightgallery" href="https://cdn.xiaobinqt.cn/xiaobinqt.io/20220406/a8ad362faec241848935c82e1fa7e428.png" title="åˆ é™¤å±éšœ03" data-thumbnail="https://cdn.xiaobinqt.cn/xiaobinqt.io/20220406/a8ad362faec241848935c82e1fa7e428.png" data-sub-html="<h2>åˆ é™¤å±éšœ03</h2><p>åˆ é™¤å±éšœ03</p>">
        
    </a><figcaption class="image-caption">åˆ é™¤å±éšœ03</figcaption>
    </figure></p>
<p><figure><a class="lightgallery" href="https://cdn.xiaobinqt.cn/xiaobinqt.io/20220406/e230f27d981248e1b4bfb254a776c038.png" title="åˆ é™¤å±éšœ04" data-thumbnail="https://cdn.xiaobinqt.cn/xiaobinqt.io/20220406/e230f27d981248e1b4bfb254a776c038.png" data-sub-html="<h2>åˆ é™¤å±éšœ04</h2><p>åˆ é™¤å±éšœ04</p>">
        
    </a><figcaption class="image-caption">åˆ é™¤å±éšœ04</figcaption>
    </figure></p>
<p><figure><a class="lightgallery" href="https://cdn.xiaobinqt.cn/xiaobinqt.io/20220406/3887ebd09e204ec9932c0cfb10fb38fa.png" title="åˆ é™¤å±éšœ05" data-thumbnail="https://cdn.xiaobinqt.cn/xiaobinqt.io/20220406/3887ebd09e204ec9932c0cfb10fb38fa.png" data-sub-html="<h2>åˆ é™¤å±éšœ05</h2><p>åˆ é™¤å±éšœ05</p>">
        
    </a><figcaption class="image-caption">åˆ é™¤å±éšœ05</figcaption>
    </figure></p>
<p><figure><a class="lightgallery" href="https://cdn.xiaobinqt.cn/xiaobinqt.io/20220406/65cdf09e3d3e454487a23e3e79c424ee.png" title="åˆ é™¤å±éšœ06" data-thumbnail="https://cdn.xiaobinqt.cn/xiaobinqt.io/20220406/65cdf09e3d3e454487a23e3e79c424ee.png" data-sub-html="<h2>åˆ é™¤å±éšœ06</h2><p>åˆ é™¤å±éšœ06</p>">
        
    </a><figcaption class="image-caption">åˆ é™¤å±éšœ06</figcaption>
    </figure></p>
<p><figure><a class="lightgallery" href="https://cdn.xiaobinqt.cn/xiaobinqt.io/20220406/7d6c80f3eec34796ab3c3e333642de96.png" title="åˆ é™¤å±éšœ07" data-thumbnail="https://cdn.xiaobinqt.cn/xiaobinqt.io/20220406/7d6c80f3eec34796ab3c3e333642de96.png" data-sub-html="<h2>åˆ é™¤å±éšœ07</h2><p>åˆ é™¤å±éšœ07</p>">
        
    </a><figcaption class="image-caption">åˆ é™¤å±éšœ07</figcaption>
    </figure></p>
<p>è¿™ç§æ–¹å¼çš„<strong>ä¸è¶³æ˜¯å›æ”¶ç²¾åº¦ä½</strong>ï¼Œä¸€ä¸ªå¯¹è±¡å³ä½¿è¢«åˆ é™¤äº†æœ€åä¸€ä¸ªæŒ‡å‘å®ƒçš„æŒ‡é’ˆä¹Ÿ<strong>ä¾æ—§å¯ä»¥</strong>æ´»è¿‡è¿™ä¸€è½®ï¼Œåœ¨ä¸‹ä¸€è½® GC ä¸­è¢«æ¸…ç†æ‰ã€‚</p>
<h2 id="æ··åˆå†™å±éšœ" class="headerLink">
    <a href="#%e6%b7%b7%e5%90%88%e5%86%99%e5%b1%8f%e9%9a%9c" class="header-mark"></a>æ··åˆå†™å±éšœ</h2><p>æ’å…¥å†™å±éšœå’Œåˆ é™¤å†™å±éšœçš„çŸ­æ¿ï¼š</p>
<ul>
<li>æ’å…¥å†™å±éšœï¼šç»“æŸæ—¶éœ€è¦ STW æ¥é‡æ–°æ‰«ææ ˆï¼Œæ ‡è®°æ ˆä¸Šå¼•ç”¨çš„ç™½è‰²å¯¹è±¡çš„å­˜æ´»ï¼Œå¤§çº¦éœ€è¦ 10-100msã€‚</li>
<li>åˆ é™¤å†™å±éšœï¼šå›æ”¶ç²¾åº¦ä½ï¼Œä¸€ä¸ªå¯¹è±¡å³ä½¿è¢«åˆ é™¤äº†æœ€åä¸€ä¸ªæŒ‡å‘å®ƒçš„æŒ‡é’ˆä¹Ÿä¾æ—§å¯ä»¥æ´»è¿‡è¿™ä¸€è½®ï¼Œåœ¨ä¸‹ä¸€è½® GC ä¸­è¢«æ¸…ç†æ‰ã€‚GC å¼€å§‹æ—¶ STW æ‰«æå †æ ˆæ¥è®°å½•åˆå§‹å¿«ç…§ï¼ˆç›‘æ§å¯¹è±¡çš„å†…å­˜ä¿®æ”¹ï¼Œåˆ¤æ–­å¯¹è±¡æ˜¯å¦åˆ é™¤ï¼‰ï¼Œè¿™ä¸ªè¿‡ç¨‹ä¼šä¿æŠ¤å¼€å§‹æ—¶åˆ»çš„æ‰€æœ‰å­˜æ´»å¯¹è±¡ã€‚</li>
</ul>
<p>Go v1.8 ç‰ˆæœ¬å¼•å…¥äº†<strong><ruby>æ··åˆå†™å±éšœæœºåˆ¶<rt>hybrid write barrier</rt></ruby></strong>ï¼Œé¿å…äº†å¯¹æ ˆ re-scan çš„è¿‡ç¨‹ï¼Œæå¤§çš„å‡å°‘äº† STW çš„æ—¶é—´ï¼Œç»“åˆäº†ä¸¤è€…çš„ä¼˜ç‚¹ã€‚</p>
<h3 id="è§„åˆ™" class="headerLink">
    <a href="#%e8%a7%84%e5%88%99" class="header-mark"></a>è§„åˆ™</h3><p>å…·ä½“æ“ä½œï¼š</p>
<ol>
<li>GC å¼€å§‹å°†æ ˆä¸Šçš„å¯¹è±¡å…¨éƒ¨æ‰«æå¹¶æ ‡è®°ä¸ºé»‘è‰²ï¼ˆä¹‹åä¸å†è¿›è¡Œç¬¬äºŒæ¬¡é‡å¤æ‰«æï¼Œæ— éœ€ STW ï¼‰ã€‚</li>
<li><strong>GC æœŸé—´ï¼Œä»»ä½•åœ¨æ ˆä¸Šåˆ›å»ºçš„æ–°å¯¹è±¡ï¼Œå‡ä¸ºé»‘è‰²</strong>ã€‚</li>
<li>è¢«åˆ é™¤çš„å¯¹è±¡æ ‡è®°ä¸ºç°è‰²ã€‚</li>
<li>è¢«æ·»åŠ çš„å¯¹è±¡æ ‡è®°ä¸ºç°è‰²ã€‚</li>
</ol>
<p>æ»¡è¶³ï¼šå˜å½¢çš„å¼±ä¸‰è‰²ä¸å˜å¼ã€‚</p>
<p>ä¼ªä»£ç ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">æ·»åŠ ä¸‹æ¸¸å¯¹è±¡(å½“å‰ä¸‹æ¸¸å¯¹è±¡slot, æ–°ä¸‹æ¸¸å¯¹è±¡ptr) {
</span></span><span class="line"><span class="cl">  	//1
</span></span><span class="line"><span class="cl">	æ ‡è®°ç°è‰²(å½“å‰ä¸‹æ¸¸å¯¹è±¡slot)    //åªè¦å½“å‰ä¸‹æ¸¸å¯¹è±¡è¢«ç§»èµ°ï¼Œå°±æ ‡è®°ç°è‰²
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  	//2
</span></span><span class="line"><span class="cl">  	æ ‡è®°ç°è‰²(æ–°ä¸‹æ¸¸å¯¹è±¡ptr)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  	//3
</span></span><span class="line"><span class="cl">  	å½“å‰ä¸‹æ¸¸å¯¹è±¡slot = æ–°ä¸‹æ¸¸å¯¹è±¡ptr
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>å±éšœæŠ€æœ¯æ˜¯ä¸åœ¨æ ˆä¸Šåº”ç”¨çš„ï¼Œå› ä¸ºè¦ä¿è¯æ ˆçš„è¿è¡Œæ•ˆç‡ã€‚</p>
</blockquote>
<h3 id="å…·ä½“åœºæ™¯" class="headerLink">
    <a href="#%e5%85%b7%e4%bd%93%e5%9c%ba%e6%99%af" class="header-mark"></a>å…·ä½“åœºæ™¯</h3><p>æˆ‘ä»¬ç”¨å‡ å¼ å›¾ï¼Œæ¥æ¨¡æ‹Ÿä¸€ä¸ªè¯¦ç»†çš„è¿‡ç¨‹ï¼Œå¸Œæœ›èƒ½å¤Ÿæ›´å¯è§‚çš„çœ‹æ¸…æ¥šæ•´ä½“æµç¨‹ã€‚</p>
<p>æ··åˆå†™å±éšœæ˜¯ GC çš„ä¸€ç§å±éšœæœºåˆ¶ï¼Œæ‰€ä»¥åªæ˜¯å½“ç¨‹åºæ‰§è¡Œ GC çš„æ—¶å€™ï¼Œæ‰ä¼šè§¦å‘è¿™ç§æœºåˆ¶ã€‚</p>
<p>GCå¼€å§‹ï¼šä¼˜å…ˆæ‰«ææ ˆåŒºï¼Œå°†å¯è¾¾å¯¹è±¡å…¨éƒ¨æ ‡è®°ä¸ºé»‘</p>
<p><figure><a class="lightgallery" href="https://cdn.xiaobinqt.cn/xiaobinqt.io/20220407/d7aefd0f1c7e47fb94db02096fe857d9.png" title="æ··åˆå†™å±éšœ01" data-thumbnail="https://cdn.xiaobinqt.cn/xiaobinqt.io/20220407/d7aefd0f1c7e47fb94db02096fe857d9.png" data-sub-html="<h2>æ··åˆå†™å±éšœ01</h2><p>æ··åˆå†™å±éšœ01</p>">
        
    </a><figcaption class="image-caption">æ··åˆå†™å±éšœ01</figcaption>
    </figure></p>
<p><figure><a class="lightgallery" href="https://cdn.xiaobinqt.cn/xiaobinqt.io/20220407/d674041682d940189041add754694bdf.png" title="æ··åˆå†™å±éšœ02" data-thumbnail="https://cdn.xiaobinqt.cn/xiaobinqt.io/20220407/d674041682d940189041add754694bdf.png" data-sub-html="<h2>æ··åˆå†™å±éšœ02</h2><p>æ··åˆå†™å±éšœ02</p>">
        
    </a><figcaption class="image-caption">æ··åˆå†™å±éšœ02</figcaption>
    </figure></p>
<h4 id="åœºæ™¯ä¸€" class="headerLink">
    <a href="#%e5%9c%ba%e6%99%af%e4%b8%80" class="header-mark"></a>åœºæ™¯ä¸€</h4><p>å¯¹è±¡è¢«ä¸€ä¸ªå †å¯¹è±¡åˆ é™¤å¼•ç”¨ï¼Œæˆä¸ºæ ˆå¯¹è±¡çš„ä¸‹æ¸¸ã€‚</p>
<p>ä¼ªä»£ç </p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">//å‰æï¼šå †å¯¹è±¡4-&gt;å¯¹è±¡7 = å¯¹è±¡7ï¼›  //å¯¹è±¡7 è¢« å¯¹è±¡4å¼•ç”¨
</span></span><span class="line"><span class="cl">æ ˆå¯¹è±¡1-&gt;å¯¹è±¡7 = å †å¯¹è±¡7ï¼›  //å°†å †å¯¹è±¡7 æŒ‚åœ¨ æ ˆå¯¹è±¡1 ä¸‹æ¸¸
</span></span><span class="line"><span class="cl">å †å¯¹è±¡4-&gt;å¯¹è±¡7 = nullï¼›    //å¯¹è±¡4 åˆ é™¤å¼•ç”¨ å¯¹è±¡7
</span></span></code></pre></td></tr></table>
</div>
</div><p><figure><a class="lightgallery" href="https://cdn.xiaobinqt.cn/xiaobinqt.io/20220407/6eccf4b23f1044499d0bbf77c2069b21.png" title="åœºæ™¯1-01" data-thumbnail="https://cdn.xiaobinqt.cn/xiaobinqt.io/20220407/6eccf4b23f1044499d0bbf77c2069b21.png" data-sub-html="<h2>åœºæ™¯1-01</h2><p>åœºæ™¯1-01</p>">
        
    </a><figcaption class="image-caption">åœºæ™¯1-01</figcaption>
    </figure></p>
<p><figure><a class="lightgallery" href="https://cdn.xiaobinqt.cn/xiaobinqt.io/20220407/03f8a2fc5bcc4d76a74f48495900d00f.png" title="åœºæ™¯1-02" data-thumbnail="https://cdn.xiaobinqt.cn/xiaobinqt.io/20220407/03f8a2fc5bcc4d76a74f48495900d00f.png" data-sub-html="<h2>åœºæ™¯1-02</h2><p>åœºæ™¯1-02</p>">
        
    </a><figcaption class="image-caption">åœºæ™¯1-02</figcaption>
    </figure></p>
<h4 id="åœºæ™¯äºŒ" class="headerLink">
    <a href="#%e5%9c%ba%e6%99%af%e4%ba%8c" class="header-mark"></a>åœºæ™¯äºŒ</h4><p>å¯¹è±¡è¢«ä¸€ä¸ªæ ˆå¯¹è±¡åˆ é™¤å¼•ç”¨ï¼Œæˆä¸ºå¦ä¸€ä¸ªæ ˆå¯¹è±¡çš„ä¸‹æ¸¸ã€‚</p>
<p>ä¼ªä»£ç ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">new æ ˆå¯¹è±¡9ï¼›
</span></span><span class="line"><span class="cl">å¯¹è±¡8-&gt;å¯¹è±¡3 = å¯¹è±¡3ï¼›      //å°†æ ˆå¯¹è±¡3 æŒ‚åœ¨ æ ˆå¯¹è±¡9 ä¸‹æ¸¸
</span></span><span class="line"><span class="cl">å¯¹è±¡2-&gt;å¯¹è±¡3 = nullï¼›      //å¯¹è±¡2 åˆ é™¤å¼•ç”¨ å¯¹è±¡3
</span></span></code></pre></td></tr></table>
</div>
</div><p><figure><a class="lightgallery" href="https://cdn.xiaobinqt.cn/xiaobinqt.io/20220407/da92001995cf4c8cbf2568c3bacd7fbd.png" title="åœºæ™¯2-01" data-thumbnail="https://cdn.xiaobinqt.cn/xiaobinqt.io/20220407/da92001995cf4c8cbf2568c3bacd7fbd.png" data-sub-html="<h2>åœºæ™¯2-01</h2><p>åœºæ™¯2-01</p>">
        
    </a><figcaption class="image-caption">åœºæ™¯2-01</figcaption>
    </figure></p>
<p><figure><a class="lightgallery" href="https://cdn.xiaobinqt.cn/xiaobinqt.io/20220407/bc9ae45a820e4af682c58a25f96155e2.png" title="åœºæ™¯2-02" data-thumbnail="https://cdn.xiaobinqt.cn/xiaobinqt.io/20220407/bc9ae45a820e4af682c58a25f96155e2.png" data-sub-html="<h2>åœºæ™¯2-02</h2><p>åœºæ™¯2-02</p>">
        
    </a><figcaption class="image-caption">åœºæ™¯2-02</figcaption>
    </figure></p>
<p><figure><a class="lightgallery" href="https://cdn.xiaobinqt.cn/xiaobinqt.io/20220407/310dda56e97f411bab5a2e5576fd4369.png" title="åœºæ™¯2-03" data-thumbnail="https://cdn.xiaobinqt.cn/xiaobinqt.io/20220407/310dda56e97f411bab5a2e5576fd4369.png" data-sub-html="<h2>åœºæ™¯2-03</h2><p>åœºæ™¯2-03</p>">
        
    </a><figcaption class="image-caption">åœºæ™¯2-03</figcaption>
    </figure></p>
<h4 id="åœºæ™¯ä¸‰" class="headerLink">
    <a href="#%e5%9c%ba%e6%99%af%e4%b8%89" class="header-mark"></a>åœºæ™¯ä¸‰</h4><p>å¯¹è±¡è¢«ä¸€ä¸ªå †å¯¹è±¡åˆ é™¤å¼•ç”¨ï¼Œæˆä¸ºå¦ä¸€ä¸ªå †å¯¹è±¡çš„ä¸‹æ¸¸ã€‚</p>
<p>ä¼ªä»£ç ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">å †å¯¹è±¡10-&gt;å¯¹è±¡7 = å †å¯¹è±¡7ï¼›       //å°†å †å¯¹è±¡7 æŒ‚åœ¨ å †å¯¹è±¡10 ä¸‹æ¸¸
</span></span><span class="line"><span class="cl">å †å¯¹è±¡4-&gt;å¯¹è±¡7 = nullï¼›         //å¯¹è±¡4 åˆ é™¤å¼•ç”¨ å¯¹è±¡7
</span></span></code></pre></td></tr></table>
</div>
</div><p><figure><a class="lightgallery" href="https://cdn.xiaobinqt.cn/xiaobinqt.io/20220407/899ed05a51664c9eb09bfecce8b2945a.png" title="åœºæ™¯3-01" data-thumbnail="https://cdn.xiaobinqt.cn/xiaobinqt.io/20220407/899ed05a51664c9eb09bfecce8b2945a.png" data-sub-html="<h2>åœºæ™¯3-01</h2><p>åœºæ™¯3-01</p>">
        
    </a><figcaption class="image-caption">åœºæ™¯3-01</figcaption>
    </figure></p>
<p><figure><a class="lightgallery" href="https://cdn.xiaobinqt.cn/xiaobinqt.io/20220407/cee749d8466d416f8a1ecb07d1c165de.png" title="åœºæ™¯3-02" data-thumbnail="https://cdn.xiaobinqt.cn/xiaobinqt.io/20220407/cee749d8466d416f8a1ecb07d1c165de.png" data-sub-html="<h2>åœºæ™¯3-02</h2><p>åœºæ™¯3-02</p>">
        
    </a><figcaption class="image-caption">åœºæ™¯3-02</figcaption>
    </figure></p>
<p><figure><a class="lightgallery" href="https://cdn.xiaobinqt.cn/xiaobinqt.io/20220407/7d0257110cd2437dac1c7835c43b2a73.png" title="åœºæ™¯3-03" data-thumbnail="https://cdn.xiaobinqt.cn/xiaobinqt.io/20220407/7d0257110cd2437dac1c7835c43b2a73.png" data-sub-html="<h2>åœºæ™¯3-03</h2><p>åœºæ™¯3-03</p>">
        
    </a><figcaption class="image-caption">åœºæ™¯3-03</figcaption>
    </figure></p>
<h4 id="åœºæ™¯å››" class="headerLink">
    <a href="#%e5%9c%ba%e6%99%af%e5%9b%9b" class="header-mark"></a>åœºæ™¯å››</h4><p>å¯¹è±¡ä»ä¸€ä¸ªæ ˆå¯¹è±¡åˆ é™¤å¼•ç”¨ï¼Œæˆä¸ºå¦ä¸€ä¸ªå †å¯¹è±¡çš„ä¸‹æ¸¸ã€‚</p>
<p>ä¼ªä»£ç ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">å †å¯¹è±¡10-&gt;å¯¹è±¡7 = å †å¯¹è±¡7ï¼›       //å°†å †å¯¹è±¡7 æŒ‚åœ¨ å †å¯¹è±¡10 ä¸‹æ¸¸
</span></span><span class="line"><span class="cl">å †å¯¹è±¡4-&gt;å¯¹è±¡7 = nullï¼›         //å¯¹è±¡4 åˆ é™¤å¼•ç”¨ å¯¹è±¡7
</span></span></code></pre></td></tr></table>
</div>
</div><p><figure><a class="lightgallery" href="https://cdn.xiaobinqt.cn/xiaobinqt.io/20220407/c1cc894d7bef4f1ba26e92c7427de8a5.png" title="åœºæ™¯4-01" data-thumbnail="https://cdn.xiaobinqt.cn/xiaobinqt.io/20220407/c1cc894d7bef4f1ba26e92c7427de8a5.png" data-sub-html="<h2>åœºæ™¯4-01</h2><p>åœºæ™¯4-01</p>">
        
    </a><figcaption class="image-caption">åœºæ™¯4-01</figcaption>
    </figure></p>
<p><figure><a class="lightgallery" href="https://cdn.xiaobinqt.cn/xiaobinqt.io/20220407/0c64f5d24f674a90942170b8998deafa.png" title="åœºæ™¯4-02" data-thumbnail="https://cdn.xiaobinqt.cn/xiaobinqt.io/20220407/0c64f5d24f674a90942170b8998deafa.png" data-sub-html="<h2>åœºæ™¯4-02</h2><p>åœºæ™¯4-02</p>">
        
    </a><figcaption class="image-caption">åœºæ™¯4-02</figcaption>
    </figure></p>
<p><figure><a class="lightgallery" href="https://cdn.xiaobinqt.cn/xiaobinqt.io/20220407/e25db1900a4d404189fdcb61d33ac5d2.png" title="åœºæ™¯4-03" data-thumbnail="https://cdn.xiaobinqt.cn/xiaobinqt.io/20220407/e25db1900a4d404189fdcb61d33ac5d2.png" data-sub-html="<h2>åœºæ™¯4-03</h2><p>åœºæ™¯4-03</p>">
        
    </a><figcaption class="image-caption">åœºæ™¯4-03</figcaption>
    </figure></p>
<p>Go ä¸­çš„æ··åˆå†™å±éšœæ»¡è¶³<strong>å¼±ä¸‰è‰²ä¸å˜å¼</strong>ï¼Œç»“åˆäº†åˆ é™¤å†™å±éšœå’Œæ’å…¥å†™å±éšœçš„ä¼˜ç‚¹ï¼Œ<strong>åªéœ€è¦åœ¨å¼€å§‹æ—¶å¹¶å‘æ‰«æå„ä¸ª goroutine çš„æ ˆ</strong>ï¼Œä½¿å…¶å˜é»‘å¹¶ä¸€ç›´ä¿æŒï¼Œè¿™ä¸ªè¿‡ç¨‹ä¸éœ€è¦ STWï¼Œè€Œæ ‡è®°ç»“æŸåï¼Œå› ä¸ºæ ˆåœ¨æ‰«æåå§‹ç»ˆæ˜¯é»‘è‰²çš„ï¼Œä¹Ÿæ— éœ€å†è¿›è¡Œ re-scan æ“ä½œäº†ï¼Œå‡å°‘äº† STW çš„æ—¶é—´ã€‚</p>
<h2 id="æ€»ç»“" class="headerLink">
    <a href="#%e6%80%bb%e7%bb%93" class="header-mark"></a>æ€»ç»“</h2><p>GoV1.3ï¼šæ™®é€šæ ‡è®°æ¸…é™¤æ³•ï¼Œæ•´ä½“è¿‡ç¨‹éœ€è¦å¯åŠ¨ STWï¼Œæ•ˆç‡æä½ã€‚</p>
<p>GoV1.5ï¼šä¸‰è‰²æ ‡è®°æ³•ï¼Œå †ç©ºé—´å¯åŠ¨å†™å±éšœï¼Œæ ˆç©ºé—´ä¸å¯åŠ¨ï¼Œå…¨éƒ¨æ‰«æä¹‹åï¼Œéœ€è¦é‡æ–°æ‰«æä¸€æ¬¡æ ˆ(éœ€è¦ STW )ï¼Œæ•ˆç‡æ™®é€šã€‚</p>
<p>GoV1.8ï¼šä¸‰è‰²æ ‡è®°æ³•ï¼Œæ··åˆå†™å±éšœæœºåˆ¶ï¼Œ æ ˆç©ºé—´ä¸å¯åŠ¨ï¼Œå †ç©ºé—´å¯åŠ¨ã€‚æ•´ä¸ªè¿‡ç¨‹å‡ ä¹ä¸éœ€è¦STWï¼Œæ•ˆç‡è¾ƒé«˜ã€‚</p>
<h2 id="å‚è€ƒ" class="headerLink">
    <a href="#%e5%8f%82%e8%80%83" class="header-mark"></a>å‚è€ƒ</h2><ul>
<li><a href="https://community.apinto.com/d/34057-golang-gc" target="_blank" rel="noopener noreferrer">ä¸€æ–‡å¼„æ‡‚ Golang GCã€ä¸‰è‰²æ ‡è®°ã€æ··åˆå†™å±éšœæœºåˆ¶</a></li>
<li><a href="https://www.kancloud.cn/aceld/golang/1958308" target="_blank" rel="noopener noreferrer">Golangä¸‰è‰²æ ‡è®°+æ··åˆå†™å±éšœGCæ¨¡å¼å…¨åˆ†æ</a></li>
<li><a href="https://www.bilibili.com/video/BV1wz4y1y7Kd/" target="_blank" rel="noopener noreferrer">Golangä¸­GCå›æ”¶æœºåˆ¶ä¸‰è‰²æ ‡è®°ä¸æ··åˆå†™å±éšœ</a></li>
</ul>
]]></description>
</item><item>
    <title>Go GMP è°ƒåº¦æ¨¡å‹</title>
    <link>https://www.xiaobinqt.cn/gmp-model/</link>
    <pubDate>Wed, 16 Mar 2022 00:00:00 &#43;0000</pubDate><author>
        <name>xiaobinqt</name>
    </author><guid>https://www.xiaobinqt.cn/gmp-model/</guid>
    <description><![CDATA[<div class="featured-image">
                <img src="https://cdn.xiaobinqt.cn/xiaobinqt.io/20221118/555f4905eb1c4615b9702ead116731d1.png" referrerpolicy="no-referrer">
            </div><h2 id="è¿›ç¨‹çº¿ç¨‹åç¨‹çš„åŒºåˆ«" class="headerLink">
    <a href="#%e8%bf%9b%e7%a8%8b%e7%ba%bf%e7%a8%8b%e5%8d%8f%e7%a8%8b%e7%9a%84%e5%8c%ba%e5%88%ab" class="header-mark"></a>è¿›ç¨‹ã€çº¿ç¨‹ã€åç¨‹çš„åŒºåˆ«</h2><p><strong>è¿›ç¨‹</strong>ï¼šè¿›ç¨‹æ˜¯æ“ä½œç³»ç»Ÿä¸ºåº”ç”¨ç¨‹åºåˆ†é…èµ„æºçš„æœ€å°å•å…ƒã€‚æ¯ä¸ªè¿›ç¨‹æœ‰ç‹¬ç«‹çš„å†…å­˜ç©ºé—´å’ŒçŠ¶æ€ã€‚</p>
<p><strong>çº¿ç¨‹</strong>ï¼šçº¿ç¨‹æ˜¯è¿›ç¨‹ä¸­çš„ä¸€ä¸ªç‹¬ç«‹æ‰§è¡Œå•å…ƒã€‚åœ¨ Go ä¸­ï¼Œä¸€ä¸ªè¿›ç¨‹å¯ä»¥å¯åŠ¨å¤šä¸ªçº¿ç¨‹ï¼Œä»¥å¹¶è¡Œæ‰§è¡Œä»»åŠ¡ã€‚</p>
<p><strong>åç¨‹</strong>ï¼šåç¨‹æ˜¯ Go è¯­è¨€ä¸­çš„ä¸€ç§è½»é‡çº§çš„å¹¶å‘æŠ€æœ¯ã€‚å®ƒæ˜¯<strong>ç”¨æˆ·æ€çš„ï¼Œä¸éœ€è¦æ“ä½œç³»ç»Ÿçš„æ”¯æŒ</strong>ï¼Œå¯ä»¥åœ¨å•ä¸ªçº¿ç¨‹ä¸­å¯åŠ¨å¤šä¸ªåç¨‹ï¼Œå¹¶è¡Œæ‰§è¡Œä»»åŠ¡ã€‚åç¨‹å…±äº«åŒä¸€ä¸ªçº¿ç¨‹çš„èµ„æºï¼Œä½†æ‹¥æœ‰è‡ªå·±çš„æ ˆå’Œå¯„å­˜å™¨ã€‚</p>
<p>æ€»çš„æ¥è¯´ï¼Œè¿›ç¨‹å’Œçº¿ç¨‹æ˜¯æ“ä½œç³»ç»Ÿçº§åˆ«çš„å¹¶å‘æŠ€æœ¯ï¼Œç”¨äºåœ¨å¤šæ ¸å¤„ç†å™¨ä¸Šåˆ©ç”¨èµ„æºï¼›è€Œåç¨‹æ˜¯ Go è¯­è¨€æä¾›çš„ä¸€ç§é«˜æ•ˆã€è½»é‡çº§çš„å¹¶å‘æŠ€æœ¯ï¼Œç”¨äºå®ç°ç¨‹åºå†…éƒ¨çš„å¹¶å‘ä»»åŠ¡ã€‚</p>
<h3 id="è¿›ç¨‹" class="headerLink">
    <a href="#%e8%bf%9b%e7%a8%8b" class="header-mark"></a>è¿›ç¨‹</h3><p>è¿›ç¨‹æ˜¯æ“ä½œç³»ç»Ÿå¯¹ä¸€ä¸ªæ­£åœ¨è¿è¡Œçš„ç¨‹åºçš„ä¸€ç§æŠ½è±¡ï¼Œ<strong>è¿›ç¨‹æ˜¯èµ„æºåˆ†é…çš„æœ€å°å•ä½</strong>ï¼Œæ¯ä¸€ä¸ªè¿›ç¨‹éƒ½æœ‰ä¸€ä¸ªè‡ªå·±çš„åœ°å€ç©ºé—´ã€‚</p>
<p><figure><a class="lightgallery" href="https://cdn.xiaobinqt.cn/xiaobinqt.io/20220405/c0032558db4249a0a8ce4d6473327d38.png" title="è¿›ç¨‹åœ¨æ“ä½œç³»ç»Ÿä¸­çš„æŠ½è±¡è¡¨ç°" data-thumbnail="https://cdn.xiaobinqt.cn/xiaobinqt.io/20220405/c0032558db4249a0a8ce4d6473327d38.png" data-sub-html="<h2>è¿›ç¨‹åœ¨æ“ä½œç³»ç»Ÿä¸­çš„æŠ½è±¡è¡¨ç°</h2><p>è¿›ç¨‹åœ¨æ“ä½œç³»ç»Ÿä¸­çš„æŠ½è±¡è¡¨ç°</p>">
        
    </a><figcaption class="image-caption">è¿›ç¨‹åœ¨æ“ä½œç³»ç»Ÿä¸­çš„æŠ½è±¡è¡¨ç°</figcaption>
    </figure></p>
<p>é€šä¿—çš„è¯´ï¼Œ<strong>è¿›ç¨‹å°±æ˜¯ä¸€ä¸ªæ­£åœ¨æ‰§è¡Œçš„ç¨‹åº</strong>ã€‚</p>
<p><figure><a class="lightgallery" href="https://cdn.xiaobinqt.cn/xiaobinqt.io/20221118/19ae7497830b4301831fe13d24a30f5f.png?imageView2/0/q/75%7cwatermark/2/text/eGlhb2JpbnF0/font/dmlqYXlh/fontsize/1000/fill/IzVDNUI1Qg==/dissolve/52/gravity/SouthEast/dx/15/dy/15" title="Windowsä»»åŠ¡ç®¡ç†å™¨" data-thumbnail="https://cdn.xiaobinqt.cn/xiaobinqt.io/20221118/19ae7497830b4301831fe13d24a30f5f.png?imageView2/0/q/75|watermark/2/text/eGlhb2JpbnF0/font/dmlqYXlh/fontsize/1000/fill/IzVDNUI1Qg==/dissolve/52/gravity/SouthEast/dx/15/dy/15" data-sub-html="<h2>Windowsä»»åŠ¡ç®¡ç†å™¨</h2><p>Windowsä»»åŠ¡ç®¡ç†å™¨</p>">
        
    </a><figcaption class="image-caption">Windowsä»»åŠ¡ç®¡ç†å™¨</figcaption>
    </figure></p>
<p>è¿›ç¨‹å­˜åœ¨çš„æ„ä¹‰æ˜¯ä¸ºäº†<strong>åˆç†å‹æ¦¨ CPU çš„æ€§èƒ½å’Œåˆ†é…è¿è¡Œçš„æ—¶é—´ç‰‡ï¼Œè®© CPU ä¸èƒ½ â€œé—²ç€â€œ</strong>ã€‚</p>
<p>åœ¨è®¡ç®—æœºä¸­ï¼Œå…¶è®¡ç®—æ ¸å¿ƒæ˜¯ CPUï¼Œè´Ÿè´£æ‰€æœ‰è®¡ç®—ç›¸å…³çš„å·¥ä½œå’Œèµ„æºã€‚å•ä¸ª CPU ä¸€æ¬¡åªèƒ½è¿è¡Œä¸€ä¸ªä»»åŠ¡ã€‚å¦‚æœä¸€ä¸ªè¿›ç¨‹è·‘ç€ï¼Œå°±æŠŠå”¯ä¸€ä¸€ä¸ª CPU ç»™å®Œå…¨å ä½ï¼Œé‚£æ˜¯éå¸¸ä¸åˆç†çš„ã€‚</p>
<p>å¦‚æœæ€»æ˜¯åœ¨è¿è¡Œä¸€ä¸ªè¿›ç¨‹ä¸Šçš„ä»»åŠ¡ï¼Œå°±ä¼šå‡ºç°ä¸€ä¸ªç°è±¡ï¼Œå°±æ˜¯ä»»åŠ¡ä¸ä¸€å®šæ€»æ˜¯åœ¨æ‰§è¡Œ â€œè®¡ç®—å‹â€ çš„ä»»åŠ¡ï¼Œä¼šæœ‰å¾ˆå¤§å¯èƒ½æ˜¯åœ¨æ‰§è¡Œç½‘ç»œè°ƒç”¨é˜»å¡äº†ï¼Œé‚£ä¹ˆ CPU å²‚ä¸å°±æµªè´¹äº†ï¼Ÿ</p>
<p><figure><a class="lightgallery" href="https://cdn.xiaobinqt.cn/xiaobinqt.io/20220405/a406c795e40e4b7395a0228b299dd6bd.png" title="è¿›ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢" data-thumbnail="https://cdn.xiaobinqt.cn/xiaobinqt.io/20220405/a406c795e40e4b7395a0228b299dd6bd.png" data-sub-html="<h2>è¿›ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢</h2><p>è¿›ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢</p>">
        
    </a><figcaption class="image-caption">è¿›ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢</figcaption>
    </figure></p>
<p>æ‰€ä»¥å‡ºç°äº†å¤šè¿›ç¨‹ï¼Œå¤šä¸ª CPUï¼Œå¤šä¸ªè¿›ç¨‹ã€‚å¤šè¿›ç¨‹å°±æ˜¯æŒ‡è®¡ç®—æœºç³»ç»Ÿå¯ä»¥åŒæ—¶æ‰§è¡Œå¤šä¸ªè¿›ç¨‹ï¼Œä»ä¸€ä¸ªè¿›ç¨‹åˆ°å¦å¤–ä¸€ä¸ªè¿›ç¨‹çš„è½¬æ¢æ˜¯ç”±æ“ä½œç³»ç»Ÿå†…æ ¸ç®¡ç†çš„ï¼Œä¸€èˆ¬æ˜¯åŒæ—¶è¿è¡Œå¤šä¸ªè½¯ä»¶ã€‚</p>
<h3 id="çº¿ç¨‹" class="headerLink">
    <a href="#%e7%ba%bf%e7%a8%8b" class="header-mark"></a>çº¿ç¨‹</h3><p>æœ‰äº†å¤šè¿›ç¨‹ï¼Œåœ¨æ“ä½œç³»ç»Ÿä¸Šå¯ä»¥åŒæ—¶è¿è¡Œå¤šä¸ªè¿›ç¨‹ã€‚é‚£ä¹ˆä¸ºä»€ä¹ˆæœ‰äº†è¿›ç¨‹ï¼Œè¿˜è¦çº¿ç¨‹å‘¢ï¼Ÿè¿™æ˜¯å› ä¸ºï¼š</p>
<ul>
<li>è¿›ç¨‹é—´çš„ä¿¡æ¯éš¾ä»¥å…±äº«æ•°æ®ï¼Œçˆ¶å­è¿›ç¨‹å¹¶æœªå…±äº«å†…å­˜ï¼Œéœ€è¦é€šè¿‡è¿›ç¨‹é—´é€šä¿¡ï¼ˆIPCï¼‰ï¼Œåœ¨è¿›ç¨‹é—´è¿›è¡Œä¿¡æ¯äº¤æ¢ï¼Œæ€§èƒ½å¼€é”€è¾ƒå¤§ã€‚</li>
<li>åˆ›å»ºè¿›ç¨‹ï¼ˆä¸€èˆ¬æ˜¯è°ƒç”¨ <code>fork</code> æ–¹æ³•ï¼‰çš„æ€§èƒ½å¼€é”€è¾ƒå¤§ã€‚</li>
</ul>
<p>æ‰€ä»¥å¤§å®¶åˆæŠŠç›®å…‰è½¬å‘äº†è¿›ç¨‹å†…ï¼Œèƒ½ä¸èƒ½åœ¨è¿›ç¨‹é‡Œåšç‚¹ä»€ä¹ˆå‘¢ï¼Ÿ</p>
<figure><a class="lightgallery" href="https://cdn.xiaobinqt.cn/xiaobinqt.io/20220405/9462880ac1eb4cdeb5288716a15bac4d.png" title="https://cdn.xiaobinqt.cn/xiaobinqt.io/20220405/9462880ac1eb4cdeb5288716a15bac4d.png" data-thumbnail="https://cdn.xiaobinqt.cn/xiaobinqt.io/20220405/9462880ac1eb4cdeb5288716a15bac4d.png" data-sub-html="<h2>è¿›ç¨‹ç”±å¤šä¸ªçº¿ç¨‹ç»„æˆ</h2>">
        
    </a><figcaption class="image-caption">è¿›ç¨‹ç”±å¤šä¸ªçº¿ç¨‹ç»„æˆ</figcaption>
    </figure>
<p>ä¸€ä¸ªè¿›ç¨‹å¯ä»¥ç”±å¤šä¸ªç§°ä¸ºçº¿ç¨‹çš„æ‰§è¡Œå•å…ƒç»„æˆã€‚æ¯ä¸ªçº¿ç¨‹éƒ½è¿è¡Œåœ¨è¿›ç¨‹çš„ä¸Šä¸‹æ–‡ä¸­ï¼Œå…±äº«ç€åŒæ ·çš„ä»£ç å’Œå…¨å±€æ•°æ®ã€‚</p>
<p>å¤šä¸ªè¿›ç¨‹ï¼Œå°±å¯ä»¥æœ‰æ›´å¤šçš„çº¿ç¨‹ã€‚<strong>å¤šçº¿ç¨‹æ¯”å¤šè¿›ç¨‹ä¹‹é—´æ›´å®¹æ˜“å…±äº«æ•°æ®ï¼Œåœ¨ä¸Šä¸‹æ–‡åˆ‡æ¢ä¸­çº¿ç¨‹ä¸€èˆ¬æ¯”è¿›ç¨‹æ›´é«˜æ•ˆ</strong>ã€‚è¿™æ˜¯å› ä¸ºï¼Œ</p>
<ul>
<li>çº¿ç¨‹ä¹‹é—´èƒ½å¤Ÿéå¸¸æ–¹ä¾¿ã€å¿«é€Ÿåœ°å…±äº«æ•°æ®ã€‚ åªéœ€å°†æ•°æ®å¤åˆ¶åˆ°è¿›ç¨‹ä¸­çš„å…±äº«åŒºåŸŸå°±å¯ä»¥äº†ï¼Œä½†éœ€è¦æ³¨æ„é¿å…å¤šä¸ªçº¿ç¨‹ä¿®æ”¹åŒä¸€ä»½å†…å­˜ã€‚</li>
<li>åˆ›å»ºçº¿ç¨‹æ¯”åˆ›å»ºè¿›ç¨‹è¦å¿« 10 å€ç”šè‡³æ›´å¤šã€‚ çº¿ç¨‹éƒ½æ˜¯åŒä¸€ä¸ªè¿›ç¨‹ä¸‹è‡ªå®¶çš„å­©å­ï¼Œåƒæ˜¯å†…å­˜é¡µã€é¡µè¡¨ç­‰å°±ä¸éœ€è¦äº†ã€‚</li>
</ul>
<h3 id="åç¨‹" class="headerLink">
    <a href="#%e5%8d%8f%e7%a8%8b" class="header-mark"></a>åç¨‹</h3><p>åç¨‹ï¼ˆCo-routineï¼‰æ˜¯ç”¨æˆ·æ€çš„çº¿ç¨‹ã€‚é€šå¸¸åˆ›å»ºåç¨‹æ—¶ï¼Œä¼šä»è¿›ç¨‹çš„å †ä¸­åˆ†é…ä¸€æ®µå†…å­˜ä½œä¸ºåç¨‹çš„æ ˆã€‚</p>
<p>çº¿ç¨‹çš„æ ˆæœ‰ 8MBï¼Œè€Œåç¨‹æ ˆçš„å¤§å°é€šå¸¸åªæœ‰ KB çº§åˆ«ï¼Œè€Œ Go è¯­è¨€çš„åç¨‹æ›´å¤¸å¼ ï¼Œåªæœ‰ 2-4KBï¼Œéå¸¸çš„è½»å·§ã€‚</p>
<p>åç¨‹æœ‰ä»¥ä¸‹ä¼˜åŠ¿ğŸ‘‹ï¼š</p>
<ul>
<li>
<p>ğŸ‘‰èŠ‚çœ CPUï¼šé¿å…ç³»ç»Ÿå†…æ ¸çº§çš„çº¿ç¨‹é¢‘ç¹åˆ‡æ¢ï¼Œé€ æˆçš„ CPU èµ„æºæµªè´¹ã€‚è€Œåç¨‹æ˜¯ç”¨æˆ·æ€çš„çº¿ç¨‹ï¼Œç”¨æˆ·å¯ä»¥è‡ªè¡Œæ§åˆ¶åç¨‹çš„åˆ›å»ºäºé”€æ¯ï¼Œæå¤§ç¨‹åº¦é¿å…äº†ç³»ç»Ÿçº§çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢é€ æˆçš„èµ„æºæµªè´¹ã€‚</p>
</li>
<li>
<p>ğŸ‘‰èŠ‚çº¦å†…å­˜ï¼šåœ¨ 64 ä½çš„ Linux ä¸­ï¼Œä¸€ä¸ªçº¿ç¨‹éœ€è¦åˆ†é… 8MB æ ˆå†…å­˜å’Œ 64MB å †å†…å­˜ï¼Œç³»ç»Ÿå†…å­˜çš„åˆ¶çº¦å¯¼è‡´æˆ‘ä»¬æ— æ³•å¼€å¯æ›´å¤šçº¿ç¨‹å®ç°é«˜å¹¶å‘ã€‚è€Œåœ¨åç¨‹ç¼–ç¨‹æ¨¡å¼ä¸‹ï¼Œå¯ä»¥è½»æ¾æœ‰åå‡ ä¸‡åç¨‹ï¼Œè¿™æ˜¯çº¿ç¨‹æ— æ³•æ¯”æ‹Ÿçš„ã€‚</p>
</li>
<li>
<p>ğŸ‘‰ç¨³å®šæ€§ï¼šçº¿ç¨‹ä¹‹é—´é€šè¿‡å†…å­˜æ¥å…±äº«æ•°æ®ï¼Œè¿™ä¹Ÿå¯¼è‡´äº†ä¸€ä¸ªé—®é¢˜ï¼Œä»»ä½•ä¸€ä¸ªçº¿ç¨‹å‡ºé”™æ—¶ï¼Œè¿›ç¨‹ä¸­çš„æ‰€æœ‰çº¿ç¨‹éƒ½ä¼šè·Ÿç€ä¸€èµ·å´©æºƒã€‚</p>
</li>
<li>
<p>ğŸ‘‰å¼€å‘æ•ˆç‡ï¼šä½¿ç”¨åç¨‹åœ¨å¼€å‘ç¨‹åºä¹‹ä¸­ï¼Œå¯ä»¥å¾ˆæ–¹ä¾¿çš„å°†ä¸€äº›è€—æ—¶çš„ IO æ“ä½œå¼‚æ­¥åŒ–ï¼Œä¾‹å¦‚å†™æ–‡ä»¶ã€è€—æ—¶ IO è¯·æ±‚ç­‰ã€‚</p>
</li>
</ul>
<h2 id="goroutine-æ˜¯ä»€ä¹ˆ" class="headerLink">
    <a href="#goroutine-%e6%98%af%e4%bb%80%e4%b9%88" class="header-mark"></a>goroutine æ˜¯ä»€ä¹ˆ</h2><p>Goroutine æ˜¯ä¸€ä¸ªç”± Go è¿è¡Œæ—¶ç®¡ç†çš„è½»é‡çº§çº¿ç¨‹ï¼Œæˆ‘ä»¬ç§°ä¸º â€œåç¨‹â€ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">go f(x, y, z)
</span></span></code></pre></td></tr></table>
</div>
</div><p>æ“ä½œç³»ç»Ÿæœ¬èº«æ˜¯æ— æ³•æ˜ç¡®æ„ŸçŸ¥åˆ° Goroutine çš„å­˜åœ¨çš„ï¼ŒGoroutine çš„æ“ä½œå’Œåˆ‡æ¢å½’å±äº â€œç”¨æˆ·æ€â€ ä¸­ã€‚</p>
<p>Goroutine ç”±ç‰¹å®šçš„è°ƒåº¦æ¨¡å¼æ¥æ§åˆ¶ï¼Œä»¥ â€œå¤šè·¯å¤ç”¨â€ çš„å½¢å¼è¿è¡Œåœ¨æ“ä½œç³»ç»Ÿä¸º Go ç¨‹åºåˆ†é…çš„å‡ ä¸ªç³»ç»Ÿçº¿ç¨‹ä¸Šã€‚</p>
<p>åŒæ—¶åˆ›å»º Goroutine çš„å¼€é”€å¾ˆå°ï¼Œåˆå§‹åªéœ€è¦ 2-4k çš„æ ˆç©ºé—´ã€‚Goroutine æœ¬èº«ä¼šæ ¹æ®å®é™…ä½¿ç”¨æƒ…å†µè¿›è¡Œè‡ªä¼¸ç¼©ï¼Œéå¸¸è½»é‡ã€‚</p>
<div class="details admonition info open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-info-circle fa-fw"></i>Tips<i class="details-icon fas fa-angle-right fa-fw"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content"><p>Go ç¨‹åºä¸­æ²¡æœ‰è¯­è¨€çº§çš„å…³é”®å­—è®©ä½ å»åˆ›å»ºä¸€ä¸ªå†…æ ¸çº¿ç¨‹ï¼Œä½ åªèƒ½åˆ›å»º goroutineï¼Œå†…æ ¸çº¿ç¨‹åªèƒ½ç”± runtime æ ¹æ®å®é™…æƒ…å†µå»åˆ›å»ºã€‚</p>
<p>Go è¿è¡Œæ—¶ç³»ç»Ÿå¹¶æ²¡æœ‰å†…æ ¸è°ƒåº¦å™¨çš„ä¸­æ–­èƒ½åŠ›ï¼Œå†…æ ¸è°ƒåº¦å™¨ä¼šå‘èµ·æŠ¢å å¼è°ƒåº¦å°†é•¿æœŸè¿è¡Œçš„çº¿ç¨‹ä¸­æ–­å¹¶è®©å‡º CPU èµ„æºï¼Œè®©å…¶ä»–çº¿ç¨‹è·å¾—æ‰§è¡Œæœºä¼šã€‚</p>
</div>
        </div>
    </div>
<h2 id="è°ƒåº¦å™¨çš„ç”±æ¥" class="headerLink">
    <a href="#%e8%b0%83%e5%ba%a6%e5%99%a8%e7%9a%84%e7%94%b1%e6%9d%a5" class="header-mark"></a>è°ƒåº¦å™¨çš„ç”±æ¥</h2><p>åœ¨å¤šè¿›ç¨‹/å¤šçº¿ç¨‹çš„æ“ä½œç³»ç»Ÿä¸­ï¼Œè§£å†³äº†æ—©æœŸçš„å•è¿›ç¨‹æ“ä½œç³»ç»Ÿè¿›ç¨‹é˜»å¡çš„é—®é¢˜ï¼Œå› ä¸ºä¸€ä¸ªè¿›ç¨‹é˜»å¡ CPU å¯ä»¥ç«‹åˆ»åˆ‡æ¢åˆ°å…¶ä»–è¿›ç¨‹ä¸­å»æ‰§è¡Œï¼Œè€Œä¸”è°ƒåº¦ CPU çš„ç®—æ³•å¯ä»¥ä¿è¯åœ¨è¿è¡Œçš„è¿›ç¨‹éƒ½å¯ä»¥è¢«åˆ†é…åˆ° CPU çš„è¿è¡Œæ—¶é—´ç‰‡ï¼Œè¿™æ ·ä»å®è§‚æ¥çœ‹ï¼Œä¼¼ä¹å¤šä¸ªè¿›ç¨‹æ˜¯åœ¨åŒæ—¶è¢«è¿è¡Œã€‚</p>
<p>ä½†æ–°çš„é—®é¢˜å°±å‡ºç°äº†ï¼Œè¿›ç¨‹æ‹¥æœ‰å¤ªå¤šçš„èµ„æºï¼Œè¿›ç¨‹çš„åˆ›å»ºã€åˆ‡æ¢ã€é”€æ¯ï¼Œéƒ½ä¼šå ç”¨å¾ˆé•¿çš„æ—¶é—´ã€‚CPU è™½ç„¶åˆ©ç”¨èµ·æ¥äº†ï¼Œä½†å¦‚æœè¿›ç¨‹è¿‡å¤šï¼ŒCPU æœ‰å¾ˆå¤§çš„ä¸€éƒ¨åˆ†éƒ½è¢«ç”¨æ¥è¿›è¡Œè¿›ç¨‹è°ƒåº¦ã€‚ä¸ºäº†èƒ½æé«˜ CPU çš„åˆ©ç”¨ç‡ï¼Œè¿™é‡Œå°±éœ€è¦ç”¨åˆ°è°ƒåº¦ã€‚</p>
<p>CPU è°ƒåº¦åˆ‡æ¢çš„æ˜¯è¿›ç¨‹å’Œçº¿ç¨‹ï¼ŒCPU å¯¹è¿›ç¨‹å’Œçº¿ç¨‹çš„æ€åº¦æ˜¯ä¸€æ ·çš„ï¼Œè™½ç„¶çº¿ç¨‹çœ‹èµ·æ¥å¾ˆå¥½ï¼Œä½†å®é™…ä¸Šå¤šçº¿ç¨‹å¼€å‘è®¾è®¡ä¼šå˜å¾—å¾ˆå¤æ‚ï¼Œè¦è€ƒè™‘å¾ˆå¤šåŒæ­¥ç«äº‰çš„é—®é¢˜ï¼Œæ¯”å¦‚é”ã€ç«äº‰å†²çªç­‰ã€‚</p>
<p>ä¸€ä¸ªçº¿ç¨‹å…¶å®åˆ†ä¸º â€œå†…æ ¸æ€â€œ çº¿ç¨‹å’Œ â€œç”¨æˆ·æ€â€ çº¿ç¨‹ã€‚ä¸€ä¸ª â€œç”¨æˆ·æ€çº¿ç¨‹â€ å¿…é¡»è¦ç»‘å®šä¸€ä¸ª â€œå†…æ ¸æ€çº¿ç¨‹â€ï¼Œä½†æ˜¯ CPU å¹¶ä¸çŸ¥é“æœ‰ â€œç”¨æˆ·æ€çº¿ç¨‹â€ çš„å­˜åœ¨ï¼ŒCPU åªçŸ¥é“å®ƒè¿è¡Œçš„æ˜¯ä¸€ä¸ª â€œå†…æ ¸æ€çº¿ç¨‹â€ã€‚è¿™é‡Œæˆ‘ä»¬å¯ä»¥æŠŠå†…æ ¸çº¿ç¨‹ä¾ç„¶å«<strong>çº¿ç¨‹</strong>ï¼Œç”¨æˆ·çº¿ç¨‹å«<strong>åç¨‹</strong>ã€‚æ—¢ç„¶ä¸€ä¸ªåç¨‹å¯ä»¥ç»‘å®šä¸€ä¸ªçº¿ç¨‹ï¼Œé‚£ä¹ˆèƒ½ä¸èƒ½å¤šä¸ªåç¨‹ç»‘å®šåœ¨ä¸€ä¸ªæˆ–è€…å¤šä¸ªçº¿ç¨‹ä¸Šå‘¢ï¼</p>
<h2 id="åç¨‹å’Œçº¿ç¨‹çš„æ˜ å°„" class="headerLink">
    <a href="#%e5%8d%8f%e7%a8%8b%e5%92%8c%e7%ba%bf%e7%a8%8b%e7%9a%84%e6%98%a0%e5%b0%84" class="header-mark"></a>åç¨‹å’Œçº¿ç¨‹çš„æ˜ å°„</h2><h3 id="n1-å…³ç³»" class="headerLink">
    <a href="#n1-%e5%85%b3%e7%b3%bb" class="header-mark"></a>N:1 å…³ç³»</h3><p>N ä¸ªåç¨‹ç»‘å®š 1 ä¸ªçº¿ç¨‹ã€‚</p>
<figure><a class="lightgallery" href="https://cdn.xiaobinqt.cn/xiaobinqt.io/20221120/32ca2352460442e1b75aed52373558a0.png" title="https://cdn.xiaobinqt.cn/xiaobinqt.io/20221120/32ca2352460442e1b75aed52373558a0.png" data-thumbnail="https://cdn.xiaobinqt.cn/xiaobinqt.io/20221120/32ca2352460442e1b75aed52373558a0.png" data-sub-html="<h2>N:1</h2>">
        
    </a><figcaption class="image-caption">N:1</figcaption>
    </figure>
<p><strong>ä¼˜ç‚¹</strong>ï¼š</p>
<p>åç¨‹åœ¨ç”¨æˆ·æ€çº¿ç¨‹å³å®Œæˆåˆ‡æ¢ï¼Œä¸ä¼šé™·å…¥åˆ°å†…æ ¸æ€ï¼Œè¿™ç§åˆ‡æ¢éå¸¸çš„è½»é‡å¿«é€Ÿã€‚ä½†ä¹Ÿæœ‰å¾ˆå¤§çš„ç¼ºç‚¹ï¼Œ1 ä¸ªè¿›ç¨‹çš„æ‰€æœ‰åç¨‹éƒ½ç»‘å®šåœ¨ 1 ä¸ªçº¿ç¨‹ä¸Šã€‚</p>
<p><strong>ç¼ºç‚¹</strong>ï¼š</p>
<ul>
<li>æŸä¸ªç¨‹åºç”¨ä¸äº†ç¡¬ä»¶çš„å¤šæ ¸åŠ é€Ÿèƒ½åŠ›</li>
<li>ä¸€æ—¦æŸåç¨‹é˜»å¡ï¼Œé€ æˆçº¿ç¨‹é˜»å¡ï¼Œæœ¬è¿›ç¨‹çš„å…¶ä»–åç¨‹éƒ½æ— æ³•æ‰§è¡Œäº†ï¼Œæ ¹æœ¬å°±æ²¡æœ‰å¹¶å‘çš„èƒ½åŠ›äº†ã€‚</li>
</ul>
<h3 id="11-å…³ç³»" class="headerLink">
    <a href="#11-%e5%85%b3%e7%b3%bb" class="header-mark"></a>1:1 å…³ç³»</h3><p>1 ä¸ªåç¨‹ç»‘å®š 1 ä¸ªçº¿ç¨‹ï¼Œåç¨‹çš„è°ƒåº¦éƒ½ç”± CPU å®Œæˆäº†ï¼Œä¸å­˜åœ¨<code>N:1</code>çš„ç¼ºç‚¹ï¼Œä½†æ˜¯åç¨‹çš„åˆ›å»ºã€åˆ é™¤å’Œåˆ‡æ¢çš„ä»£ä»·éƒ½ç”± CPU å®Œæˆï¼Œç•¥æ˜¾æ˜‚è´µã€‚</p>
<figure><a class="lightgallery" href="https://cdn.xiaobinqt.cn/xiaobinqt.io/20221120/48726c7c54854150a7088dba1bc78860.png" title="https://cdn.xiaobinqt.cn/xiaobinqt.io/20221120/48726c7c54854150a7088dba1bc78860.png" data-thumbnail="https://cdn.xiaobinqt.cn/xiaobinqt.io/20221120/48726c7c54854150a7088dba1bc78860.png" data-sub-html="<h2>1:1</h2>">
        
    </a><figcaption class="image-caption">1:1</figcaption>
    </figure>
<h3 id="mn-å…³ç³»" class="headerLink">
    <a href="#mn-%e5%85%b3%e7%b3%bb" class="header-mark"></a>M:N å…³ç³»</h3><p>M ä¸ªåç¨‹ç»‘å®š N ä¸ªçº¿ç¨‹ï¼Œæ˜¯<code>N:1</code>å’Œ<code>1:1</code>ç±»å‹çš„ç»“åˆï¼Œå…‹æœäº†ä»¥ä¸Š 2 ç§æ¨¡å‹çš„ç¼ºç‚¹ï¼Œä½†å®ç°å¤æ‚ã€‚</p>
<figure><a class="lightgallery" href="https://cdn.xiaobinqt.cn/xiaobinqt.io/20221120/042a666564f44407a0efe47b5ffeaa7d.png" title="https://cdn.xiaobinqt.cn/xiaobinqt.io/20221120/042a666564f44407a0efe47b5ffeaa7d.png" data-thumbnail="https://cdn.xiaobinqt.cn/xiaobinqt.io/20221120/042a666564f44407a0efe47b5ffeaa7d.png" data-sub-html="<h2>M:N</h2>">
        
    </a><figcaption class="image-caption">M:N</figcaption>
    </figure>
<h2 id="go-çš„è°ƒåº¦" class="headerLink">
    <a href="#go-%e7%9a%84%e8%b0%83%e5%ba%a6" class="header-mark"></a>Go çš„è°ƒåº¦</h2><p><strong>ç”¨æˆ·æ€çš„ Goroutineï¼Œæ“ä½œç³»ç»Ÿçœ‹ä¸åˆ°å®ƒ</strong>
ï¼Œå¿…ç„¶éœ€è¦æœ‰æŸä¸ªä¸œè¥¿å»ç®¡ç†ä»–ï¼Œæ‰èƒ½æ›´å¥½çš„è¿ä½œèµ·æ¥ã€‚è¿™å°±æ˜¯ Go è¯­è¨€ä¸­çš„è°ƒåº¦ï¼Œä¹Ÿå°±æ˜¯ GMP æ¨¡å‹ã€‚</p>
<p>Go scheduler<code> /ËˆskedÊ’uËlÉ™r/</code> çš„ä¸»è¦åŠŸèƒ½æ˜¯é’ˆå¯¹åœ¨å¤„ç†å™¨ä¸Šè¿è¡Œçš„ OS çº¿ç¨‹åˆ†å‘å¯è¿è¡Œçš„ Goroutineï¼Œè€Œæˆ‘ä»¬ä¸€æåˆ°è°ƒåº¦å™¨ï¼Œå°±ç¦»ä¸å¼€ä¸‰ä¸ªç»å¸¸è¢«æåˆ°çš„ç¼©å†™ï¼Œä»–ä»¬åˆ†åˆ«æ˜¯ï¼š</p>
<ul>
<li>
<p>Gï¼šGoroutineï¼Œå®é™…ä¸Šæˆ‘ä»¬æ¯æ¬¡è°ƒç”¨<code>go func</code>å°±æ˜¯ç”Ÿæˆäº†ä¸€ä¸ª Gã€‚</p>
</li>
<li>
<p>Pï¼šProcessorï¼Œå¤„ç†å™¨ï¼Œä¸€èˆ¬ P çš„æ•°é‡å°±æ˜¯å¤„ç†å™¨çš„æ ¸æ•°ï¼Œå¯ä»¥é€šè¿‡<code>runtime.GOMAXPROCS(n)</code>è¿›è¡Œä¿®æ”¹ã€‚P åŒ…å«äº†è¿è¡Œ goroutine çš„èµ„æºï¼Œå¦‚æœçº¿ç¨‹ M æƒ³è¿è¡Œ goroutineï¼Œå¿…é¡»å…ˆè·å– P ï¼Œä¸€ä¸ª M åœ¨ä¸ä¸€ä¸ª P å…³è”ä¹‹åå½¢æˆäº†ä¸€ä¸ªæœ‰æ•ˆçš„ G è¿è¡Œç¯å¢ƒã€Œå†…æ ¸çº¿ç¨‹ + ä¸Šä¸‹æ–‡ç¯å¢ƒã€ã€‚P ä¸­è¿˜åŒ…å«äº†å¯è¿è¡Œçš„æœ¬åœ° G é˜Ÿåˆ—ï¼Œæœ¬åœ° G é˜Ÿåˆ—ä¸è¶…è¿‡ 256 ä¸ª Gï¼Œä¼˜å…ˆä¼šå°†æ–°åˆ›å»ºçš„ G æ”¾åˆ°æŸä¸ª P çš„æœ¬åœ°é˜Ÿåˆ—ä¸­ï¼Œå¦‚æœæœ¬åœ°é˜Ÿåˆ—æ»¡äº†ä¼šæ”¾åˆ°å…¨å±€é˜Ÿåˆ—ä¸­ã€‚</p>
</li>
<li>
<p>Mï¼šMachineï¼Œç³»ç»Ÿ/å†…æ ¸çº¿ç¨‹ï¼Œæ˜¯è¿è¡Œ goroutine çš„å®ä½“ï¼Œæ¯ä¸ª M éƒ½ä»£è¡¨äº† 1 ä¸ªå†…æ ¸çº¿ç¨‹ã€‚<strong>M å¯ä»¥è¿è¡Œ 2 ç§ä»£ç ï¼Œå½“ M è¿è¡Œ go ä»£ç ä¸€å®šéœ€è¦ä¸€ä¸ªPï¼Œå½“ M è¿è¡ŒåŸç”Ÿä»£ç , ä¾‹å¦‚é˜»å¡çš„<code>syscall</code>, æ­¤æ—¶ M ä¸éœ€è¦ P</strong>ã€‚</p>
</li>
</ul>
<p>M ä¸ P çš„æ•°é‡æ²¡æœ‰ç»å¯¹å…³ç³»ï¼Œä¸€ä¸ª M é˜»å¡ï¼ŒP å°±ä¼šå»åˆ›å»ºæˆ–è€…åˆ‡æ¢å¦ä¸€ä¸ª Mï¼Œæ‰€ä»¥ï¼Œ<strong>å³ä½¿ P çš„é»˜è®¤æ•°é‡æ˜¯ 1ï¼Œä¹Ÿæœ‰å¯èƒ½ä¼šåˆ›å»ºå¾ˆå¤šä¸ª M å‡ºæ¥</strong>ã€‚</p>
<p>è¿™ä¸‰è€…äº¤äº’å®é™…æ¥æºäº Go çš„<code>M:N</code>è°ƒåº¦æ¨¡å‹ï¼Œä¹Ÿå°±æ˜¯ <strong>M å¿…é¡»ä¸ P è¿›è¡Œç»‘å®š</strong>ï¼Œç„¶åä¸æ–­åœ°åœ¨ M ä¸Šå¾ªç¯å¯»æ‰¾å¯è¿è¡Œçš„ G æ¥æ‰§è¡Œç›¸åº”çš„ä»»åŠ¡ã€‚</p>
<p><figure><a class="lightgallery" href="https://cdn.xiaobinqt.cn/xiaobinqt.io/20221119/849f150e61d6472ea2099f1097c581fa.png" title="GMPè°ƒåº¦" data-thumbnail="https://cdn.xiaobinqt.cn/xiaobinqt.io/20221119/849f150e61d6472ea2099f1097c581fa.png" data-sub-html="<h2>GMPè°ƒåº¦</h2><p>GMPè°ƒåº¦</p>">
        
    </a><figcaption class="image-caption">GMPè°ƒåº¦</figcaption>
    </figure></p>
<h3 id="på’Œmä½•æ—¶è¢«åˆ›å»º" class="headerLink">
    <a href="#p%e5%92%8cm%e4%bd%95%e6%97%b6%e8%a2%ab%e5%88%9b%e5%bb%ba" class="header-mark"></a>På’ŒMä½•æ—¶è¢«åˆ›å»º</h3><p><strong>P ä½•æ—¶åˆ›å»º</strong>ï¼šåœ¨ç¡®å®šäº† P çš„æœ€å¤§æ•°é‡ n åï¼Œè¿è¡Œæ—¶ç³»ç»Ÿä¼šæ ¹æ®è¿™ä¸ªæ•°é‡åˆ›å»º n ä¸ª Pã€‚</p>
<p><strong>M ä½•æ—¶åˆ›å»º</strong>
ï¼šæ²¡æœ‰è¶³å¤Ÿçš„ M æ¥å…³è” P å¹¶è¿è¡Œå…¶ä¸­çš„å¯è¿è¡Œçš„ Gã€‚æ¯”å¦‚æ‰€æœ‰çš„ M æ­¤æ—¶éƒ½é˜»å¡ä½äº†ï¼Œè€Œ P ä¸­è¿˜æœ‰å¾ˆå¤šå°±ç»ªä»»åŠ¡ï¼Œå°±ä¼šå»å¯»æ‰¾ç©ºé—²çš„ Mï¼Œè€Œæ²¡æœ‰ç©ºé—²çš„ï¼Œruntime è¿è¡Œæ—¶å°±ä¼šå»åˆ›å»ºæ–°çš„ Mã€‚å½“ M æœ‰ç©ºé—²å°±ä¼šè¢«å›æ”¶æˆ–æ˜¯ç¡çœ ã€‚</p>
<h2 id="è°ƒåº¦æµç¨‹" class="headerLink">
    <a href="#%e8%b0%83%e5%ba%a6%e6%b5%81%e7%a8%8b" class="header-mark"></a>è°ƒåº¦æµç¨‹</h2><p><figure><a class="lightgallery" href="https://cdn.xiaobinqt.cn/xiaobinqt.io/20221119/945c94520e1b40c5adb516f58a0c2f30.png" title="è°ƒåº¦æµç¨‹" data-thumbnail="https://cdn.xiaobinqt.cn/xiaobinqt.io/20221119/945c94520e1b40c5adb516f58a0c2f30.png" data-sub-html="<h2>è°ƒåº¦æµç¨‹</h2><p>è°ƒåº¦æµç¨‹</p>">
        
    </a><figcaption class="image-caption">è°ƒåº¦æµç¨‹</figcaption>
    </figure></p>
<ol>
<li>
<p>å½“æˆ‘ä»¬æ‰§è¡Œ <code>go func()</code> æ—¶ï¼Œå®é™…ä¸Šå°±æ˜¯åˆ›å»ºä¸€ä¸ªå…¨æ–°çš„ Goroutineï¼Œæˆ‘ä»¬ç§°å®ƒä¸º Gã€‚</p>
</li>
<li>
<p>æ–°åˆ›å»ºçš„ G ä¼šè¢«æ”¾å…¥ P çš„æœ¬åœ°é˜Ÿåˆ—ï¼ˆLocal Queueï¼‰æˆ–å…¨å±€é˜Ÿåˆ—ï¼ˆGlobal Queueï¼‰ä¸­ï¼Œå‡†å¤‡ä¸‹ä¸€æ­¥çš„åŠ¨ä½œã€‚éœ€è¦æ³¨æ„çš„ä¸€ç‚¹ï¼Œè¿™é‡Œçš„ P æŒ‡çš„æ˜¯åˆ›å»º G çš„ Pï¼Œå¦‚æœ P çš„æœ¬åœ°é˜Ÿåˆ—å·²ç»æ»¡äº†å°±ä¼šä¿å­˜åœ¨å…¨å±€çš„é˜Ÿåˆ—ä¸­ã€‚</p>
</li>
<li>
<p>å”¤é†’æˆ–åˆ›å»º M ä»¥ä¾¿æ‰§è¡Œ Gã€‚G åªèƒ½è¿è¡Œåœ¨ M ä¸­ï¼Œä¸€ä¸ª M å¿…é¡»æŒæœ‰ä¸€ä¸ª Pï¼ŒM ä¸ P æ˜¯<code>1:1</code>çš„å…³ç³»ã€‚M ä¼šä» P çš„æœ¬åœ°é˜Ÿåˆ—å¼¹å‡ºä¸€ä¸ªå¯æ‰§è¡ŒçŠ¶æ€çš„ G æ¥æ‰§è¡Œï¼Œå¦‚æœ P çš„æœ¬åœ°é˜Ÿåˆ—ä¸ºç©ºï¼Œå°±ä¼šæƒ³å…¶ä»–çš„<code>MP</code>ç»„åˆå·å–ä¸€ä¸ªå¯æ‰§è¡Œçš„ G æ¥æ‰§è¡Œã€‚</p>
</li>
<li>
<p>ä¸€ä¸ª M è°ƒåº¦ G æ‰§è¡Œçš„è¿‡ç¨‹æ˜¯ä¸€ä¸ªå¾ªç¯æœºåˆ¶ã€‚</p>
</li>
<li>
<p>å½“ M æ‰§è¡ŒæŸä¸€ä¸ª G çš„æ—¶å€™å¦‚æœå‘ç”Ÿäº†<code>syscall</code>æˆ–è€…å…¶ä½™çš„é˜»å¡æ“ä½œï¼ŒM ä¼šé˜»å¡ï¼Œå¦‚æœå½“å‰æœ‰ä¸€äº› G åœ¨æ‰§è¡Œï¼Œruntime ä¼šæŠŠè¿™ä¸ªçº¿ç¨‹ M ä» P ä¸­æ‘˜é™¤ï¼ˆdetachï¼‰ï¼Œç„¶åå†åˆ›å»ºä¸€ä¸ªæ–°çš„æ“ä½œç³»ç»Ÿçš„çº¿ç¨‹ï¼ˆå¦‚æœæœ‰ç©ºé—²çš„çº¿ç¨‹å¯ç”¨å°±å¤ç”¨ç©ºé—²çº¿ç¨‹ï¼‰æ¥æœåŠ¡äºè¿™ä¸ª Pã€‚</p>
</li>
<li>
<p>å½“ M ç³»ç»Ÿè°ƒç”¨ç»“æŸæ—¶å€™ï¼Œè¿™ä¸ª G ä¼šå°è¯•è·å–ä¸€ä¸ªç©ºé—²çš„ P æ‰§è¡Œï¼Œå¹¶æ”¾å…¥åˆ°è¿™ä¸ª P çš„æœ¬åœ°é˜Ÿåˆ—ã€‚å¦‚æœè·å–ä¸åˆ° Pï¼Œé‚£ä¹ˆè¿™ä¸ªçº¿ç¨‹ M å˜æˆä¼‘çœ çŠ¶æ€ï¼ŒåŠ å…¥åˆ°ç©ºé—²çº¿ç¨‹ä¸­ï¼Œç„¶åè¿™ä¸ª G ä¼šè¢«æ”¾å…¥å…¨å±€é˜Ÿåˆ—ä¸­ã€‚</p>
</li>
</ol>
<p>åœ¨æè¿°ä¸­æœ‰æåˆ°å…¨å±€å’Œæœ¬åœ°è¿™ä¸¤ç±»é˜Ÿåˆ—ï¼Œå…¶å®åœ¨åŠŸèƒ½ä¸Šæ¥è®²éƒ½æ˜¯ç”¨äºå­˜æ”¾æ­£åœ¨ç­‰å¾…è¿è¡Œçš„ Gï¼Œä½†æ˜¯ä¸åŒç‚¹åœ¨äºï¼Œ<strong>æœ¬åœ°é˜Ÿåˆ—æœ‰æ•°é‡é™åˆ¶ï¼Œä¸å…è®¸è¶…è¿‡ 256 ä¸ª</strong>ã€‚</p>
<p>å¹¶ä¸”åœ¨æ–°å»º G æ—¶ï¼Œä¼šä¼˜å…ˆé€‰æ‹© P çš„æœ¬åœ°é˜Ÿåˆ—ï¼Œå¦‚æœæœ¬åœ°é˜Ÿåˆ—æ»¡äº†ï¼Œåˆ™å°† P çš„æœ¬åœ°é˜Ÿåˆ—çš„ä¸€åŠçš„ G ç§»åŠ¨åˆ°å…¨å±€é˜Ÿåˆ—ã€‚ å¯ä»¥ç†è§£ä¸ºè°ƒåº¦èµ„æºçš„å…±äº«å’Œå†å¹³è¡¡ã€‚</p>
<h2 id="m0å’Œg0" class="headerLink">
    <a href="#m0%e5%92%8cg0" class="header-mark"></a>M0å’ŒG0</h2><p><code>M0</code>æ˜¯å¯åŠ¨ç¨‹åºåç¼–å·ä¸º 0 çš„ä¸»çº¿ç¨‹ï¼Œè¿™ä¸ª M å¯¹åº”çš„å®ä¾‹ä¼šåœ¨å…¨å±€å˜é‡<code>runtime.m0</code>ä¸­ï¼Œ<code>M0</code>è´Ÿè´£æ‰§è¡Œåˆå§‹åŒ–æ“ä½œå’Œå¯åŠ¨ç¬¬ä¸€ä¸ª Gï¼Œ åœ¨ä¹‹å<code>M0</code>å°±å’Œå…¶ä»–çš„ M ä¸€æ ·ã€‚</p>
<p><code>G0</code>æ˜¯æ¯æ¬¡å¯åŠ¨ä¸€ä¸ª M éƒ½ä¼šç¬¬ä¸€ä¸ªåˆ›å»ºçš„ gourtineï¼Œ<code>G0</code>ä»…ç”¨äºè´Ÿè´£è°ƒåº¦ Gï¼Œ<code>G0</code>ä¸æŒ‡å‘ä»»ä½•å¯æ‰§è¡Œçš„å‡½æ•°, æ¯ä¸ª M éƒ½ä¼šæœ‰ä¸€ä¸ªè‡ªå·±çš„<code>G0</code>ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="s">&#34;fmt&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;Hello world&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>â˜ï¸ä¸Šé¢ä»£ç ä¼šç»å†å¦‚ä¸‹è¿‡ç¨‹ï¼š</p>
<ol>
<li>runtime åˆ›å»ºæœ€åˆçš„çº¿ç¨‹ m0 å’Œ goroutine g0ï¼Œå¹¶æŠŠ 2 è€…å…³è”ã€‚</li>
<li>è°ƒåº¦å™¨åˆå§‹åŒ–ï¼šåˆå§‹åŒ– m0ã€æ ˆã€åƒåœ¾å›æ”¶ï¼Œä»¥åŠåˆ›å»ºå’Œåˆå§‹åŒ–ç”±<code>GOMAXPROCS</code>ä¸ª P æ„æˆçš„ P åˆ—è¡¨ã€‚</li>
<li>ç¤ºä¾‹ä»£ç ä¸­çš„ main å‡½æ•°æ˜¯<code>main.main</code>ï¼Œruntime ä¸­ä¹Ÿæœ‰ 1 ä¸ª main å‡½æ•°<code>runtime.main</code>ï¼Œä»£ç ç»è¿‡ç¼–è¯‘åï¼Œ<code>runtime.main</code>ä¼šè°ƒç”¨<code>main.main</code>ï¼Œç¨‹åºå¯åŠ¨æ—¶ä¼šä¸º<code>runtime.main</code>åˆ›å»º goroutineï¼Œå¯ä»¥ç§°å®ƒä¸º main goroutineï¼Œç„¶åæŠŠ main goroutine åŠ å…¥åˆ° P çš„æœ¬åœ°é˜Ÿåˆ—ã€‚</li>
<li>å¯åŠ¨ m0ï¼Œm0 å·²ç»ç»‘å®šäº† Pï¼Œä¼šä» P çš„æœ¬åœ°é˜Ÿåˆ—è·å– Gï¼Œè·å–åˆ° main goroutineã€‚</li>
<li>M æ ¹æ® G ä¸­çš„æ ˆä¿¡æ¯å’Œè°ƒåº¦ä¿¡æ¯è®¾ç½®è¿è¡Œç¯å¢ƒï¼ŒM è¿è¡Œ Gã€‚</li>
<li>G é€€å‡ºï¼Œå†æ¬¡å›åˆ° M è·å–å¯è¿è¡Œçš„ Gï¼Œè¿™æ ·é‡å¤ä¸‹å»ï¼Œç›´åˆ°<code>main.main</code>é€€å‡ºï¼Œ<code>runtime.main</code>æ‰§è¡Œ Defer å’Œ Panic å¤„ç†ï¼Œæˆ–è°ƒç”¨<code>runtime.exit</code>é€€å‡ºç¨‹åºã€‚</li>
</ol>
<p>è°ƒåº¦å™¨çš„ç”Ÿå‘½å‘¨æœŸå‡ ä¹å æ»¡äº†ä¸€ä¸ª Go ç¨‹åºçš„ä¸€ç”Ÿï¼Œ<code>runtime.main</code>çš„ goroutine æ‰§è¡Œä¹‹å‰éƒ½æ˜¯ä¸ºè°ƒåº¦å™¨åšå‡†å¤‡å·¥ä½œï¼Œ<code>runtime.main</code>çš„ goroutine è¿è¡Œï¼Œæ‰æ˜¯è°ƒåº¦å™¨çš„çœŸæ­£å¼€å§‹ï¼Œç›´åˆ°<code>runtime.main</code>ç»“æŸè€Œç»“æŸã€‚</p>
<h2 id="çªƒå–è¡Œä¸º" class="headerLink">
    <a href="#%e7%aa%83%e5%8f%96%e8%a1%8c%e4%b8%ba" class="header-mark"></a>çªƒå–è¡Œä¸º</h2><p>å½“åˆ›å»ºæ–°çš„ G æˆ–è€… G å˜æˆå¯è¿è¡ŒçŠ¶æ€æ—¶ï¼Œå®ƒä¼šè¢«æ¨é€åŠ å…¥åˆ°å½“å‰ P çš„æœ¬åœ°é˜Ÿåˆ—ä¸­ã€‚å½“ P æ‰§è¡Œ G å®Œæ¯•åï¼ŒP ä¼šå°† G ä»æœ¬åœ°é˜Ÿåˆ—ä¸­å¼¹å‡ºï¼ŒåŒæ—¶ä¼šæ£€æŸ¥å½“å‰æœ¬åœ°é˜Ÿåˆ—æ˜¯å¦ä¸ºç©ºï¼Œå¦‚æœä¸ºç©ºä¸ä¼šç«‹åˆ»é”€æ¯çº¿ç¨‹ï¼Œè€Œæ˜¯ä¼šéšæœºçš„ä»å…¶ä»– P çš„æœ¬åœ°é˜Ÿåˆ—ä¸­å°è¯•
<strong>çªƒå–ä¸€åŠ</strong>å¯è¿è¡Œçš„ G åˆ°è‡ªå·±çš„åä¸‹ã€‚</p>
<figure><a class="lightgallery" href="https://cdn.xiaobinqt.cn/xiaobinqt.io/20220405/a378474165e94b908f8fc7b44812cc4c.png" title="https://cdn.xiaobinqt.cn/xiaobinqt.io/20220405/a378474165e94b908f8fc7b44812cc4c.png" data-thumbnail="https://cdn.xiaobinqt.cn/xiaobinqt.io/20220405/a378474165e94b908f8fc7b44812cc4c.png" data-sub-html="<h2>çªƒå–è¡Œä¸º</h2>">
        
    </a><figcaption class="image-caption">çªƒå–è¡Œä¸º</figcaption>
    </figure>
<p>ä¸Šå›¾ä¸­ğŸ‘†ï¼ŒP2 åœ¨æœ¬åœ°é˜Ÿåˆ—ä¸­æ‰¾ä¸åˆ°å¯ä»¥è¿è¡Œçš„ Gï¼Œå®ƒä¼šæ‰§è¡Œ <code>work-stealing</code> è°ƒåº¦ç®—æ³•ï¼Œéšæœºé€‰æ‹©å…¶å®ƒçš„å¤„ç†å™¨ P1ï¼Œå¹¶ä» P1 çš„æœ¬åœ°é˜Ÿåˆ—ä¸­çªƒå–äº†ä¸‰ä¸ª G åˆ°å®ƒè‡ªå·±çš„æœ¬åœ°é˜Ÿåˆ—ä¸­å»ã€‚è‡³æ­¤ï¼ŒP1ã€P2 éƒ½æ‹¥æœ‰äº†å¯è¿è¡Œçš„ Gï¼ŒP1 å¤šä½™çš„ G ä¹Ÿä¸ä¼šè¢«æµªè´¹ï¼Œè°ƒåº¦èµ„æºå°†ä¼šæ›´åŠ å¹³å‡çš„åœ¨å¤šä¸ªå¤„ç†å™¨ä¸­æµè½¬ã€‚</p>
<h2 id="é™åˆ¶æ¡ä»¶" class="headerLink">
    <a href="#%e9%99%90%e5%88%b6%e6%9d%a1%e4%bb%b6" class="header-mark"></a>é™åˆ¶æ¡ä»¶</h2><h3 id="m-çš„é™åˆ¶" class="headerLink">
    <a href="#m-%e7%9a%84%e9%99%90%e5%88%b6" class="header-mark"></a>M çš„é™åˆ¶</h3><p>åœ¨åç¨‹çš„æ‰§è¡Œä¸­ï¼ŒçœŸæ­£å¹²æ´»çš„æ˜¯ GPM ä¸­çš„ Mï¼ˆç³»ç»Ÿçº¿ç¨‹ï¼‰ ï¼Œå› ä¸º G æ˜¯ç”¨æˆ·æ€ä¸Šçš„ä¸œè¥¿ï¼Œæœ€ç»ˆæ‰§è¡Œéƒ½æ˜¯å¾—æ˜ å°„ï¼Œå¯¹åº”åˆ° M è¿™ä¸€ä¸ªç³»ç»Ÿçº¿ç¨‹ä¸Šå»è¿è¡Œã€‚</p>
<p>é‚£ä¹ˆ M æœ‰æ²¡æœ‰é™åˆ¶å‘¢ï¼Ÿ</p>
<p>ç­”æ¡ˆæ˜¯ï¼šæœ‰çš„ã€‚åœ¨ Go è¯­è¨€ä¸­ï¼Œ<strong>M çš„é»˜è®¤æ•°é‡é™åˆ¶æ˜¯ 10000</strong>ï¼Œå¦‚æœè¶…å‡ºåˆ™ä¼šæŠ¥é”™ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">GO: runtime: program exceeds 10000-thread limit
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä½†æ˜¯é€šå¸¸åªæœ‰åœ¨ Goroutine å‡ºç°é˜»å¡æ“ä½œçš„æƒ…å†µä¸‹ï¼Œæ‰ä¼šé‡åˆ°è¿™ç§æƒ…å†µã€‚è¿™å¯èƒ½ä¹Ÿé¢„ç¤ºç€ä½ çš„ç¨‹åºæœ‰é—®é¢˜ã€‚</p>
<p>è‹¥ç¡®åˆ‡æ˜¯éœ€è¦é‚£ä¹ˆå¤šï¼Œè¿˜å¯ä»¥é€šè¿‡ <code>debug.SetMaxThreads</code> æ–¹æ³•è¿›è¡Œè®¾ç½®ã€‚</p>
<h3 id="g-çš„é™åˆ¶" class="headerLink">
    <a href="#g-%e7%9a%84%e9%99%90%e5%88%b6" class="header-mark"></a>G çš„é™åˆ¶</h3><p>Goroutine çš„åˆ›å»ºæ•°é‡æ˜¯å¦æœ‰é™åˆ¶ï¼Ÿ</p>
<p>ç­”æ¡ˆæ˜¯ï¼šæ²¡æœ‰ã€‚ä½†ç†è®ºä¸Šä¼šå—å†…å­˜çš„å½±å“ï¼Œå‡è®¾ä¸€ä¸ª Goroutine åˆ›å»ºéœ€è¦ 4k çš„<strong>è¿ç»­çš„å†…å­˜å—</strong>ï¼š</p>
<p>4k * 80,000 = 320,000k â‰ˆ 0.3Gå†…å­˜</p>
<p>4k * 1,000,000 = 4,000,000k â‰ˆ 4Gå†…å­˜</p>
<p>ä»¥æ­¤å°±å¯ä»¥ç›¸å¯¹è®¡ç®—å‡ºæ¥ä¸€å°å•æœºåœ¨é€šä¿—æƒ…å†µä¸‹ï¼Œæ‰€èƒ½å¤Ÿåˆ›å»º Goroutine çš„å¤§æ¦‚æ•°é‡çº§åˆ«ã€‚</p>
<h3 id="p-çš„é™åˆ¶" class="headerLink">
    <a href="#p-%e7%9a%84%e9%99%90%e5%88%b6" class="header-mark"></a>P çš„é™åˆ¶</h3><p>P çš„æ•°é‡æ˜¯å¦æœ‰é™åˆ¶ï¼Œå—ä»€ä¹ˆå½±å“ï¼Ÿ</p>
<p>ç­”æ¡ˆæ˜¯ï¼šæœ‰é™åˆ¶ã€‚<strong>P çš„æ•°é‡å—ç¯å¢ƒå˜é‡ <code>GOMAXPROCS</code> çš„ç›´æ¥å½±å“</strong>ã€‚</p>
<p>ç¯å¢ƒå˜é‡ <code>GOMAXPROCS</code> åˆæ˜¯ä»€ä¹ˆï¼Ÿåœ¨ Go è¯­è¨€ä¸­ï¼Œé€šè¿‡è®¾ç½® <code>GOMAXPROCS</code>ï¼Œç”¨æˆ·å¯ä»¥è°ƒæ•´è°ƒåº¦ä¸­ Pï¼ˆProcessorï¼‰çš„æ•°é‡ã€‚</p>
<p>å¦ä¸€ä¸ªé‡ç‚¹åœ¨äºï¼Œä¸ P ç›¸å…³è”çš„çš„ Mï¼ˆç³»ç»Ÿçº¿ç¨‹ï¼‰ï¼Œæ˜¯éœ€è¦ç»‘å®š P æ‰èƒ½è¿›è¡Œå…·ä½“çš„ä»»åŠ¡æ‰§è¡Œçš„ï¼Œå› æ­¤<strong>P çš„å¤šå°‘ä¼šå½±å“åˆ° Go ç¨‹åºçš„è¿è¡Œè¡¨ç°</strong>ã€‚</p>
<p>P çš„æ•°é‡åŸºæœ¬æ˜¯å—æœ¬æœºçš„æ ¸æ•°å½±å“ï¼Œæ²¡å¿…è¦å¤ªè¿‡åº¦çº ç»“ä»–ã€‚</p>
<p>é‚£ P çš„æ•°é‡æ˜¯å¦ä¼šå½±å“ Goroutine çš„æ•°é‡åˆ›å»ºå‘¢ï¼Ÿ</p>
<p>ç­”æ¡ˆæ˜¯ï¼šä¸å½±å“ã€‚ä¸” Goroutine å¤šäº†å°‘äº†ï¼ŒP ä¹Ÿè¯¥å¹²å˜›å¹²å˜›ï¼Œä¸ä¼šå¸¦æ¥ç¾éš¾æ€§é—®é¢˜ã€‚</p>
<h3 id="å°ç»“" class="headerLink">
    <a href="#%e5%b0%8f%e7%bb%93" class="header-mark"></a>å°ç»“</h3><ul>
<li>Mï¼šæœ‰é™åˆ¶ï¼Œé»˜è®¤æ•°é‡é™åˆ¶æ˜¯ 10000ï¼Œå¯è°ƒæ•´ã€‚</li>
<li>Gï¼šæ²¡é™åˆ¶ï¼Œä½†å—å†…å­˜å½±å“ã€‚</li>
<li>Pï¼šå—æœ¬æœºçš„æ ¸æ•°å½±å“ï¼Œå¯å¤§å¯å°ï¼Œä¸å½±å“ G çš„æ•°é‡åˆ›å»ºã€‚</li>
</ul>
<p>æ‰€ä»¥<strong>Goroutine æ•°é‡æ€ä¹ˆé¢„ç®—ï¼Œæ‰å«åˆç†ï¼Ÿ</strong></p>
<p>åœ¨çœŸå®çš„åº”ç”¨åœºæ™¯ä¸­ï¼Œå¦‚æœä½  Goroutineï¼š</p>
<ul>
<li>åœ¨é¢‘ç¹è¯·æ±‚ HTTPï¼ŒMySQLï¼Œæ‰“å¼€æ–‡ä»¶ç­‰ï¼Œé‚£å‡è®¾çŸ­æ—¶é—´å†…æœ‰å‡ åä¸‡ä¸ªåç¨‹åœ¨è·‘ï¼Œé‚£è‚¯å®šå°±ä¸å¤§åˆç†äº†ï¼ˆå¯èƒ½ä¼šå¯¼è‡´ too many files openï¼‰ã€‚</li>
<li>å¸¸è§çš„ Goroutine æ³„éœ²æ‰€å¯¼è‡´çš„ CPUã€Memory ä¸Šæ¶¨ç­‰ï¼Œè¿˜æ˜¯å¾—çœ‹ä½ çš„ Goroutine é‡Œå…·ä½“åœ¨è·‘ä»€ä¹ˆä¸œè¥¿ã€‚</li>
</ul>
<p>è·‘çš„å¦‚æœæ˜¯ â€œèµ„æºæ€ªå…½â€ï¼Œåªè¿è¡Œå‡ ä¸ª Goroutine éƒ½å¯ä»¥è·‘æ­»ã€‚</p>
<h2 id="ä¸ºä»€ä¹ˆè¦æœ‰-p" class="headerLink">
    <a href="#%e4%b8%ba%e4%bb%80%e4%b9%88%e8%a6%81%e6%9c%89-p" class="header-mark"></a>ä¸ºä»€ä¹ˆè¦æœ‰ P</h2><figure><a class="lightgallery" href="https://cdn.xiaobinqt.cn/xiaobinqt.io/20221120/bdcbfb4a788d477b991c0179a7180c3c.png" title="https://cdn.xiaobinqt.cn/xiaobinqt.io/20221120/bdcbfb4a788d477b991c0179a7180c3c.png" data-thumbnail="https://cdn.xiaobinqt.cn/xiaobinqt.io/20221120/bdcbfb4a788d477b991c0179a7180c3c.png" data-sub-html="<h2>æ—©æœŸè°ƒåº¦å™¨</h2>">
        
    </a><figcaption class="image-caption">æ—©æœŸè°ƒåº¦å™¨</figcaption>
    </figure>
<p>Go æ—©æœŸçš„è°ƒåº¦å™¨æ˜¯æ²¡æœ‰ P çš„ï¼Œåªæœ‰ M å’Œ Gã€‚M æƒ³è¦æ‰§è¡Œå’Œæ”¾å› G éƒ½å¿…é¡»è®¿é—®å…¨å±€ G é˜Ÿåˆ—ï¼Œå¹¶ä¸” M æœ‰å¤šä¸ªï¼Œå¤šçº¿ç¨‹è®¿é—®åŒä¸€èµ„æºéœ€è¦åŠ é”è¿›è¡Œä¿è¯äº’æ–¥/åŒæ­¥ï¼Œæ‰€ä»¥å…¨å±€ G é˜Ÿåˆ—æ˜¯æœ‰äº’æ–¥é”è¿›è¡Œä¿æŠ¤çš„ã€‚</p>
<p>æ‰€ä»¥æ—©æœŸçš„è°ƒåº¦å™¨å­˜åœ¨è¿™æ ·å‡ ä¸ªç¼ºç‚¹ï¼š</p>
<ul>
<li>åˆ›å»ºã€é”€æ¯ã€è°ƒåº¦ G éƒ½éœ€è¦æ¯ä¸ª M è·å–é”ï¼Œè¿™å°±å½¢æˆäº†æ¿€çƒˆçš„<strong>é”ç«äº‰</strong>ã€‚</li>
<li>M è½¬ç§» G ä¼šé€ æˆå»¶è¿Ÿå’Œé¢å¤–çš„ç³»ç»Ÿè´Ÿè½½ã€‚æ¯”å¦‚å½“ G ä¸­åŒ…å«åˆ›å»ºæ–°åç¨‹çš„æ—¶å€™ï¼ŒM åˆ›å»ºäº†<code>G'</code>ï¼Œä¸ºäº†ç»§ç»­æ‰§è¡Œ Gï¼Œéœ€è¦æŠŠ<code>G'</code>äº¤ç»™<code>M'</code>æ‰§è¡Œï¼Œä¹Ÿé€ æˆäº†å¾ˆå·®çš„å±€éƒ¨æ€§ï¼Œå› ä¸º<code>G'</code>å’Œ G æ˜¯ç›¸å…³çš„ï¼Œæœ€å¥½æ”¾åœ¨ M ä¸Šæ‰§è¡Œï¼Œè€Œä¸æ˜¯å…¶ä»–<code>M'</code>ã€‚</li>
<li>ç³»ç»Ÿè°ƒç”¨ï¼ˆCPU åœ¨ M ä¹‹é—´çš„åˆ‡æ¢ï¼‰å¯¼è‡´é¢‘ç¹çš„çº¿ç¨‹é˜»å¡å’Œå–æ¶ˆé˜»å¡æ“ä½œå¢åŠ äº†ç³»ç»Ÿå¼€é”€ã€‚</li>
</ul>
<h2 id="faq" class="headerLink">
    <a href="#faq" class="header-mark"></a>FAQ</h2><ol>
<li><strong>hand off æœºåˆ¶</strong></li>
</ol>
<p>å½“æœ¬çº¿ç¨‹ä¸Šæ‰§è¡Œçš„ G é˜»å¡æ—¶ï¼Œçº¿ç¨‹ä¼šé‡Šæ”¾ç»‘å®šçš„ Pï¼ŒæŠŠ P å’Œ M åˆ†ç¦»ï¼ŒæŠŠ P è½¬ç§»ç»™å…¶ä»–ç©ºé—²çš„çº¿ç¨‹æ‰§è¡Œã€‚</p>
<ol start="2">
<li><strong>åˆ©ç”¨å¹¶è¡Œ</strong></li>
</ol>
<p>å¯ä»¥é€šè¿‡<code>GOMAXPROCS</code>è®¾ç½® P çš„æ•°é‡ï¼Œæœ€å¤šæœ‰<code>GOMAXPROCS</code>ä¸ªçº¿ç¨‹åˆ†å¸ƒåœ¨å¤šä¸ª CPU ä¸ŠåŒæ—¶è¿è¡Œï¼Œå› ä¸º P æ˜¯ç»‘å®šåœ¨ M ä¸Šçš„ï¼ŒM æƒ³è¦è¿è¡Œ G å¿…é¡»å…ˆè·å– Pã€‚<code>GOMAXPROCS</code>ä¹Ÿé™åˆ¶äº†å¹¶å‘çš„ç¨‹åº¦ï¼Œæ¯”å¦‚<code>GOMAXPROCS = æ ¸æ•°/2</code>ï¼Œåˆ™æœ€å¤šåˆ©ç”¨äº†ä¸€åŠçš„ CPU æ ¸è¿›è¡Œå¹¶è¡Œã€‚</p>
<ol start="3">
<li><strong>æŠ¢å </strong></li>
</ol>
<p>ä¸€ä¸ª goroutine æœ€å¤šå ç”¨ CPU 10msï¼Œé˜²æ­¢å…¶ä»– goroutine è¢«é¥¿æ­»ã€‚</p>
<ol start="4">
<li><strong>è‡ªæ—‹çº¿ç¨‹</strong></li>
</ol>
<p><figure><a class="lightgallery" href="https://cdn.xiaobinqt.cn/xiaobinqt.io/20221120/f6015c66c0b946e5a775ee6928f4d9a7.png" title="è‡ªæ—‹çº¿ç¨‹" data-thumbnail="https://cdn.xiaobinqt.cn/xiaobinqt.io/20221120/f6015c66c0b946e5a775ee6928f4d9a7.png" data-sub-html="<h2>è‡ªæ—‹çº¿ç¨‹</h2><p>è‡ªæ—‹çº¿ç¨‹</p>">
        
    </a><figcaption class="image-caption">è‡ªæ—‹çº¿ç¨‹</figcaption>
    </figure></p>
<p>å‡å®š G2 å”¤é†’äº† M2ï¼ŒM2 ç»‘å®šäº† P2ï¼ŒM2 è°ƒç”¨å¹¶è¿è¡Œ<code>G0</code>ï¼Œä½† P2 æœ¬åœ°é˜Ÿåˆ—æ²¡æœ‰ Gï¼ŒM2 æ­¤æ—¶çš„çŠ¶æ€ç§°ä¸ºè‡ªæ—‹çº¿ç¨‹ï¼ˆæ²¡æœ‰ G ä½†ä¸ºè¿è¡ŒçŠ¶æ€çš„çº¿ç¨‹ï¼Œä¸æ–­å¯»æ‰¾ Gï¼‰ã€‚è‡ªæ—‹çº¿ç¨‹<strong>ä¼˜å…ˆ</strong>ä¼šä»å…¨å±€é˜Ÿåˆ—é‡Œè·å– Gï¼Œå½“å…¨å±€é˜Ÿåˆ—é‡Œæ²¡æœ‰äº†æ—¶ï¼Œä¼šå»å…¶ä»–çš„<code>MP</code>ç»„åˆä¸­å·å– Gã€‚</p>
<p>è‡ªæ—‹çº¿ç¨‹çš„æœ€å¤§é™åˆ¶ç¬¦åˆå…¬å¼ï¼š<code>è‡ªæ—‹çº¿ç¨‹ + æ‰§è¡Œçº¿ç¨‹ &lt;= GOMAXPROCS</code></p>
<ol start="5">
<li><strong>å¦‚ä½•ä»å…¨å±€é˜Ÿåˆ—å– G çš„æ•°é‡</strong></li>
</ol>
<p>æŸä¸ª M å°è¯•ä»å…¨å±€é˜Ÿåˆ—ï¼ˆç®€ç§° â€œGQâ€ï¼‰å–ä¸€æ‰¹ G æ”¾åˆ°è‡ªå·± P çš„æœ¬åœ°é˜Ÿåˆ—ï¼Œä»å…¨å±€é˜Ÿåˆ—å–çš„ G æ•°é‡ç¬¦åˆä¸‹é¢çš„å…¬å¼ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">n =  min(len(GQ) / GOMAXPROCS +  1,  cap(LQ) / 2 )
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="å‚è€ƒ" class="headerLink">
    <a href="#%e5%8f%82%e8%80%83" class="header-mark"></a>å‚è€ƒ</h2><ul>
<li><a href="https://www.yuque.com/aceld/golang/srxd6d" target="_blank" rel="noopener noreferrer">Golangçš„åç¨‹è°ƒåº¦å™¨åŸç†åŠGMPè®¾è®¡æ€æƒ³</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/111346689" target="_blank" rel="noopener noreferrer">Go ä¸ºä»€ä¹ˆè¿™ä¹ˆâ€œå¿«â€</a></li>
<li><a href="https://blog.csdn.net/weixin_38054045/article/details/104098072" target="_blank" rel="noopener noreferrer">è®©ä½ å¾ˆå¿«å°±èƒ½ç†è§£-goçš„åç¨‹è°ƒåº¦åŸç†</a></li>
<li><a href="https://mp.weixin.qq.com/s/uWP2X6iFu7BtwjIv5H55vw" target="_blank" rel="noopener noreferrer">Goroutine æ•°é‡æ§åˆ¶åœ¨å¤šå°‘åˆé€‚ï¼Œä¼šå½±å“ GC å’Œè°ƒåº¦ï¼Ÿ</a></li>
<li><a href="https://studygolang.com/articles/9211" target="_blank" rel="noopener noreferrer">Golang goroutineä¸è°ƒåº¦å™¨</a></li>
<li><a href="https://www.ruanyifeng.com/blog/2013/04/processes_and_threads.html" target="_blank" rel="noopener noreferrer">è¿›ç¨‹ä¸çº¿ç¨‹çš„ä¸€ä¸ªç®€å•è§£é‡Š</a></li>
<li><a href="https://mp.weixin.qq.com/s?__biz=MzUxMDI4MDc1NA==&amp;mid=2247488604&amp;idx=1&amp;sn=83219ea874b1345debc65904cd7f025a" target="_blank" rel="noopener noreferrer">Go é¢è¯•å®˜ï¼šä»€ä¹ˆæ˜¯åç¨‹ï¼Œåç¨‹å’Œçº¿ç¨‹çš„åŒºåˆ«å’Œè”ç³»ï¼Ÿ</a></li>
<li><a href="https://blog.csdn.net/genziisme/article/details/124324755" target="_blank" rel="noopener noreferrer">golangé«˜çº§è¿›é˜¶ï¼ˆä¸€ï¼‰ï¼šè¿›ç¨‹ã€çº¿ç¨‹ã€å¹¶å‘ã€å¹¶è¡Œã€goroutineåç¨‹</a></li>
</ul>
]]></description>
</item><item>
    <title>Go å¸¸ç”¨å‘½ä»¤</title>
    <link>https://www.xiaobinqt.cn/go-build-args/</link>
    <pubDate>Wed, 16 Mar 2022 00:00:00 &#43;0000</pubDate><author>
        <name>xiaobinqt</name>
    </author><guid>https://www.xiaobinqt.cn/go-build-args/</guid>
    <description><![CDATA[<div class="featured-image">
                <img src="https://cdn.xiaobinqt.cn/xiaobinqt.io/20230714/766aed50dd3947ca9b2b2f9c0562a31a.png" referrerpolicy="no-referrer">
            </div><h2 id="å¸¸ç”¨ç¼–è¯‘å‚æ•°" class="headerLink">
    <a href="#%e5%b8%b8%e7%94%a8%e7%bc%96%e8%af%91%e5%8f%82%e6%95%b0" class="header-mark"></a>å¸¸ç”¨ç¼–è¯‘å‚æ•°</h2><table>
<thead>
<tr>
<th>å‚æ•°</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td>-o</td>
<td>æŒ‡å®šè¾“å‡ºå¯æ‰§è¡Œæ–‡ä»¶å</td>
</tr>
<tr>
<td>-v</td>
<td>ç¼–è¯‘æ—¶æ˜¾ç¤ºåŒ…åï¼Œå¯ä»¥ç†è§£æˆè¾“å‡ºè¯¦ç»†ç¼–è¯‘ä¿¡æ¯</td>
</tr>
<tr>
<td>-u</td>
<td>ä¸åŠ <code>-u</code>æ ‡è®°ï¼Œæ‰§è¡Œ go get ä¸€ä¸ªå·²æœ‰çš„ä»£ç åŒ…ï¼Œä¼šå‘ç°å‘½ä»¤ä»€ä¹ˆéƒ½ä¸æ‰§è¡Œã€‚åŠ äº†<code>-u</code>æ‰ä¼šå»æ‹‰å–æœ€æ–°çš„ä»£ç åŒ…çš„æœ€æ–°ç‰ˆæœ¬</td>
</tr>
<tr>
<td>-race</td>
<td>å¼€å¯ç«æ€æ£€æµ‹</td>
</tr>
<tr>
<td>*.go</td>
<td>ç¼–è¯‘å½“å‰ç›®å½•ä¸‹çš„æ‰€æœ‰goæ–‡ä»¶ï¼Œä¹Ÿå¯ä»¥å†™æˆ f2.go f2.go &hellip;</td>
</tr>
<tr>
<td>-a</td>
<td>è¯¥é€‰é¡¹ç”¨äºå¼ºåˆ¶é‡æ–°ç¼–è¯‘æ‰€æœ‰çš„ä¾èµ–é¡¹ï¼Œå³ä½¿å®ƒä»¬ä¼¼ä¹æ˜¯æœ€æ–°çš„æˆ–æœªæ›´æ”¹ã€‚è¿™å¯¹äºç¡®ä¿æ‰€æœ‰ä¾èµ–é¡¹éƒ½ä¸æœ€æ–°çš„ä»£ç ä¸€è‡´éå¸¸æœ‰ç”¨ã€‚ä½¿ç”¨ <code>-a</code> æ ‡å¿—å¯ä»¥é˜²æ­¢ä½¿ç”¨ç¼“å­˜çš„ä¾èµ–é¡¹ï¼Œä»è€Œç¡®ä¿æ¯ä¸ªä¾èµ–é¡¹éƒ½ä¼šè¢«é‡æ–°ç¼–è¯‘ï¼Œå¹¶ä¸æœ€æ–°çš„ä»£ç è¿›è¡Œé“¾æ¥ã€‚</td>
</tr>
<tr>
<td>-w</td>
<td>è¯¥é€‰é¡¹ç”¨äºç¦ç”¨é“¾æ¥å™¨äº§ç”Ÿçš„è­¦å‘Šä¿¡æ¯ã€‚å½“æ„å»ºå¯æ‰§è¡Œæ–‡ä»¶æ—¶ï¼Œé“¾æ¥å™¨é€šå¸¸ä¼šç”Ÿæˆä¸€äº›è­¦å‘Šï¼Œä¾‹å¦‚æœªä½¿ç”¨çš„å˜é‡æˆ–æœªå¯¼å‡ºçš„ç¬¦å·ç­‰ã€‚ä½¿ç”¨ <code>-w</code> æ ‡å¿—å¯ä»¥ç¦ç”¨è¿™äº›è­¦å‘Šä¿¡æ¯ï¼Œä»¥å‡å°å¯æ‰§è¡Œæ–‡ä»¶çš„å¤§å°ã€‚</td>
</tr>
<tr>
<td>-s</td>
<td><code>-s</code> å‚æ•°ä¼šå‘Šè¯‰é“¾æ¥å™¨åœ¨æ„å»ºå¯æ‰§è¡Œæ–‡ä»¶æ—¶ä¸ç”Ÿæˆç¬¦å·è¡¨å’Œè°ƒè¯•ä¿¡æ¯ã€‚ç¬¦å·è¡¨åŒ…å«äº†æºä»£ç ä¸­çš„ç¬¦å·ï¼ˆå¦‚å˜é‡åã€å‡½æ•°åç­‰ï¼‰å’Œå¯¹åº”çš„åœ°å€ä¿¡æ¯ï¼Œè€Œè°ƒè¯•ä¿¡æ¯åˆ™åŒ…å«äº†ç”¨äºè°ƒè¯•ç¨‹åºçš„ç›¸å…³ä¿¡æ¯ï¼ˆå¦‚æºä»£ç æ–‡ä»¶è·¯å¾„ã€è¡Œå·ç­‰ï¼‰ã€‚<br/> ç¦ç”¨ç¬¦å·è¡¨å’Œè°ƒè¯•ä¿¡æ¯çš„ç”Ÿæˆå¯ä»¥å‡å°æœ€ç»ˆç”Ÿæˆçš„å¯æ‰§è¡Œæ–‡ä»¶çš„å¤§å°ï¼ŒåŒæ—¶ä¹Ÿå¯ä»¥å¢å¼ºä»£ç çš„å®‰å…¨æ€§ï¼Œå› ä¸ºè¿™äº›ä¿¡æ¯å¯¹äºæ”»å‡»è€…æ¥è¯´å¯èƒ½æ˜¯æœ‰ä»·å€¼çš„ã€‚</td>
</tr>
<tr>
<td>-X</td>
<td>è®¾ç½®åŒ…ä¸­çš„å˜é‡å€¼</td>
</tr>
<tr>
<td><code>-gcflags &quot;-N -l&quot;</code></td>
<td><code>-N</code>ï¼šè¯¥æ ‡å¿—å‘Šè¯‰ç¼–è¯‘å™¨ä¸è¿›è¡Œä¼˜åŒ–ã€‚ä¼˜åŒ–æ˜¯ç¼–è¯‘å™¨å¯¹ä»£ç è¿›è¡Œçš„ä¸€ç³»åˆ—è½¬æ¢å’Œé‡ç»„ï¼Œæ—¨åœ¨æé«˜ä»£ç çš„æ‰§è¡Œæ•ˆç‡ã€‚é€šè¿‡ç¦ç”¨ä¼˜åŒ–ï¼Œå¯æ‰§è¡Œæ–‡ä»¶çš„ç”Ÿæˆå°†æ›´ç¬¦åˆæºä»£ç çš„ç»“æ„ï¼Œä¾¿äºè°ƒè¯•ã€‚<br/> <code>-l</code>ï¼šè¯¥æ ‡å¿—å‘Šè¯‰ç¼–è¯‘å™¨ç¦ç”¨å†…è”ä¼˜åŒ–ã€‚å†…è”ä¼˜åŒ–æ˜¯ç¼–è¯‘å™¨å°†å‡½æ•°è°ƒç”¨æ›¿æ¢ä¸ºå‡½æ•°ä½“å†…å®¹çš„ä¸€ç§ä¼˜åŒ–æŠ€æœ¯ï¼Œå¯ä»¥å‡å°‘å‡½æ•°è°ƒç”¨çš„å¼€é”€ã€‚ç¦ç”¨å†…è”ä¼˜åŒ–å¯ä»¥ç¡®ä¿å‡½æ•°è°ƒç”¨ä¿æŒä¸å˜ï¼Œä½¿å¾—è°ƒè¯•è¿‡ç¨‹ä¸­å¯ä»¥ç²¾ç¡®åœ°è·Ÿè¸ªå‡½æ•°çš„æ‰§è¡Œã€‚<br/>è¿™ä¸¤ä¸ªæ ‡å¿—çš„ç»„åˆ <code>-gcflags &quot;-N -l&quot;</code> ä¸€èµ·ä½¿ç”¨ï¼Œå¯ä»¥åœ¨æ„å»ºè¿‡ç¨‹ä¸­ç¦ç”¨ä¼˜åŒ–å’Œå†…è”ä¼˜åŒ–ï¼Œä»è€Œäº§ç”Ÿæ›´å®¹æ˜“è°ƒè¯•çš„å¯æ‰§è¡Œæ–‡ä»¶ã€‚</td>
</tr>
<tr>
<td>-ldflags</td>
<td>ç»™ go é“¾æ¥å™¨ä¼ å…¥å‚æ•°ï¼Œå®é™…æ˜¯ç»™ go tool link çš„å‚æ•°ï¼Œå¯ä»¥ç”¨ <code>go tool link --help</code> æŸ¥çœ‹å¯ç”¨çš„å‚æ•°ã€‚</td>
</tr>
<tr>
<td><code>-ldflags '-extldflags &quot;-static&quot;' </code></td>
<td>é™æ€ç¼–è¯‘ã€‚å‘Šè¯‰é“¾æ¥å™¨åœ¨æ„å»ºå¯æ‰§è¡Œæ–‡ä»¶æ—¶ä½¿ç”¨é™æ€é“¾æ¥ã€‚é™æ€é“¾æ¥æ„å‘³ç€å°†æ‰€æœ‰çš„ä¾èµ–é¡¹ï¼ˆåŒ…æ‹¬ç³»ç»Ÿåº“ï¼‰éƒ½åŒ…å«åœ¨æœ€ç»ˆçš„å¯æ‰§è¡Œæ–‡ä»¶ä¸­ï¼Œä»¥ä¾¿åœ¨å…¶ä»–ç³»ç»Ÿä¸Šè¿è¡Œæ—¶ä¸éœ€è¦ä¾èµ–å¤–éƒ¨çš„åº“ã€‚</td>
</tr>
</tbody>
</table>
<h2 id="äº¤å‰ç¼–è¯‘" class="headerLink">
    <a href="#%e4%ba%a4%e5%8f%89%e7%bc%96%e8%af%91" class="header-mark"></a>äº¤å‰ç¼–è¯‘</h2><table>
<thead>
<tr>
<th>å‚æ•°</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td>GOOS</td>
<td>GOARCH</td>
</tr>
<tr>
<td>linux</td>
<td>386 / amd64 / arm</td>
</tr>
<tr>
<td>darwin</td>
<td>386 / amd64</td>
</tr>
<tr>
<td>feedbsd</td>
<td>386 / amd64</td>
</tr>
<tr>
<td>windows</td>
<td>386 / amd64</td>
</tr>
</tbody>
</table>
<p>å¯¹äºç¼–è¯‘ç»™ ARM ä½¿ç”¨çš„ Go ç¨‹åºï¼Œéœ€è¦æ ¹æ®å®é™…æƒ…å†µé…ç½®<code>$GOARM</code>ï¼Œè¿™æ˜¯ç”¨æ¥æ§åˆ¶ CPU çš„æµ®ç‚¹åå¤„ç†å™¨çš„å‚æ•°ã€‚</p>
<p><code>$GOARM</code>é»˜è®¤æ˜¯ 6ï¼Œå¯¹äºä¸æ”¯æŒ VFP ä½¿ç”¨è½¯ä»¶è¿ç®—çš„è€ç‰ˆæœ¬ ARM å¹³å°è¦è®¾ç½®æˆ 5ï¼Œæ”¯æŒ VFPv1 çš„è®¾ç½®æˆ 6ï¼Œæ”¯æŒ VFPv3 çš„è®¾ç½®æˆ 7ã€‚</p>
<p>ç¤ºä¾‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="nv">GOARM</span><span class="o">=</span><span class="m">7</span> <span class="nv">GOARCH</span><span class="o">=</span>arm <span class="nv">GOOS</span><span class="o">=</span>linux go build -v -o fca
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="go-mod" class="headerLink">
    <a href="#go-mod" class="header-mark"></a>go mod</h2><p>å½“è°ˆåˆ° Go è¯­è¨€çš„æ¨¡å—åŒ–ç®¡ç†æ—¶ï¼ŒGo Moduleï¼ˆgo modï¼‰æ˜¯ä¸€ä¸ªé‡è¦çš„å·¥å…·å’Œæ¦‚å¿µã€‚</p>
<p><strong>å†å²ï¼š</strong></p>
<ul>
<li>
<p>Go 1.11ï¼ˆ2018å¹´8æœˆå‘å¸ƒï¼‰å¼•å…¥äº† Go Module çš„åŸå§‹æ”¯æŒã€‚å®ƒæä¾›äº†å¯¹ç‰ˆæœ¬åŒ–æ¨¡å—çš„æ”¯æŒï¼Œä»¥è§£å†³ Go è¯­è¨€åŒ…ç®¡ç†çš„é—®é¢˜ã€‚</p>
</li>
<li>
<p>Go 1.13ï¼ˆ2019å¹´9æœˆå‘å¸ƒï¼‰å¯¹ Go Module è¿›è¡Œäº†ä¸€äº›æ”¹è¿›ï¼Œå¢å¼ºäº†å¯¹ä»£ç†å’Œç§æœ‰æ¨¡å—çš„æ”¯æŒï¼Œå¹¶æä¾›äº†æ›´å¥½çš„æ€§èƒ½å’Œå¯é æ€§ã€‚</p>
</li>
<li>
<p>ä» Go 1.14ï¼ˆ2020å¹´2æœˆå‘å¸ƒï¼‰å¼€å§‹ï¼ŒGo Module æˆä¸º Go è¯­è¨€é»˜è®¤çš„åŒ…ç®¡ç†å·¥å…·ï¼Œå–ä»£äº†ä¹‹å‰çš„ GOPATH æ¨¡å¼ã€‚</p>
</li>
</ul>
<p><strong>ä¸ºä»€ä¹ˆéœ€è¦ Go Moduleï¼š</strong></p>
<ul>
<li>
<p>ç‰ˆæœ¬ç®¡ç†ï¼šGo Module å…è®¸å¼€å‘è€…æ˜ç¡®æŒ‡å®šé¡¹ç›®æ‰€ä½¿ç”¨çš„ä¾èµ–é¡¹çš„ç‰ˆæœ¬ï¼Œä»¥ä¾¿åœ¨ä¸åŒçš„å¼€å‘ç¯å¢ƒä¸­è·å¾—ä¸€è‡´çš„æ„å»ºç»“æœã€‚</p>
</li>
<li>
<p>æ¨¡å—éš”ç¦»ï¼šæ¯ä¸ªæ¨¡å—éƒ½æœ‰è‡ªå·±çš„ä¾èµ–å…³ç³»ï¼Œä½¿å¾—ä¸åŒçš„é¡¹ç›®å¯ä»¥ä½¿ç”¨ä¸åŒç‰ˆæœ¬çš„ä¾èµ–é¡¹ï¼Œè€Œä¸ä¼šç›¸äº’å¹²æ‰°ã€‚</p>
</li>
<li>
<p>æ›´å¥½çš„åŒ…ç®¡ç†ï¼šGo Module ç®¡ç†åŒ…çš„æ–¹å¼æ›´åŠ çµæ´»ã€ç®€å•ï¼Œå¯ä»¥è‡ªåŠ¨è§£æå’Œä¸‹è½½ä¾èµ–é¡¹ï¼Œä½¿å¾—åŒ…çš„å¯¼å…¥å’Œæ›´æ–°æ›´åŠ æ–¹ä¾¿ã€‚</p>
</li>
</ul>
<p><strong>å¸¸è§ä½¿ç”¨å‘½ä»¤ï¼š</strong></p>
<ul>
<li>
<p><code>go mod init &lt;module&gt;</code>ï¼šåˆå§‹åŒ–ä¸€ä¸ªæ–°çš„æ¨¡å—ï¼Œå¯ä»¥æŒ‡å®šæ¨¡å—çš„åç§°ã€‚</p>
</li>
<li>
<p><code>go mod tidy</code>ï¼šæ ¹æ®é¡¹ç›®çš„æºç æ–‡ä»¶ï¼Œè‡ªåŠ¨åˆ†æå¹¶æ›´æ–°æ¨¡å—çš„ä¾èµ–å…³ç³»ï¼Œç§»é™¤ä¸å†ä½¿ç”¨çš„ä¾èµ–é¡¹ã€‚</p>
</li>
<li>
<p><code>go mod vendor</code>ï¼šå°†ä¾èµ–é¡¹å¤åˆ¶åˆ°é¡¹ç›®çš„ <code>vendor</code> ç›®å½•ä¸‹ï¼Œä»¥ä¾¿ç¦»çº¿ä½¿ç”¨æˆ–ä¸ç‰ˆæœ¬æ§åˆ¶ç³»ç»Ÿä¸€èµ·ç®¡ç†ã€‚</p>
</li>
<li>
<p><code>go mod download</code>ï¼šä¸‹è½½æ¨¡å—çš„ä¾èµ–é¡¹åˆ°æœ¬åœ°ç¼“å­˜ï¼Œä»¥ä¾¿ç¦»çº¿ä½¿ç”¨ã€‚</p>
</li>
<li>
<p><code>go mod graph</code>ï¼šæ˜¾ç¤ºæ¨¡å—çš„ä¾èµ–å…³ç³»å›¾ã€‚</p>
</li>
<li>
<p><code>go mod edit</code>ï¼šç¼–è¾‘æ¨¡å—çš„ go.mod æ–‡ä»¶ï¼Œå¯ä»¥æ·»åŠ ã€æ›´æ–°æˆ–ç§»é™¤ä¾èµ–é¡¹ã€‚</p>
</li>
<li>
<p><code>go mod verify</code>ï¼šéªŒè¯æ¨¡å—çš„ä¾èµ–é¡¹ï¼Œç¡®ä¿å…¶å®Œæ•´æ€§å’Œæ­£ç¡®æ€§ã€‚</p>
</li>
<li>
<p><code>go mod list</code>ï¼šåˆ—å‡ºé¡¹ç›®çš„æ‰€æœ‰ä¾èµ–é¡¹åŠå…¶ç‰ˆæœ¬ã€‚</p>
</li>
<li>
<p><code>go mod why &lt;module&gt;</code>ï¼šè§£é‡Šä¸ºä»€ä¹ˆéœ€è¦ç‰¹å®šçš„ä¾èµ–é¡¹ã€‚</p>
</li>
<li>
<p><code>go mod graph</code>ï¼šæ˜¾ç¤ºæ¨¡å—çš„ä¾èµ–å…³ç³»å›¾ï¼Œä»¥å›¾å½¢æ–¹å¼å±•ç¤ºæ¨¡å—ä¹‹é—´çš„ä¾èµ–å…³ç³»ã€‚</p>
</li>
<li>
<p><code>go mod edit -require &lt;module&gt;@&lt;version&gt;</code>ï¼šæ‰‹åŠ¨æ·»åŠ æˆ–æ›´æ–°ä¾èµ–é¡¹çš„ç‰ˆæœ¬ï¼Œå¯ä»¥ä½¿ç”¨ç‰¹å®šçš„æ¨¡å—å’Œç‰ˆæœ¬å·ã€‚</p>
</li>
<li>
<p><code>go mod edit -replace &lt;module&gt;=&lt;replacement&gt;@&lt;version&gt;</code>ï¼šç”¨å…¶ä»–æ¨¡å—æ›¿ä»£æŒ‡å®šçš„ä¾èµ–é¡¹ï¼Œç”¨äºæœ¬åœ°å¼€å‘æˆ–æµ‹è¯•ã€‚</p>
</li>
<li>
<p><code>go mod tidy -v</code>ï¼šä»¥è¯¦ç»†æ¨¡å¼è¿è¡Œ <code>go mod tidy</code> å‘½ä»¤ï¼Œæ˜¾ç¤ºæ“ä½œçš„è¯¦ç»†ä¿¡æ¯ã€‚</p>
</li>
<li>
<p><code>go mod download -x</code>ï¼šä»¥è¯¦ç»†æ¨¡å¼è¿è¡Œ <code>go mod download</code> å‘½ä»¤ï¼Œæ˜¾ç¤ºä¸‹è½½è¿‡ç¨‹ä¸­çš„è¯¦ç»†ä¿¡æ¯ã€‚</p>
</li>
<li>
<p><code>go mod vendor -v</code>ï¼šä»¥è¯¦ç»†æ¨¡å¼è¿è¡Œ <code>go mod vendor</code> å‘½ä»¤ï¼Œæ˜¾ç¤ºå¤åˆ¶ä¾èµ–é¡¹åˆ° <code>vendor</code> ç›®å½•çš„è¯¦ç»†ä¿¡æ¯ã€‚</p>
</li>
<li>
<p><code>go mod why -m &lt;module&gt;</code>ï¼šæ˜¾ç¤ºç‰¹å®šæ¨¡å—ä¸ºä»€ä¹ˆè¢«åŒ…å«åœ¨æ¨¡å—å›¾ä¸­ï¼Œè§£é‡Šæ¨¡å—ä¹‹é—´çš„ç›´æ¥å’Œé—´æ¥ä¾èµ–å…³ç³»ã€‚</p>
</li>
<li>
<p><code>go mod why -u</code>ï¼šæ£€æŸ¥å¯å‡çº§çš„ä¾èµ–é¡¹ï¼Œè§£é‡Šä¸ºä»€ä¹ˆæŸä¸ªä¾èµ–é¡¹éœ€è¦æ›´æ–°åˆ°æ›´é«˜ç‰ˆæœ¬ã€‚</p>
</li>
</ul>
<h2 id="å‚è€ƒ" class="headerLink">
    <a href="#%e5%8f%82%e8%80%83" class="header-mark"></a>å‚è€ƒ</h2><ul>
<li><a href="https://studygolang.com/articles/23900" target="_blank" rel="noopener noreferrer">golangç¼–è¯‘æ—¶çš„å‚æ•°ä¼ é€’ï¼ˆgcflags, ldflagsï¼‰</a></li>
<li><a href="https://blog.csdn.net/hx7013/article/details/91489642" target="_blank" rel="noopener noreferrer">Golangäº¤å‰ç¼–è¯‘ï¼ˆè·¨å¹³å°ç¼–è¯‘ï¼‰ç®€è¿°</a></li>
<li><a href="https://holmesian.org/golang-cross-compile" target="_blank" rel="noopener noreferrer">äº¤å‰ç¼–è¯‘Goç¨‹åº</a></li>
<li><a href="https://github.com/goreleaser/goreleaser/issues/36" target="_blank" rel="noopener noreferrer">ARM flags GOARM</a></li>
<li><a href="https://www.jianshu.com/p/760c97ff644c" target="_blank" rel="noopener noreferrer">go modä½¿ç”¨</a></li>
</ul>
]]></description>
</item><item>
    <title>running gcc failed: exit status 1</title>
    <link>https://www.xiaobinqt.cn/build-running-gcc-failed/</link>
    <pubDate>Thu, 10 Feb 2022 00:00:00 &#43;0000</pubDate><author>
        <name>xiaobinqt</name>
    </author><guid>https://www.xiaobinqt.cn/build-running-gcc-failed/</guid>
    <description><![CDATA[<p>ä»Šå¤©åœ¨ç¼–è¯‘ go é¡¹ç›®æ—¶å‡ºç°äº†å¦‚ä¸‹é”™è¯¯ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">/usr/local/go/pkg/tool/linux_amd64/link: running gcc failed: <span class="nb">exit</span> status <span class="m">1</span>
</span></span><span class="line"><span class="cl">/usr/bin/ld: cannot find -lpthread
</span></span><span class="line"><span class="cl">/usr/bin/ld: cannot find -lc
</span></span><span class="line"><span class="cl">collect2: error: ld returned <span class="m">1</span> <span class="nb">exit</span> status
</span></span></code></pre></td></tr></table>
</div>
</div><p>è§£å†³åŠæ³•ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">yum install glibc-static.x86_64 -y
</span></span></code></pre></td></tr></table>
</div>
</div>]]></description>
</item><item>
    <title>Go å®ç°ä¸‹è½½æ–‡ä»¶çš„æ–­ç‚¹ç»­ä¼ </title>
    <link>https://www.xiaobinqt.cn/go-breakpoint-resume/</link>
    <pubDate>Fri, 21 Jan 2022 00:00:00 &#43;0000</pubDate><author>
        <name>xiaobinqt</name>
    </author><guid>https://www.xiaobinqt.cn/go-breakpoint-resume/</guid>
    <description><![CDATA[<!-- authorï¼š xiaobinqt -->
<!-- emailï¼š xiaobinqt@163.com -->
<!-- https://xiaobinqt.github.io -->
<!-- https://www.xiaobinqt.cn -->
<h2 id="æ–­ç‚¹ç»­ä¼ " class="headerLink">
    <a href="#%e6%96%ad%e7%82%b9%e7%bb%ad%e4%bc%a0" class="header-mark"></a>æ–­ç‚¹ç»­ä¼ </h2><p>æ–­ç‚¹ç»§ä¼ å°±æ˜¯ä¸‹è½½çš„æ–‡ä»¶å¯ä»¥åœ¨ä½ ä¸‹è½½äº†ä¸€åŠçš„æ—¶å€™æš‚åœï¼Œä¸‹ä¸€æ¬¡ä¸‹è½½çš„æ—¶å€™å¯ä»¥ä»ä½ æš‚åœçš„åœ°æ–¹ç»§ç»­ä¸‹è½½ï¼Œä¸ç”¨ä»å¤´å¼€å§‹ä¸‹è½½ã€‚</p>
<h2 id="æœåŠ¡ç«¯" class="headerLink">
    <a href="#%e6%9c%8d%e5%8a%a1%e7%ab%af" class="header-mark"></a>æœåŠ¡ç«¯</h2><h3 id="martini-å®ç°" class="headerLink">
    <a href="#martini-%e5%ae%9e%e7%8e%b0" class="header-mark"></a>martini å®ç°</h3><p><a href="https://github.com/go-martini/martini" target="_blank" rel="noopener noreferrer">martini</a> æ¡†æ¶å®ç°ğŸ‘‡</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;bufio&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;crypto/md5&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;encoding/hex&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;fmt&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;io&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;net/http&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;os&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;strconv&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;strings&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="s">&#34;github.com/go-martini/martini&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;github.com/pkg/errors&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// å¤§æ–‡ä»¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">var</span> <span class="nx">path</span> <span class="p">=</span> <span class="s">&#34;/mnt/d/code-server-3.11.0-linux-amd64.tar.gz&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">download</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">filename</span> <span class="o">:=</span> <span class="s">&#34;download&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">file</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nf">Open</span><span class="p">(</span><span class="nx">path</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">err</span> <span class="p">=</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">Wrapf</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="s">&#34;download openfile err&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="nx">w</span><span class="p">.</span><span class="nf">WriteHeader</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="nx">w</span><span class="p">.</span><span class="nf">Write</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nf">Error</span><span class="p">()))</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">defer</span> <span class="nx">file</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">info</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">file</span><span class="p">.</span><span class="nf">Stat</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">err</span> <span class="p">=</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">Wrapf</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="s">&#34;download stat err&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="nx">w</span><span class="p">.</span><span class="nf">WriteHeader</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="nx">w</span><span class="p">.</span><span class="nf">Write</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nf">Error</span><span class="p">()))</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">md5sum</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">MD5sum</span><span class="p">(</span><span class="nx">file</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">err</span> <span class="p">=</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">Wrapf</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="s">&#34;download md5sum err&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="nx">w</span><span class="p">.</span><span class="nf">WriteHeader</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="nx">w</span><span class="p">.</span><span class="nf">Write</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nf">Error</span><span class="p">()))</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;md5sum = &#34;</span><span class="p">,</span> <span class="nx">md5sum</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">w</span><span class="p">.</span><span class="nf">Header</span><span class="p">().</span><span class="nf">Add</span><span class="p">(</span><span class="s">&#34;Accept-Ranges&#34;</span><span class="p">,</span> <span class="s">&#34;bytes&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">w</span><span class="p">.</span><span class="nf">Header</span><span class="p">().</span><span class="nf">Add</span><span class="p">(</span><span class="s">&#34;Content-Disposition&#34;</span><span class="p">,</span> <span class="s">&#34;attachment; filename=&#34;</span><span class="o">+</span><span class="nx">filename</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">w</span><span class="p">.</span><span class="nf">Header</span><span class="p">().</span><span class="nf">Add</span><span class="p">(</span><span class="s">&#34;Content-Md5&#34;</span><span class="p">,</span> <span class="nx">md5sum</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">start</span><span class="p">,</span> <span class="nx">end</span> <span class="kt">int64</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">r</span> <span class="o">:=</span> <span class="nx">r</span><span class="p">.</span><span class="nx">Header</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="s">&#34;Range&#34;</span><span class="p">);</span> <span class="nx">r</span> <span class="o">!=</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">strings</span><span class="p">.</span><span class="nf">Contains</span><span class="p">(</span><span class="nx">r</span><span class="p">,</span> <span class="s">&#34;bytes=&#34;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">strings</span><span class="p">.</span><span class="nf">Contains</span><span class="p">(</span><span class="nx">r</span><span class="p">,</span> <span class="s">&#34;-&#34;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">fmt</span><span class="p">.</span><span class="nf">Sscanf</span><span class="p">(</span><span class="nx">r</span><span class="p">,</span> <span class="s">&#34;bytes=%d-%d&#34;</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">start</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">end</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="nx">end</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="nx">end</span> <span class="p">=</span> <span class="nx">info</span><span class="p">.</span><span class="nf">Size</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">			<span class="c1">// start ä» 0 å¼€å§‹,æ‰€ä»¥ end = info.Size() ä¹Ÿæ˜¯æœ‰é—®é¢˜çš„ï¼Œend æœ€å¤§æ˜¯ `info.Size() - 1`
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="k">if</span> <span class="nx">start</span> <span class="p">&gt;</span> <span class="nx">end</span> <span class="o">||</span> <span class="nx">start</span> <span class="p">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="nx">end</span> <span class="p">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="nx">end</span> <span class="o">&gt;=</span> <span class="nx">info</span><span class="p">.</span><span class="nf">Size</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="nx">w</span><span class="p">.</span><span class="nf">WriteHeader</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">StatusRequestedRangeNotSatisfiable</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">				<span class="nx">w</span><span class="p">.</span><span class="nf">Write</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="s">&#34;å‚æ•°é”™è¯¯....&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">				<span class="k">return</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">			<span class="nx">w</span><span class="p">.</span><span class="nf">Header</span><span class="p">().</span><span class="nf">Add</span><span class="p">(</span><span class="s">&#34;Content-Length&#34;</span><span class="p">,</span> <span class="nx">strconv</span><span class="p">.</span><span class="nf">FormatInt</span><span class="p">(</span><span class="nx">end</span><span class="o">-</span><span class="nx">start</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">			<span class="nx">w</span><span class="p">.</span><span class="nf">Header</span><span class="p">().</span><span class="nf">Add</span><span class="p">(</span><span class="s">&#34;Content-Range&#34;</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;bytes %d-%d/%d&#34;</span><span class="p">,</span> <span class="nx">start</span><span class="p">,</span> <span class="nx">end</span><span class="p">,</span> <span class="nx">info</span><span class="p">.</span><span class="nf">Size</span><span class="p">()))</span>
</span></span><span class="line"><span class="cl">			<span class="nx">w</span><span class="p">.</span><span class="nf">Header</span><span class="p">().</span><span class="nf">Set</span><span class="p">(</span><span class="s">&#34;Content-Type&#34;</span><span class="p">,</span> <span class="s">&#34;application/octet-stream&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="nx">w</span><span class="p">.</span><span class="nf">WriteHeader</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">StatusPartialContent</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">w</span><span class="p">.</span><span class="nf">WriteHeader</span><span class="p">(</span><span class="mi">400</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="nx">w</span><span class="p">.</span><span class="nf">Write</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="s">&#34;header Range&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">w</span><span class="p">.</span><span class="nf">Header</span><span class="p">().</span><span class="nf">Add</span><span class="p">(</span><span class="s">&#34;Content-Length&#34;</span><span class="p">,</span> <span class="nx">strconv</span><span class="p">.</span><span class="nf">FormatInt</span><span class="p">(</span><span class="nx">info</span><span class="p">.</span><span class="nf">Size</span><span class="p">(),</span> <span class="mi">10</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">		<span class="nx">w</span><span class="p">.</span><span class="nf">Header</span><span class="p">().</span><span class="nf">Set</span><span class="p">(</span><span class="s">&#34;Content-Type&#34;</span><span class="p">,</span> <span class="s">&#34;application/octet-stream&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="nx">start</span> <span class="p">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">		<span class="nx">end</span> <span class="p">=</span> <span class="nx">info</span><span class="p">.</span><span class="nf">Size</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">file</span><span class="p">.</span><span class="nf">Seek</span><span class="p">(</span><span class="nx">start</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">err</span> <span class="p">=</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">Wrapf</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="s">&#34;file seek err&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="nx">w</span><span class="p">.</span><span class="nf">WriteHeader</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="nx">w</span><span class="p">.</span><span class="nf">Write</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nf">Error</span><span class="p">()))</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">n</span> <span class="o">:=</span> <span class="mi">2048</span>
</span></span><span class="line"><span class="cl">	<span class="nx">buf</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">byte</span><span class="p">,</span> <span class="nx">n</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">end</span><span class="o">-</span><span class="nx">start</span><span class="o">+</span><span class="mi">1</span> <span class="p">&lt;</span> <span class="nb">int64</span><span class="p">(</span><span class="nx">n</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">n</span> <span class="p">=</span> <span class="nb">int</span><span class="p">(</span><span class="nx">end</span> <span class="o">-</span> <span class="nx">start</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">file</span><span class="p">.</span><span class="nf">Read</span><span class="p">(</span><span class="nx">buf</span><span class="p">[:</span><span class="nx">n</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="nx">io</span><span class="p">.</span><span class="nx">EOF</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="nx">err</span> <span class="p">=</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">Wrapf</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="s">&#34;io.Eof err&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">				<span class="nx">w</span><span class="p">.</span><span class="nf">WriteHeader</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">				<span class="nx">w</span><span class="p">.</span><span class="nf">Write</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nf">Error</span><span class="p">()))</span>
</span></span><span class="line"><span class="cl">				<span class="k">return</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">w</span><span class="p">.</span><span class="nf">Write</span><span class="p">(</span><span class="nx">buf</span><span class="p">[:</span><span class="nx">n</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">err</span> <span class="p">=</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">Wrapf</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="s">&#34;Writer.Write err&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="nx">w</span><span class="p">.</span><span class="nf">WriteHeader</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="nx">w</span><span class="p">.</span><span class="nf">Write</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nf">Error</span><span class="p">()))</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="nx">start</span> <span class="o">+=</span> <span class="nb">int64</span><span class="p">(</span><span class="nx">n</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">start</span> <span class="o">&gt;=</span> <span class="nx">end</span><span class="o">+</span><span class="mi">1</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">MD5sum</span><span class="p">(</span><span class="nx">file</span> <span class="o">*</span><span class="nx">os</span><span class="p">.</span><span class="nx">File</span><span class="p">)</span> <span class="p">(</span><span class="kt">string</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">hash</span> <span class="o">:=</span> <span class="nx">md5</span><span class="p">.</span><span class="nf">New</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="nx">buf</span><span class="p">,</span> <span class="nx">reader</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">byte</span><span class="p">,</span> <span class="mi">65536</span><span class="p">),</span> <span class="nx">bufio</span><span class="p">.</span><span class="nf">NewReader</span><span class="p">(</span><span class="nx">file</span><span class="p">);</span> <span class="p">;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">n</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">reader</span><span class="p">.</span><span class="nf">Read</span><span class="p">(</span><span class="nx">buf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="nx">err</span> <span class="o">==</span> <span class="nx">io</span><span class="p">.</span><span class="nx">EOF</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="k">break</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="s">&#34;&#34;</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="nx">hash</span><span class="p">.</span><span class="nf">Write</span><span class="p">(</span><span class="nx">buf</span><span class="p">[:</span><span class="nx">n</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">hex</span><span class="p">.</span><span class="nf">EncodeToString</span><span class="p">(</span><span class="nx">hash</span><span class="p">.</span><span class="nf">Sum</span><span class="p">(</span><span class="kc">nil</span><span class="p">)),</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">route</span> <span class="o">:=</span> <span class="nx">martini</span><span class="p">.</span><span class="nf">Classic</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="nx">route</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="s">&#34;/download&#34;</span><span class="p">,</span> <span class="nx">download</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">route</span><span class="p">.</span><span class="nf">RunOnAddr</span><span class="p">(</span><span class="s">&#34;:8080&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="å®¢æˆ·ç«¯ä¸‹è½½" class="headerLink">
    <a href="#%e5%ae%a2%e6%88%b7%e7%ab%af%e4%b8%8b%e8%bd%bd" class="header-mark"></a>å®¢æˆ·ç«¯ä¸‹è½½</h2><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;bufio&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;fmt&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;io&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;net/http&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;net/url&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;os&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;os/exec&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;strconv&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="s">&#34;github.com/pkg/errors&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;github.com/sirupsen/logrus&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">DownloadDownloadArtifact</span><span class="p">(</span><span class="nx">downloadPath</span><span class="p">,</span> <span class="nx">surl</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">dfn</span> <span class="o">:=</span> <span class="nx">downloadPath</span>
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">		<span class="nx">file</span> <span class="o">*</span><span class="nx">os</span><span class="p">.</span><span class="nx">File</span>
</span></span><span class="line"><span class="cl">		<span class="nx">size</span> <span class="kt">int64</span>
</span></span><span class="line"><span class="cl">		<span class="nx">headerMd5sum</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">downloadMd5sum</span> <span class="kt">string</span>
</span></span><span class="line"><span class="cl">	<span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">file</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">os</span><span class="p">.</span><span class="nf">OpenFile</span><span class="p">(</span><span class="nx">dfn</span><span class="p">,</span> <span class="nx">os</span><span class="p">.</span><span class="nx">O_RDWR</span><span class="p">|</span><span class="nx">os</span><span class="p">.</span><span class="nx">O_CREATE</span><span class="p">,</span> <span class="mo">0644</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">defer</span> <span class="nx">file</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">err</span> <span class="p">=</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">Wrapf</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="s">&#34;download openfile err&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">stat</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">file</span><span class="p">.</span><span class="nf">Stat</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="nx">size</span> <span class="p">=</span> <span class="nx">stat</span><span class="p">.</span><span class="nf">Size</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="nx">sk</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">file</span><span class="p">.</span><span class="nf">Seek</span><span class="p">(</span><span class="nx">size</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">err</span> <span class="p">=</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">Wrapf</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="s">&#34;seek err&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">sk</span> <span class="o">!=</span> <span class="nx">size</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">err</span> <span class="p">=</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;seek length not equal file size,seek=%d,size=%d&#34;</span><span class="p">,</span> <span class="nx">sk</span><span class="p">,</span> <span class="nx">size</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="nx">logrus</span><span class="p">.</span><span class="nf">Error</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nf">Error</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">request</span> <span class="o">:=</span> <span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">{}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">request</span><span class="p">.</span><span class="nx">Method</span> <span class="p">=</span> <span class="nx">http</span><span class="p">.</span><span class="nx">MethodGet</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">size</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">header</span> <span class="o">:=</span> <span class="nx">http</span><span class="p">.</span><span class="nx">Header</span><span class="p">{}</span>
</span></span><span class="line"><span class="cl">		<span class="nx">header</span><span class="p">.</span><span class="nf">Set</span><span class="p">(</span><span class="s">&#34;Range&#34;</span><span class="p">,</span> <span class="s">&#34;bytes=&#34;</span><span class="o">+</span><span class="nx">strconv</span><span class="p">.</span><span class="nf">FormatInt</span><span class="p">(</span><span class="nx">size</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span><span class="o">+</span><span class="s">&#34;-&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="nx">request</span><span class="p">.</span><span class="nx">Header</span> <span class="p">=</span> <span class="nx">header</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">parse</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">url</span><span class="p">.</span><span class="nf">Parse</span><span class="p">(</span><span class="nx">surl</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">request</span><span class="p">.</span><span class="nx">URL</span> <span class="p">=</span> <span class="nx">parse</span>
</span></span><span class="line"><span class="cl">	<span class="nx">resp</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">http</span><span class="p">.</span><span class="nx">DefaultClient</span><span class="p">.</span><span class="nf">Do</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">request</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="c1">//resp, err := http.DefaultClient.Do(&amp;request)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">defer</span> <span class="nx">resp</span><span class="p">.</span><span class="nx">Body</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">err</span> <span class="p">=</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">Wrapf</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="s">&#34;client do err&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="nx">logrus</span><span class="p">.</span><span class="nf">Error</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nf">Error</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">headerMd5sum</span> <span class="p">=</span> <span class="nx">resp</span><span class="p">.</span><span class="nx">Header</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="s">&#34;Content-Md5&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">headerMd5sum</span> <span class="o">==</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;resp header md5sum empty&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">body</span> <span class="o">:=</span> <span class="nx">resp</span><span class="p">.</span><span class="nx">Body</span>
</span></span><span class="line"><span class="cl">	<span class="nx">writer</span> <span class="o">:=</span> <span class="nx">bufio</span><span class="p">.</span><span class="nf">NewWriter</span><span class="p">(</span><span class="nx">file</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">bs</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">byte</span><span class="p">,</span> <span class="mi">1024</span><span class="o">*</span><span class="mi">1024</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="kd">var</span> <span class="nx">read</span> <span class="kt">int</span>
</span></span><span class="line"><span class="cl">		<span class="nx">read</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">body</span><span class="p">.</span><span class="nf">Read</span><span class="p">(</span><span class="nx">bs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="nx">io</span><span class="p">.</span><span class="nx">EOF</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="nx">err</span> <span class="p">=</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">Wrapf</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="s">&#34;body read not io eof&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">				<span class="nx">logrus</span><span class="p">.</span><span class="nf">Error</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nf">Error</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">				<span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="nx">err</span> <span class="o">==</span> <span class="nx">io</span><span class="p">.</span><span class="nx">EOF</span> <span class="o">&amp;&amp;</span> <span class="nx">resp</span><span class="p">.</span><span class="nx">StatusCode</span> <span class="o">!=</span> <span class="nx">http</span><span class="p">.</span><span class="nx">StatusOK</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="nx">err</span> <span class="p">=</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">				<span class="k">return</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="nx">read</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">writer</span><span class="p">.</span><span class="nf">Write</span><span class="p">(</span><span class="nx">bs</span><span class="p">[:</span><span class="nx">read</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">				<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">					<span class="nx">err</span> <span class="p">=</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">Wrapf</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="s">&#34;writer write err&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">					<span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">				<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">			<span class="nx">err</span> <span class="p">=</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">			<span class="k">break</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">writer</span><span class="p">.</span><span class="nf">Write</span><span class="p">(</span><span class="nx">bs</span><span class="p">[:</span><span class="nx">read</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">err</span> <span class="p">=</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">Wrapf</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="s">&#34;writer write err&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">err</span> <span class="p">=</span> <span class="nx">writer</span><span class="p">.</span><span class="nf">Flush</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">err</span> <span class="p">=</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">Wrapf</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="s">&#34;writer.Flush err&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// æ¯”å¯¹ md5 æ˜¯å¦ä¸€è‡´
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">downloadMd5sum</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nf">md5sum</span><span class="p">(</span><span class="nx">downloadPath</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">err</span> <span class="p">=</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">Wrapf</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="s">&#34;get download md5dum err&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="nx">logrus</span><span class="p">.</span><span class="nf">Error</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nf">Error</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// md5 ä¸ä¸€è‡´ç›´æ¥åˆ é™¤
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nx">os</span><span class="p">.</span><span class="nf">Remove</span><span class="p">(</span><span class="nx">downloadPath</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">logrus</span><span class="p">.</span><span class="nf">Debugf</span><span class="p">(</span><span class="s">&#34;downloadMd5sum: %s,headerMd5sum:%s &#34;</span><span class="p">,</span> <span class="nx">downloadMd5sum</span><span class="p">,</span> <span class="nx">headerMd5sum</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">downloadMd5sum</span> <span class="o">==</span> <span class="nx">headerMd5sum</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// é”™è¯¯äº†åˆ é™¤ tar åŒ…
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">os</span><span class="p">.</span><span class="nf">Remove</span><span class="p">(</span><span class="nx">downloadPath</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;download md5sum not equal header md5dum&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">md5sum</span><span class="p">(</span><span class="nx">downloadPath</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="kt">string</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">cmdStr</span> <span class="o">:=</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;printf $(md5sum %s)&#34;</span><span class="p">,</span> <span class="nx">downloadPath</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">cmdOutput</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">exec</span><span class="p">.</span><span class="nf">Command</span><span class="p">(</span><span class="s">&#34;/bin/sh&#34;</span><span class="p">,</span> <span class="s">&#34;-c&#34;</span><span class="p">,</span> <span class="nx">cmdStr</span><span class="p">).</span><span class="nf">CombinedOutput</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="nx">logrus</span><span class="p">.</span><span class="nf">Debugf</span><span class="p">(</span><span class="s">&#34;md5sum: %s &#34;</span><span class="p">,</span> <span class="nx">cmdStr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">err</span> <span class="p">=</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">Wrapf</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="s">&#34;md5sum [%s] exec.Command err&#34;</span><span class="p">,</span> <span class="nx">cmdStr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="nx">logrus</span><span class="p">.</span><span class="nf">Error</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nf">Error</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="s">&#34;&#34;</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nb">string</span><span class="p">(</span><span class="nx">cmdOutput</span><span class="p">),</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">err</span> <span class="o">:=</span> <span class="nf">DownloadDownloadArtifact</span><span class="p">(</span><span class="s">&#34;/mnt/d/tmp/xxx.111.test&#34;</span><span class="p">,</span> <span class="s">&#34;http://127.0.0.1:8080/download&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;download err&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">.</span><span class="nf">Error</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;success..........&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div>]]></description>
</item><item>
    <title>å¸¸è§è®¾è®¡æ¨¡å¼-Goå®ç°</title>
    <link>https://www.xiaobinqt.cn/design-patterns/</link>
    <pubDate>Wed, 20 Oct 2021 00:00:00 &#43;0000</pubDate><author>
        <name>xiaobinqt</name>
    </author><guid>https://www.xiaobinqt.cn/design-patterns/</guid>
    <description><![CDATA[<div class="featured-image">
                <img src="https://cdn.xiaobinqt.cn/xiaobinqt.io/20221115/7f6d12f27a2e456db7779a98e9fc86f7.png" referrerpolicy="no-referrer">
            </div><!-- authorï¼š xiaobinqt -->
<!-- emailï¼š xiaobinqt@163.com -->
<!-- https://xiaobinqt.github.io -->
<!-- https://www.xiaobinqt.cn -->
<h2 id="åˆ›å»ºå‹æ¨¡å¼" class="headerLink">
    <a href="#%e5%88%9b%e5%bb%ba%e5%9e%8b%e6%a8%a1%e5%bc%8f" class="header-mark"></a>åˆ›å»ºå‹æ¨¡å¼</h2><h3 id="å•ä¾‹æ¨¡å¼" class="headerLink">
    <a href="#%e5%8d%95%e4%be%8b%e6%a8%a1%e5%bc%8f" class="header-mark"></a>å•ä¾‹æ¨¡å¼</h3><p>ä¿è¯ä¸€ä¸ªç±»æ°¸è¿œåªèƒ½æœ‰ä¸€ä¸ªå¯¹è±¡ï¼Œå¹¶æä¾›ä¸€ä¸ªè®¿é—®å®ƒçš„å…¨å±€è®¿é—®ç‚¹ï¼Œä¸”è¯¥å¯¹è±¡çš„åŠŸèƒ½ä¾ç„¶èƒ½è¢«å…¶ä»–æ¨¡å—ä½¿ç”¨ã€‚</p>
<p>å› ä¸ºåœ¨ç³»ç»Ÿå†…å­˜ä¸­åªå­˜åœ¨ä¸€ä¸ªå¯¹è±¡ï¼Œå•ä¾‹å¯ä»¥èŠ‚çœç³»ç»Ÿèµ„æºã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;fmt&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;sync&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;sync/atomic&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//æ ‡è®°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">var</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">	<span class="nx">initialized</span> <span class="kt">uint32</span>
</span></span><span class="line"><span class="cl">	<span class="nx">lock</span>        <span class="nx">sync</span><span class="p">.</span><span class="nx">Mutex</span>
</span></span><span class="line"><span class="cl">	<span class="nx">instance</span>    <span class="o">*</span><span class="nx">singelton</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">singelton</span> <span class="kd">struct</span><span class="p">{}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">GetInstance</span><span class="p">()</span> <span class="o">*</span><span class="nx">singelton</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">//å¦‚æœæ ‡è®°ä¸ºè¢«è®¾ç½®ï¼Œç›´æ¥è¿”å›ï¼Œä¸åŠ é”
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="nx">atomic</span><span class="p">.</span><span class="nf">LoadUint32</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">initialized</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">instance</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//å¦‚æœæ²¡æœ‰ï¼Œåˆ™åŠ é”ç”³è¯·
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">lock</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="k">defer</span> <span class="nx">lock</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">initialized</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">instance</span> <span class="p">=</span> <span class="nb">new</span><span class="p">(</span><span class="nx">singelton</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="c1">//è®¾ç½®æ ‡è®°ä½
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nx">atomic</span><span class="p">.</span><span class="nf">StoreUint32</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">initialized</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">instance</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">singelton</span><span class="p">)</span> <span class="nf">SomeThing</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;å•ä¾‹å¯¹è±¡çš„æŸæ–¹æ³•&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">s</span> <span class="o">:=</span> <span class="nf">GetInstance</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="nx">s</span><span class="p">.</span><span class="nf">SomeThing</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="ç®€å•å·¥å‚æ¨¡å¼" class="headerLink">
    <a href="#%e7%ae%80%e5%8d%95%e5%b7%a5%e5%8e%82%e6%a8%a1%e5%bc%8f" class="header-mark"></a>ç®€å•å·¥å‚æ¨¡å¼</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">func NewFruit(name string) *Fruit {
</span></span><span class="line"><span class="cl">	fruit := new(Fruit)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	if name == &#34;apple&#34; {
</span></span><span class="line"><span class="cl">		//åˆ›å»ºappleé€»è¾‘
</span></span><span class="line"><span class="cl">	} else if name == &#34;banana&#34; {
</span></span><span class="line"><span class="cl">		//åˆ›å»ºbananaé€»è¾‘
</span></span><span class="line"><span class="cl">	} else if name == &#34;pear&#34; {
</span></span><span class="line"><span class="cl">		//åˆ›å»ºpearé€»è¾‘
</span></span><span class="line"><span class="cl">	}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	return fruit
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div><p>å¦‚æœæ²¡æœ‰å·¥å‚ï¼Œå°†å¯¹è±¡çš„åˆå§‹åŒ–ä»£ç éƒ½é›†ä¸­åœ¨ä¸€ä¸ªç±»ä¸­å®ç°ï¼Œè¿åäº†<strong>å•ä¸€èŒè´£åŸåˆ™</strong>ï¼Œä¸åˆ©äºç±»çš„é‡ç”¨å’Œç»´æŠ¤ã€‚å½“éœ€è¦åŠ å…¥æ–°çš„å¯¹è±¡æ—¶ï¼Œå¿…é¡»ä¿®æ”¹åŸºç¡€ç±»çš„ New æ„é€ å‡½æ•°å’Œå…¶ä»–ç›¸å…³çš„æºä»£ç ï¼Œè¿åäº†<strong>å¼€é—­åŸåˆ™</strong>ã€‚</p>
<p>ç®€å•å·¥å‚æ¨¡å¼åœ¨ä¸­é—´åŠ äº†ä¸€ä¸ªå·¥å‚æ¨¡å—ï¼Œè§£å†³äº†ä¸šåŠ¡é€»è¾‘ä¸åŸºç¡€ç±»çš„å¼ºè€¦åˆã€‚ç®€å•å·¥å‚æ¨¡å¼åˆå«é™æ€æ–¹æ³•æ¨¡å¼ï¼Œå› ä¸ºå·¥å‚ç±»ä¸­å®šä¹‰äº†ä¸€ä¸ªç”¨äºåˆ›å»ºå¯¹è±¡çš„æ–¹æ³•ã€‚ç®€å•å·¥å‚è®©ä½¿ç”¨è€…ä¸ç”¨çŸ¥é“å…·ä½“çš„å‚æ•°å°±å¯ä»¥åˆ›å»ºå‡ºæ‰€éœ€çš„â€œäº§å“â€ç±»ï¼Œå³ä½¿ç”¨è€…å¯ä»¥ç›´æ¥æ¶ˆè´¹äº§å“è€Œä¸éœ€è¦çŸ¥é“äº§å“çš„å…·ä½“ç”Ÿäº§ç»†èŠ‚ã€‚</p>
<div class="mermaid" id="id-1"></div><p>ç”±ğŸ‘‡ä»£ç å¯çŸ¥ï¼Œå·¥å‚æ–¹æ³•æ¨¡å¼è™½ç„¶è§£å†³äº†å¯¹è±¡åˆ›å»ºå’Œä½¿ç”¨çš„åˆ†ç¦»ï¼Œä½†æ˜¯åŒæ ·è¿å<strong>å¼€é—­åŸåˆ™</strong>ï¼Œå› ä¸ºæ·»åŠ æ–°äº§å“éœ€è¦ä¿®æ”¹å·¥å‚é€»è¾‘ï¼Œè€Œä¸”å·¥å‚ä¼šè¶Šæ¥è¶Šå¤æ‚ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="s">&#34;fmt&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// ======= æŠ½è±¡å±‚ =========
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="c1">//æ°´æœç±»(æŠ½è±¡æ¥å£)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">Fruit</span> <span class="kd">interface</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nf">Show</span><span class="p">()</span> <span class="c1">//æ¥å£çš„æŸæ–¹æ³•
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// ======= åŸºç¡€ç±»æ¨¡å— =========
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">Apple</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">Fruit</span> <span class="c1">//ä¸ºäº†æ˜“äºç†è§£æ˜¾ç¤ºç»§æ‰¿(æ­¤è¡Œå¯ä»¥çœç•¥)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">apple</span> <span class="o">*</span><span class="nx">Apple</span><span class="p">)</span> <span class="nf">Show</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;æˆ‘æ˜¯è‹¹æœ&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">Banana</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">Fruit</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">banana</span> <span class="o">*</span><span class="nx">Banana</span><span class="p">)</span> <span class="nf">Show</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;æˆ‘æ˜¯é¦™è•‰&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">Pear</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">Fruit</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">pear</span> <span class="o">*</span><span class="nx">Pear</span><span class="p">)</span> <span class="nf">Show</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;æˆ‘æ˜¯æ¢¨&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// ========= å·¥å‚æ¨¡å—  =========
</span></span></span><span class="line"><span class="cl"><span class="c1">//ä¸€ä¸ªå·¥å‚ï¼Œ æœ‰ä¸€ä¸ªç”Ÿäº§æ°´æœçš„æœºå™¨ï¼Œè¿”å›ä¸€ä¸ªæŠ½è±¡æ°´æœçš„æŒ‡é’ˆ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">Factory</span> <span class="kd">struct</span><span class="p">{}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">fac</span> <span class="o">*</span><span class="nx">Factory</span><span class="p">)</span> <span class="nf">CreateFruit</span><span class="p">(</span><span class="nx">kind</span> <span class="kt">string</span><span class="p">)</span> <span class="nx">Fruit</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">fruit</span> <span class="nx">Fruit</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">kind</span> <span class="o">==</span> <span class="s">&#34;apple&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">fruit</span> <span class="p">=</span> <span class="nb">new</span><span class="p">(</span><span class="nx">Apple</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="nx">kind</span> <span class="o">==</span> <span class="s">&#34;banana&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">fruit</span> <span class="p">=</span> <span class="nb">new</span><span class="p">(</span><span class="nx">Banana</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="nx">kind</span> <span class="o">==</span> <span class="s">&#34;pear&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">fruit</span> <span class="p">=</span> <span class="nb">new</span><span class="p">(</span><span class="nx">Pear</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">fruit</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// ==========ä¸šåŠ¡é€»è¾‘å±‚==============
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">factory</span> <span class="o">:=</span> <span class="nb">new</span><span class="p">(</span><span class="nx">Factory</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">apple</span> <span class="o">:=</span> <span class="nx">factory</span><span class="p">.</span><span class="nf">CreateFruit</span><span class="p">(</span><span class="s">&#34;apple&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">apple</span><span class="p">.</span><span class="nf">Show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">banana</span> <span class="o">:=</span> <span class="nx">factory</span><span class="p">.</span><span class="nf">CreateFruit</span><span class="p">(</span><span class="s">&#34;banana&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">banana</span><span class="p">.</span><span class="nf">Show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">pear</span> <span class="o">:=</span> <span class="nx">factory</span><span class="p">.</span><span class="nf">CreateFruit</span><span class="p">(</span><span class="s">&#34;pear&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">pear</span><span class="p">.</span><span class="nf">Show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="å·¥å‚æ–¹æ³•æ¨¡å¼" class="headerLink">
    <a href="#%e5%b7%a5%e5%8e%82%e6%96%b9%e6%b3%95%e6%a8%a1%e5%bc%8f" class="header-mark"></a>å·¥å‚æ–¹æ³•æ¨¡å¼</h3><p>ç®€å•å·¥å‚æ¨¡å¼ + å¼€é—­åŸåˆ™ = <strong><ruby>å·¥å‚æ–¹æ³•æ¨¡å¼<rt>Factory Method Pattern</rt></ruby></strong></p>
<p>åœ¨å·¥å‚æ–¹æ³•æ¨¡å¼ä¸­ï¼Œå·¥å‚çˆ¶ç±»è´Ÿè´£å®šä¹‰åˆ›å»ºäº§å“å¯¹è±¡çš„å…¬å…±æ¥å£ï¼Œè€Œå·¥å‚å­ç±»åˆ™è´Ÿè´£ç”Ÿæˆå…·ä½“çš„äº§å“å¯¹è±¡ï¼Œè¿™æ ·åšçš„ç›®çš„æ˜¯<strong>å°†äº§å“ç±»çš„å®ä¾‹åŒ–æ“ä½œå»¶è¿Ÿåˆ°å·¥å‚å­ç±»ä¸­å®Œæˆ</strong>ï¼Œå³é€šè¿‡å·¥å‚å­ç±»æ¥ç¡®å®šç©¶ç«Ÿåº”è¯¥å®ä¾‹åŒ–å“ªä¸€ä¸ªå…·ä½“äº§å“ç±»ã€‚</p>
<p><figure><a class="lightgallery" href="https://cdn.xiaobinqt.cn/xiaobinqt.io/20221115/bef83a26b8774238a257470832b08882.png" title="å·¥å‚æ–¹æ³•æ¨¡å¼" data-thumbnail="https://cdn.xiaobinqt.cn/xiaobinqt.io/20221115/bef83a26b8774238a257470832b08882.png" data-sub-html="<h2>å·¥å‚æ–¹æ³•æ¨¡å¼</h2><p>å·¥å‚æ–¹æ³•æ¨¡å¼</p>">
        
    </a><figcaption class="image-caption">å·¥å‚æ–¹æ³•æ¨¡å¼</figcaption>
    </figure></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="s">&#34;fmt&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// ======= æŠ½è±¡å±‚ =========
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="c1">//æ°´æœç±»(æŠ½è±¡æ¥å£)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">Fruit</span> <span class="kd">interface</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nf">Show</span><span class="p">()</span> <span class="c1">//æ¥å£çš„æŸæ–¹æ³•
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//å·¥å‚ç±»(æŠ½è±¡æ¥å£)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">AbstractFactory</span> <span class="kd">interface</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nf">CreateFruit</span><span class="p">()</span> <span class="nx">Fruit</span> <span class="c1">//ç”Ÿäº§æ°´æœç±»(æŠ½è±¡)çš„ç”Ÿäº§å™¨æ–¹æ³•
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// ======= åŸºç¡€ç±»æ¨¡å— =========
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">Apple</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">Fruit</span> <span class="c1">//ä¸ºäº†æ˜“äºç†è§£æ˜¾ç¤ºç»§æ‰¿(æ­¤è¡Œå¯ä»¥çœç•¥)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">apple</span> <span class="o">*</span><span class="nx">Apple</span><span class="p">)</span> <span class="nf">Show</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;æˆ‘æ˜¯è‹¹æœ&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">Banana</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">Fruit</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">banana</span> <span class="o">*</span><span class="nx">Banana</span><span class="p">)</span> <span class="nf">Show</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;æˆ‘æ˜¯é¦™è•‰&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">Pear</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">Fruit</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">pear</span> <span class="o">*</span><span class="nx">Pear</span><span class="p">)</span> <span class="nf">Show</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;æˆ‘æ˜¯æ¢¨&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// ========= å·¥å‚æ¨¡å—  =========
</span></span></span><span class="line"><span class="cl"><span class="c1">//å…·ä½“çš„è‹¹æœå·¥å‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">AppleFactory</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">AbstractFactory</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">fac</span> <span class="o">*</span><span class="nx">AppleFactory</span><span class="p">)</span> <span class="nf">CreateFruit</span><span class="p">()</span> <span class="nx">Fruit</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">fruit</span> <span class="nx">Fruit</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//ç”Ÿäº§ä¸€ä¸ªå…·ä½“çš„è‹¹æœ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">fruit</span> <span class="p">=</span> <span class="nb">new</span><span class="p">(</span><span class="nx">Apple</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">fruit</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//å…·ä½“çš„é¦™è•‰å·¥å‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">BananaFactory</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">AbstractFactory</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">fac</span> <span class="o">*</span><span class="nx">BananaFactory</span><span class="p">)</span> <span class="nf">CreateFruit</span><span class="p">()</span> <span class="nx">Fruit</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">fruit</span> <span class="nx">Fruit</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//ç”Ÿäº§ä¸€ä¸ªå…·ä½“çš„é¦™è•‰
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">fruit</span> <span class="p">=</span> <span class="nb">new</span><span class="p">(</span><span class="nx">Banana</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">fruit</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//å…·ä½“çš„æ¢¨å·¥å‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">PearFactory</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">AbstractFactory</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">fac</span> <span class="o">*</span><span class="nx">PearFactory</span><span class="p">)</span> <span class="nf">CreateFruit</span><span class="p">()</span> <span class="nx">Fruit</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">fruit</span> <span class="nx">Fruit</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//ç”Ÿäº§ä¸€ä¸ªå…·ä½“çš„æ¢¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">fruit</span> <span class="p">=</span> <span class="nb">new</span><span class="p">(</span><span class="nx">Pear</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">fruit</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//======= ä¸šåŠ¡é€»è¾‘å±‚ =======
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">		ä¸ºäº†çªå‡ºæ ¹æ®ä¾èµ–å€’è½¬åŸåˆ™ä¸é¢å‘æ¥å£ç¼–ç¨‹ç‰¹æ€§ã€‚
</span></span></span><span class="line"><span class="cl"><span class="cm">		ä¸€äº›å˜é‡çš„å®šä¹‰å°†ä½¿ç”¨æ˜¾ç¤ºç±»å‹å£°æ˜æ–¹å¼
</span></span></span><span class="line"><span class="cl"><span class="cm">	*/</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//éœ€æ±‚1ï¼šéœ€è¦ä¸€ä¸ªå…·ä½“çš„è‹¹æœå¯¹è±¡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">//1-å…ˆè¦ä¸€ä¸ªå…·ä½“çš„è‹¹æœå·¥å‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="kd">var</span> <span class="nx">appleFac</span> <span class="nx">AbstractFactory</span>
</span></span><span class="line"><span class="cl">	<span class="nx">appleFac</span> <span class="p">=</span> <span class="nb">new</span><span class="p">(</span><span class="nx">AppleFactory</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="c1">//2-ç”Ÿäº§ç›¸å¯¹åº”çš„å…·ä½“æ°´æœ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="kd">var</span> <span class="nx">apple</span> <span class="nx">Fruit</span>
</span></span><span class="line"><span class="cl">	<span class="nx">apple</span> <span class="p">=</span> <span class="nx">appleFac</span><span class="p">.</span><span class="nf">CreateFruit</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">apple</span><span class="p">.</span><span class="nf">Show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//éœ€æ±‚2ï¼šéœ€è¦ä¸€ä¸ªå…·ä½“çš„é¦™è•‰å¯¹è±¡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">//1-å…ˆè¦ä¸€ä¸ªå…·ä½“çš„é¦™è•‰å·¥å‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="kd">var</span> <span class="nx">bananaFac</span> <span class="nx">AbstractFactory</span>
</span></span><span class="line"><span class="cl">	<span class="nx">bananaFac</span> <span class="p">=</span> <span class="nb">new</span><span class="p">(</span><span class="nx">BananaFactory</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="c1">//2-ç”Ÿäº§ç›¸å¯¹åº”çš„å…·ä½“æ°´æœ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="kd">var</span> <span class="nx">banana</span> <span class="nx">Fruit</span>
</span></span><span class="line"><span class="cl">	<span class="nx">banana</span> <span class="p">=</span> <span class="nx">bananaFac</span><span class="p">.</span><span class="nf">CreateFruit</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">banana</span><span class="p">.</span><span class="nf">Show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//éœ€æ±‚3ï¼šéœ€è¦ä¸€ä¸ªå…·ä½“çš„æ¢¨å¯¹è±¡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">//1-å…ˆè¦ä¸€ä¸ªå…·ä½“çš„æ¢¨å·¥å‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="kd">var</span> <span class="nx">pearFac</span> <span class="nx">AbstractFactory</span>
</span></span><span class="line"><span class="cl">	<span class="nx">pearFac</span> <span class="p">=</span> <span class="nb">new</span><span class="p">(</span><span class="nx">PearFactory</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="c1">//2-ç”Ÿäº§ç›¸å¯¹åº”çš„å…·ä½“æ°´æœ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="kd">var</span> <span class="nx">pear</span> <span class="nx">Fruit</span>
</span></span><span class="line"><span class="cl">	<span class="nx">pear</span> <span class="p">=</span> <span class="nx">pearFac</span><span class="p">.</span><span class="nf">CreateFruit</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">pear</span><span class="p">.</span><span class="nf">Show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="æŠ½è±¡å·¥å‚æ–¹æ³•æ¨¡å¼" class="headerLink">
    <a href="#%e6%8a%bd%e8%b1%a1%e5%b7%a5%e5%8e%82%e6%96%b9%e6%b3%95%e6%a8%a1%e5%bc%8f" class="header-mark"></a>æŠ½è±¡å·¥å‚æ–¹æ³•æ¨¡å¼</h3><p><strong><ruby>æŠ½è±¡å·¥å‚æ¨¡<rt>Abstract Factory Pattern</rt></ruby></strong>ï¼Œæä¾›ä¸€ä¸ªåˆ›å»ºä¸€ç³»åˆ—ç›¸å…³æˆ–ç›¸äº’ä¾èµ–å¯¹è±¡çš„æ¥å£ï¼Œè€Œæ— é¡»æŒ‡å®šå®ƒä»¬å…·ä½“çš„ç±»ã€‚</p>
<p>å·¥å‚æ–¹æ³•æ¨¡å¼é€šè¿‡å¼•å…¥å·¥å‚ç»“æ„ï¼Œè§£å†³äº†ç®€å•å·¥å‚æ¨¡å¼ä¸­å·¥å‚ç±»èŒè´£å¤ªé‡çš„é—®é¢˜ï¼Œä½†ç”±äºå·¥å‚æ–¹æ³•æ¨¡å¼ä¸­çš„æ¯ä¸ªå·¥å‚åªç”Ÿäº§ä¸€ç±»äº§å“ï¼Œå¯èƒ½ä¼šå¯¼è‡´ç³»ç»Ÿä¸­å­˜åœ¨å¤§é‡çš„å·¥å‚ç±»ï¼ŒåŠ¿å¿…ä¼šå¢åŠ ç³»ç»Ÿçš„å¼€é”€ã€‚å› æ­¤ï¼Œå¯ä»¥è€ƒè™‘å°†ä¸€äº›ç›¸å…³çš„äº§å“ç»„æˆä¸€ä¸ªâ€œäº§å“æ—â€ï¼Œç”±åŒä¸€ä¸ªå·¥å‚æ¥ç»Ÿä¸€ç”Ÿäº§ï¼Œè¿™æ ·ï¼Œä¸€ä¸ªå·¥å‚å¯ä»¥æä¾›å¤šä¸ªäº§å“å¯¹è±¡ï¼Œè€Œä¸æ˜¯å•ä¸€çš„äº§å“å¯¹è±¡ã€‚</p>
<p>å…·ä½“å¯ä»¥å‚çœ‹ <a href="https://www.yuque.com/aceld/lfhu8y/hv3rqf" target="_blank" rel="noopener noreferrer">æŠ½è±¡å·¥å‚æ–¹æ³•æ¨¡å¼</a></p>
<blockquote>
<p>è®¾è®¡ä¸€ä¸ªç”µè„‘ä¸»æ¿æ¶æ„ï¼Œç”µè„‘åŒ…æ‹¬ï¼šæ˜¾å¡ï¼Œå†…å­˜ï¼ŒCPU 3 ä¸ªå›ºå®šçš„æ’å£ï¼Œæ˜¾å¡å…·æœ‰æ˜¾ç¤ºåŠŸèƒ½<code>display</code>ï¼ˆåŠŸèƒ½å®ç°åªè¦æ‰“å°å‡ºæ„ä¹‰å³å¯ï¼‰ï¼Œå†…å­˜å…·æœ‰å­˜å‚¨åŠŸèƒ½<code>storage</code>ï¼Œcpu å…·æœ‰è®¡ç®—åŠŸèƒ½<code>calculate</code>ã€‚</p>
<p>ç°æœ‰ Intel å‚å•†ï¼Œnvidia å‚å•†ï¼ŒKingston å‚å•†ï¼Œå‡ä¼šç”Ÿäº§ä»¥ä¸Šä¸‰ç§ç¡¬ä»¶ã€‚</p>
<p>è¦æ±‚ç»„è£…ä¸¤å°ç”µè„‘ï¼Œ
1å°ï¼ˆIntelçš„CPUï¼ŒIntelçš„æ˜¾å¡ï¼ŒIntelçš„å†…å­˜ï¼‰</p>
<p>1å°ï¼ˆIntelçš„CPUï¼Œ nvidiaçš„æ˜¾å¡ï¼ŒKingstonçš„å†…å­˜ï¼‰</p>
<p>ç”¨æŠ½è±¡å·¥å‚æ¨¡å¼å®ç°ã€‚</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="s">&#34;fmt&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">è®¾è®¡ä¸€ä¸ªç”µè„‘ä¸»æ¿æ¶æ„ï¼Œç”µè„‘åŒ…æ‹¬ï¼ˆæ˜¾å¡ï¼Œå†…å­˜ï¼ŒCPUï¼‰3ä¸ªå›ºå®šçš„æ’å£ï¼Œæ˜¾å¡å…·æœ‰æ˜¾ç¤ºåŠŸèƒ½ï¼ˆdisplayï¼ŒåŠŸèƒ½å®ç°åªè¦æ‰“å°å‡ºæ„ä¹‰å³å¯ï¼‰ï¼Œ
</span></span></span><span class="line"><span class="cl"><span class="cm">å†…å­˜å…·æœ‰å­˜å‚¨åŠŸèƒ½ï¼ˆstorageï¼‰ï¼Œcpu å…·æœ‰è®¡ç®—åŠŸèƒ½ï¼ˆcalculateï¼‰ã€‚
</span></span></span><span class="line"><span class="cl"><span class="cm">
</span></span></span><span class="line"><span class="cl"><span class="cm">ç°æœ‰ Intel å‚å•†ï¼Œnvidia å‚å•†ï¼ŒKingston å‚å•†ï¼Œå‡ä¼šç”Ÿäº§ä»¥ä¸Šä¸‰ç§ç¡¬ä»¶ã€‚
</span></span></span><span class="line"><span class="cl"><span class="cm">
</span></span></span><span class="line"><span class="cl"><span class="cm">è¦æ±‚ç»„è£…ä¸¤å°ç”µè„‘ï¼Œ 1å°ï¼ˆIntelçš„CPUï¼ŒIntelçš„æ˜¾å¡ï¼ŒIntelçš„å†…å­˜ï¼‰
</span></span></span><span class="line"><span class="cl"><span class="cm">
</span></span></span><span class="line"><span class="cl"><span class="cm">1å°ï¼ˆIntelçš„CPUï¼Œ nvidiaçš„æ˜¾å¡ï¼ŒKingstonçš„å†…å­˜ï¼‰
</span></span></span><span class="line"><span class="cl"><span class="cm">
</span></span></span><span class="line"><span class="cl"><span class="cm">ç”¨æŠ½è±¡å·¥å‚æ¨¡å¼å®ç°ã€‚
</span></span></span><span class="line"><span class="cl"><span class="cm">
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">AbstractGPU</span> <span class="kd">interface</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nf">Display</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">AbstractMemory</span> <span class="kd">interface</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nf">Storage</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">AbstractCPU</span> <span class="kd">interface</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nf">Calculate</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">AbstractFactory</span> <span class="kd">interface</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nf">CreateGPU</span><span class="p">()</span> <span class="nx">AbstractGPU</span>
</span></span><span class="line"><span class="cl">	<span class="nf">CreateMemory</span><span class="p">()</span> <span class="nx">AbstractMemory</span>
</span></span><span class="line"><span class="cl">	<span class="nf">CreateCPU</span><span class="p">()</span> <span class="nx">AbstractCPU</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Intel -----------
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">IntelGPU</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">IntelMemory</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">IntelCPU</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">IntelGPU</span><span class="p">)</span> <span class="nf">Display</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;Intel æ˜¾å¡&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">IntelMemory</span><span class="p">)</span> <span class="nf">Storage</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;Intel å†…å­˜&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">IntelCPU</span><span class="p">)</span> <span class="nf">Calculate</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;Intel å¤„ç†å™¨&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">IntelFactory</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">AbstractFactory</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">IntelFactory</span><span class="p">)</span> <span class="nf">CreateGPU</span><span class="p">()</span> <span class="nx">AbstractGPU</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nb">new</span><span class="p">(</span><span class="nx">IntelGPU</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">IntelFactory</span><span class="p">)</span> <span class="nf">CreateMemory</span><span class="p">()</span> <span class="nx">AbstractMemory</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nb">new</span><span class="p">(</span><span class="nx">IntelMemory</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">IntelFactory</span><span class="p">)</span> <span class="nf">CreateCPU</span><span class="p">()</span> <span class="nx">AbstractCPU</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nb">new</span><span class="p">(</span><span class="nx">IntelCPU</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//  Nvidia -------------
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">NvidiaGPU</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">NvidiaMemory</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">NvidiaCPU</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">NvidiaGPU</span><span class="p">)</span> <span class="nf">Display</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;Nvidia æ˜¾å¡&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">NvidiaMemory</span><span class="p">)</span> <span class="nf">Storage</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;Nvidia å†…å­˜&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">NvidiaCPU</span><span class="p">)</span> <span class="nf">Calculate</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;Nvidia å¤„ç†å™¨&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">NvidiaFactory</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">AbstractFactory</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">NvidiaFactory</span><span class="p">)</span> <span class="nf">CreateGPU</span><span class="p">()</span> <span class="nx">AbstractGPU</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nb">new</span><span class="p">(</span><span class="nx">NvidiaGPU</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">NvidiaFactory</span><span class="p">)</span> <span class="nf">CreateMemory</span><span class="p">()</span> <span class="nx">AbstractMemory</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nb">new</span><span class="p">(</span><span class="nx">NvidiaMemory</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">NvidiaFactory</span><span class="p">)</span> <span class="nf">CreateCPU</span><span class="p">()</span> <span class="nx">AbstractCPU</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nb">new</span><span class="p">(</span><span class="nx">NvidiaCPU</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//  Kingston ----------
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">KingstonGPU</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">KingstonMemory</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">KingstonCPU</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">KingstonGPU</span><span class="p">)</span> <span class="nf">Display</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;Kingston æ˜¾å¡&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">KingstonMemory</span><span class="p">)</span> <span class="nf">Storage</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;Kingston å†…å­˜&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">KingstonCPU</span><span class="p">)</span> <span class="nf">Calculate</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;Kingston å¤„ç†å™¨&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">KingstonFactory</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">AbstractFactory</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">KingstonFactory</span><span class="p">)</span> <span class="nf">CreateGPU</span><span class="p">()</span> <span class="nx">AbstractGPU</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nb">new</span><span class="p">(</span><span class="nx">KingstonGPU</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">KingstonFactory</span><span class="p">)</span> <span class="nf">CreateMemory</span><span class="p">()</span> <span class="nx">AbstractMemory</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nb">new</span><span class="p">(</span><span class="nx">KingstonMemory</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">KingstonFactory</span><span class="p">)</span> <span class="nf">CreateCPU</span><span class="p">()</span> <span class="nx">AbstractCPU</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nb">new</span><span class="p">(</span><span class="nx">KingstonCPU</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">	1å°ï¼ˆIntelçš„CPUï¼ŒIntelçš„æ˜¾å¡ï¼ŒIntelçš„å†…å­˜ï¼‰
</span></span></span><span class="line"><span class="cl"><span class="cm">	1å°ï¼ˆIntelçš„CPUï¼Œ nvidiaçš„æ˜¾å¡ï¼ŒKingstonçš„å†…å­˜ï¼‰
</span></span></span><span class="line"><span class="cl"><span class="cm">	*/</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">		<span class="nx">intel</span>    <span class="nx">AbstractFactory</span>
</span></span><span class="line"><span class="cl">		<span class="nx">nvidia</span>   <span class="nx">AbstractFactory</span>
</span></span><span class="line"><span class="cl">		<span class="nx">kingston</span> <span class="nx">AbstractFactory</span>
</span></span><span class="line"><span class="cl">	<span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">intel</span> <span class="p">=</span> <span class="nb">new</span><span class="p">(</span><span class="nx">IntelFactory</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">nvidia</span> <span class="p">=</span> <span class="nb">new</span><span class="p">(</span><span class="nx">NvidiaFactory</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">kingston</span> <span class="p">=</span> <span class="nb">new</span><span class="p">(</span><span class="nx">KingstonFactory</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">intel</span><span class="p">.</span><span class="nf">CreateCPU</span><span class="p">().</span><span class="nf">Calculate</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="nx">intel</span><span class="p">.</span><span class="nf">CreateGPU</span><span class="p">().</span><span class="nf">Display</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="nx">intel</span><span class="p">.</span><span class="nf">CreateMemory</span><span class="p">().</span><span class="nf">Storage</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;---------------&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">intel</span><span class="p">.</span><span class="nf">CreateCPU</span><span class="p">().</span><span class="nf">Calculate</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="nx">nvidia</span><span class="p">.</span><span class="nf">CreateGPU</span><span class="p">().</span><span class="nf">Display</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="nx">kingston</span><span class="p">.</span><span class="nf">CreateMemory</span><span class="p">().</span><span class="nf">Storage</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="ç»“æ„å‹æ¨¡å¼" class="headerLink">
    <a href="#%e7%bb%93%e6%9e%84%e5%9e%8b%e6%a8%a1%e5%bc%8f" class="header-mark"></a>ç»“æ„å‹æ¨¡å¼</h2><h3 id="ä»£ç†æ¨¡å¼" class="headerLink">
    <a href="#%e4%bb%a3%e7%90%86%e6%a8%a1%e5%bc%8f" class="header-mark"></a>ä»£ç†æ¨¡å¼</h3><p><figure><a class="lightgallery" href="https://cdn.xiaobinqt.cn/xiaobinqt.io/20221115/d56dfab0e3df4e6ba4a00d2405d2a614.png" title="ä»£ç†æ¨¡å¼" data-thumbnail="https://cdn.xiaobinqt.cn/xiaobinqt.io/20221115/d56dfab0e3df4e6ba4a00d2405d2a614.png" data-sub-html="<h2>ä»£ç†æ¨¡å¼</h2><p>ä»£ç†æ¨¡å¼</p>">
        
    </a><figcaption class="image-caption">ä»£ç†æ¨¡å¼</figcaption>
    </figure></p>
<p>ä»£ç†æ¨¡å¼åˆå« Proxy æ¨¡å¼ï¼Œå®ƒå¯ä»¥ä¸ºå…¶ä»–å¯¹è±¡æä¾›ä¸€ç§ä»£ç† Proxy ä»¥<strong>æ§åˆ¶</strong>å¯¹è¿™ä¸ªå¯¹è±¡çš„è®¿é—®ã€‚ä»£ç†éœ€è¦å…·æœ‰ä¸è¢«ä»£ç†çš„å¯¹è±¡ç›¸åŒçš„æ¥å£çš„ç±»ï¼Œå®¢æˆ·ç«¯å¿…é¡»é€šè¿‡ä»£ç†ä¸è¢«ä»£ç†çš„ç›®æ ‡ç±»äº¤äº’ï¼Œè€Œ<strong>ä»£ç†ä¸€èˆ¬åœ¨äº¤äº’çš„è¿‡ç¨‹ä¸­ï¼ˆäº¤äº’å‰åï¼‰ï¼Œè¿›è¡ŒæŸäº›ç‰¹åˆ«çš„å¤„ç†</strong>ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="s">&#34;fmt&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">Goods</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">Kind</span> <span class="kt">string</span> <span class="c1">//å•†å“ç§ç±»
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">Fact</span> <span class="kt">bool</span>   <span class="c1">//å•†å“çœŸä¼ª
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// =========== æŠ½è±¡å±‚ ===========
</span></span></span><span class="line"><span class="cl"><span class="c1">//æŠ½è±¡çš„è´­ç‰©ä¸»é¢˜Subject
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">Shopping</span> <span class="kd">interface</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nf">Buy</span><span class="p">(</span><span class="nx">goods</span> <span class="o">*</span><span class="nx">Goods</span><span class="p">)</span> <span class="c1">//æŸä»»åŠ¡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// =========== å®ç°å±‚ ===========
</span></span></span><span class="line"><span class="cl"><span class="c1">//å…·ä½“çš„è´­ç‰©ä¸»é¢˜ï¼Œ å®ç°äº†shoppingï¼Œ å»éŸ©å›½è´­ç‰©
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">KoreaShopping</span> <span class="kd">struct</span><span class="p">{}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">ks</span> <span class="o">*</span><span class="nx">KoreaShopping</span><span class="p">)</span> <span class="nf">Buy</span><span class="p">(</span><span class="nx">goods</span> <span class="o">*</span><span class="nx">Goods</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;å»éŸ©å›½è¿›è¡Œäº†è´­ç‰©, ä¹°äº† &#34;</span><span class="p">,</span> <span class="nx">goods</span><span class="p">.</span><span class="nx">Kind</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//å…·ä½“çš„è´­ç‰©ä¸»é¢˜ï¼Œ å®ç°äº†shoppingï¼Œ å»ç¾å›½è´­ç‰©
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">AmericanShopping</span> <span class="kd">struct</span><span class="p">{}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">as</span> <span class="o">*</span><span class="nx">AmericanShopping</span><span class="p">)</span> <span class="nf">Buy</span><span class="p">(</span><span class="nx">goods</span> <span class="o">*</span><span class="nx">Goods</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;å»ç¾å›½è¿›è¡Œäº†è´­ç‰©, ä¹°äº† &#34;</span><span class="p">,</span> <span class="nx">goods</span><span class="p">.</span><span class="nx">Kind</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//å…·ä½“çš„è´­ç‰©ä¸»é¢˜ï¼Œ å®ç°äº†shoppingï¼Œ å»éæ´²è´­ç‰©
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">AfricaShopping</span> <span class="kd">struct</span><span class="p">{}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">as</span> <span class="o">*</span><span class="nx">AfricaShopping</span><span class="p">)</span> <span class="nf">Buy</span><span class="p">(</span><span class="nx">goods</span> <span class="o">*</span><span class="nx">Goods</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;å»éæ´²è¿›è¡Œäº†è´­ç‰©, ä¹°äº† &#34;</span><span class="p">,</span> <span class="nx">goods</span><span class="p">.</span><span class="nx">Kind</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//æµ·å¤–çš„ä»£ç†
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">OverseasProxy</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">shopping</span> <span class="nx">Shopping</span> <span class="c1">//ä»£ç†æŸä¸ªä¸»é¢˜ï¼Œè¿™é‡Œæ˜¯æŠ½è±¡ç±»å‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">op</span> <span class="o">*</span><span class="nx">OverseasProxy</span><span class="p">)</span> <span class="nf">Buy</span><span class="p">(</span><span class="nx">goods</span> <span class="o">*</span><span class="nx">Goods</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// 1. å…ˆéªŒè´§
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="nx">op</span><span class="p">.</span><span class="nf">distinguish</span><span class="p">(</span><span class="nx">goods</span><span class="p">)</span> <span class="o">==</span> <span class="kc">true</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="c1">//2. è¿›è¡Œè´­ä¹°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nx">op</span><span class="p">.</span><span class="nx">shopping</span><span class="p">.</span><span class="nf">Buy</span><span class="p">(</span><span class="nx">goods</span><span class="p">)</span> <span class="c1">//è°ƒç”¨åŸè¢«ä»£ç†çš„å…·ä½“ä¸»é¢˜ä»»åŠ¡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="c1">//3 æµ·å…³å®‰æ£€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nx">op</span><span class="p">.</span><span class="nf">check</span><span class="p">(</span><span class="nx">goods</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//åˆ›å»ºä¸€ä¸ªä»£ç†,å¹¶ä¸”é…ç½®å…³è”è¢«ä»£ç†çš„ä¸»é¢˜
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">NewProxy</span><span class="p">(</span><span class="nx">shopping</span> <span class="nx">Shopping</span><span class="p">)</span> <span class="nx">Shopping</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="o">&amp;</span><span class="nx">OverseasProxy</span><span class="p">{</span><span class="nx">shopping</span><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//éªŒè´§æµç¨‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">op</span> <span class="o">*</span><span class="nx">OverseasProxy</span><span class="p">)</span> <span class="nf">distinguish</span><span class="p">(</span><span class="nx">goods</span> <span class="o">*</span><span class="nx">Goods</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;å¯¹ [&#34;</span><span class="p">,</span> <span class="nx">goods</span><span class="p">.</span><span class="nx">Kind</span><span class="p">,</span> <span class="s">&#34;] è¿›è¡Œäº†è¾¨åˆ«çœŸä¼ª.&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">goods</span><span class="p">.</span><span class="nx">Fact</span> <span class="o">==</span> <span class="kc">false</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;å‘ç°å‡è´§&#34;</span><span class="p">,</span> <span class="nx">goods</span><span class="p">.</span><span class="nx">Kind</span><span class="p">,</span> <span class="s">&#34;, ä¸åº”è¯¥è´­ä¹°ã€‚&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">goods</span><span class="p">.</span><span class="nx">Fact</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//å®‰æ£€æµç¨‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">op</span> <span class="o">*</span><span class="nx">OverseasProxy</span><span class="p">)</span> <span class="nf">check</span><span class="p">(</span><span class="nx">goods</span> <span class="o">*</span><span class="nx">Goods</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;å¯¹[&#34;</span><span class="p">,</span> <span class="nx">goods</span><span class="p">.</span><span class="nx">Kind</span><span class="p">,</span> <span class="s">&#34;] è¿›è¡Œäº†æµ·å…³æ£€æŸ¥ï¼Œ æˆåŠŸçš„å¸¦å›ç¥–å›½&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">g1</span> <span class="o">:=</span> <span class="nx">Goods</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Kind</span><span class="p">:</span> <span class="s">&#34;éŸ©å›½é¢è†œ&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Fact</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">g2</span> <span class="o">:=</span> <span class="nx">Goods</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Kind</span><span class="p">:</span> <span class="s">&#34;CET4è¯ä¹¦&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Fact</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//å¦‚æœä¸ä½¿ç”¨ä»£ç†æ¥å®Œæˆä»éŸ©å›½è´­ä¹°ä»»åŠ¡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="kd">var</span> <span class="nx">shopping</span> <span class="nx">Shopping</span>
</span></span><span class="line"><span class="cl">	<span class="nx">shopping</span> <span class="p">=</span> <span class="nb">new</span><span class="p">(</span><span class="nx">KoreaShopping</span><span class="p">)</span> <span class="c1">//å…·ä½“çš„è´­ä¹°ä¸»é¢˜
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">	<span class="c1">//1-å…ˆéªŒè´§
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="nx">g1</span><span class="p">.</span><span class="nx">Fact</span> <span class="o">==</span> <span class="kc">true</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;å¯¹[&#34;</span><span class="p">,</span> <span class="nx">g1</span><span class="p">.</span><span class="nx">Kind</span><span class="p">,</span> <span class="s">&#34;] è¿›è¡Œäº†è¾¨åˆ«çœŸä¼ª.&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="c1">//2-å»éŸ©å›½è´­ä¹°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nx">shopping</span><span class="p">.</span><span class="nf">Buy</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">g1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="c1">//3-æµ·å…³å®‰æ£€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;å¯¹[&#34;</span><span class="p">,</span> <span class="nx">g1</span><span class="p">.</span><span class="nx">Kind</span><span class="p">,</span> <span class="s">&#34;] è¿›è¡Œäº†æµ·å…³æ£€æŸ¥ï¼Œ æˆåŠŸçš„å¸¦å›ç¥–å›½&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;---------------ä»¥ä¸‹æ˜¯ ä½¿ç”¨ ä»£ç†æ¨¡å¼-------&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">overseasProxy</span> <span class="nx">Shopping</span>
</span></span><span class="line"><span class="cl">	<span class="nx">overseasProxy</span> <span class="p">=</span> <span class="nf">NewProxy</span><span class="p">(</span><span class="nx">shopping</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">overseasProxy</span><span class="p">.</span><span class="nf">Buy</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">g1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">overseasProxy</span><span class="p">.</span><span class="nf">Buy</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">g2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="è£…é¥°æ¨¡å¼" class="headerLink">
    <a href="#%e8%a3%85%e9%a5%b0%e6%a8%a1%e5%bc%8f" class="header-mark"></a>è£…é¥°æ¨¡å¼</h3><p>åŠ¨æ€åœ°ç»™ä¸€ä¸ªå¯¹è±¡å¢åŠ ä¸€äº›é¢å¤–çš„èŒè´£ï¼Œå°±å¢åŠ å¯¹è±¡åŠŸèƒ½æ¥è¯´ï¼Œè£…é¥°æ¨¡å¼æ¯”ç”Ÿæˆå­ç±»å®ç°æ›´ä¸ºçµæ´»ã€‚</p>
<p>æ¯”å¦‚<code>I</code>æ¥å£ä¸­æœ‰<code>Create()</code>æ–¹æ³•ï¼Œå½“<code>A</code>å¯¹è±¡å®ç°äº†<code>I</code>æ¥å£å¹¶è°ƒç”¨äº†<code>Create()</code>ï¼Œä½†æ˜¯ç°åœ¨å¢åŠ ï¼Œåœ¨è°ƒç”¨<code>Create()</code>åæ‰“å°ä¸‹æ—¥å¿—çš„åŠŸèƒ½ï¼Œå°±å¯ä»¥ç”¨è£…é¥°å™¨ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="s">&#34;fmt&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">I</span> <span class="kd">interface</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nf">Create</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">A</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">A</span><span class="p">)</span> <span class="nf">Create</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;A create æ–¹æ³•&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">Decorator</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">i</span> <span class="nx">I</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">d</span> <span class="o">*</span><span class="nx">Decorator</span><span class="p">)</span> <span class="nf">Create</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">d</span><span class="p">.</span><span class="nx">i</span><span class="p">.</span><span class="nf">Create</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// å…¶ä»–çš„äº‹...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;è¿˜èƒ½åšç‚¹å…¶ä»–çš„äº‹,æ¯”å¦‚æ‰“å°æ—¥å¿—...&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">a</span> <span class="nx">I</span>
</span></span><span class="line"><span class="cl">	<span class="nx">a</span> <span class="p">=</span> <span class="nb">new</span><span class="p">(</span><span class="nx">A</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">a</span><span class="p">.</span><span class="nf">Create</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;----- åŠ ä¸Šè£…é¥°å™¨ ----------&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">d</span> <span class="nx">Decorator</span>
</span></span><span class="line"><span class="cl">	<span class="nx">d</span> <span class="p">=</span> <span class="nx">Decorator</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">i</span><span class="p">:</span> <span class="nx">a</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">d</span><span class="p">.</span><span class="nf">Create</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="é€‚é…å™¨æ¨¡å¼" class="headerLink">
    <a href="#%e9%80%82%e9%85%8d%e5%99%a8%e6%a8%a1%e5%bc%8f" class="header-mark"></a>é€‚é…å™¨æ¨¡å¼</h3><p>å°†ä¸€ä¸ªç±»çš„æ¥å£è½¬æ¢æˆå®¢æˆ·å¸Œæœ›çš„å¦å¤–ä¸€ä¸ªæ¥å£ï¼Œä½¿å¾—åŸæœ¬ç”±äºæ¥å£ä¸å…¼å®¹è€Œä¸èƒ½ä¸€èµ·å·¥ä½œçš„é‚£äº›ç±»èƒ½ä¸€èµ·å·¥ä½œã€‚</p>
<p><figure><a class="lightgallery" href="https://cdn.xiaobinqt.cn/xiaobinqt.io/20221115/13065a7685984820925871b451ef59fb.png" title="é€‚é…å™¨æ¨¡å¼" data-thumbnail="https://cdn.xiaobinqt.cn/xiaobinqt.io/20221115/13065a7685984820925871b451ef59fb.png" data-sub-html="<h2>é€‚é…å™¨æ¨¡å¼</h2><p>é€‚é…å™¨æ¨¡å¼</p>">
        
    </a><figcaption class="image-caption">é€‚é…å™¨æ¨¡å¼</figcaption>
    </figure></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;fmt&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">OldInterface</span> <span class="kd">interface</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nf">InsertToDatabase</span><span class="p">(</span><span class="nx">Data</span> <span class="kd">interface</span><span class="p">{})</span> <span class="p">(</span><span class="kt">bool</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">AddCustomInfoToMysql</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">DbName</span> <span class="kt">string</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">pA</span> <span class="o">*</span><span class="nx">AddCustomInfoToMysql</span><span class="p">)</span> <span class="nf">InsertToDatabase</span><span class="p">(</span><span class="nx">info</span> <span class="kd">interface</span><span class="p">{})</span> <span class="p">(</span><span class="kt">bool</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">switch</span> <span class="nx">info</span><span class="p">.(</span><span class="kd">type</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">case</span> <span class="kt">string</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;add &#34;</span><span class="p">,</span> <span class="nx">info</span><span class="p">.(</span><span class="kt">string</span><span class="p">),</span> <span class="s">&#34; to &#34;</span><span class="p">,</span> <span class="nx">pA</span><span class="p">.</span><span class="nx">DbName</span><span class="p">,</span> <span class="s">&#34; successful!&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="kc">true</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">NewInterface</span> <span class="kd">interface</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nf">SaveData</span><span class="p">(</span><span class="nx">Data</span> <span class="kd">interface</span><span class="p">{})</span> <span class="p">(</span><span class="kt">bool</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">Adapter</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">old</span> <span class="nx">OldInterface</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">pA</span> <span class="o">*</span><span class="nx">Adapter</span><span class="p">)</span> <span class="nf">SaveData</span><span class="p">(</span><span class="nx">Data</span> <span class="kd">interface</span><span class="p">{})</span> <span class="p">(</span><span class="kt">bool</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;In Adapter&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">pA</span><span class="p">.</span><span class="nx">old</span><span class="p">.</span><span class="nf">InsertToDatabase</span><span class="p">(</span><span class="nx">Data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">		<span class="nx">iNew</span> <span class="nx">NewInterface</span>
</span></span><span class="line"><span class="cl">	<span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">iNew</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">Adapter</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">old</span><span class="p">:</span> <span class="o">&amp;</span><span class="nx">AddCustomInfoToMysql</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">DbName</span><span class="p">:</span> <span class="s">&#34;mysql&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="p">}}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">iNew</span><span class="p">.</span><span class="nf">SaveData</span><span class="p">(</span><span class="s">&#34;helloworld&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="å¤–è§‚æ¨¡å¼" class="headerLink">
    <a href="#%e5%a4%96%e8%a7%82%e6%a8%a1%e5%bc%8f" class="header-mark"></a>å¤–è§‚æ¨¡å¼</h3><p><figure><a class="lightgallery" href="https://cdn.xiaobinqt.cn/xiaobinqt.io/20221115/30b158d5348440608ab2113f7cdfd881.png" title="å¤–è§‚æ¨¡å¼" data-thumbnail="https://cdn.xiaobinqt.cn/xiaobinqt.io/20221115/30b158d5348440608ab2113f7cdfd881.png" data-sub-html="<h2>å¤–è§‚æ¨¡å¼</h2><p>å¤–è§‚æ¨¡å¼</p>">
        
    </a><figcaption class="image-caption">å¤–è§‚æ¨¡å¼</figcaption>
    </figure></p>
<p><strong><ruby>å¤–è§‚æ¨¡å¼<rt>Facade Pattern</rt></ruby></strong>åˆç§°ä¸º Facade é—¨é¢æ¨¡å¼ã€‚Facade æ¨¡å¼ä¸ºä¸€ç»„å…·æœ‰ç±»ä¼¼åŠŸèƒ½çš„ç±»ç¾¤ï¼Œæ¯”å¦‚ç±»åº“ï¼Œå­ç³»ç»Ÿç­‰ï¼Œæä¾›ä¸€ä¸ªä¸€è‡´çš„ç®€å•çš„ç•Œé¢ï¼Œè¿™ä¸ªä¸€è‡´çš„ç®€å•çš„ç•Œé¢è¢«ç§°ä½œ facadeã€‚</p>
<p>å¤–è§‚æ¨¡å¼å¯¹å®¢æˆ·ç«¯å±è”½äº†å­ç³»ç»Ÿç»„ä»¶ï¼Œå‡å°‘äº†å®¢æˆ·ç«¯æ‰€éœ€å¤„ç†çš„å¯¹è±¡æ•°ç›®ï¼Œå¹¶ä½¿å¾—å­ç³»ç»Ÿä½¿ç”¨èµ·æ¥æ›´åŠ å®¹æ˜“ã€‚é€šè¿‡å¼•å…¥å¤–è§‚æ¨¡å¼ï¼Œå®¢æˆ·ç«¯ä»£ç å°†å˜å¾—å¾ˆç®€å•ï¼Œä¸ä¹‹å…³è”çš„å¯¹è±¡ä¹Ÿå¾ˆå°‘ã€‚</p>
<p>å¤–è§‚æ¨¡å¼å®ç°äº†å­ç³»ç»Ÿä¸å®¢æˆ·ç«¯ä¹‹é—´çš„æ¾è€¦åˆå…³ç³»ï¼Œè¿™ä½¿å¾—å­ç³»ç»Ÿçš„å˜åŒ–ä¸ä¼šå½±å“åˆ°è°ƒç”¨å®ƒçš„å®¢æˆ·ç«¯ï¼Œåªéœ€è¦è°ƒæ•´å¤–è§‚ç±»å³å¯ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="s">&#34;fmt&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//ç”µè§†æœº
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">TV</span> <span class="kd">struct</span><span class="p">{}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">TV</span><span class="p">)</span> <span class="nf">On</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;æ‰“å¼€ ç”µè§†æœº&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">TV</span><span class="p">)</span> <span class="nf">Off</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;å…³é—­ ç”µè§†æœº&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//ç”µè§†æœº
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">VoiceBox</span> <span class="kd">struct</span><span class="p">{}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">v</span> <span class="o">*</span><span class="nx">VoiceBox</span><span class="p">)</span> <span class="nf">On</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;æ‰“å¼€ éŸ³ç®±&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">v</span> <span class="o">*</span><span class="nx">VoiceBox</span><span class="p">)</span> <span class="nf">Off</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;å…³é—­ éŸ³ç®±&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//ç¯å…‰
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">Light</span> <span class="kd">struct</span><span class="p">{}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">l</span> <span class="o">*</span><span class="nx">Light</span><span class="p">)</span> <span class="nf">On</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;æ‰“å¼€ ç¯å…‰&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">l</span> <span class="o">*</span><span class="nx">Light</span><span class="p">)</span> <span class="nf">Off</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;å…³é—­ ç¯å…‰&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//æ¸¸æˆæœº
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">Xbox</span> <span class="kd">struct</span><span class="p">{}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">x</span> <span class="o">*</span><span class="nx">Xbox</span><span class="p">)</span> <span class="nf">On</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;æ‰“å¼€ æ¸¸æˆæœº&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">x</span> <span class="o">*</span><span class="nx">Xbox</span><span class="p">)</span> <span class="nf">Off</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;å…³é—­ æ¸¸æˆæœº&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//éº¦å…‹é£
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">MicroPhone</span> <span class="kd">struct</span><span class="p">{}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">m</span> <span class="o">*</span><span class="nx">MicroPhone</span><span class="p">)</span> <span class="nf">On</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;æ‰“å¼€ éº¦å…‹é£&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">m</span> <span class="o">*</span><span class="nx">MicroPhone</span><span class="p">)</span> <span class="nf">Off</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;å…³é—­ éº¦å…‹é£&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//æŠ•å½±ä»ª
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">Projector</span> <span class="kd">struct</span><span class="p">{}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">p</span> <span class="o">*</span><span class="nx">Projector</span><span class="p">)</span> <span class="nf">On</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;æ‰“å¼€ æŠ•å½±ä»ª&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">p</span> <span class="o">*</span><span class="nx">Projector</span><span class="p">)</span> <span class="nf">Off</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;å…³é—­ æŠ•å½±ä»ª&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//å®¶åº­å½±é™¢(å¤–è§‚)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">HomePlayerFacade</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">tv</span>    <span class="nx">TV</span>
</span></span><span class="line"><span class="cl">	<span class="nx">vb</span>    <span class="nx">VoiceBox</span>
</span></span><span class="line"><span class="cl">	<span class="nx">light</span> <span class="nx">Light</span>
</span></span><span class="line"><span class="cl">	<span class="nx">xbox</span>  <span class="nx">Xbox</span>
</span></span><span class="line"><span class="cl">	<span class="nx">mp</span>    <span class="nx">MicroPhone</span>
</span></span><span class="line"><span class="cl">	<span class="nx">pro</span>   <span class="nx">Projector</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//KTVæ¨¡å¼
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">hp</span> <span class="o">*</span><span class="nx">HomePlayerFacade</span><span class="p">)</span> <span class="nf">DoKTV</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;å®¶åº­å½±é™¢è¿›å…¥KTVæ¨¡å¼&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">hp</span><span class="p">.</span><span class="nx">tv</span><span class="p">.</span><span class="nf">On</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="nx">hp</span><span class="p">.</span><span class="nx">pro</span><span class="p">.</span><span class="nf">On</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="nx">hp</span><span class="p">.</span><span class="nx">mp</span><span class="p">.</span><span class="nf">On</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="nx">hp</span><span class="p">.</span><span class="nx">light</span><span class="p">.</span><span class="nf">Off</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="nx">hp</span><span class="p">.</span><span class="nx">vb</span><span class="p">.</span><span class="nf">On</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//æ¸¸æˆæ¨¡å¼
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">hp</span> <span class="o">*</span><span class="nx">HomePlayerFacade</span><span class="p">)</span> <span class="nf">DoGame</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;å®¶åº­å½±é™¢è¿›å…¥Gameæ¨¡å¼&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">hp</span><span class="p">.</span><span class="nx">tv</span><span class="p">.</span><span class="nf">On</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="nx">hp</span><span class="p">.</span><span class="nx">light</span><span class="p">.</span><span class="nf">On</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="nx">hp</span><span class="p">.</span><span class="nx">xbox</span><span class="p">.</span><span class="nf">On</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">homePlayer</span> <span class="o">:=</span> <span class="nb">new</span><span class="p">(</span><span class="nx">HomePlayerFacade</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">homePlayer</span><span class="p">.</span><span class="nf">DoKTV</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;------------&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">homePlayer</span><span class="p">.</span><span class="nf">DoGame</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="è¡Œä¸ºå‹æ¨¡å¼" class="headerLink">
    <a href="#%e8%a1%8c%e4%b8%ba%e5%9e%8b%e6%a8%a1%e5%bc%8f" class="header-mark"></a>è¡Œä¸ºå‹æ¨¡å¼</h2><h3 id="å‘½ä»¤æ¨¡å¼" class="headerLink">
    <a href="#%e5%91%bd%e4%bb%a4%e6%a8%a1%e5%bc%8f" class="header-mark"></a>å‘½ä»¤æ¨¡å¼</h3><p><figure><a class="lightgallery" href="https://cdn.xiaobinqt.cn/xiaobinqt.io/20221115/665ace353b0342e389a0731982b30a13.png" title="å‘½ä»¤æ¨¡å¼" data-thumbnail="https://cdn.xiaobinqt.cn/xiaobinqt.io/20221115/665ace353b0342e389a0731982b30a13.png" data-sub-html="<h2>å‘½ä»¤æ¨¡å¼</h2><p>å‘½ä»¤æ¨¡å¼</p>">
        
    </a><figcaption class="image-caption">å‘½ä»¤æ¨¡å¼</figcaption>
    </figure></p>
<p>å‘½ä»¤æ¨¡å¼å¯ä»¥å°†è¯·æ±‚å‘é€è€…å’Œæ¥æ”¶è€…å®Œå…¨è§£è€¦ï¼Œå‘é€è€…ä¸æ¥æ”¶è€…ä¹‹é—´æ²¡æœ‰ç›´æ¥å¼•ç”¨å…³ç³»ï¼Œå‘é€è¯·æ±‚çš„å¯¹è±¡åªéœ€è¦çŸ¥é“å¦‚ä½•å‘é€è¯·æ±‚ï¼Œè€Œä¸å¿…çŸ¥é“å¦‚ä½•å®Œæˆè¯·æ±‚ã€‚å‘½ä»¤æ¨¡å¼å¯ä»¥è¿›è¡Œå­˜å‚¨ï¼Œå»¶åæ‰§è¡Œã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="s">&#34;fmt&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">Command</span> <span class="kd">interface</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nf">Execute</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">MoveCommand</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">x</span><span class="p">,</span> <span class="nx">y</span> <span class="kt">int64</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">m</span> <span class="o">*</span><span class="nx">MoveCommand</span><span class="p">)</span> <span class="nf">Execute</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;å‘å³ç§»åŠ¨%dï¼Œå‘ä¸Šç§»åŠ¨%d \n&#34;</span><span class="p">,</span> <span class="nx">m</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="nx">m</span><span class="p">.</span><span class="nx">y</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">AttackCommand</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">skill</span> <span class="kt">string</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">a</span> <span class="o">*</span><span class="nx">AttackCommand</span><span class="p">)</span> <span class="nf">Execute</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;ä½¿ç”¨æŠ€èƒ½%s\n&#34;</span><span class="p">,</span> <span class="nx">a</span><span class="p">.</span><span class="nx">skill</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">AddCommand</span><span class="p">(</span><span class="nx">action</span> <span class="kt">string</span><span class="p">)</span> <span class="nx">Command</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">action</span> <span class="o">==</span> <span class="s">&#34;attack&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="o">&amp;</span><span class="nx">AttackCommand</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">skill</span><span class="p">:</span> <span class="s">&#34;é‡è›®å†²æ’&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="c1">//é»˜è®¤æ˜¯ç§»åŠ¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">return</span> <span class="o">&amp;</span><span class="nx">MoveCommand</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">x</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="nx">y</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">//å°†å‘½ä»¤è®°å½•
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">lc</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="nx">Command</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">lc</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">lc</span><span class="p">,</span> <span class="nf">AddCommand</span><span class="p">(</span><span class="s">&#34;attack&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	<span class="nx">lc</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">lc</span><span class="p">,</span> <span class="nf">AddCommand</span><span class="p">(</span><span class="s">&#34;move&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	<span class="nx">lc</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">lc</span><span class="p">,</span> <span class="nf">AddCommand</span><span class="p">(</span><span class="s">&#34;move&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	<span class="nx">lc</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">lc</span><span class="p">,</span> <span class="nf">AddCommand</span><span class="p">(</span><span class="s">&#34;attack&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//æ‰§è¡Œå‘½ä»¤
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">c</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">lc</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">c</span><span class="p">.</span><span class="nf">Execute</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="è§‚å¯Ÿè€…æ¨¡å¼" class="headerLink">
    <a href="#%e8%a7%82%e5%af%9f%e8%80%85%e6%a8%a1%e5%bc%8f" class="header-mark"></a>è§‚å¯Ÿè€…æ¨¡å¼</h3><p><figure><a class="lightgallery" href="https://cdn.xiaobinqt.cn/xiaobinqt.io/20221116/dd1bb9e2a0b5493384d105cdf70edef7.png" title="è§‚å¯Ÿè€…æ¨¡å¼" data-thumbnail="https://cdn.xiaobinqt.cn/xiaobinqt.io/20221116/dd1bb9e2a0b5493384d105cdf70edef7.png" data-sub-html="<h2>è§‚å¯Ÿè€…æ¨¡å¼</h2><p>è§‚å¯Ÿè€…æ¨¡å¼</p>">
        
    </a><figcaption class="image-caption">è§‚å¯Ÿè€…æ¨¡å¼</figcaption>
    </figure></p>
<p>è§‚å¯Ÿè€…æ¨¡å¼ï¼Œå®ƒå®šä¹‰äº†ä¸€ç§ä¸€å¯¹å¤šçš„å…³ç³»ï¼Œè®©å¤šä¸ªè§‚å¯Ÿè€…å¯¹è±¡åŒæ—¶ç›‘å¬æŸä¸€ä¸ªä¸»é¢˜å¯¹è±¡ï¼Œè¿™ä¸ªä¸»é¢˜å¯¹è±¡çš„çŠ¶æ€å‘ç”Ÿå˜åŒ–æ—¶å°±ä¼šé€šçŸ¥æ‰€æœ‰çš„è§‚å¯Ÿè€…å¯¹è±¡ï¼Œä½¿å¾—å®ƒä»¬èƒ½å¤Ÿè‡ªåŠ¨æ›´æ–°è‡ªå·±ã€‚</p>
<p>è§‚å¯Ÿè€…æ¨¡å¼æ˜¯ç”¨äºå»ºç«‹ä¸€ç§å¯¹è±¡ä¸å¯¹è±¡ä¹‹é—´çš„ä¾èµ–å…³ç³»ï¼Œä¸€ä¸ªå¯¹è±¡å‘ç”Ÿæ”¹å˜æ—¶å°†è‡ªåŠ¨é€šçŸ¥å…¶ä»–å¯¹è±¡ï¼Œå…¶ä»–å¯¹è±¡å°†ç›¸åº”ä½œå‡ºååº”ã€‚åœ¨è§‚å¯Ÿè€…æ¨¡å¼ä¸­ï¼Œå‘ç”Ÿæ”¹å˜çš„å¯¹è±¡ç§°ä¸ºè§‚å¯Ÿç›®æ ‡ï¼Œè€Œè¢«é€šçŸ¥çš„å¯¹è±¡ç§°ä¸ºè§‚å¯Ÿè€…ï¼Œä¸€ä¸ªè§‚å¯Ÿç›®æ ‡å¯ä»¥å¯¹åº”å¤šä¸ªè§‚å¯Ÿè€…ï¼Œè€Œä¸”è¿™äº›è§‚å¯Ÿè€…ä¹‹é—´å¯ä»¥æ²¡æœ‰ä»»ä½•ç›¸äº’è”ç³»ï¼Œå¯ä»¥æ ¹æ®éœ€è¦å¢åŠ å’Œåˆ é™¤è§‚å¯Ÿè€…ï¼Œä½¿å¾—ç³»ç»Ÿæ›´æ˜“äºæ‰©å±•ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="s">&#34;fmt&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//--------- æŠ½è±¡å±‚ --------
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="c1">// Observer è§‚å¯Ÿè€…
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">Observer</span> <span class="kd">interface</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nf">OnTeacherComming</span><span class="p">()</span> <span class="c1">// è§‚å¯Ÿè€…å¾—åˆ°é€šçŸ¥åè¦è§¦å‘çš„åŠ¨ä½œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// è¢«è§‚å¯Ÿè€…
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">Notifier</span> <span class="kd">interface</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nf">AddObserver</span><span class="p">(</span><span class="nx">observer</span> <span class="nx">Observer</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nf">RemoveObserver</span><span class="p">(</span><span class="nx">observer</span> <span class="nx">Observer</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nf">Notify</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//--------- å®ç°å±‚ --------
</span></span></span><span class="line"><span class="cl"><span class="c1">//è§‚å¯Ÿè€…å­¦ç”Ÿ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">StuZhang3</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">Badthing</span> <span class="kt">string</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">StuZhang3</span><span class="p">)</span> <span class="nf">OnTeacherComming</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;å¼ 3 åœæ­¢ &#34;</span><span class="p">,</span> <span class="nx">s</span><span class="p">.</span><span class="nx">Badthing</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">StuZhang3</span><span class="p">)</span> <span class="nf">DoBadthing</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;å¼ 3 æ­£åœ¨&#34;</span><span class="p">,</span> <span class="nx">s</span><span class="p">.</span><span class="nx">Badthing</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">StuZhao4</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">Badthing</span> <span class="kt">string</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">StuZhao4</span><span class="p">)</span> <span class="nf">OnTeacherComming</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;èµµ4 åœæ­¢ &#34;</span><span class="p">,</span> <span class="nx">s</span><span class="p">.</span><span class="nx">Badthing</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">StuZhao4</span><span class="p">)</span> <span class="nf">DoBadthing</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;èµµ4 æ­£åœ¨&#34;</span><span class="p">,</span> <span class="nx">s</span><span class="p">.</span><span class="nx">Badthing</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">StuWang5</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">Badthing</span> <span class="kt">string</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">StuWang5</span><span class="p">)</span> <span class="nf">OnTeacherComming</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;ç‹5 åœæ­¢ &#34;</span><span class="p">,</span> <span class="nx">s</span><span class="p">.</span><span class="nx">Badthing</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">StuWang5</span><span class="p">)</span> <span class="nf">DoBadthing</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;ç‹5 æ­£åœ¨&#34;</span><span class="p">,</span> <span class="nx">s</span><span class="p">.</span><span class="nx">Badthing</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// å…·ä½“çš„è¢«è§‚å¯Ÿè€…ç­é•¿
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">ClassMonitor</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">ObserverList</span> <span class="p">[]</span><span class="nx">Observer</span> <span class="c1">//éœ€è¦é€šçŸ¥çš„å…¨éƒ¨è§‚å¯Ÿè€…é›†åˆ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">m</span> <span class="o">*</span><span class="nx">ClassMonitor</span><span class="p">)</span> <span class="nf">AddObserver</span><span class="p">(</span><span class="nx">observer</span> <span class="nx">Observer</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">m</span><span class="p">.</span><span class="nx">ObserverList</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">m</span><span class="p">.</span><span class="nx">ObserverList</span><span class="p">,</span> <span class="nx">observer</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">m</span> <span class="o">*</span><span class="nx">ClassMonitor</span><span class="p">)</span> <span class="nf">RemoveObserver</span><span class="p">(</span><span class="nx">observer</span> <span class="nx">Observer</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="nx">index</span><span class="p">,</span> <span class="nx">l</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">m</span><span class="p">.</span><span class="nx">ObserverList</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="c1">//æ‰¾åˆ°è¦åˆ é™¤çš„å…ƒç´ ä½ç½®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">if</span> <span class="nx">observer</span> <span class="o">==</span> <span class="nx">l</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="c1">//å°†åˆ é™¤çš„ç‚¹å‰åçš„å…ƒç´ é“¾æ¥èµ·æ¥
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="nx">m</span><span class="p">.</span><span class="nx">ObserverList</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">m</span><span class="p">.</span><span class="nx">ObserverList</span><span class="p">[:</span><span class="nx">index</span><span class="p">],</span> <span class="nx">m</span><span class="p">.</span><span class="nx">ObserverList</span><span class="p">[</span><span class="nx">index</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span><span class="o">...</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="k">break</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">m</span> <span class="o">*</span><span class="nx">ClassMonitor</span><span class="p">)</span> <span class="nf">Notify</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">observer</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">m</span><span class="p">.</span><span class="nx">ObserverList</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="c1">//ä¾æ¬¡è°ƒç”¨å…¨éƒ¨è§‚å¯Ÿçš„å…·ä½“åŠ¨ä½œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nx">observer</span><span class="p">.</span><span class="nf">OnTeacherComming</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">s1</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">StuZhang3</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Badthing</span><span class="p">:</span> <span class="s">&#34;æŠ„ä½œä¸š&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">s2</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">StuZhao4</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Badthing</span><span class="p">:</span> <span class="s">&#34;ç©ç‹è€…è£è€€&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">s3</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">StuWang5</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Badthing</span><span class="p">:</span> <span class="s">&#34;çœ‹èµµå››ç©ç‹è€…è£è€€&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">classMonitor</span> <span class="o">:=</span> <span class="nb">new</span><span class="p">(</span><span class="nx">ClassMonitor</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;ä¸Šè¯¾äº†ï¼Œä½†æ˜¯è€å¸ˆæ²¡æœ‰æ¥ï¼Œå­¦ç”Ÿä»¬éƒ½åœ¨å¿™è‡ªå·±çš„äº‹...&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">s1</span><span class="p">.</span><span class="nf">DoBadthing</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="nx">s2</span><span class="p">.</span><span class="nf">DoBadthing</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="nx">s3</span><span class="p">.</span><span class="nf">DoBadthing</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">classMonitor</span><span class="p">.</span><span class="nf">AddObserver</span><span class="p">(</span><span class="nx">s1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">classMonitor</span><span class="p">.</span><span class="nf">AddObserver</span><span class="p">(</span><span class="nx">s2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">classMonitor</span><span class="p">.</span><span class="nf">AddObserver</span><span class="p">(</span><span class="nx">s3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;è¿™æ—¶å€™è€å¸ˆæ¥äº†ï¼Œç­é•¿ç»™å­¦ä»€ä¹ˆä½¿äº†ä¸€ä¸ªçœ¼ç¥...&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">classMonitor</span><span class="p">.</span><span class="nf">Notify</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="ç­–ç•¥æ¨¡å¼" class="headerLink">
    <a href="#%e7%ad%96%e7%95%a5%e6%a8%a1%e5%bc%8f" class="header-mark"></a>ç­–ç•¥æ¨¡å¼</h3><p><figure><a class="lightgallery" href="https://cdn.xiaobinqt.cn/xiaobinqt.io/20221115/ff2c7e6ad034452e883aea57026237f1.png" title="å‡ºè¡Œç­–ç•¥" data-thumbnail="https://cdn.xiaobinqt.cn/xiaobinqt.io/20221115/ff2c7e6ad034452e883aea57026237f1.png" data-sub-html="<h2>å‡ºè¡Œç­–ç•¥</h2><p>å‡ºè¡Œç­–ç•¥</p>">
        
    </a><figcaption class="image-caption">å‡ºè¡Œç­–ç•¥</figcaption>
    </figure></p>
<p><strong><ruby>ç­–ç•¥æ¨¡å¼<rt>Strategy Pattern</rt></ruby></strong>ï¼šå®šä¹‰ä¸€ç³»åˆ—ç®—æ³•ï¼Œå°†æ¯ä¸€ä¸ªç®—æ³•å°è£…èµ·æ¥ï¼Œå¹¶è®©å®ƒä»¬å¯ä»¥ç›¸äº’æ›¿æ¢ã€‚ç­–ç•¥æ¨¡å¼è®©ç®—æ³•ç‹¬ç«‹äºä½¿ç”¨å®ƒçš„å®¢æˆ·è€Œå˜åŒ–ï¼Œä¹Ÿç§°ä¸ºæ”¿ç­–æ¨¡å¼(Policy)ã€‚</p>
<blockquote>
<p>å•†åœºä¿ƒé”€æœ‰ç­–ç•¥ Aï¼ˆ0.8æŠ˜ï¼‰ç­–ç•¥ Bï¼ˆæ¶ˆè´¹æ»¡200ï¼Œè¿”ç°100ï¼‰ï¼Œç”¨ç­–ç•¥æ¨¡å¼æ¨¡æ‹Ÿåœºæ™¯</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="s">&#34;fmt&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//é”€å”®ç­–ç•¥
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">SellStrategy</span> <span class="kd">interface</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">//æ ¹æ®åŸä»·å¾—åˆ°å”®å–ä»·
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">GetPrice</span><span class="p">(</span><span class="nx">price</span> <span class="kt">float64</span><span class="p">)</span> <span class="kt">float64</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">StrategyA</span> <span class="kd">struct</span><span class="p">{}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">sa</span> <span class="o">*</span><span class="nx">StrategyA</span><span class="p">)</span> <span class="nf">GetPrice</span><span class="p">(</span><span class="nx">price</span> <span class="kt">float64</span><span class="p">)</span> <span class="kt">float64</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;æ‰§è¡Œç­–ç•¥A, æ‰€æœ‰å•†å“æ‰“å…«æŠ˜&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">price</span> <span class="o">*</span> <span class="mf">0.8</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">StrategyB</span> <span class="kd">struct</span><span class="p">{}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">sb</span> <span class="o">*</span><span class="nx">StrategyB</span><span class="p">)</span> <span class="nf">GetPrice</span><span class="p">(</span><span class="nx">price</span> <span class="kt">float64</span><span class="p">)</span> <span class="kt">float64</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;æ‰§è¡Œç­–ç•¥B, æ‰€æœ‰å•†å“æ»¡200 å‡100&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">price</span> <span class="o">&gt;=</span> <span class="mi">200</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">price</span> <span class="o">-=</span> <span class="mi">100</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">price</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//ç¯å¢ƒç±»
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">Goods</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">Price</span>    <span class="kt">float64</span>
</span></span><span class="line"><span class="cl">	<span class="nx">Strategy</span> <span class="nx">SellStrategy</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">g</span> <span class="o">*</span><span class="nx">Goods</span><span class="p">)</span> <span class="nf">SetStrategy</span><span class="p">(</span><span class="nx">s</span> <span class="nx">SellStrategy</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">g</span><span class="p">.</span><span class="nx">Strategy</span> <span class="p">=</span> <span class="nx">s</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">g</span> <span class="o">*</span><span class="nx">Goods</span><span class="p">)</span> <span class="nf">SellPrice</span><span class="p">()</span> <span class="kt">float64</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;åŸä»·å€¼ &#34;</span><span class="p">,</span> <span class="nx">g</span><span class="p">.</span><span class="nx">Price</span><span class="p">,</span> <span class="s">&#34; .&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">g</span><span class="p">.</span><span class="nx">Strategy</span><span class="p">.</span><span class="nf">GetPrice</span><span class="p">(</span><span class="nx">g</span><span class="p">.</span><span class="nx">Price</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">nike</span> <span class="o">:=</span> <span class="nx">Goods</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Price</span><span class="p">:</span> <span class="mf">200.0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="c1">//ä¸Šåˆ ï¼Œå•†åœºæ‰§è¡Œç­–ç•¥A
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">nike</span><span class="p">.</span><span class="nf">SetStrategy</span><span class="p">(</span><span class="nb">new</span><span class="p">(</span><span class="nx">StrategyA</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;ä¸Šåˆnikeé‹å–&#34;</span><span class="p">,</span> <span class="nx">nike</span><span class="p">.</span><span class="nf">SellPrice</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//ä¸‹åˆï¼Œ å•†åœºæ‰§è¡Œç­–ç•¥B
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">nike</span><span class="p">.</span><span class="nf">SetStrategy</span><span class="p">(</span><span class="nb">new</span><span class="p">(</span><span class="nx">StrategyB</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;ä¸‹åˆnikeé‹å–&#34;</span><span class="p">,</span> <span class="nx">nike</span><span class="p">.</span><span class="nf">SellPrice</span><span class="p">())</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="æ¨¡æ¿æ–¹å¼æ¨¡å¼" class="headerLink">
    <a href="#%e6%a8%a1%e6%9d%bf%e6%96%b9%e5%bc%8f%e6%a8%a1%e5%bc%8f" class="header-mark"></a>æ¨¡æ¿æ–¹å¼æ¨¡å¼</h3><p><figure><a class="lightgallery" href="https://cdn.xiaobinqt.cn/xiaobinqt.io/20221117/6b1e4e2ab0a34a4ba196f4d74f47bbc6.png" title="æ¨¡æ¿æ–¹æ³•æ¨¡å¼" data-thumbnail="https://cdn.xiaobinqt.cn/xiaobinqt.io/20221117/6b1e4e2ab0a34a4ba196f4d74f47bbc6.png" data-sub-html="<h2>æ¨¡æ¿æ–¹æ³•æ¨¡å¼</h2><p>æ¨¡æ¿æ–¹æ³•æ¨¡å¼</p>">
        
    </a><figcaption class="image-caption">æ¨¡æ¿æ–¹æ³•æ¨¡å¼</figcaption>
    </figure></p>
<p>æ¨¡æ¿æ–¹æ³•æ¨¡å¼ç”±æŠ½è±¡çˆ¶ç±»å’Œå…·ä½“çš„å®ç°å­ç±»æ„æˆã€‚é€šå¸¸åœ¨æŠ½è±¡çˆ¶ç±»ä¸­å°è£…äº†å­ç±»çš„ç®—æ³•æ¡†æ¶ï¼Œä¹ŸåŒ…æ‹¬å®ç°ä¸€äº›å…¬å…±æ–¹æ³•ä»¥åŠå°è£…å­ç±»ä¸­æ‰€æœ‰æ–¹æ³•çš„æ‰§è¡Œé¡ºåºã€‚å­ç±»é€šè¿‡ç»§æ‰¿è¿™ä¸ªæŠ½è±¡ç±»ï¼Œä¹Ÿç»§æ‰¿äº†æ•´ä¸ªç®—æ³•ç»“æ„ï¼Œå¹¶ä¸”å¯ä»¥é€‰æ‹©é‡å†™çˆ¶ç±»çš„æ–¹æ³•ã€‚</p>
<p>æ¨¡æ¿æ–¹æ³•æ¨¡å¼å»ºè®®å°†ç®—æ³•åˆ†è§£ä¸ºä¸€ç³»åˆ—æ­¥éª¤ï¼Œç„¶åå°†è¿™äº›æ­¥éª¤æ”¹å†™ä¸ºæ–¹æ³•ï¼Œæœ€ååœ¨â€œæ¨¡æ¿æ–¹æ³•â€ä¸­ä¾æ¬¡è°ƒç”¨è¿™äº›æ–¹æ³•ã€‚æ­¥éª¤å¯ä»¥æ˜¯æŠ½è±¡çš„ï¼Œä¹Ÿå¯ä»¥æœ‰ä¸€äº›é»˜è®¤çš„å®ç°ã€‚ä¸ºäº†èƒ½å¤Ÿä½¿ç”¨ç®—æ³•ï¼Œ å®¢æˆ·ç«¯éœ€è¦è‡ªè¡Œæä¾›å­ç±»å¹¶å®ç°æ‰€æœ‰çš„æŠ½è±¡æ­¥éª¤ã€‚å¦‚æœæœ‰å¿…è¦è¿˜éœ€é‡å†™ä¸€äº›æ­¥éª¤ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="s">&#34;fmt&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//æŠ½è±¡ç±»ï¼Œåˆ¶ä½œé¥®æ–™,åŒ…è£¹ä¸€ä¸ªæ¨¡æ¿çš„å…¨éƒ¨å®ç°æ­¥éª¤
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">Beverage</span> <span class="kd">interface</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nf">BoilWater</span><span class="p">()</span> <span class="c1">//ç…®å¼€æ°´
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">Brew</span><span class="p">()</span>      <span class="c1">//å†²æ³¡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">PourInCup</span><span class="p">()</span> <span class="c1">//å€’å…¥æ¯ä¸­
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">AddThings</span><span class="p">()</span> <span class="c1">//æ·»åŠ é…Œæ–™
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">	<span class="nf">WantAddThings</span><span class="p">()</span> <span class="kt">bool</span> <span class="c1">//æ˜¯å¦åŠ å…¥é…Œæ–™Hook
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//å°è£…ä¸€å¥—æµç¨‹æ¨¡æ¿ï¼Œè®©å…·ä½“çš„åˆ¶ä½œæµç¨‹ç»§æ‰¿ä¸”å®ç°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">template</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">b</span> <span class="nx">Beverage</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//å°è£…çš„å›ºå®šæ¨¡æ¿
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">template</span><span class="p">)</span> <span class="nf">MakeBeverage</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">t</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">t</span><span class="p">.</span><span class="nx">b</span><span class="p">.</span><span class="nf">BoilWater</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="nx">t</span><span class="p">.</span><span class="nx">b</span><span class="p">.</span><span class="nf">Brew</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="nx">t</span><span class="p">.</span><span class="nx">b</span><span class="p">.</span><span class="nf">PourInCup</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//å­ç±»å¯ä»¥é‡å†™è¯¥æ–¹æ³•æ¥å†³å®šæ˜¯å¦æ‰§è¡Œä¸‹é¢åŠ¨ä½œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="nx">t</span><span class="p">.</span><span class="nx">b</span><span class="p">.</span><span class="nf">WantAddThings</span><span class="p">()</span> <span class="o">==</span> <span class="kc">true</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">t</span><span class="p">.</span><span class="nx">b</span><span class="p">.</span><span class="nf">AddThings</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//å…·ä½“çš„æ¨¡æ¿å­ç±» åˆ¶ä½œå’–å•¡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">MakeCaffee</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">template</span> <span class="c1">//ç»§æ‰¿æ¨¡æ¿
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">NewMakeCaffee</span><span class="p">()</span> <span class="o">*</span><span class="nx">MakeCaffee</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">makeCaffe</span> <span class="o">:=</span> <span class="nb">new</span><span class="p">(</span><span class="nx">MakeCaffee</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="c1">//b ä¸ºBeverageï¼Œæ˜¯MakeCaffeeçš„æ¥å£ï¼Œè¿™é‡Œéœ€è¦ç»™æ¥å£èµ‹å€¼ï¼ŒæŒ‡å‘å…·ä½“çš„å­ç±»å¯¹è±¡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">//æ¥è§¦å‘bå…¨éƒ¨æ¥å£æ–¹æ³•çš„å¤šæ€ç‰¹æ€§ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">makeCaffe</span><span class="p">.</span><span class="nx">b</span> <span class="p">=</span> <span class="nx">makeCaffe</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">makeCaffe</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">mc</span> <span class="o">*</span><span class="nx">MakeCaffee</span><span class="p">)</span> <span class="nf">BoilWater</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;å°†æ°´ç…®åˆ°100æ‘„æ°åº¦&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">mc</span> <span class="o">*</span><span class="nx">MakeCaffee</span><span class="p">)</span> <span class="nf">Brew</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;ç”¨æ°´å†²å’–å•¡è±†&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">mc</span> <span class="o">*</span><span class="nx">MakeCaffee</span><span class="p">)</span> <span class="nf">PourInCup</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;å°†å……å¥½çš„å’–å•¡å€’å…¥é™¶ç“·æ¯ä¸­&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">mc</span> <span class="o">*</span><span class="nx">MakeCaffee</span><span class="p">)</span> <span class="nf">AddThings</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;æ·»åŠ ç‰›å¥¶å’Œç³–&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">mc</span> <span class="o">*</span><span class="nx">MakeCaffee</span><span class="p">)</span> <span class="nf">WantAddThings</span><span class="p">()</span> <span class="kt">bool</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="kc">true</span> <span class="c1">//å¯åŠ¨Hookæ¡ä»¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//å…·ä½“çš„æ¨¡æ¿å­ç±» åˆ¶ä½œèŒ¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">MakeTea</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">template</span> <span class="c1">//ç»§æ‰¿æ¨¡æ¿
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">NewMakeTea</span><span class="p">()</span> <span class="o">*</span><span class="nx">MakeTea</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">makeTea</span> <span class="o">:=</span> <span class="nb">new</span><span class="p">(</span><span class="nx">MakeTea</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="c1">//b ä¸ºBeverageï¼Œæ˜¯MakeTeaï¼Œè¿™é‡Œéœ€è¦ç»™æ¥å£èµ‹å€¼ï¼ŒæŒ‡å‘å…·ä½“çš„å­ç±»å¯¹è±¡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">//æ¥è§¦å‘bå…¨éƒ¨æ¥å£æ–¹æ³•çš„å¤šæ€ç‰¹æ€§ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">makeTea</span><span class="p">.</span><span class="nx">b</span> <span class="p">=</span> <span class="nx">makeTea</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">makeTea</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">mt</span> <span class="o">*</span><span class="nx">MakeTea</span><span class="p">)</span> <span class="nf">BoilWater</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;å°†æ°´ç…®åˆ°80æ‘„æ°åº¦&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">mt</span> <span class="o">*</span><span class="nx">MakeTea</span><span class="p">)</span> <span class="nf">Brew</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;ç”¨æ°´å†²èŒ¶å¶&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">mt</span> <span class="o">*</span><span class="nx">MakeTea</span><span class="p">)</span> <span class="nf">PourInCup</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;å°†å……å¥½çš„å’–å•¡å€’å…¥èŒ¶å£¶ä¸­&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">mt</span> <span class="o">*</span><span class="nx">MakeTea</span><span class="p">)</span> <span class="nf">AddThings</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;æ·»åŠ æŸ æª¬&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">mt</span> <span class="o">*</span><span class="nx">MakeTea</span><span class="p">)</span> <span class="nf">WantAddThings</span><span class="p">()</span> <span class="kt">bool</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="kc">false</span> <span class="c1">//å…³é—­Hookæ¡ä»¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">//1. åˆ¶ä½œä¸€æ¯å’–å•¡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">makeCoffee</span> <span class="o">:=</span> <span class="nf">NewMakeCaffee</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="nx">makeCoffee</span><span class="p">.</span><span class="nf">MakeBeverage</span><span class="p">()</span> <span class="c1">//è°ƒç”¨å›ºå®šæ¨¡æ¿æ–¹æ³•
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;------------&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//2. åˆ¶ä½œèŒ¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">makeTea</span> <span class="o">:=</span> <span class="nf">NewMakeTea</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="nx">makeTea</span><span class="p">.</span><span class="nf">MakeBeverage</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="faq" class="headerLink">
    <a href="#faq" class="header-mark"></a>FAQ</h2><ul>
<li><strong>è£…é¥°æ¨¡å¼å’Œä»£ç†æ¨¡å¼æœ‰ä½•ä¸åŒâ“</strong></li>
</ul>
<p>ä»£ç†æ¨¡å¼æ³¨é‡å¯¹å¯¹è±¡æŸä¸€åŠŸèƒ½çš„æµç¨‹æŠŠæ§å’Œè¾…åŠ©ã€‚å®ƒå¯ä»¥<strong>æ§åˆ¶å¯¹è±¡åšæŸäº›äº‹</strong>ï¼Œé‡å¿ƒæ˜¯ä¸ºäº†å€Ÿç”¨å¯¹è±¡çš„åŠŸèƒ½å®ŒæˆæŸä¸€æµç¨‹ï¼Œè€Œéå¯¹è±¡åŠŸèƒ½å¦‚ä½•ã€‚</p>
<p>è£…é¥°æ¨¡å¼æ³¨é‡å¯¹<strong>å¯¹è±¡åŠŸèƒ½çš„æ‰©å±•</strong>ï¼Œå®ƒä¸å…³å¿ƒå¤–ç•Œå¦‚ä½•è°ƒç”¨ï¼Œåªæ³¨é‡å¯¹å¯¹è±¡åŠŸèƒ½çš„åŠ å¼ºï¼Œè£…é¥°åè¿˜æ˜¯å¯¹è±¡æœ¬èº«ã€‚</p>
<h2 id="å‚è€ƒ" class="headerLink">
    <a href="#%e5%8f%82%e8%80%83" class="header-mark"></a>å‚è€ƒ</h2><ul>
<li><a href="https://www.yuque.com/aceld/lfhu8y" target="_blank" rel="noopener noreferrer">Easy æå®š Golangè®¾è®¡æ¨¡å¼</a></li>
<li><a href="http://www.zjwave.com/article/49.html" target="_blank" rel="noopener noreferrer">è®¾è®¡æ¨¡å¼-é€‚é…å™¨æ¨¡å¼ä¸å¤–è§‚æ¨¡å¼</a></li>
<li><a href="https://refactoringguru.cn/design-patterns" target="_blank" rel="noopener noreferrer">è®¾è®¡æ¨¡å¼-refactoringguru.cn/design-patterns</a></li>
<li><a href="https://segmentfault.com/a/1190000030850326" target="_blank" rel="noopener noreferrer">å›¾è§£ä¹ç§å¸¸è§çš„è®¾è®¡æ¨¡å¼</a></li>
<li><a href="https://design-patterns.readthedocs.io/zh_CN/latest/index.html" target="_blank" rel="noopener noreferrer">å›¾è¯´è®¾è®¡æ¨¡å¼</a></li>
<li><a href="https://www.bilibili.com/video/BV1Eg411m7rV" target="_blank" rel="noopener noreferrer">Easyæå®šGolangè®¾è®¡æ¨¡å¼</a></li>
</ul>
]]></description>
</item><item>
    <title>go å‡½æ•°å¼é€‰é¡¹æ¨¡å¼</title>
    <link>https://www.xiaobinqt.cn/functional-options-pattern/</link>
    <pubDate>Mon, 23 Aug 2021 00:00:00 &#43;0000</pubDate><author>
        <name>xiaobinqt</name>
    </author><guid>https://www.xiaobinqt.cn/functional-options-pattern/</guid>
    <description><![CDATA[<p>Go è¯­è¨€æ²¡æœ‰æ„é€ å‡½æ•°ï¼Œä¸€èˆ¬é€šè¿‡å®šä¹‰ New å‡½æ•°æ¥å……å½“æ„é€ å‡½æ•°ã€‚ä½†æ˜¯ï¼Œå¦‚æœç»“æ„æœ‰è¾ƒå¤šå­—æ®µï¼Œè¦åˆå§‹åŒ–è¿™äº›å­—æ®µï¼Œå°±æœ‰å¾ˆå¤šç§æ–¹å¼ï¼Œæœ‰ä¸€ç§æ–¹å¼è¢«è®¤ä¸ºæ˜¯æœ€ä¼˜é›…çš„ï¼Œå°±æ˜¯å‡½æ•°å¼é€‰é¡¹æ¨¡å¼ï¼ˆFunctional Options Patternï¼‰ã€‚</p>
<blockquote>
<p>å‡½æ•°å¼é€‰é¡¹æ¨¡å¼ç”¨äºæ„é€ å‡½æ•°å’Œå…¶ä»–å…¬å…± API ä¸­çš„<strong>å¯é€‰å‚æ•°</strong>ï¼Œä½ é¢„è®¡è¿™äº›å‚æ•°éœ€è¦æ‰©å±•ï¼Œå°¤å…¶æ˜¯åœ¨è¿™äº›å‡½æ•°ä¸Šå·²ç»æœ‰ä¸‰ä¸ªæˆ–æ›´å¤šå‚æ•°çš„æƒ…å†µä¸‹ã€‚</p>
</blockquote>
<h2 id="å¸¸è§„æ–¹å¼" class="headerLink">
    <a href="#%e5%b8%b8%e8%a7%84%e6%96%b9%e5%bc%8f" class="header-mark"></a>å¸¸è§„æ–¹å¼</h2><p>æˆ‘ä»¬æœ‰å¦‚ä¸‹ç»“æ„ä½“ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">type Server struct {
</span></span><span class="line"><span class="cl">	host    string        // å¿…å¡«
</span></span><span class="line"><span class="cl">	port    int           // å¿…å¡«
</span></span><span class="line"><span class="cl">	timeout time.Duration // å¯é€‰
</span></span><span class="line"><span class="cl">	maxConn int           // å¯é€‰
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>host</code> å’Œ <code>port</code> å­—æ®µæ˜¯å¿…é¡»çš„ï¼Œ<code>timeout</code> å’Œ <code>maxConn</code> å­—æ®µæ˜¯å¯é€‰çš„ã€‚</p>
<p>ä¹‹å‰æˆ‘çš„åšæ³•æ˜¯è¿™æ ·å¤„ç†çš„ï¼Œå®šä¹‰ä¸€ä¸ª New å‡½æ•°ï¼Œåˆå§‹åŒ–å¿…å¡«å­—æ®µï¼Œå¯¹æ¯ä¸ªå¯é€‰å­—æ®µéƒ½å®šä¹‰äº†ä¸€ä¸ª SetXXX å‡½æ•°ï¼Œå¦‚ä¸‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="s">&#34;time&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">Server</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">host</span>    <span class="kt">string</span>        <span class="c1">// å¿…å¡«
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">port</span>    <span class="kt">int</span>           <span class="c1">// å¿…å¡«
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">timeout</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Duration</span> <span class="c1">// å¯é€‰
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">maxConn</span> <span class="kt">int</span>           <span class="c1">// å¯é€‰
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">New</span><span class="p">(</span><span class="nx">host</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">port</span> <span class="kt">int</span><span class="p">)</span> <span class="o">*</span><span class="nx">Server</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="o">&amp;</span><span class="nx">Server</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">host</span><span class="p">:</span>    <span class="nx">host</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">port</span><span class="p">:</span>    <span class="nx">port</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">timeout</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">maxConn</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">Server</span><span class="p">)</span> <span class="nf">SetTimeout</span><span class="p">(</span><span class="nx">timeout</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Duration</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">s</span><span class="p">.</span><span class="nx">timeout</span> <span class="p">=</span> <span class="nx">timeout</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">Server</span><span class="p">)</span> <span class="nf">SetMaxConn</span><span class="p">(</span><span class="nx">maxConn</span> <span class="kt">int</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">s</span><span class="p">.</span><span class="nx">maxConn</span> <span class="p">=</span> <span class="nx">maxConn</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä¸ªäººè§‰å¾—è¿™ç§æ–¹å¼å…¶å®å·²ç»å¾ˆä¼˜é›…äº†ï¼Œä¸€èˆ¬æƒ…å†µä¸‹ä¹Ÿæ˜¯å¤Ÿç”¨çš„ã€‚</p>
<h2 id="functional-option-pattern" class="headerLink">
    <a href="#functional-option-pattern" class="header-mark"></a>Functional Option Pattern</h2><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;log&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;time&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">Server</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">host</span>    <span class="kt">string</span>        <span class="c1">// å¿…å¡«
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">port</span>    <span class="kt">int</span>           <span class="c1">// å¿…å¡«
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">timeout</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Duration</span> <span class="c1">// å¯é€‰
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">maxConn</span> <span class="kt">int</span>           <span class="c1">// å¯é€‰
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">Option</span> <span class="kd">func</span><span class="p">(</span><span class="o">*</span><span class="nx">Server</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">New</span><span class="p">(</span><span class="nx">options</span> <span class="o">...</span><span class="nx">Option</span><span class="p">)</span> <span class="o">*</span><span class="nx">Server</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">svr</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">Server</span><span class="p">{}</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">f</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">options</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nf">f</span><span class="p">(</span><span class="nx">svr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">svr</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">WithHost</span><span class="p">(</span><span class="nx">host</span> <span class="kt">string</span><span class="p">)</span> <span class="nx">Option</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="kd">func</span><span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">Server</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">s</span><span class="p">.</span><span class="nx">host</span> <span class="p">=</span> <span class="nx">host</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">WithPort</span><span class="p">(</span><span class="nx">port</span> <span class="kt">int</span><span class="p">)</span> <span class="nx">Option</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="kd">func</span><span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">Server</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">s</span><span class="p">.</span><span class="nx">port</span> <span class="p">=</span> <span class="nx">port</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">WithTimeout</span><span class="p">(</span><span class="nx">timeout</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Duration</span><span class="p">)</span> <span class="nx">Option</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="kd">func</span><span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">Server</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">s</span><span class="p">.</span><span class="nx">timeout</span> <span class="p">=</span> <span class="nx">timeout</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">WithMaxConn</span><span class="p">(</span><span class="nx">maxConn</span> <span class="kt">int</span><span class="p">)</span> <span class="nx">Option</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="kd">func</span><span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">Server</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">s</span><span class="p">.</span><span class="nx">maxConn</span> <span class="p">=</span> <span class="nx">maxConn</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">Server</span><span class="p">)</span> <span class="nf">Run</span><span class="p">()</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">svr</span> <span class="o">:=</span> <span class="nf">New</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">		<span class="nf">WithHost</span><span class="p">(</span><span class="s">&#34;localhost&#34;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">		<span class="nf">WithPort</span><span class="p">(</span><span class="mi">8080</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">		<span class="nf">WithTimeout</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nx">Minute</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">		<span class="nf">WithMaxConn</span><span class="p">(</span><span class="mi">120</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">	<span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">svr</span><span class="p">.</span><span class="nf">Run</span><span class="p">();</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">log</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>åœ¨è¿™ä¸ªæ¨¡å¼ä¸­ï¼Œæˆ‘ä»¬å®šä¹‰ä¸€ä¸ª Option å‡½æ•°ç±»å‹ï¼Œå®ƒæ¥æ”¶ä¸€ä¸ªå‚æ•°ï¼š*Serverã€‚ç„¶åï¼ŒServer çš„æ„é€ å‡½æ•°æ¥æ”¶ä¸€ä¸ª Option ç±»å‹çš„ä¸å®šå‚æ•°ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">func New(options ...Option) *Server {
</span></span><span class="line"><span class="cl">	svr := &amp;Server{}
</span></span><span class="line"><span class="cl">	for _, f := range options {
</span></span><span class="line"><span class="cl">		f(svr)
</span></span><span class="line"><span class="cl">	}
</span></span><span class="line"><span class="cl">	return svr
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div><p>é€‰é¡¹çš„å®šä¹‰éœ€è¦å®šä¹‰ä¸€ç³»åˆ—ç›¸å…³è¿”å› Option çš„å‡½æ•°ï¼Œå¦‚ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">func WithPort(port int) Option {
</span></span><span class="line"><span class="cl">  return func(s *Server) {
</span></span><span class="line"><span class="cl">    s.port = port
</span></span><span class="line"><span class="cl">  }
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div><p>å¦‚æœå¢åŠ é€‰é¡¹ï¼Œåªéœ€è¦å¢åŠ å¯¹åº”çš„ WithXXX å‡½æ•°å³å¯ã€‚</p>
<h2 id="å‚è€ƒ" class="headerLink">
    <a href="#%e5%8f%82%e8%80%83" class="header-mark"></a>å‚è€ƒ</h2><ul>
<li><a href="https://golang.cafe/blog/golang-functional-options-pattern.html" target="_blank" rel="noopener noreferrer">Golang Functional Options Pattern</a></li>
</ul>
]]></description>
</item><item>
    <title>golang make å’Œ new çš„åŒºåˆ«</title>
    <link>https://www.xiaobinqt.cn/new-make-difference/</link>
    <pubDate>Mon, 21 Jun 2021 00:00:00 &#43;0000</pubDate><author>
        <name>xiaobinqt</name>
    </author><guid>https://www.xiaobinqt.cn/new-make-difference/</guid>
    <description><![CDATA[<ul>
<li>make çš„ä½œç”¨æ˜¯åˆå§‹åŒ–å†…ç½®çš„æ•°æ®ç»“æ„ï¼Œä¹Ÿå°±æ˜¯ <code>slice</code>ã€<code>map</code>å’Œ <code>channel</code>ã€‚</li>
<li>new çš„ä½œç”¨æ˜¯æ ¹æ®ä¼ å…¥çš„ç±»å‹åˆ†é…ä¸€ç‰‡å†…å­˜ç©ºé—´å¹¶è¿”å›æŒ‡å‘è¿™ç‰‡å†…å­˜ç©ºé—´çš„æŒ‡é’ˆã€‚</li>
</ul>
<h2 id="make" class="headerLink">
    <a href="#make" class="header-mark"></a>make</h2><p>å†…ç½®å‡½æ•° <code>make</code> ä»…æ”¯æŒ <code>slice</code>ã€<code>map</code>ã€<code>channel</code> ä¸‰ç§æ•°æ®ç±»å‹çš„å†…å­˜åˆ›å»ºï¼Œ<strong>å…¶è¿”å›å€¼æ˜¯æ‰€åˆ›å»ºç±»å‹çš„æœ¬èº«ï¼Œè€Œä¸æ˜¯æ–°çš„æŒ‡é’ˆå¼•ç”¨</strong>ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">func make(t Type, size ...IntegerType) Type
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">func main() {
</span></span><span class="line"><span class="cl"> v1 := make([]int, 1, 5)
</span></span><span class="line"><span class="cl"> v2 := make(map[int]bool, 5)
</span></span><span class="line"><span class="cl"> v3 := make(chan int, 1)
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl"> fmt.Println(v1, v2, v3)
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div><p>åœ¨â˜ï¸ä»£ç ä¸­ï¼Œæˆ‘ä»¬åˆ†åˆ«å¯¹ä¸‰ç§ç±»å‹è°ƒç”¨äº† <code>make</code> å‡½æ•°è¿›è¡Œäº†åˆå§‹åŒ–ã€‚ä¼šå‘ç°æœ‰çš„å…¥å‚æ˜¯æœ‰å¤šä¸ªé•¿åº¦æŒ‡å®šï¼Œæœ‰çš„æ²¡æœ‰ã€‚è¿™é‡Œçš„åŒºåˆ«ä¸»è¦æ˜¯é•¿åº¦ï¼ˆlenï¼‰å’Œå®¹é‡ï¼ˆcapï¼‰çš„æŒ‡å®šï¼Œ
<strong>æœ‰çš„ç±»å‹æ˜¯æ²¡æœ‰å®¹é‡è¿™ä¸€è¯´æ³•</strong>ã€‚</p>
<p>è¾“å‡ºç»“æœï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">[0] map[] 0xc000044070
</span></span></code></pre></td></tr></table>
</div>
</div><p>è°ƒç”¨ <code>make</code>å‡½æ•°å»åˆå§‹åŒ–åˆ‡ç‰‡ï¼ˆsliceï¼‰çš„ç±»å‹æ—¶ï¼Œä¼šå¸¦æœ‰é›¶å€¼ã€‚</p>
<h2 id="new" class="headerLink">
    <a href="#new" class="header-mark"></a>new</h2><p>å†…ç½®å‡½æ•° <code>new</code> å¯ä»¥å¯¹ä»»æ„ç±»å‹è¿›è¡Œå†…å­˜åˆ›å»ºå’Œåˆå§‹åŒ–ã€‚<strong>å…¶è¿”å›å€¼æ˜¯æ‰€åˆ›å»ºç±»å‹çš„æŒ‡é’ˆå¼•ç”¨</strong>ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">func new(Type) *Type
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>new(T)</code> å’Œ <code>&amp;T{}</code> æ•ˆæœæ˜¯ä¸€æ ·çš„ã€‚</p>
<h2 id="åŒºåˆ«" class="headerLink">
    <a href="#%e5%8c%ba%e5%88%ab" class="header-mark"></a>åŒºåˆ«</h2><p><code>make</code> å‡½æ•°åœ¨åˆå§‹åŒ–æ—¶ï¼Œä¼šåˆå§‹åŒ– <code>slice</code>ã€<code>chan</code>ã€<code>map</code> ç±»å‹çš„å†…éƒ¨æ•°æ®ç»“æ„ï¼Œ<code>new</code> å‡½æ•°å¹¶ä¸ä¼šã€‚</p>
<p>ä¾‹å¦‚ï¼Œåœ¨ <code>map</code> ç±»å‹ä¸­ï¼Œåˆç†çš„é•¿åº¦ï¼ˆlenï¼‰å’Œå®¹é‡ï¼ˆcapï¼‰å¯ä»¥æé«˜æ•ˆç‡å’Œå‡å°‘å¼€é”€ã€‚</p>
<ul>
<li>
<p><code>make</code> å‡½æ•°ï¼š</p>
<ul>
<li>èƒ½å¤Ÿåˆ†é…å¹¶åˆå§‹åŒ–ç±»å‹æ‰€éœ€çš„å†…å­˜ç©ºé—´å’Œç»“æ„ï¼Œè¿”å›å¼•ç”¨ç±»å‹çš„æœ¬èº«ã€‚</li>
<li>å…·æœ‰ä½¿ç”¨èŒƒå›´çš„å±€é™æ€§ï¼Œä»…æ”¯æŒ <code>channel</code>ã€<code>map</code>ã€<code>slice</code> ä¸‰ç§ç±»å‹ã€‚</li>
<li>å…·æœ‰ç‹¬ç‰¹çš„ä¼˜åŠ¿ï¼Œ<code>make</code> å‡½æ•°ä¼šå¯¹ä¸‰ç§ç±»å‹çš„å†…éƒ¨æ•°æ®ç»“æ„ï¼ˆé•¿åº¦ã€å®¹é‡ç­‰ï¼‰èµ‹å€¼ã€‚</li>
</ul>
</li>
<li>
<p><code>new</code> å‡½æ•°ï¼š</p>
<ul>
<li>èƒ½å¤Ÿåˆ†é…ç±»å‹æ‰€éœ€çš„å†…å­˜ç©ºé—´ï¼Œè¿”å›æŒ‡é’ˆå¼•ç”¨ï¼ˆæŒ‡å‘å†…å­˜çš„æŒ‡é’ˆï¼‰ï¼ŒåŒæ—¶æŠŠåˆ†é…çš„å†…å­˜ç½®ä¸ºé›¶ï¼Œä¹Ÿå°±æ˜¯ç±»å‹çš„é›¶å€¼ã€‚</li>
<li>å¯è¢«æ›¿ä»£ï¼Œå…¶å®ä¸å¸¸ç”¨ï¼Œæˆ‘ä»¬é€šå¸¸éƒ½æ˜¯é‡‡ç”¨çŸ­è¯­å¥å£°æ˜ä»¥åŠç»“æ„ä½“çš„å­—é¢é‡è¾¾åˆ°æˆ‘ä»¬çš„ç›®çš„ï¼Œæ¯”å¦‚ï¼š
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"> i := 0
</span></span><span class="line"><span class="cl"> u := &amp;user{}
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ul>
</li>
</ul>
<h2 id="é›¶å€¼" class="headerLink">
    <a href="#%e9%9b%b6%e5%80%bc" class="header-mark"></a>é›¶å€¼</h2><ul>
<li>arrayã€struct æ¯ä¸ªå…ƒç´ æˆ–å­—æ®µéƒ½æ˜¯å¯¹åº”è¯¥ç±»å‹çš„é›¶å€¼</li>
<li>sliceã€map å¯¹äºé›¶å€¼ nil</li>
</ul>
<h2 id="å‚è€ƒ" class="headerLink">
    <a href="#%e5%8f%82%e8%80%83" class="header-mark"></a>å‚è€ƒ</h2><ul>
<li><a href="https://github.com/astaxie/build-web-application-with-golang/blob/master/zh/02.2.md#makenew%E6%93%8D%E4%BD%9C" target="_blank" rel="noopener noreferrer">makeã€newæ“ä½œ</a></li>
<li><a href="https://www.cnblogs.com/vincenshen/p/9356974.html" target="_blank" rel="noopener noreferrer">Go make å’Œ newçš„åŒºåˆ«</a></li>
<li><a href="https://dryyun.com/2019/05/30/go-new-make-use/" target="_blank" rel="noopener noreferrer">Go - var &amp; make &amp; new åœ¨å¤æ‚ç±»å‹ä¸Šçš„ä½¿ç”¨åŒºåˆ«</a></li>
<li><a href="https://mp.weixin.qq.com/s?__biz=MzUxMDI4MDc1NA==&amp;mid=2247487140&amp;idx=1&amp;sn=36d12263308fd24c32e9f5327e73ba21" target="_blank" rel="noopener noreferrer">Go é¢è¯•é¢˜ï¼š new å’Œ make æ˜¯ä»€ä¹ˆï¼Œå·®å¼‚åœ¨å“ªï¼Ÿ</a></li>
</ul>
]]></description>
</item></channel>
</rss>
